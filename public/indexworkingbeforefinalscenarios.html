<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitMyGolfClubs Pro Demo v5</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="pro-view">

    <!-- Main Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-text" id="header-business-name">Fairway Golf Academy</div>
                    <div class="logo-sub">Powered by <span>FitMyGolfClubs Pro</span> <span class="patent-badge" onclick="openModal('patent-modal')">üîí Patent Pending</span></div>
                </div>
            </div>
            
            <div class="view-toggle">
                <button class="view-toggle-btn active" onclick="setView('pro')">Pro View</button>
                <button class="view-toggle-btn client-btn" onclick="setView('client')">Client Preview</button>
            </div>
            
            <div class="header-right">
                <div class="credits-display" onclick="openCreditsModal()">
                    <span class="credits-icon">‚ö°</span>
                    <span class="credits-value">487/500</span>
                    <span class="credits-label">Pro Credits</span>
                </div>
                <div class="user-avatar" id="user-avatar" onclick="showLoginModal()" title="Click to login">?</div>
            </div>
        </div>
    </header>

    <div class="app-container">
        
        <!-- Demo Badge -->
        <div class="demo-controls" style="justify-content: center;">
            <span class="demo-badge">DEMO v5AA</span>
        </div>

        <!-- ============================================
             PRO VIEW PAGES
             ============================================ -->
        
        <!-- Pro Dashboard Tabs -->
        <div class="pro-tabs" id="pro-tabs">
            <button class="pro-tab active" id="tab-clients" onclick="showProTab('clients')">
                üë• Clients
            </button>
            <button class="pro-tab" id="tab-opportunities" onclick="showProTab('opportunities')">
                üí° AI <span class="badge">12</span>
            </button>
            <button class="pro-tab" onclick="openModal('add-event-modal')">
                üìÖ Add Event
            </button>
            <button class="pro-tab" onclick="openModal('log-lesson-modal')">
                üìö Log Lesson
            </button>
            <button class="pro-tab" id="tab-settings" onclick="showProTab('settings')">
                ‚öôÔ∏è Settings
            </button>
        </div>

        <!-- Page: AI Opportunities -->
        <div id="page-opportunities" class="page">
            <div class="opportunities-header">
                <div>
                    <h1 class="opportunities-title">üí° AI Opportunities</h1>
                    <p class="opportunities-subtitle">Equipment upgrade and fitting recommendations across your clients</p>
                </div>
            </div>

            <!-- AI Summary -->
            <div class="ai-summary-box">
                <div class="ai-summary-header">
                    <span>ü§ñ</span> AI Analysis Summary <span class="patent-tag">AI Recommendation Engine ‚Ä¢ Patent Pending</span>
                </div>
                <div class="ai-summary-text">
                    This month you have <span class="ai-summary-highlight">12 active opportunities</span> across 8 clients with an estimated <span class="ai-summary-highlight">$4,200 potential revenue</span>. 
                    Top priority: <span class="ai-summary-highlight">3 clients</span> have aging drivers (5+ years) that are significantly impacting their bag grades.
                </div>
            </div>

            <!-- Stats -->
            <div class="opportunity-stats">
                <div class="opp-stat-card">
                    <div class="opp-stat-value green">12</div>
                    <div class="opp-stat-label">Total Opportunities</div>
                </div>
                <div class="opp-stat-card">
                    <div class="opp-stat-value yellow">5</div>
                    <div class="opp-stat-label">High Priority</div>
                </div>
                <div class="opp-stat-card">
                    <div class="opp-stat-value cyan">$4,200</div>
                    <div class="opp-stat-label">Est. Revenue</div>
                </div>
                <div class="opp-stat-card">
                    <div class="opp-stat-value purple">8</div>
                    <div class="opp-stat-label">Clients Affected</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="opp-filters">
                <button class="opp-filter active" onclick="filterOpportunities('all')">All <span class="count">12</span></button>
                <button class="opp-filter" onclick="filterOpportunities('upgrade')">üîÑ Upgrades <span class="count">5</span></button>
                <button class="opp-filter" onclick="filterOpportunities('fitting')">üìê Fitting <span class="count">3</span></button>
                <button class="opp-filter" onclick="filterOpportunities('replacement')">‚ôªÔ∏è Replacement <span class="count">2</span></button>
                <button class="opp-filter" onclick="filterOpportunities('aging')">‚è∞ Aging <span class="count">2</span></button>
            </div>

            <!-- Opportunity Cards -->
            <div class="opportunity-card high-priority" onclick="viewClientOpportunity('mike')">
                <div class="opp-card-header">
                    <div class="opp-client-info">
                        <div class="opp-avatar">MJ</div>
                        <div>
                            <div class="opp-client-name">Mike Johnson</div>
                            <div class="opp-client-meta">10 Handicap ‚Ä¢ 14 clubs ‚Ä¢ Last active: Today</div>
                        </div>
                    </div>
                    <span class="opp-priority-badge high">High Priority</span>
                </div>
                
                <div>
                    <span class="opp-type-badge upgrade">üîÑ Upgrade</span>
                    <span class="opp-type-badge fitting">üìê Fitting</span>
                </div>
                
                <div class="opp-description">
                    Mike's 3-Wood has a weight progression issue causing D+ grade. Scenario analysis shows upgrading shaft weight from 90g to 75g would improve his bag grade from B- to B+.
                </div>
                
                <div class="opp-equipment">
                    <div class="opp-equipment-label">AFFECTED EQUIPMENT</div>
                    <div class="opp-equipment-item">
                        <span>3-Wood: TaylorMade Stealth 2 (Stock 90g shaft)</span>
                        <span class="opp-equipment-grade fair">D+</span>
                    </div>
                </div>
                
                <div class="opp-footer">
                    <div class="opp-revenue">
                        <span class="opp-revenue-label">Est. Value: </span>
                        <span class="opp-revenue-value">$350 - $500</span>
                    </div>
                    <div class="opp-actions">
                        <button class="opp-action-btn secondary" onclick="event.stopPropagation(); runClientScenario('mike')">Run Scenario</button>
                        <button class="opp-action-btn primary" onclick="event.stopPropagation(); contactClient('mike')">Contact</button>
                    </div>
                </div>
            </div>

            <div class="opportunity-card high-priority" onclick="viewClientOpportunity('tom')">
                <div class="opp-card-header">
                    <div class="opp-client-info">
                        <div class="opp-avatar">TB</div>
                        <div>
                            <div class="opp-client-name">Tom Bradley</div>
                            <div class="opp-client-meta">16 Handicap ‚Ä¢ 13 clubs ‚Ä¢ Last active: 3 days ago</div>
                        </div>
                    </div>
                    <span class="opp-priority-badge high">High Priority</span>
                </div>
                
                <div>
                    <span class="opp-type-badge aging">‚è∞ Aging</span>
                    <span class="opp-type-badge replacement">‚ôªÔ∏è Replacement</span>
                </div>
                
                <div class="opp-description">
                    Tom's driver is 6 years old (2019 Callaway Epic Flash). Club age is dragging his overall grade down. Modern drivers could add 10-15 yards and improve consistency.
                </div>
                
                <div class="opp-equipment">
                    <div class="opp-equipment-label">AFFECTED EQUIPMENT</div>
                    <div class="opp-equipment-item">
                        <span>Driver: Callaway Epic Flash (2019)</span>
                        <span class="opp-equipment-grade poor">D-</span>
                    </div>
                </div>
                
                <div class="opp-footer">
                    <div class="opp-revenue">
                        <span class="opp-revenue-label">Est. Value: </span>
                        <span class="opp-revenue-value">$500 - $700</span>
                    </div>
                    <div class="opp-actions">
                        <button class="opp-action-btn secondary" onclick="event.stopPropagation(); runClientScenario('tom')">Run Scenario</button>
                        <button class="opp-action-btn primary" onclick="event.stopPropagation(); contactClient('tom')">Contact</button>
                    </div>
                </div>
            </div>

            <div class="opportunity-card medium-priority" onclick="viewClientOpportunity('sarah')">
                <div class="opp-card-header">
                    <div class="opp-client-info">
                        <div class="opp-avatar">SL</div>
                        <div>
                            <div class="opp-client-name">Sarah Lee</div>
                            <div class="opp-client-meta">8 Handicap ‚Ä¢ 13 clubs ‚Ä¢ Last active: Yesterday</div>
                        </div>
                    </div>
                    <span class="opp-priority-badge medium">Medium</span>
                </div>
                
                <div>
                    <span class="opp-type-badge fitting">üìê Fitting</span>
                </div>
                
                <div class="opp-description">
                    Sarah's hybrid shaft flex is inconsistent with rest of bag (Regular vs Stiff). This creates tempo inconsistency. Simple shaft swap could fix.
                </div>
                
                <div class="opp-equipment">
                    <div class="opp-equipment-label">AFFECTED EQUIPMENT</div>
                    <div class="opp-equipment-item">
                        <span>4-Hybrid: Titleist TSi2 (Regular flex)</span>
                        <span class="opp-equipment-grade fair">C</span>
                    </div>
                </div>
                
                <div class="opp-footer">
                    <div class="opp-revenue">
                        <span class="opp-revenue-label">Est. Value: </span>
                        <span class="opp-revenue-value">$150 - $250</span>
                    </div>
                    <div class="opp-actions">
                        <button class="opp-action-btn secondary" onclick="event.stopPropagation(); runClientScenario('sarah')">Run Scenario</button>
                        <button class="opp-action-btn primary" onclick="event.stopPropagation(); contactClient('sarah')">Contact</button>
                    </div>
                </div>
            </div>

            <div class="opportunity-card medium-priority" onclick="viewClientOpportunity('dave')">
                <div class="opp-card-header">
                    <div class="opp-client-info">
                        <div class="opp-avatar">DW</div>
                        <div>
                            <div class="opp-client-name">Dave Wilson</div>
                            <div class="opp-client-meta">14 Handicap ‚Ä¢ 14 clubs ‚Ä¢ Last active: 5 days ago</div>
                        </div>
                    </div>
                    <span class="opp-priority-badge medium">Medium</span>
                </div>
                
                <div>
                    <span class="opp-type-badge upgrade">üîÑ Upgrade</span>
                </div>
                
                <div class="opp-description">
                    Dave's wedge loft gapping has issues - his 52¬∞ and 56¬∞ are too close (only 4¬∞ gap vs recommended 4-6¬∞). Adding a 50¬∞ gap wedge or adjusting lofts would help.
                </div>
                
                <div class="opp-equipment">
                    <div class="opp-equipment-label">AFFECTED EQUIPMENT</div>
                    <div class="opp-equipment-item">
                        <span>Wedges: Vokey SM8 (52¬∞, 56¬∞, 60¬∞)</span>
                        <span class="opp-equipment-grade fair">C+</span>
                    </div>
                </div>
                
                <div class="opp-footer">
                    <div class="opp-revenue">
                        <span class="opp-revenue-label">Est. Value: </span>
                        <span class="opp-revenue-value">$180 - $220</span>
                    </div>
                    <div class="opp-actions">
                        <button class="opp-action-btn secondary" onclick="event.stopPropagation(); runClientScenario('dave')">Run Scenario</button>
                        <button class="opp-action-btn primary" onclick="event.stopPropagation(); contactClient('dave')">Contact</button>
                    </div>
                </div>
            </div>

            <div class="opportunity-card low-priority" onclick="viewClientOpportunity('jen')">
                <div class="opp-card-header">
                    <div class="opp-client-info">
                        <div class="opp-avatar">JM</div>
                        <div>
                            <div class="opp-client-name">Jennifer Martinez</div>
                            <div class="opp-client-meta">22 Handicap ‚Ä¢ 12 clubs ‚Ä¢ Last active: 1 week ago</div>
                        </div>
                    </div>
                    <span class="opp-priority-badge low">Low</span>
                </div>
                
                <div>
                    <span class="opp-type-badge aging">‚è∞ Aging</span>
                </div>
                
                <div class="opp-description">
                    Jennifer's putter is 8 years old but still performing well. Consider as future upgrade opportunity when she's ready to invest in equipment.
                </div>
                
                <div class="opp-equipment">
                    <div class="opp-equipment-label">AFFECTED EQUIPMENT</div>
                    <div class="opp-equipment-item">
                        <span>Putter: Odyssey Stroke Lab (2017)</span>
                        <span class="opp-equipment-grade fair">C+</span>
                    </div>
                </div>
                
                <div class="opp-footer">
                    <div class="opp-revenue">
                        <span class="opp-revenue-label">Est. Value: </span>
                        <span class="opp-revenue-value">$250 - $400</span>
                    </div>
                    <div class="opp-actions">
                        <button class="opp-action-btn secondary" onclick="event.stopPropagation(); runClientScenario('jen')">Run Scenario</button>
                        <button class="opp-action-btn primary" onclick="event.stopPropagation(); contactClient('jen')">Contact</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Page: Settings -->
        <div id="page-settings" class="page">
            <div class="settings-header">
                <h1 class="settings-title">‚öôÔ∏è Settings</h1>
                <p class="settings-subtitle">Customize your Pro account and white label experience</p>
            </div>

            <div class="demo-notice">
                üéÆ <strong>Demo Mode:</strong> Changes here are for demonstration only and won't persist after refresh.
            </div>

            <!-- White Label Settings -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <span>üè∑Ô∏è</span> White Label Branding
                </div>
                
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Business Name</div>
                        <div class="settings-label-hint">Displayed to your clients in the app header</div>
                    </div>
                    <input type="text" class="settings-input" id="business-name" value="Fairway Golf Academy" onchange="updateBusinessName()">
                </div>

                <div class="settings-row">
                    <div>
                        <div class="settings-label">Brand Color</div>
                        <div class="settings-label-hint">Accent color throughout your client's experience</div>
                    </div>
                    <div class="color-picker-row">
                        <div class="color-swatch active" style="background: #4caf50;" onclick="selectBrandColor('#4caf50', this)" title="Green"></div>
                        <div class="color-swatch" style="background: #00d4ff;" onclick="selectBrandColor('#00d4ff', this)" title="Cyan"></div>
                        <div class="color-swatch" style="background: #a855f7;" onclick="selectBrandColor('#a855f7', this)" title="Purple"></div>
                        <div class="color-swatch" style="background: #ff6464;" onclick="selectBrandColor('#ff6464', this)" title="Red"></div>
                        <div class="color-swatch" style="background: #ffb400;" onclick="selectBrandColor('#ffb400', this)" title="Gold"></div>
                    </div>
                </div>

                <!-- Live Preview -->
                <div class="preview-box">
                    <div class="preview-label">PREVIEW</div>
                    <div class="preview-header">
                        <div>
                            <div class="preview-logo" id="preview-business-name" style="color: var(--pro-green);">Fairway Golf Academy</div>
                            <div class="preview-powered">Powered by <span style="color: var(--cyan);">FitMyGolfClubs</span></div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="saveSettings('branding')">Save Branding</button>
            </div>

            <!-- Account Info -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <span>üë§</span> Account
                </div>
                
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Email</div>
                    </div>
                    <span style="color: var(--text-muted);"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ee9e9c81ae888f879c998f9789818288c08d8183">[email&#160;protected]</a></span>
                </div>

                <div class="settings-row">
                    <div>
                        <div class="settings-label">Member Since</div>
                    </div>
                    <span style="color: var(--text-muted);">October 2024</span>
                </div>

                <div class="settings-row">
                    <div>
                        <div class="settings-label">Billing</div>
                    </div>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="alert('Billing portal coming soon!')">Manage Billing ‚Üí</button>
                </div>
            </div>

            <!-- Admin Divider -->
            <div style="border-top: 2px solid var(--border-medium); margin: 24px 0 16px 0; padding-top: 16px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üõ†Ô∏è</span>
                    <span style="font-size: 16px; font-weight: 600; color: var(--purple);">FitMyGolfClubs Admin</span>
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                    Internal controls for demo and testing. These will be in the Firebase admin panel in production.
                </p>
            </div>

            <!-- Subscription Tier (Demo) -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <span>üí≥</span> Subscription Simulation
                </div>
                
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Pro Tier</div>
                        <div class="settings-label-hint">Your subscription level - determines monthly credits</div>
                    </div>
                    <select class="settings-select" id="pro-tier" onchange="updateProTier()">
                        <option value="elite">Elite ($199/mo) - 2000 credits</option>
                        <option value="growth">Growth ($99/mo) - 1000 credits</option>
                        <option value="starter" selected>Starter ($49/mo) - 500 credits</option>
                        <option value="free">Free Trial - 50 credits</option>
                    </select>
                </div>

                <div class="settings-row">
                    <div>
                        <div class="settings-label">Client Default Access</div>
                        <div class="settings-label-hint">Default access level for new clients</div>
                    </div>
                    <select class="settings-select" id="client-tier" onchange="updateClientTier()">
                        <option value="full" selected>Full Access</option>
                        <option value="limited">Limited Access</option>
                    </select>
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="saveSettings('subscription')">Save Subscription Settings</button>
            </div>

            <!-- Demo Controls -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <span>üéÆ</span> Demo Controls
                </div>
                
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Simulate Low Credits</div>
                        <div class="settings-label-hint">Test credit warning and paywall behavior</div>
                    </div>
                    <div class="settings-toggle" id="low-credits-toggle" onclick="toggleLowCreditsNew()"></div>
                </div>

                <div class="settings-row">
                    <div>
                        <div class="settings-label">Golf Genius Connected</div>
                        <div class="settings-label-hint">Toggle GG integration on Events tab</div>
                    </div>
                    <div class="settings-toggle active" id="gg-toggle" onclick="toggleGGDemo()"></div>
                </div>
            </div>

            <!-- Grading Engine (A/B Testing) -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <span>üß†</span> Grading Engine
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                    Choose how factor scores are calculated. Results are stored for A/B comparison.
                </p>
                
                <div class="settings-row" style="flex-direction: column; gap: 12px;">
                    <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; padding: 12px; background: var(--bg-main); border-radius: 8px; border: 2px solid transparent;" id="engine-js-label">
                        <input type="radio" name="grading-engine" value="javascript" id="engine-js" onchange="updateGradingEngine('javascript')" checked style="margin-top: 3px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">JavaScript Only</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Fast, deterministic. Uses hardcoded thresholds for each factor.</div>
                        </div>
                    </label>
                    
                    <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; padding: 12px; background: var(--bg-main); border-radius: 8px; border: 2px solid transparent;" id="engine-hybrid-label">
                        <input type="radio" name="grading-engine" value="hybrid" id="engine-hybrid" onchange="updateGradingEngine('hybrid')" style="margin-top: 3px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">JavaScript + Claude Review</div>
                            <div style="font-size: 12px; color: var(--text-muted);">JS calculates first, Claude reviews and adjusts (¬±15 pts max). Best of both.</div>
                        </div>
                    </label>
                    
                    <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; padding: 12px; background: var(--bg-main); border-radius: 8px; border: 2px solid transparent;" id="engine-claude-label">
                        <input type="radio" name="grading-engine" value="claude" id="engine-claude" onchange="updateGradingEngine('claude')" style="margin-top: 3px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">Claude Only</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Claude scores all factors from raw data. More contextual, slower, costs tokens.</div>
                        </div>
                    </label>
                </div>
                
                <div style="margin-top: 16px; padding: 12px; background: var(--bg-main); border-radius: 8px; border-left: 3px solid var(--cyan);">
                    <div style="font-size: 12px; color: var(--text-muted);">
                        <strong style="color: var(--cyan);">Current Mode:</strong> <span id="current-engine-display">JavaScript Only</span>
                    </div>
                    <div style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">
                        All grading results are saved to <code>gradingTests</code> collection for comparison.
                    </div>
                </div>
            </div>

            <!-- Factor Weights (Admin Only) -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <span>‚öñÔ∏è</span> Factor Weights
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                    Adjust how each factor contributes to the overall bag grade. Must total 100%.
                </p>
                
                <div class="settings-row" style="flex-direction: column; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="settings-label">Loft Gapping</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="40" value="20" id="weight-loft" oninput="updateWeightDisplay('loft')" style="width: 100px;">
                            <span id="weight-loft-val" style="width: 36px; text-align: right; font-size: 13px; color: var(--cyan);">20%</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="settings-label">Club Age</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="40" value="20" id="weight-age" oninput="updateWeightDisplay('age')" style="width: 100px;">
                            <span id="weight-age-val" style="width: 36px; text-align: right; font-size: 13px; color: var(--cyan);">20%</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="settings-label">Weight Progression</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="40" value="15" id="weight-weight" oninput="updateWeightDisplay('weight')" style="width: 100px;">
                            <span id="weight-weight-val" style="width: 36px; text-align: right; font-size: 13px; color: var(--cyan);">15%</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="settings-label">Shaft Flex</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="40" value="10" id="weight-flex" oninput="updateWeightDisplay('flex')" style="width: 100px;">
                            <span id="weight-flex-val" style="width: 36px; text-align: right; font-size: 13px; color: var(--cyan);">10%</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="settings-label">Kickpoint</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="40" value="10" id="weight-kickpoint" oninput="updateWeightDisplay('kickpoint')" style="width: 100px;">
                            <span id="weight-kickpoint-val" style="width: 36px; text-align: right; font-size: 13px; color: var(--cyan);">10%</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="settings-label">Length Progression</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="40" value="10" id="weight-length" oninput="updateWeightDisplay('length')" style="width: 100px;">
                            <span id="weight-length-val" style="width: 36px; text-align: right; font-size: 13px; color: var(--cyan);">10%</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="settings-label">Lie Angle</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="40" value="10" id="weight-lie" oninput="updateWeightDisplay('lie')" style="width: 100px;">
                            <span id="weight-lie-val" style="width: 36px; text-align: right; font-size: 13px; color: var(--cyan);">10%</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="settings-label">Torque</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" min="0" max="40" value="5" id="weight-torque" oninput="updateWeightDisplay('torque')" style="width: 100px;">
                            <span id="weight-torque-val" style="width: 36px; text-align: right; font-size: 13px; color: var(--cyan);">5%</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-light);">
                    <div>
                        <span style="font-size: 13px; color: var(--text-muted);">Total: </span>
                        <span id="weight-total" style="font-size: 14px; font-weight: 600; color: var(--green);">100%</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;" onclick="resetWeights()">Reset</button>
                        <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;" onclick="saveSettings('weights')">Save Weights</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Page: Client List -->
        <div id="page-client-list" class="page active">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Your Clients</h1>
                    <p class="page-subtitle">Manage client bags, run scenarios, track progress</p>
                </div>
                <button class="btn btn-pro" onclick="openModal('onboarding-modal')">+ Add/Invite Client</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card clickable" onclick="filterClients('all')">
                    <div class="stat-value">24</div>
                    <div class="stat-label">Total Clients</div>
                </div>
                <div class="stat-card clickable" onclick="filterClients('onboarded')">
                    <div class="stat-value green">18</div>
                    <div class="stat-label">Bags Onboarded</div>
                </div>
                <div class="stat-card clickable" onclick="filterClients('need-onboarding')">
                    <div class="stat-value yellow">6</div>
                    <div class="stat-label">Need Onboarding</div>
                </div>
                <div class="stat-card clickable" onclick="filterClients('attention')">
                    <div class="stat-value red">7</div>
                    <div class="stat-label">Needs Attention</div>
                </div>
            </div>

            <!-- Active Filter Indicator -->
            <div id="filter-indicator" style="display: none; margin-bottom: 12px; padding: 10px 16px; background: var(--cyan-dim); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span id="filter-text" style="font-size: 13px; color: var(--cyan);">Showing: All Clients</span>
                <button onclick="filterClients('all')" style="background: none; border: none; color: var(--cyan); cursor: pointer; font-size: 12px;">‚úï Clear Filter</button>
            </div>

            <div class="search-bar">
                <span>üîç</span>
                <input type="text" placeholder="Search clients...">
            </div>

            <!-- Desktop Table -->
            <table class="clients-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Access</th>
                        <th>Bag Grade</th>
                        <th>Clubs</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated dynamically by firebase-auth.js -->
                </tbody>
            </table>

            <!-- Mobile Cards (populated dynamically by firebase-auth.js) -->
            <div class="clients-cards">
                <div id="cards-loading-indicator" style="text-align: center; padding: 20px; color: var(--text-muted);">
                    Loading clients...
                </div>
            </div>
        </div>

        <!-- Page: Client Detail -->
        <div id="page-client-detail" class="page">
            <span class="back-link pro-only" onclick="backToClientList()">‚Üê Back to Clients</span>
            
            <!-- Pro View: Shows client info -->
            <div class="client-detail-header pro-only">
                <div class="client-detail-info">
                    <div class="client-avatar-lg" id="client-avatar-lg">MJ</div>
                    <div>
                        <div class="client-detail-name" id="client-detail-name">Mike Johnson</div>
                        <div class="client-detail-meta" id="client-detail-meta">
                            <span class="tier-badge full" style="margin-right: 8px;">Full</span>
                            <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="aec3c7c5cbeecbd6cfc3dec2cb80cdc1c3">[email&#160;protected]</a> ‚Ä¢ Member since Jan 2025
                        </div>
                    </div>
                </div>
                <div class="client-detail-stats">
                    <div class="detail-stat">
                        <div class="detail-stat-value grade" id="client-bag-grade">B-</div>
                        <div class="detail-stat-label">Bag Grade</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value" id="client-handicap" style="color: var(--text-primary);">10.4</div>
                        <div class="detail-stat-label">Handicap</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value green" id="client-credits">27/30</div>
                        <div class="detail-stat-label">Credits</div>
                    </div>
                </div>
            </div>

            <!-- Client View: Simpler header -->
            <div class="client-detail-header client-only">
                <div class="client-detail-stats" style="width: 100%; justify-content: center;">
                    <div class="detail-stat">
                        <div class="detail-stat-value grade" id="client-bag-grade-client">B-</div>
                        <div class="detail-stat-label">Bag Grade</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value" id="client-handicap-client" style="color: var(--text-primary);">10.4</div>
                        <div class="detail-stat-label">Handicap</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value green" id="client-credits-client">27/30</div>
                        <div class="detail-stat-label">Credits</div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showClientTab('bag')">Bag</button>
                <button class="tab" onclick="showClientTab('progress')">Progress</button>
                <button class="tab" onclick="showClientTab('scenarios')">Scenarios</button>
                <button class="tab" onclick="showClientTab('testing')">Testing</button>
                <button class="tab" onclick="showClientTab('events')">Events</button>
                <button class="tab" onclick="showClientTab('messages')" id="messages-tab">Messages <span class="tab-badge" id="message-badge">2</span></button>
            </div>

            <!-- Tab: My Bag -->
            <div id="tab-bag" class="tab-content">
                <div class="content-card">
                    <div class="grade-overview">
                        <div class="overall-grade">
                            <div class="overall-grade-value" id="overall-grade-letter">--</div>
                            <div class="overall-grade-label">Overall Bag Grade <span class="patent-tag">Equipment-Only Analysis ‚Ä¢ Patent Pending</span></div>
                            
                            <!-- Grade Explainer Section - Compact -->
                            <div class="grade-explainer" id="grade-explainer">
                                <div class="grade-explainer-header">
                                    <span>üìä</span>
                                    <h4>Why This Grade?</h4>
                                </div>
                                
                                <!-- AI Score Comparison -->
                                <div class="ai-score-comparison" id="ai-score-comparison" style="display: none;">
                                    <div class="score-item">
                                        <div class="score-value" id="raw-algo-score">--</div>
                                        <div class="score-label">Raw Score</div>
                                    </div>
                                    <div class="score-arrow">‚Üí</div>
                                    <div class="score-item">
                                        <div class="score-value" id="ai-adjusted-score">--</div>
                                        <div class="score-label">AI Adjusted</div>
                                    </div>
                                    <div class="score-adjustment">
                                        <div class="adj-value neutral" id="ai-adjustment-value">+0</div>
                                        <div class="adj-label">Change</div>
                                    </div>
                                </div>
                                
                                <!-- AI Adjustment Summary -->
                                <div class="ai-adjustment-summary" id="ai-adjustment-summary" style="display: none;"></div>
                                
                                <!-- Factor Adjustment Tags -->
                                <div class="ai-factor-adjustments" id="ai-factor-adjustments" style="display: none;"></div>
                                
                                <div class="grade-explainer-summary" id="grade-explainer-summary" style="display: none;">
                                </div>
                                <!-- Impacts section hidden - AI summary now provides this context -->
                                <div class="grade-explainer-impacts" id="grade-explainer-impacts" style="display: none;">
                                </div>
                                
                                <!-- Active Baselines Badges -->
                                <div class="active-baselines-container" id="active-baselines-container" style="display: flex; gap: 8px; justify-content: center; margin-top: 12px; flex-wrap: wrap;">
                                    <div id="favorite-baseline-badge" class="baseline-badge clickable-badge" style="display: none;" onclick="showBaselineModal('favorite')">
                                        <span class="baseline-star">‚òÖ</span> <span id="baseline-club-type">7-Iron</span> Baseline
                                    </div>
                                    <div id="bodyfit-baseline-badge" class="bodyfit-badge clickable-badge" style="display: none;" onclick="showBaselineModal('bodyfit')">
                                        <span class="bodyfit-icon">üìè</span> Body Fit
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="factors-grid">
                            <div class="factor-item" onclick="showFactorDetail('loft')">
                                <span class="factor-name">Loft Gapping</span>
                                <span>
                                    <span class="factor-grade a">A-</span>
                                    <span class="factor-weight pro-only-inline">(20%)</span>
                                </span>
                            </div>
                            <div class="factor-item" onclick="showFactorDetail('age')">
                                <span class="factor-name">Club Age</span>
                                <span>
                                    <span class="factor-grade b">B+</span>
                                    <span class="factor-weight pro-only-inline">(20%)</span>
                                </span>
                            </div>
                            <div class="factor-item issue" onclick="showFactorDetail('weight')">
                                <span class="factor-name">Weight Prog.</span>
                                <span>
                                    <span class="factor-grade d">D+</span>
                                    <span class="factor-weight pro-only-inline">(15%)</span>
                                </span>
                            </div>
                            <div class="factor-item" onclick="showFactorDetail('flex')">
                                <span class="factor-name">Shaft Flex</span>
                                <span>
                                    <span class="factor-grade c">C</span>
                                    <span class="factor-weight pro-only-inline">(10%)</span>
                                </span>
                            </div>
                            <div class="factor-item" onclick="showFactorDetail('kickpoint')">
                                <span class="factor-name">Kickpoint</span>
                                <span>
                                    <span class="factor-grade b">B</span>
                                    <span class="factor-weight pro-only-inline">(10%)</span>
                                </span>
                            </div>
                            <div class="factor-item" onclick="showFactorDetail('length')">
                                <span class="factor-name">Length Prog.</span>
                                <span>
                                    <span class="factor-grade a">A</span>
                                    <span class="factor-weight pro-only-inline">(10%)</span>
                                </span>
                            </div>
                            <div class="factor-item" onclick="showFactorDetail('lie')">
                                <span class="factor-name">Lie Angle</span>
                                <span>
                                    <span class="factor-grade a">A-</span>
                                    <span class="factor-weight pro-only-inline">(10%)</span>
                                </span>
                            </div>
                            <div class="factor-item" onclick="showFactorDetail('torque')">
                                <span class="factor-name">Torque</span>
                                <span>
                                    <span class="factor-grade b">B-</span>
                                    <span class="factor-weight pro-only-inline">(5%)</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="attention-summary" onclick="openIssuesModal()" title="Click to see all issues">
                        <span>‚ö†Ô∏è</span>
                        <span><strong>3 Clubs Need Attention</strong> ‚Äî Click to view details</span>
                    </div>

                    <!-- AI Bag Summary -->
                    <div class="ai-bag-summary" id="ai-bag-summary">
                        <div class="ai-summary-header">
                            <div class="ai-summary-header-left">
                                <span>ü§ñ</span>
                                <span>AI Analysis</span>
                            </div>
                            <span class="patent-tag">Patent Pending</span>
                        </div>
                        <div class="ai-summary-body">
                            <div class="ai-summary-empty" id="ai-summary-empty">
                                Grade this bag to see AI analysis
                            </div>
                            <div id="ai-summary-content" style="display: none;">
                                <div class="ai-overall-assessment" id="ai-overall-assessment">
                                    <!-- Populated by JS -->
                                </div>
                                <div class="ai-bag-personality" id="ai-bag-personality">
                                    <!-- Populated by JS -->
                                </div>
                                <div class="ai-summary-columns">
                                    <div class="ai-summary-section">
                                        <div class="ai-summary-section-title strengths">‚úÖ Key Strengths</div>
                                        <ul class="ai-summary-list strengths" id="ai-key-strengths">
                                            <!-- Populated by JS -->
                                        </ul>
                                    </div>
                                    <div class="ai-summary-section">
                                        <div class="ai-summary-section-title weaknesses">‚ö†Ô∏è Key Weaknesses</div>
                                        <ul class="ai-summary-list weaknesses" id="ai-key-weaknesses">
                                            <!-- Populated by JS -->
                                        </ul>
                                    </div>
                                </div>
                                <div class="ai-recommendations-section">
                                    <div class="ai-summary-section-title recommendations">üéØ Priority Recommendations</div>
                                    <ul class="ai-summary-list recommendations" id="ai-priority-recommendations">
                                        <!-- Populated by JS -->
                                    </ul>
                                </div>
                                <div class="ai-summary-disclaimer">
                                    This analysis represents FitMyGolfClubs' opinion based on the equipment data provided. Results depend on data accuracy and are intended as suggestions only‚Äînot professional fitting advice. Consult a certified club fitter for personalized recommendations.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Club Cards -->
                <div class="clubs-section" id="clubs-container">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="section-label">Woods</div>
                        <button class="btn btn-sm btn-secondary" onclick="openAddClubModal()">+ Add Club</button>
                    </div>
                    
                    <div class="club-card status-good">
                        <div class="club-header">
                            <div class="club-header-left">
                                <span class="club-name">Driver</span>
                                <span class="club-status good">‚úì Good Fit</span>
                            </div>
                            <div class="club-menu-wrapper">
                                <button class="club-menu-btn" onclick="toggleClubMenu(this, 'driver')">‚ãÆ</button>
                                <div class="club-menu-dropdown" id="club-menu-driver">
                                    <button class="club-menu-item" onclick="editClub('driver')">‚úèÔ∏è Edit</button>
                                    <button class="club-menu-item danger" onclick="deleteClub('driver')">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="club-specs">
                            TaylorMade Stealth 2 (2023)<br>
                            10.5¬∞ ‚Ä¢ Fujikura Ventus Blue 65g ‚Ä¢ Stiff
                        </div>
                        <div class="club-actions">
                            <button class="club-action-btn scenario" onclick="startScenarioForClub('driver')">üîÑ Scenario</button>
                            <button class="club-action-btn test" onclick="startTestForClub('driver')">üìä Test</button>
                            <button class="club-action-btn shop pro-only">üõí Shop</button>
                        </div>
                    </div>

                    <div class="club-card status-attention">
                        <div class="club-header">
                            <div class="club-header-left">
                                <span class="club-name">3-Wood</span>
                                <span class="club-status attention">‚ö†Ô∏è Attention</span>
                            </div>
                            <div class="club-menu-wrapper">
                                <button class="club-menu-btn" onclick="toggleClubMenu(this, '3wood')">‚ãÆ</button>
                                <div class="club-menu-dropdown" id="club-menu-3wood">
                                    <button class="club-menu-item" onclick="editClub('3wood')">‚úèÔ∏è Edit</button>
                                    <button class="club-menu-item danger" onclick="deleteClub('3wood')">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="club-specs">
                            TaylorMade Stealth 2 (2023)<br>
                            15¬∞ ‚Ä¢ Stock Aldila 90g ‚Ä¢ Stiff
                        </div>
                        <div class="club-issue">Shaft 25g heavier than driver ‚Äî creates tempo inconsistency</div>
                        <div class="club-suggestion">üí° Try 70-75g shaft in Scenarios to improve weight flow</div>
                        <div class="club-actions">
                            <button class="club-action-btn scenario" onclick="startScenarioForClub('3wood')">üîÑ Scenario</button>
                            <button class="club-action-btn test" onclick="startTestForClub('3wood')">üìä Test</button>
                            <button class="club-action-btn shop pro-only">üõí Shop</button>
                        </div>
                    </div>

                    <div class="section-label">Hybrids</div>

                    <div class="club-card status-attention">
                        <div class="club-header">
                            <div class="club-header-left">
                                <span class="club-name">4-Hybrid</span>
                                <span class="club-status attention">‚ö†Ô∏è Attention</span>
                            </div>
                            <div class="club-menu-wrapper">
                                <button class="club-menu-btn" onclick="toggleClubMenu(this, '4hybrid')">‚ãÆ</button>
                                <div class="club-menu-dropdown" id="club-menu-4hybrid">
                                    <button class="club-menu-item" onclick="editClub('4hybrid')">‚úèÔ∏è Edit</button>
                                    <button class="club-menu-item danger" onclick="deleteClub('4hybrid')">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="club-specs">
                            Cobra LTDx (2022)<br>
                            21¬∞ ‚Ä¢ Cobra Ultralight 50g ‚Ä¢ Regular
                        </div>
                        <div class="club-issue">Mismatched brand/flex breaks set consistency</div>
                        <div class="club-suggestion">üí° Consider TaylorMade hybrid with Stiff flex to match</div>
                        <div class="club-actions">
                            <button class="club-action-btn scenario" onclick="startScenarioForClub('hybrid')">üîÑ Scenario</button>
                            <button class="club-action-btn test" onclick="startTestForClub('hybrid')">üìä Test</button>
                            <button class="club-action-btn shop pro-only">üõí Shop</button>
                        </div>
                    </div>

                    <div class="club-card status-good">
                        <div class="club-header">
                            <div class="club-header-left">
                                <span class="club-name">5-Hybrid</span>
                                <span class="club-status good">‚úì Good Fit</span>
                            </div>
                            <div class="club-menu-wrapper">
                                <button class="club-menu-btn" onclick="toggleClubMenu(this, '5hybrid')">‚ãÆ</button>
                                <div class="club-menu-dropdown" id="club-menu-5hybrid">
                                    <button class="club-menu-item" onclick="editClub('5hybrid')">‚úèÔ∏è Edit</button>
                                    <button class="club-menu-item danger" onclick="deleteClub('5hybrid')">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="club-specs">
                            TaylorMade Stealth 2 (2023)<br>
                            25¬∞ ‚Ä¢ Fujikura Ventus HB 75g ‚Ä¢ Stiff
                        </div>
                        <div class="club-actions">
                            <button class="club-action-btn scenario" onclick="startScenarioForClub('5hybrid')">üîÑ Scenario</button>
                            <button class="club-action-btn test" onclick="startTestForClub('5hybrid')">üìä Test</button>
                            <button class="club-action-btn shop pro-only">üõí Shop</button>
                        </div>
                    </div>

                    <div class="section-label">Irons</div>

                    <div class="club-card status-good">
                        <div class="club-header">
                            <div class="club-header-left">
                                <span class="club-name">6i - PW (5 clubs)</span>
                                <span class="club-status good">‚úì Good Fit</span>
                            </div>
                            <div class="club-menu-wrapper">
                                <button class="club-menu-btn" onclick="toggleClubMenu(this, 'irons')">‚ãÆ</button>
                                <div class="club-menu-dropdown" id="club-menu-irons">
                                    <button class="club-menu-item" onclick="editClub('irons')">‚úèÔ∏è Edit</button>
                                    <button class="club-menu-item danger" onclick="deleteClub('irons')">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="club-specs">
                            TaylorMade P790 (2023)<br>
                            26¬∞ - 45¬∞ ‚Ä¢ KBS Tour 120g ‚Ä¢ Stiff
                        </div>
                        <div class="club-actions">
                            <button class="club-action-btn scenario" onclick="startScenarioForClub('irons')">üîÑ Scenario</button>
                            <button class="club-action-btn test" onclick="startTestForClub('7iron')">üìä Test</button>
                            <button class="club-action-btn shop pro-only">üõí Shop</button>
                        </div>
                    </div>

                    <div class="section-label">Wedges</div>

                    <div class="club-card status-attention">
                        <div class="club-header">
                            <div class="club-header-left">
                                <span class="club-name">52¬∞, 56¬∞, 60¬∞</span>
                                <span class="club-status attention">‚ö†Ô∏è Aging</span>
                            </div>
                            <div class="club-menu-wrapper">
                                <button class="club-menu-btn" onclick="toggleClubMenu(this, 'wedges')">‚ãÆ</button>
                                <div class="club-menu-dropdown" id="club-menu-wedges">
                                    <button class="club-menu-item" onclick="editClub('wedges')">‚úèÔ∏è Edit</button>
                                    <button class="club-menu-item danger" onclick="deleteClub('wedges')">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="club-specs">
                            Titleist Vokey SM8 (2020)<br>
                            True Temper DG S200 ‚Ä¢ 130g
                        </div>
                        <div class="club-issue">Wedges 4+ years old ‚Äî groove wear affects spin</div>
                        <div class="club-suggestion">üí° Plan update within next season for optimal performance</div>
                        <div class="club-actions">
                            <button class="club-action-btn scenario" onclick="startScenarioForClub('wedges')">üîÑ Scenario</button>
                            <button class="club-action-btn test" onclick="startTestForClub('pw')">üìä Test</button>
                            <button class="club-action-btn shop pro-only">üõí Shop</button>
                        </div>
                    </div>

                    <button class="add-club-btn" onclick="openAddClubModal()">+ Add Another Club</button>
                </div>
                
                <!-- Grip Assessment Section - Bottom of Bag Tab -->
                <div class="grip-assessment" id="grip-assessment" style="margin-top: 20px;">
                    <div class="grip-assessment-header">
                        <h4>üß§ Grip Assessment</h4>
                        <span class="grip-status-badge warning" id="grip-status-badge">No Data</span>
                    </div>
                    <div class="grip-assessment-content">
                        <div class="grip-stat">
                            <div class="grip-stat-value" id="grip-clubs-count">--</div>
                            <div class="grip-stat-label">Total Clubs</div>
                        </div>
                        <div class="grip-stat">
                            <div class="grip-stat-value" id="grip-need-regrip">--</div>
                            <div class="grip-stat-label">Need Regrip</div>
                        </div>
                        <div class="grip-stat">
                            <div class="grip-stat-value" id="grip-data-count">--</div>
                            <div class="grip-stat-label">With Data</div>
                        </div>
                    </div>
                    <div class="grip-cost-row" id="grip-cost-row" style="display: none;">
                        <span class="grip-cost-label">üí∞ Regrip Cost Estimate</span>
                        <span class="grip-cost-value" id="grip-cost-value">$0 - $0</span>
                    </div>
                    <div class="grip-no-data" id="grip-no-data" style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 13px;">
                        Add grip condition details to each club for assessment and regrip recommendations.
                    </div>
                    <button class="grip-add-data-btn" onclick="alert('Grip editing coming soon!')">
                        + Add/Edit Grip Data
                    </button>
                </div>
            </div>

            <!-- Tab: Events -->
            <div id="tab-events" class="tab-content" style="display: none;">
                <div class="handicap-container">
                    
                    <!-- Golf Genius Connection Card (Pro Only) -->
                    <div class="ghin-card pro-only" id="gg-connection-card">
                        <div class="ghin-header">
                            <div class="ghin-title">
                                <span>‚õ≥</span> Golf Genius
                            </div>
                            <span class="ghin-status connected" id="gg-status">‚úì Connected</span>
                        </div>
                        
                        <div id="gg-connected-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light);">
                                <div>
                                    <div style="font-size: 14px; font-weight: 500;">Falmouth Country Club</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Last synced: Today 9:42 AM</div>
                                </div>
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px;" onclick="syncGolfGenius()">üîÑ Sync</button>
                            </div>
                            <div style="display: flex; gap: 16px; margin-top: 12px;">
                                <div style="text-align: center; flex: 1; padding: 10px; background: var(--bg-main); border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: 600; color: var(--cyan);">8</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Events</div>
                                </div>
                                <div style="text-align: center; flex: 1; padding: 10px; background: var(--bg-main); border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: 600; color: var(--green);">3</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Registered</div>
                                </div>
                                <div style="text-align: center; flex: 1; padding: 10px; background: var(--bg-main); border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: 600; color: var(--purple);">2</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Results</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="gg-disconnected-content" style="display: none;">
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 12px;">
                                Connect to Golf Genius to automatically import tournaments, leagues, and events from your club.
                            </div>
                            <button class="btn btn-primary" style="margin-top: 12px; width: 100%;" onclick="connectGolfGenius()">Connect Golf Genius</button>
                        </div>
                    </div>

                    <!-- Pro-only: Header -->
                    <div class="pro-only" style="margin: 20px 0;">
                        <div style="font-size: 16px; font-weight: 600;">üìÖ Club Events</div>
                    </div>

                    <!-- Client-only: Header -->
                    <div class="client-only" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600;">üìÖ Events & Tournaments</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Register for events, view results & leaderboards</div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 8px 14px; font-size: 12px;" onclick="openModal('add-event-modal')">+ Add Personal</button>
                        </div>
                    </div>

                    <!-- Event Tabs: Upcoming / Past / Results -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                        <button class="trend-period-btn active" id="events-upcoming-btn" onclick="showEventTab('upcoming')">Upcoming</button>
                        <button class="trend-period-btn" id="events-past-btn" onclick="showEventTab('past')">Past</button>
                        <button class="trend-period-btn" id="events-results-btn" onclick="showEventTab('results')">Results</button>
                    </div>

                    <!-- Upcoming Events -->
                    <div id="events-upcoming">
                        <!-- GG Imported: Tournament -->
                        <div class="ghin-card" style="border-left: 4px solid var(--green);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span style="font-size: 11px; background: var(--green-dim); color: var(--green); padding: 3px 8px; border-radius: 6px;">Tournament</span>
                                    <span style="font-size: 9px; background: rgba(255,180,0,0.2); color: var(--yellow); padding: 2px 6px; border-radius: 4px; font-weight: 600;">GG</span>
                                </div>
                                <span style="font-size: 12px; color: var(--text-muted);">Jan 25</span>
                            </div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 6px;">üèÜ Men's Winter Classic</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Individual stroke play, flighted by handicap. Top 3 in each flight win prizes.</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; color: var(--text-muted);">
                                    <span>üìç Blue Tees 8:00 AM</span>
                                    <span style="margin-left: 12px;">üë• 32/48</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 11px;" onclick="viewGGEvent()">View in GG</button>
                                    <span style="font-size: 11px; background: var(--green-dim); color: var(--green); padding: 6px 10px; border-radius: 6px;">‚úì Registered</span>
                                </div>
                            </div>
                        </div>

                        <!-- GG Imported: League -->
                        <div class="ghin-card" style="border-left: 4px solid var(--cyan);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span style="font-size: 11px; background: var(--cyan-dim); color: var(--cyan); padding: 3px 8px; border-radius: 6px;">League</span>
                                    <span style="font-size: 9px; background: rgba(255,180,0,0.2); color: var(--yellow); padding: 2px 6px; border-radius: 4px; font-weight: 600;">GG</span>
                                </div>
                                <span style="font-size: 12px; color: var(--text-muted);">Thursdays</span>
                            </div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 6px;">‚õ≥ Thursday Men's League</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Weekly 9-hole league. Modified Stableford scoring. Season runs Jan-Mar.</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; color: var(--text-muted);">
                                    <span>üìç Back 9 ‚Ä¢ 4:30 PM</span>
                                    <span style="margin-left: 12px;">üèÖ 3rd Place</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 11px;" onclick="viewLeaderboard()">Leaderboard</button>
                                </div>
                            </div>
                        </div>

                        <!-- GG Imported: Member Event -->
                        <div class="ghin-card" style="border-left: 4px solid var(--purple);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span style="font-size: 11px; background: var(--purple-dim); color: var(--purple); padding: 3px 8px; border-radius: 6px;">Member Event</span>
                                    <span style="font-size: 9px; background: rgba(255,180,0,0.2); color: var(--yellow); padding: 2px 6px; border-radius: 4px; font-weight: 600;">GG</span>
                                </div>
                                <span style="font-size: 12px; color: var(--text-muted);">Feb 8</span>
                            </div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 6px;">üéâ Super Bowl Scramble</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">4-person scramble before the big game. Lunch included. Prizes for top teams.</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; color: var(--text-muted);">
                                    <span>üìç Shotgun 9:00 AM</span>
                                    <span style="margin-left: 12px;">üí∞ $65</span>
                                </div>
                                <button class="btn btn-primary" style="padding: 6px 14px; font-size: 12px;" onclick="registerGGEvent()">Register</button>
                            </div>
                        </div>

                        <!-- Custom Event (not from GG) -->
                        <div class="ghin-card" style="border-left: 4px solid var(--yellow);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div>
                                    <span style="font-size: 11px; background: rgba(255, 180, 0, 0.15); color: var(--yellow); padding: 3px 8px; border-radius: 6px;">Demo Day</span>
                                </div>
                                <span style="font-size: 12px; color: var(--text-muted);">Feb 15</span>
                            </div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 6px;">üèåÔ∏è TaylorMade Fitting Day</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">TaylorMade reps on-site. Full bag fitting available. Great for hybrid options.</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; color: var(--text-muted);">
                                    <span>üìç Driving Range</span>
                                    <span style="margin-left: 12px;">üÜì Free</span>
                                </div>
                                <button class="btn btn-secondary" style="padding: 6px 14px; font-size: 12px;">Sign Up</button>
                            </div>
                        </div>
                    </div>

                    <!-- Past Events -->
                    <div id="events-past" style="display: none;">
                        <div class="ghin-card" style="opacity: 0.8; border-left: 4px solid var(--border-medium);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span style="font-size: 11px; background: rgba(255,255,255,0.1); color: var(--text-muted); padding: 3px 8px; border-radius: 6px;">Tournament</span>
                                    <span style="font-size: 9px; background: rgba(255,180,0,0.1); color: var(--yellow); padding: 2px 6px; border-radius: 4px; font-weight: 600; opacity: 0.7;">GG</span>
                                </div>
                                <span style="font-size: 12px; color: var(--text-muted);">Dec 14, 2024</span>
                            </div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 6px;">üéÑ Holiday Four-Ball</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Two-person best ball. You finished <strong style="color: var(--green);">2nd in Flight B</strong>.</div>
                            <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 11px;" onclick="viewGGResults()">View Results</button>
                        </div>

                        <div class="ghin-card" style="opacity: 0.8; border-left: 4px solid var(--border-medium);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span style="font-size: 11px; background: rgba(255,255,255,0.1); color: var(--text-muted); padding: 3px 8px; border-radius: 6px;">Member Event</span>
                                    <span style="font-size: 9px; background: rgba(255,180,0,0.1); color: var(--yellow); padding: 2px 6px; border-radius: 4px; font-weight: 600; opacity: 0.7;">GG</span>
                                </div>
                                <span style="font-size: 12px; color: var(--text-muted);">Nov 23, 2024</span>
                            </div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 6px;">ü¶É Turkey Shoot</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Individual Stableford. 38 points - <strong>won a turkey!</strong> üèÜ</div>
                            <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 11px;" onclick="viewGGResults()">View Results</button>
                        </div>

                        <div class="ghin-card" style="opacity: 0.8; border-left: 4px solid var(--border-medium);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div>
                                    <span style="font-size: 11px; background: rgba(255,255,255,0.1); color: var(--text-muted); padding: 3px 8px; border-radius: 6px;">Demo Day</span>
                                </div>
                                <span style="font-size: 12px; color: var(--text-muted);">Nov 16, 2024</span>
                            </div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 6px;">üèåÔ∏è Callaway Demo Day</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Tested Paradym irons and Ai Smoke driver.</div>
                        </div>
                    </div>

                    <!-- Results Tab -->
                    <div id="events-results" style="display: none;">
                        <div class="ghin-card">
                            <div style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">üèÜ Recent Tournament Results</div>
                            
                            <div style="border: 1px solid var(--border-light); border-radius: 10px; overflow: hidden;">
                                <div style="background: var(--bg-main); padding: 12px 16px; border-bottom: 1px solid var(--border-light);">
                                    <div style="font-size: 14px; font-weight: 600;">Holiday Four-Ball</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Dec 14, 2024 ‚Ä¢ Flight B</div>
                                </div>
                                <div style="padding: 0;">
                                    <div style="display: flex; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid var(--border-light); background: rgba(255,215,0,0.1);">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 14px;">ü•á</span>
                                            <span style="font-size: 13px;">Smith / Anderson</span>
                                        </div>
                                        <span style="font-size: 13px; font-weight: 600;">66</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid var(--border-light); background: rgba(192,192,192,0.1);">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 14px;">ü•à</span>
                                            <span style="font-size: 13px; color: var(--cyan); font-weight: 500;">Johnson / Roberts ‚Üê You</span>
                                        </div>
                                        <span style="font-size: 13px; font-weight: 600;">68</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 10px 16px; background: rgba(205,127,50,0.1);">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 14px;">ü•â</span>
                                            <span style="font-size: 13px;">Wilson / Thompson</span>
                                        </div>
                                        <span style="font-size: 13px; font-weight: 600;">69</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" style="width: 100%; margin-top: 16px;" onclick="viewGGEvent()">View Full Leaderboard in Golf Genius</button>
                        </div>

                        <div class="ghin-card">
                            <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">üìä League Standings</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">Thursday Men's League ‚Ä¢ Week 4 of 12</div>
                            
                            <div style="border: 1px solid var(--border-light); border-radius: 10px; overflow: hidden;">
                                <div style="display: flex; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid var(--border-light);">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-weight: 600; width: 20px;">1</span>
                                        <span style="font-size: 13px;">Tom Williams</span>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">156 pts</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid var(--border-light);">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-weight: 600; width: 20px;">2</span>
                                        <span style="font-size: 13px;">Dave Miller</span>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">148 pts</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px 16px; background: var(--cyan-dim);">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-weight: 600; width: 20px; color: var(--cyan);">3</span>
                                        <span style="font-size: 13px; color: var(--cyan); font-weight: 500;">Mike Johnson ‚Üê You</span>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600; color: var(--cyan);">142 pts</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pro Insights (Pro Only) -->
                    <div class="ghin-card pro-only" style="margin-top: 20px;">
                        <div class="ghin-title" style="margin-bottom: 12px;">
                            <span>üí°</span> Event Insights
                        </div>
                        <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                            <strong>Mike is active in club events</strong> - registered for 3 upcoming events and placed in 2 recent tournaments.
                            His league performance (3rd place) suggests his equipment improvements are translating to competitive play.
                            Good candidate for a fitting session before the Winter Classic.
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab: Scenarios -->

            <!-- ==========================================
                 SCENARIOS TAB - Simple Swap & Regrade
                 ========================================== -->
            <div id="tab-scenarios" class="tab-content" style="display: none;">
                <!-- Header -->
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">
                        What-if equipment changes <span class="patent-tag">Patent Pending</span>
                    </div>
                    <div class="info-box" style="background: var(--cyan-dim); border-color: var(--cyan); color: var(--cyan);">
                        üí° <strong>Scenario Mode:</strong> Swap up to 7 clubs, then run ONE full analysis for 1 credit. 
                        Changes are temporary - your real bag stays untouched.
                    </div>
                </div>

                <!-- Swap Summary (shows when swaps pending) -->
                <div id="scenario-swap-summary" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--green-dim); border-radius: 10px; border: 1px solid rgba(0,200,100,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: var(--green); font-weight: 600;" id="swap-count">0</span>
                            <span style="color: var(--text-secondary);"> club(s) swapped</span>
                        </div>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="clearAllSwaps()">Clear All</button>
                    </div>
                </div>

                <!-- Club List -->
                <div id="scenario-club-list">
                    <!-- Populated by renderScenarioClubList() -->
                </div>

                <!-- Run Button -->
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="run-scenario-btn" onclick="runScenarioAnalysis()" disabled style="width: 100%;">
                        Run Scenario Analysis (1 credit)
                    </button>
                </div>

                <!-- Results Section (hidden until run) -->
                <div id="scenario-results-section" style="display: none; margin-top: 24px;">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 16px; text-align: center;">‚ú® Scenario Results</div>
                    
                    <!-- Grade Comparison -->
                    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--text-secondary);" id="scenario-current-grade">B+</div>
                            <div style="font-size: 11px; color: var(--text-muted);">CURRENT</div>
                        </div>
                        <div style="font-size: 24px; color: var(--text-muted);">‚Üí</div>
                        <div style="text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--green);" id="scenario-projected-grade">A-</div>
                            <div style="font-size: 11px; color: var(--text-muted);">PROJECTED</div>
                        </div>
                    </div>

                    <!-- Score Change -->
                    <div id="scenario-score-change" style="text-align: center; padding: 12px; background: var(--green-dim); border-radius: 10px; margin-bottom: 16px;">
                        üéâ +8 points improvement
                    </div>

                    <!-- Full AI Analysis -->
                    <div class="scenario-card" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">ü§ñ AI ANALYSIS</div>
                        <div id="scenario-ai-analysis" style="font-size: 13px; line-height: 1.6; color: var(--text-secondary);">
                            <!-- Full analysis from API -->
                        </div>
                    </div>

                    <!-- Factor Breakdown -->
                    <div class="scenario-card" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">FACTOR CHANGES</div>
                        <div id="scenario-factor-changes">
                            <!-- Populated by displayScenarioResults() -->
                        </div>
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="applyScenarioToBag()" style="flex: 1;">‚úÖ Apply to Bag</button>
                        <button class="btn btn-secondary" onclick="resetScenario()" style="flex: 1;">üîÑ New Scenario</button>
                    </div>
                </div>
            </div>

            <!-- Head Picker Screen -->
            <div class="picker-screen" id="head-picker-screen">
                <div class="picker-header">
                    <button class="picker-back" onclick="closeHeadPicker()">‚Üê</button>
                    <span class="picker-title">Select Club Head</span>
                </div>
                <div class="picker-content">
                    <div class="picker-filters">
                        <button class="picker-filter active" onclick="filterHeads('woods')">Woods</button>
                        <button class="picker-filter" onclick="filterHeads('hybrids')">Hybrids</button>
                        <button class="picker-filter" onclick="filterHeads('irons')">Irons</button>
                        <button class="picker-filter" onclick="filterHeads('wedges')">Wedges</button>
                    </div>

                    <div class="info-box" style="margin-bottom: 16px;">
                        Showing Woods from major manufacturers
                    </div>

                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase;">2024-2025 Models</div>

                    <div class="picker-card" onclick="selectHead('TaylorMade Stealth 2 Plus', '15¬∞', 'Fujikura Ventus Blue 75g')">
                        <div class="picker-card-badge">AI RECOMMENDED</div>
                        <div class="picker-card-name">TaylorMade Stealth 2 Plus</div>
                        <div class="picker-card-specs">15¬∞ ‚Ä¢ Carbonwood Face ‚Ä¢ Speed Pocket<br>Stock: Fujikura Ventus Blue 75g ‚Ä¢ Stiff</div>
                    </div>

                    <div class="picker-card" onclick="selectHead('Callaway Paradym Ai Smoke', '15¬∞', 'Project X HZRDUS Black 70g')">
                        <div class="picker-card-name">Callaway Paradym Ai Smoke</div>
                        <div class="picker-card-specs">15¬∞ ‚Ä¢ Ai Smart Face ‚Ä¢ Jailbreak<br>Stock: Project X HZRDUS Black 70g ‚Ä¢ Stiff</div>
                    </div>

                    <div class="picker-card" onclick="selectHead('Titleist GT2', '15¬∞', 'Project X HZRDUS Black 65g')">
                        <div class="picker-card-name">Titleist GT2</div>
                        <div class="picker-card-specs">15¬∞ ‚Ä¢ Speed Ring VFT Face<br>Stock: Project X HZRDUS Black 65g ‚Ä¢ Stiff</div>
                    </div>

                    <div class="picker-card" onclick="selectHead('PING G430 Max', '15¬∞', 'PING Alta CB Black 65g')">
                        <div class="picker-card-name">PING G430 Max</div>
                        <div class="picker-card-specs">15¬∞ ‚Ä¢ Carbonfly Wrap ‚Ä¢ Facewrap<br>Stock: PING Alta CB Black 65g ‚Ä¢ Stiff</div>
                    </div>

                    <div class="picker-card" onclick="selectHead('Cobra Darkspeed LS', '15¬∞', 'UST Mamiya Helium 5F')">
                        <div class="picker-card-name">Cobra Darkspeed LS</div>
                        <div class="picker-card-specs">15¬∞ ‚Ä¢ HOT Face Technology<br>Stock: UST Mamiya Helium 5F ‚Ä¢ Stiff</div>
                    </div>
                </div>
            </div>

            <!-- Shaft Picker Screen -->
            <div class="picker-screen" id="shaft-picker-screen">
                <div class="picker-header">
                    <button class="picker-back" onclick="closeShaftPicker()">‚Üê</button>
                    <span class="picker-title">Select Aftermarket Shaft</span>
                </div>
                <div class="picker-content">
                    <div class="picker-filters">
                        <button class="picker-filter active" onclick="filterShafts('all')">All</button>
                        <button class="picker-filter" onclick="filterShafts('60-70g')">60-70g</button>
                        <button class="picker-filter" onclick="filterShafts('70-80g')">70-80g</button>
                        <button class="picker-filter" onclick="filterShafts('80g+')">80g+</button>
                    </div>

                    <div class="info-box" style="margin-bottom: 16px;">
                        Showing shafts compatible with selected club head
                    </div>

                    <div class="picker-card" onclick="selectShaft('Fujikura Ventus Blue 7S', '73g', 'Mid', '3.5¬∞')">
                        <div class="picker-card-badge">BEST MATCH</div>
                        <div class="picker-card-name">Fujikura Ventus Blue 7S</div>
                        <div class="picker-card-specs">73g ‚Ä¢ Mid Kickpoint ‚Ä¢ 3.5¬∞ Torque ‚Ä¢ Stiff</div>
                    </div>

                    <div class="picker-card" onclick="selectShaft('Project X HZRDUS Smoke Black', '70g', 'Low-Mid', '3.2¬∞')">
                        <div class="picker-card-name">Project X HZRDUS Smoke Black</div>
                        <div class="picker-card-specs">70g ‚Ä¢ Low-Mid Kickpoint ‚Ä¢ 3.2¬∞ Torque ‚Ä¢ Stiff</div>
                    </div>

                    <div class="picker-card" onclick="selectShaft('Graphite Design Tour AD DI', '75g', 'Mid', '3.4¬∞')">
                        <div class="picker-card-name">Graphite Design Tour AD DI</div>
                        <div class="picker-card-specs">75g ‚Ä¢ Mid Kickpoint ‚Ä¢ 3.4¬∞ Torque ‚Ä¢ Stiff</div>
                    </div>

                    <div class="picker-card" onclick="selectShaft('Mitsubishi Kai\'li White', '65g', 'Mid-High', '4.0¬∞')">
                        <div class="picker-card-name">Mitsubishi Kai'li White</div>
                        <div class="picker-card-specs">65g ‚Ä¢ Mid-High Kickpoint ‚Ä¢ 4.0¬∞ Torque ‚Ä¢ Stiff</div>
                    </div>

                    <div class="picker-card" onclick="selectShaft('Aldila Rogue Silver', '70g', 'Mid', '3.6¬∞')">
                        <div class="picker-card-name">Aldila Rogue Silver</div>
                        <div class="picker-card-specs">70g ‚Ä¢ Mid Kickpoint ‚Ä¢ 3.6¬∞ Torque ‚Ä¢ Stiff</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Testing (placeholder) -->
            <!-- Tab: Performance Testing -->
            <div id="tab-testing" class="tab-content" style="display: none;">
                <!-- Saved Tests Banner Cards -->
                <div id="testing-banner-cards" class="banner-cards-container">
                    <!-- Populated by TestingTab.js -->
                </div>
                
                <div class="perf-test-container">
                    
                    <!-- Test Progress - 5 Steps -->
                    <div class="scenario-progress">
                        <div class="progress-step active" id="test-progress-1"></div>
                        <div class="progress-step" id="test-progress-2"></div>
                        <div class="progress-step" id="test-progress-3"></div>
                        <div class="progress-step" id="test-progress-4"></div>
                        <div class="progress-step" id="test-progress-5"></div>
                    </div>

                    <!-- Step 1: Select Your Club -->
                    <div class="scenario-step active" id="test-step-1">
                        <div class="perf-test-header">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div class="perf-test-title">üìä Performance Test</div>
                            </div>
                            <div class="perf-test-subtitle">Step 1: Select YOUR club from your bag</div>
                        </div>
                        
                        <div id="test-club-select-grid" class="club-select-grid">
                            <!-- Populated by TestingTab.js -->
                        </div>

                        <div class="scenario-nav">
                            <button class="btn btn-secondary" onclick="cancelPerfTest()">Cancel</button>
                            <button class="btn btn-primary" id="test-step1-next" onclick="goToTestStep(2)" disabled>Next ‚Üí</button>
                        </div>
                    </div>

                    <!-- Step 2: Select Comparison Club -->
                    <div class="scenario-step" id="test-step-2">
                        <div class="perf-test-header">
                            <div class="perf-test-title">Select Comparison Club</div>
                            <div class="perf-test-subtitle">Step 2: What club are you testing against?</div>
                        </div>

                        <!-- Your Club Reminder -->
                        <div class="test-club-selector" style="margin-bottom: 16px;">
                            <div class="test-club-current" style="background: var(--cyan-dim); border: 1px solid var(--cyan);">
                                <div class="test-club-icon">üèåÔ∏è</div>
                                <div class="test-club-info">
                                    <div style="font-size: 10px; text-transform: uppercase; color: var(--cyan); margin-bottom: 2px;">Your Club (A)</div>
                                    <h3 id="step2-your-club">Driver</h3>
                                    <p id="step2-your-specs">TaylorMade Stealth 2 ‚Ä¢ 10.5¬∞</p>
                                </div>
                            </div>
                        </div>

                        <div class="info-box" style="margin-bottom: 16px;">
                            Enter the club you're comparing against. This could be a demo club, rental, friend's club, or a club you're considering buying.
                        </div>

                        <!-- Comparison Club Preview - ABOVE selector -->
                        <div id="compare-preview" style="display: none; margin-bottom: 16px;">
                            <div class="test-club-selector">
                                <div class="test-club-current" style="background: var(--green-dim); border: 1px solid var(--green);">
                                    <div class="test-club-icon">üèåÔ∏è</div>
                                    <div class="test-club-info">
                                        <div style="font-size: 10px; text-transform: uppercase; color: var(--green); margin-bottom: 2px;">Test Club (B)</div>
                                        <h3 id="compare-preview-name">TaylorMade Qi10</h3>
                                        <p id="compare-preview-specs">Stock Shaft</p>
                                    </div>
                                    <button class="btn btn-ghost" style="margin-left: auto; padding: 4px 8px; font-size: 11px;" onclick="TestingTab.clearComparisonClub()">‚úï Clear</button>
                                </div>
                            </div>
                        </div>

                        <!-- Comparison Club Entry - ClubSelector Integration -->
                        <div class="scenario-card" style="background: var(--bg-main); border: 1px solid var(--border-light); border-radius: 12px; padding: 16px;">
                            <div style="font-size: 10px; text-transform: uppercase; color: var(--green); margin-bottom: 12px; font-weight: 600;">Test Club (B)</div>
                            
                            <button class="btn btn-secondary" style="width: 100%; padding: 16px; font-size: 14px;" onclick="TestingTab.openComparisonSelector()">
                                <span style="margin-right: 8px;">üîç</span> Select Club from Database
                            </button>
                            
                            <!-- Collapsible Manual Entry -->
                            <div style="text-align: center; margin: 12px 0;">
                                <button class="btn btn-ghost" style="font-size: 12px; color: var(--text-muted);" onclick="toggleManualEntry(this)">
                                    ‚ñº Enter manually instead
                                </button>
                            </div>
                            
                            <div id="manual-entry-fields" style="display: none;">
                                <div class="data-input-group" style="margin-bottom: 12px;">
                                    <div class="data-input-label">Brand *</div>
                                    <input type="text" class="data-input" id="compare-brand-manual" placeholder="e.g., TaylorMade" oninput="TestingTab.updateManualCompare()">
                                </div>
                                
                                <div class="data-input-group" style="margin-bottom: 12px;">
                                    <div class="data-input-label">Model *</div>
                                    <input type="text" class="data-input" id="compare-model-manual" placeholder="e.g., Qi10 Max" oninput="TestingTab.updateManualCompare()">
                                </div>
                                
                                <div class="data-input-group" style="margin-bottom: 12px;">
                                    <div class="data-input-label">
                                        <span>Shaft</span>
                                        <span class="unit-hint">optional</span>
                                    </div>
                                    <input type="text" class="data-input" id="compare-shaft-manual" placeholder="e.g., Fujikura Ventus Blue 6S" oninput="TestingTab.updateManualCompare()">
                                </div>
                            </div>
                        </div>

                        <div class="scenario-nav" style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="goToTestStep(1)">‚Üê Back</button>
                            <button class="btn btn-primary" id="test-step2-next" onclick="goToTestStep(3)" disabled>Continue ‚Üí</button>
                        </div>
                    </div>

                    <!-- Step 3: Capture/Enter Data -->
                    <div class="scenario-step" id="test-step-3">
                        <div class="perf-test-header">
                            <div class="perf-test-title">Capture Shot Data</div>
                            <div class="perf-test-subtitle">Step 3: Enter data for BOTH clubs from your launch monitor</div>
                        </div>

                        <!-- Both Clubs Summary -->
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <div style="flex: 1; background: var(--cyan-dim); border: 1px solid var(--cyan); border-radius: 10px; padding: 12px;">
                                <div style="font-size: 10px; text-transform: uppercase; color: var(--cyan); margin-bottom: 4px;">Your Club (A)</div>
                                <div style="font-weight: 600;" id="step3-your-club">Driver</div>
                                <div style="font-size: 12px; color: var(--text-muted);" id="step3-your-specs">TaylorMade Stealth 2</div>
                            </div>
                            <div style="flex: 1; background: var(--green-dim); border: 1px solid var(--green); border-radius: 10px; padding: 12px;">
                                <div style="font-size: 10px; text-transform: uppercase; color: var(--green); margin-bottom: 4px;">Test Club (B)</div>
                                <div style="font-weight: 600;" id="step3-compare-club">TaylorMade Qi10</div>
                                <div style="font-size: 12px; color: var(--text-muted);" id="step3-compare-specs">Stock Shaft</div>
                            </div>
                        </div>

                        <!-- Club A Data Entry -->
                        <div style="background: var(--bg-main); border: 1px solid var(--cyan); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="background: var(--cyan); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">A</span>
                                <span style="font-weight: 600;">Your Club Data</span>
                            </div>
                            
                            <div class="photo-capture-area" onclick="addTestPhotoA()" id="photo-capture-zone-a" style="padding: 16px;">
                                <div class="photo-capture-icon" style="font-size: 24px;">üì∏</div>
                                <div class="photo-capture-text" style="font-size: 13px;">Capture YOUR club's data</div>
                            </div>
                            
                            <div id="club-a-data" style="display: none; margin-top: 12px;">
                                <!-- Required Fields -->
                                <div style="font-size: 10px; color: var(--cyan); margin-bottom: 6px; text-transform: uppercase;">Required</div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Ball Speed <span style="color: var(--text-muted);">(mph)</span></div>
                                        <input type="number" class="data-input" id="perf-ball-speed-a" placeholder="165" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Carry <span style="color: var(--text-muted);">(yds)</span></div>
                                        <input type="number" class="data-input" id="perf-carry-a" placeholder="275" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                </div>
                                
                                <!-- Optional Fields -->
                                <div style="font-size: 10px; color: var(--text-muted); margin: 8px 0 6px 0; text-transform: uppercase;">Optional (enhances analysis)</div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Launch <span style="color: var(--text-muted);">(¬∞)</span></div>
                                        <input type="number" class="data-input" id="perf-launch-a" placeholder="12.5" step="0.1" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Spin <span style="color: var(--text-muted);">(rpm)</span></div>
                                        <input type="number" class="data-input" id="perf-spin-a" placeholder="2400" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Club Speed <span style="color: var(--text-muted);">(mph)</span></div>
                                        <input type="number" class="data-input" id="perf-club-speed-a" placeholder="105" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Total Dist <span style="color: var(--text-muted);">(yds)</span></div>
                                        <input type="number" class="data-input" id="perf-total-a" placeholder="290" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Attack Angle <span style="color: var(--text-muted);">(¬∞)</span></div>
                                        <input type="number" class="data-input" id="perf-attack-a" placeholder="-2.5" step="0.1" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Smash Factor</div>
                                        <input type="number" class="data-input" id="perf-smash-a" placeholder="1.48" step="0.01" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Club Path <span style="color: var(--text-muted);">(¬∞)</span></div>
                                        <input type="number" class="data-input" id="perf-path-a" placeholder="2.1" step="0.1" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Face Angle <span style="color: var(--text-muted);">(¬∞)</span></div>
                                        <input type="number" class="data-input" id="perf-face-a" placeholder="1.2" step="0.1" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Height/Apex <span style="color: var(--text-muted);">(ft)</span></div>
                                        <input type="number" class="data-input" id="perf-height-a" placeholder="95" style="padding: 8px;" oninput="updatePerfDataA()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <!-- Placeholder for future OCR fields -->
                                    </div>
                                </div>
                            </div>
                            <button class="btn-skip" onclick="showClubAManualEntry()" style="font-size: 12px;">Enter manually ‚Üí</button>
                        </div>

                        <!-- Club B Data Entry -->
                        <div style="background: var(--bg-main); border: 1px solid var(--green); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="background: var(--green); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">B</span>
                                <span style="font-weight: 600;">Test Club Data</span>
                            </div>
                            
                            <div class="photo-capture-area" onclick="addTestPhotoB()" id="photo-capture-zone-b" style="padding: 16px;">
                                <div class="photo-capture-icon" style="font-size: 24px;">üì∏</div>
                                <div class="photo-capture-text" style="font-size: 13px;">Capture TEST club's data</div>
                            </div>
                            
                            <div id="club-b-data" style="display: none; margin-top: 12px;">
                                <!-- Required Fields -->
                                <div style="font-size: 10px; color: var(--green); margin-bottom: 6px; text-transform: uppercase;">Required</div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Ball Speed <span style="color: var(--text-muted);">(mph)</span></div>
                                        <input type="number" class="data-input" id="perf-ball-speed-b" placeholder="168" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Carry <span style="color: var(--text-muted);">(yds)</span></div>
                                        <input type="number" class="data-input" id="perf-carry-b" placeholder="280" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                </div>
                                
                                <!-- Optional Fields -->
                                <div style="font-size: 10px; color: var(--text-muted); margin: 8px 0 6px 0; text-transform: uppercase;">Optional (enhances analysis)</div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Launch <span style="color: var(--text-muted);">(¬∞)</span></div>
                                        <input type="number" class="data-input" id="perf-launch-b" placeholder="13.2" step="0.1" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Spin <span style="color: var(--text-muted);">(rpm)</span></div>
                                        <input type="number" class="data-input" id="perf-spin-b" placeholder="2200" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Club Speed <span style="color: var(--text-muted);">(mph)</span></div>
                                        <input type="number" class="data-input" id="perf-club-speed-b" placeholder="107" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Total Dist <span style="color: var(--text-muted);">(yds)</span></div>
                                        <input type="number" class="data-input" id="perf-total-b" placeholder="295" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Attack Angle <span style="color: var(--text-muted);">(¬∞)</span></div>
                                        <input type="number" class="data-input" id="perf-attack-b" placeholder="-1.8" step="0.1" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Smash Factor</div>
                                        <input type="number" class="data-input" id="perf-smash-b" placeholder="1.50" step="0.01" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Club Path <span style="color: var(--text-muted);">(¬∞)</span></div>
                                        <input type="number" class="data-input" id="perf-path-b" placeholder="1.8" step="0.1" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Face Angle <span style="color: var(--text-muted);">(¬∞)</span></div>
                                        <input type="number" class="data-input" id="perf-face-b" placeholder="0.8" step="0.1" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <div class="data-input-label" style="font-size: 11px;">Height/Apex <span style="color: var(--text-muted);">(ft)</span></div>
                                        <input type="number" class="data-input" id="perf-height-b" placeholder="98" style="padding: 8px;" oninput="updatePerfDataB()">
                                    </div>
                                    <div class="data-input-group" style="flex: 1; margin-bottom: 8px;">
                                        <!-- Placeholder for future OCR fields -->
                                    </div>
                                </div>
                            </div>
                            <button class="btn-skip" onclick="showClubBManualEntry()" style="font-size: 12px;">Enter manually ‚Üí</button>
                        </div>

                        <button class="btn btn-primary" id="data-continue-btn" onclick="goToTestStep(4)" disabled style="opacity: 0.5;">Continue to Goals</button>

                        <div class="scenario-nav" style="margin-top: 16px;">
                            <button class="btn btn-secondary" onclick="goToTestStep(2)">‚Üê Back</button>
                        </div>
                    </div>

                    <!-- Step 4: Set Goals -->
                    <div class="scenario-step" id="test-step-4">
                        <div class="perf-test-header">
                            <div class="perf-test-title">What are you working on?</div>
                            <div class="perf-test-subtitle">Step 4: Select your goals (optional)</div>
                        </div>

                        <div class="goals-section">
                            <div class="goal-chips">
                                <div class="goal-chip" onclick="toggleGoal(this)">üéØ More distance</div>
                                <div class="goal-chip" onclick="toggleGoal(this)">üìè Better accuracy</div>
                                <div class="goal-chip" onclick="toggleGoal(this)">üîÑ Reduce slice</div>
                                <div class="goal-chip" onclick="toggleGoal(this)">‚Ü©Ô∏è Reduce hook</div>
                                <div class="goal-chip" onclick="toggleGoal(this)">‚¨ÜÔ∏è Higher ball flight</div>
                                <div class="goal-chip" onclick="toggleGoal(this)">‚¨áÔ∏è Lower ball flight</div>
                                <div class="goal-chip" onclick="toggleGoal(this)">üéöÔ∏è More consistency</div>
                                <div class="goal-chip" onclick="toggleGoal(this)">üí® Less spin</div>
                            </div>
                        </div>

                        <div style="text-align: center; padding: 16px; background: var(--cyan-dim); border-radius: 10px; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 4px;">Running this test costs</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--cyan);">‚ö° 1 Credit</div>
                        </div>

                        <div class="scenario-nav">
                            <button class="btn btn-secondary" onclick="goToTestStep(3)">‚Üê Back</button>
                            <button class="btn btn-primary" onclick="runPerfTest()">üìä Run Comparison</button>
                        </div>
                    </div>

                    <!-- Step 5: Comparison Results -->
                    <div class="scenario-step" id="test-step-5">
                        <div class="perf-test-header">
                            <div class="perf-test-title">üìä Comparison Results</div>
                            <div class="perf-test-subtitle" id="results-subtitle">Driver Test ‚Ä¢ Dec 27, 2024</div>
                        </div>

                        <!-- Winner Summary -->
                        <div class="test-results">
                            <div class="test-result-summary" id="winner-summary" style="background: var(--green-dim); border: 1px solid var(--green);">
                                <div class="test-result-icon" id="winner-icon">üèÜ</div>
                                <div class="test-result-title" id="winner-title" style="color: var(--green);">Test Club (B) Wins!</div>
                                <div class="test-result-subtitle" id="winner-subtitle">TaylorMade Qi10 outperforms your current driver</div>
                            </div>
                        </div>

                        <!-- Side by Side Comparison -->
                        <div style="margin: 20px 0;">
                            <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Head-to-Head Comparison</div>
                            
                            <!-- Comparison Headers -->
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <div style="flex: 1; font-size: 11px; text-transform: uppercase; color: var(--text-muted);">Metric</div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 11px; text-transform: uppercase; color: var(--cyan);">Your Club (A)</div>
                                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;" id="header-club-a-name">--</div>
                                </div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 11px; text-transform: uppercase; color: var(--green);">Test Club (B)</div>
                                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;" id="header-club-b-name">--</div>
                                </div>
                            </div>
                            
                            <!-- Dynamic Comparison Rows -->
                            <div id="comparison-rows">
                                <!-- Ball Speed Row -->
                                <div class="comparison-row" id="row-ballSpeed" style="display: flex; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Ball Speed</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-ballSpeed-a">-- mph</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-ballSpeed-b">-- mph</div>
                                </div>
                                
                                <!-- Carry Row -->
                                <div class="comparison-row" id="row-carry" style="display: flex; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Carry Distance</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-carry-a">-- yds</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-carry-b">-- yds</div>
                                </div>
                                
                                <!-- Launch Row (optional) -->
                                <div class="comparison-row" id="row-launch" style="display: none; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Launch Angle</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-launch-a">--¬∞</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-launch-b">--¬∞</div>
                                </div>
                                
                                <!-- Spin Row (optional) -->
                                <div class="comparison-row" id="row-spin" style="display: none; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Spin Rate</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-spin-a">-- rpm</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-spin-b">-- rpm</div>
                                </div>
                                
                                <!-- Club Speed Row (optional) -->
                                <div class="comparison-row" id="row-clubSpeed" style="display: none; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Club Speed</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-clubSpeed-a">-- mph</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-clubSpeed-b">-- mph</div>
                                </div>
                                
                                <!-- Total Distance Row (optional) -->
                                <div class="comparison-row" id="row-total" style="display: none; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Total Distance</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-total-a">-- yds</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-total-b">-- yds</div>
                                </div>
                                
                                <!-- Smash Factor Row (optional) -->
                                <div class="comparison-row" id="row-smash" style="display: none; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Smash Factor</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-smash-a">--</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-smash-b">--</div>
                                </div>
                                
                                <!-- Attack Angle Row (optional) -->
                                <div class="comparison-row" id="row-attack" style="display: none; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Attack Angle</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-attack-a">--¬∞</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-attack-b">--¬∞</div>
                                </div>
                                
                                <!-- Club Path Row (optional) -->
                                <div class="comparison-row" id="row-path" style="display: none; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Club Path</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-path-a">--¬∞</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-path-b">--¬∞</div>
                                </div>
                                
                                <!-- Face Angle Row (optional) -->
                                <div class="comparison-row" id="row-face" style="display: none; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border-light);">
                                    <div style="flex: 1; color: var(--text-muted);">Face Angle</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-face-a">--¬∞</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-face-b">--¬∞</div>
                                </div>
                                
                                <!-- Height/Apex Row (optional) -->
                                <div class="comparison-row" id="row-height" style="display: none; gap: 8px; padding: 10px 0;">
                                    <div style="flex: 1; color: var(--text-muted);">Height/Apex</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-height-a">-- ft</div>
                                    <div style="flex: 1; text-align: center; font-weight: 600;" id="result-height-b">-- ft</div>
                                </div>
                            </div>
                        </div>

                        <!-- Net Gains Summary -->
                        <div id="net-gains-section" style="background: var(--green-dim); border-radius: 10px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-size: 12px; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;" id="net-gains-label">Net Gains with Test Club (B)</div>
                            <div id="net-gains-content" style="display: flex; justify-content: space-around; text-align: center;">
                                <div>
                                    <div style="font-size: 24px; font-weight: 700;" id="net-carry">+0</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">yards carry</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: 700;" id="net-ballspeed">+0</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">mph ball speed</div>
                                </div>
                                <div id="net-spin-container">
                                    <div style="font-size: 24px; font-weight: 700;" id="net-spin">0</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">rpm spin</div>
                                </div>
                            </div>
                        </div>

                        <div class="test-ai-analysis">
                            <div class="test-ai-header">
                                <span>ü§ñ</span> AI Analysis <span class="patent-tag">Patent Pending</span>
                            </div>
                            <div class="test-ai-text" id="ai-analysis-text">
                                Loading analysis...
                            </div>
                        </div>

                        <div class="perf-test-actions" style="margin-top: 20px;">
                            <button class="scenario-action-btn" onclick="saveTest()">
                                üíæ Save Test
                            </button>
                            <button class="scenario-action-btn" onclick="showScenarioTeaser()" id="add-to-scenario-btn">
                                üìã Add to Scenario <span style="font-size: 10px; color: var(--green);">FREE Preview</span>
                            </button>
                            <button class="scenario-action-btn" onclick="applyTestClubToBag()">
                                üîÑ Replace My Club with Test Club
                            </button>
                            <button class="scenario-action-btn pro-only" onclick="shopForTestClub()">
                                üõí Shop for Test Club
                            </button>
                            <button class="scenario-action-btn" onclick="runAnotherTest()">
                                üìä Test Another <span class="credit-cost">‚ö° 1</span>
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab: Progress -->
            <div id="tab-progress" class="tab-content" style="display: none;">
                <div class="handicap-container">
                    
                    <!-- GHIN Connection Card -->
                    <div class="ghin-card">
                        <div class="ghin-header">
                            <div class="ghin-title">
                                <span>‚õ≥</span> GHIN Connection
                            </div>
                            <span class="ghin-status connected" id="ghin-status">‚úì Connected</span>
                        </div>
                        
                        <div class="ghin-input-row">
                            <input type="text" class="ghin-input" id="ghin-number" placeholder="Enter GHIN Number" value="1234567" maxlength="7">
                            <button class="btn-sync" id="ghin-sync-btn" onclick="syncGHIN()">
                                <span id="sync-btn-text">üîÑ Sync</span>
                            </button>
                        </div>
                        
                        <div class="ghin-last-sync" id="ghin-last-sync">
                            Last synced: Today at 9:42 AM
                        </div>
                    </div>

                    <!-- Handicap Display -->
                    <div class="handicap-display" id="handicap-display">
                        <div class="handicap-label">Current Handicap Index</div>
                        <div class="handicap-value" id="handicap-value">10.4</div>
                        <div class="handicap-trend improving" id="handicap-trend">
                            <span>‚Üì</span> Improved 0.8 in last 30 days
                        </div>
                    </div>

                    <!-- Unified Progress Chart -->
                    <div class="trend-card">
                        <div class="trend-header">
                            <div class="trend-title">üìà Progress Timeline</div>
                            <div class="trend-period">
                                <button class="trend-period-btn" onclick="setTrendPeriod('3m')">3M</button>
                                <button class="trend-period-btn active" onclick="setTrendPeriod('6m')">6M</button>
                                <button class="trend-period-btn" onclick="setTrendPeriod('1y')">1Y</button>
                            </div>
                        </div>
                        
                        <div class="trend-chart">
                            <div class="chart-y-labels">
                                <span>8</span>
                                <span>10</span>
                                <span>12</span>
                            </div>
                            <div class="chart-line">
                                <svg class="chart-svg" viewBox="0 0 300 100" preserveAspectRatio="none">
                                    <defs>
                                        <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:var(--cyan);stop-opacity:0.4" />
                                            <stop offset="100%" style="stop-color:var(--cyan);stop-opacity:0" />
                                        </linearGradient>
                                    </defs>
                                    <!-- Area fill -->
                                    <path class="chart-area" d="M0,60 L50,55 L100,70 L150,50 L200,45 L250,35 L300,40 L300,100 L0,100 Z" />
                                    <!-- Line -->
                                    <path class="chart-path" d="M0,60 L50,55 L100,70 L150,50 L200,45 L250,35 L300,40" />
                                    <!-- Round data points (cyan) -->
                                    <circle cx="0" cy="60" r="5" fill="var(--cyan)" />
                                    <circle cx="50" cy="55" r="5" fill="var(--cyan)" />
                                    <circle cx="100" cy="70" r="5" fill="var(--cyan)" />
                                    <circle cx="150" cy="50" r="5" fill="var(--cyan)" />
                                    <circle cx="200" cy="45" r="5" fill="var(--cyan)" />
                                    <circle cx="250" cy="35" r="5" fill="var(--cyan)" />
                                    <circle cx="300" cy="40" r="5" fill="var(--cyan)" />
                                    <!-- Lesson markers (purple diamonds) -->
                                    <polygon points="75,52 80,47 85,52 80,57" fill="var(--purple)" />
                                    <polygon points="175,45 180,40 185,45 180,50" fill="var(--purple)" />
                                    <polygon points="275,33 280,28 285,33 280,38" fill="var(--purple)" />
                                    <!-- Equipment change markers (green squares) -->
                                    <rect x="222" y="40" width="8" height="8" fill="var(--green)" rx="2" />
                                </svg>
                            </div>
                            <div class="chart-labels">
                                <span>Jul</span>
                                <span>Aug</span>
                                <span>Sep</span>
                                <span>Oct</span>
                                <span>Nov</span>
                                <span>Dec</span>
                            </div>
                        </div>
                        
                        <!-- Chart Legend -->
                        <div class="chart-legend">
                            <div class="legend-item">
                                <span class="legend-dot rounds"></span>
                                <span>Rounds</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot lessons" style="border-radius: 2px; transform: rotate(45deg);"></span>
                                <span>Lessons</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot equipment" style="border-radius: 2px;"></span>
                                <span>Equipment</span>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible: Lessons History -->
                    <!-- Collapsible: Bag Changes -->
                    <div class="collapsible-section" id="bag-changes-section">
                        <div class="collapsible-header" onclick="toggleCollapsible('bag-changes-section')">
                            <div class="collapsible-title">
                                <span>üèåÔ∏è</span> Bag Changes
                                <span class="collapsible-count">(2 changes)</span>
                            </div>
                            <span class="collapsible-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="bag-change-item">
                                <div class="bag-change-icon upgrade">üîÑ</div>
                                <div class="bag-change-info">
                                    <div class="bag-change-title">3-Wood Shaft Upgrade</div>
                                    <div class="bag-change-detail">Nov 15 ‚Ä¢ Stock Aldila 90g ‚Üí Fujikura Ventus Blue 73g</div>
                                </div>
                                <div class="bag-change-grade">
                                    <div class="grade-change positive">B- ‚Üí B+</div>
                                </div>
                            </div>
                            <div class="bag-change-item">
                                <div class="bag-change-icon added">‚ûï</div>
                                <div class="bag-change-info">
                                    <div class="bag-change-title">Added 60¬∞ Lob Wedge</div>
                                    <div class="bag-change-detail">Sep 3 ‚Ä¢ Titleist Vokey SM9 60¬∞</div>
                                </div>
                                <div class="bag-change-grade">
                                    <div class="grade-change positive">Improved gapping</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible: Lessons History -->
                    <div class="collapsible-section" id="lessons-section">
                        <div class="collapsible-header" onclick="toggleCollapsible('lessons-section')">
                            <div class="collapsible-title">
                                <span>üìö</span> Lessons History
                                <span class="collapsible-count">(3 lessons)</span>
                            </div>
                            <span class="collapsible-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="lesson-item">
                                <div class="lesson-info">
                                    <div class="lesson-type">Full Swing Lesson</div>
                                    <div class="lesson-meta">Dec 20, 2024 ‚Ä¢ 1 hour</div>
                                    <div class="lesson-notes">"Worked on takeaway and hip rotation. Good progress on driver consistency."</div>
                                </div>
                                <span class="lesson-badge">Swing</span>
                            </div>
                            <div class="lesson-item">
                                <div class="lesson-info">
                                    <div class="lesson-type">Club Fitting Session</div>
                                    <div class="lesson-meta">Nov 15, 2024 ‚Ä¢ 2 hours</div>
                                    <div class="lesson-notes">"Fitted new 3-wood shaft. Upgraded from 90g to 73g Ventus Blue."</div>
                                </div>
                                <span class="lesson-badge" style="background: var(--green-dim); color: var(--green);">Fitting</span>
                            </div>
                            <div class="lesson-item">
                                <div class="lesson-info">
                                    <div class="lesson-type">Short Game Lesson</div>
                                    <div class="lesson-meta">Oct 8, 2024 ‚Ä¢ 1 hour</div>
                                    <div class="lesson-notes">"Focused on 50-yard pitch shots and bunker play. Need more practice on distance control."</div>
                                </div>
                                <span class="lesson-badge">Short Game</span>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible: Recent Rounds -->
                    <div class="collapsible-section" id="rounds-section">
                        <div class="collapsible-header" onclick="toggleCollapsible('rounds-section')">
                            <div class="collapsible-title">
                                <span>üèÜ</span> Recent Rounds
                                <span class="collapsible-count">(4 rounds)</span>
                            </div>
                            <span class="collapsible-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="round-item">
                                <div class="round-info">
                                    <div class="round-course">Falmouth Country Club</div>
                                    <div class="round-meta">Dec 22, 2024 ‚Ä¢ Back 9</div>
                                </div>
                                <div class="round-score">
                                    <div class="round-score-value good">38</div>
                                    <div class="round-differential">Diff: 9.2</div>
                                </div>
                            </div>
                            
                            <div class="round-item">
                                <div class="round-info">
                                    <div class="round-course">Purpoodock Club</div>
                                    <div class="round-meta">Dec 18, 2024 ‚Ä¢ 18 holes</div>
                                </div>
                                <div class="round-score">
                                    <div class="round-score-value avg">84</div>
                                    <div class="round-differential">Diff: 10.8</div>
                                </div>
                            </div>
                            
                            <div class="round-item">
                                <div class="round-info">
                                    <div class="round-course">Val Halla Golf Course</div>
                                    <div class="round-meta">Dec 14, 2024 ‚Ä¢ 18 holes</div>
                                </div>
                                <div class="round-score">
                                    <div class="round-score-value avg">86</div>
                                    <div class="round-differential">Diff: 11.4</div>
                                </div>
                            </div>
                            
                            <div class="round-item">
                                <div class="round-info">
                                    <div class="round-course">Nonesuch River Golf Club</div>
                                    <div class="round-meta">Dec 10, 2024 ‚Ä¢ 18 holes</div>
                                </div>
                                <div class="round-score">
                                    <div class="round-score-value poor">89</div>
                                    <div class="round-differential">Diff: 13.1</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pro-only: Insights -->
                    <div class="ghin-card pro-only">
                        <div class="ghin-title" style="margin-bottom: 12px;">
                            <span>üí°</span> Pro Insights
                        </div>
                        <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                            <strong>Analysis:</strong> Mike's handicap has improved 0.8 strokes over the last 30 days. 
                            The 3-wood shaft upgrade in November correlates with his recent improvement.
                            His best differentials are coming from rounds at Falmouth CC. Consider scheduling 
                            a follow-up lesson to work on the improvements from the fitting.
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab: Messages -->
            <div id="tab-messages" class="tab-content" style="display: none;">
                <div class="messages-container">
                    
                    <div class="messages-header">
                        <div class="messages-title">üí¨ Messages</div>
                        <span style="font-size: 12px; color: var(--text-muted);">
                            <span class="pro-only-inline">with Mike Johnson</span>
                            <span class="client-only" style="display: none;">with Your Pro</span>
                        </span>
                    </div>

                    <!-- Quick Actions (Pro Only) -->
                    <div class="quick-actions pro-only">
                        <button class="quick-action-btn" onclick="sendQuickMessage('scenario')">üìä Share Scenario Results</button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('recommendation')">üí° Send Recommendation</button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('schedule')">üìÖ Schedule Lesson</button>
                    </div>

                    <!-- Messages List -->
                    <div class="messages-list" id="messages-list">
                        <div class="message-item received">
                            <div class="message-bubble">
                                Hey! I was looking at my bag grade and saw the 3-wood issue. What do you think I should do about the shaft weight?
                            </div>
                            <div class="message-meta">Mike Johnson ‚Ä¢ Dec 26, 2:34 PM</div>
                        </div>

                        <div class="message-item sent">
                            <div class="message-bubble">
                                Great question! The 90g shaft is definitely too heavy compared to your driver's 65g shaft. I'd recommend looking at something in the 70-75g range to smooth out the weight progression.
                            </div>
                            <div class="message-meta">You ‚Ä¢ Dec 26, 3:15 PM</div>
                        </div>

                        <div class="message-item received">
                            <div class="message-bubble">
                                That makes sense. Any specific shafts you'd recommend? I'm open to upgrading if it'll help my game.
                            </div>
                            <div class="message-meta">Mike Johnson ‚Ä¢ Dec 26, 4:02 PM</div>
                        </div>

                        <div class="message-item sent">
                            <div class="message-bubble">
                                The Fujikura Ventus Blue 7S (73g) would be a great match. It has a similar profile to what's in your driver. I ran a scenario and it would bump your bag grade from B- to B+. Want me to share the full analysis?
                            </div>
                            <div class="message-meta">You ‚Ä¢ Dec 26, 4:28 PM</div>
                        </div>

                        <div class="message-item received">
                            <div class="message-bubble">
                                Yes please! Also, I played a round yesterday and shot 38 on the back 9. Feeling good about my game lately üéâ
                            </div>
                            <div class="message-meta">Mike Johnson ‚Ä¢ Today, 9:15 AM</div>
                        </div>

                        <div class="message-item received">
                            <div class="message-bubble">
                                Can we schedule a time to do the fitting? Maybe this weekend?
                            </div>
                            <div class="message-meta">Mike Johnson ‚Ä¢ Today, 9:16 AM</div>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="message-input-area">
                        <input type="text" class="message-input" id="message-input" placeholder="Type a message..." onkeypress="handleMessageKeypress(event)">
                        <button class="btn-send" onclick="sendMessage()" id="send-btn">‚û§</button>
                    </div>

                </div>
            </div>

        </div>

        <!-- ============================================
             CLIENT PREVIEW (Phone Frame)
             ============================================ -->
        <div id="page-client-preview" class="page">
            <div class="phone-frame-container">
                <div class="phone-frame">
                    <div class="phone-screen">
                        <!-- White Label Header -->
                        <div style="background: var(--bg-dark); padding: 12px 16px; border-bottom: 1px solid var(--border-light);">
                            <div id="phone-business-name" style="font-size: 14px; font-weight: 700; color: var(--pro-green);">Fairway Golf Academy</div>
                            <div style="font-size: 10px; color: var(--text-muted);">Powered by <span style="color: var(--cyan);">FitMyGolfClubs</span></div>
                        </div>
                        <div class="phone-header">
                            <div class="phone-header-left">
                                <button class="phone-back-btn">‚Üê</button>
                                <span class="phone-title">My Bag</span>
                            </div>
                            <span class="phone-credits" onclick="openCreditsModal()" style="cursor: pointer;">‚ö° 27</span>
                        </div>
                        <div class="phone-content">
                            <!-- Grade Overview (compact) -->
                            <div style="text-align: center; padding: 20px; background: var(--cyan-dim); border-radius: 16px; margin-bottom: 16px;">
                                <div style="font-size: 48px; font-weight: 800; color: var(--cyan);">B-</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Overall Bag Grade</div>
                            </div>

                            <div class="attention-summary" style="margin-bottom: 16px;">
                                <span>‚ö†Ô∏è</span>
                                <span><strong>3 Clubs Need Attention</strong></span>
                            </div>

                            <!-- Club Cards (mobile style) -->
                            <div class="section-label">Woods</div>
                            
                            <div class="club-card status-good">
                                <div class="club-header">
                                    <div class="club-header-left">
                                        <span class="club-name">Driver</span>
                                        <span class="club-status good">‚úì Good</span>
                                    </div>
                                </div>
                                <div class="club-specs">
                                    TaylorMade Stealth 2 ‚Ä¢ 10.5¬∞<br>
                                    Fujikura Ventus Blue 65g ‚Ä¢ Stiff
                                </div>
                            </div>

                            <div class="club-card status-attention">
                                <div class="club-header">
                                    <div class="club-header-left">
                                        <span class="club-name">3-Wood</span>
                                        <span class="club-status attention">‚ö†Ô∏è Attention</span>
                                    </div>
                                </div>
                                <div class="club-specs">
                                    TaylorMade Stealth 2 ‚Ä¢ 15¬∞<br>
                                    Stock Aldila 90g ‚Ä¢ Stiff
                                </div>
                                <div class="club-issue">Shaft 25g heavier than driver</div>
                            </div>

                            <div class="section-label">Hybrids</div>

                            <div class="club-card status-attention">
                                <div class="club-header">
                                    <div class="club-header-left">
                                        <span class="club-name">4-Hybrid</span>
                                        <span class="club-status attention">‚ö†Ô∏è Attention</span>
                                    </div>
                                </div>
                                <div class="club-specs">
                                    Cobra LTDx ‚Ä¢ 21¬∞<br>
                                    Cobra Ultralight 50g ‚Ä¢ Regular
                                </div>
                                <div class="club-issue">Mismatched brand/flex</div>
                            </div>

                            <!-- Contact Pro Button (Client only) -->
                            <button class="btn btn-pro" id="client-contact-btn" style="width: 100%; margin-top: 20px;" onclick="openModal('contact-pro-modal')">
                                üí¨ Contact Your Pro
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ============================================
         MODALS
         ============================================ -->
    
    <!-- Issues Detail Modal -->
    <div id="issues-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <span class="modal-title">‚ö†Ô∏è Issues Found</span>
                <button class="modal-close" onclick="closeModal('issues-modal')">&times;</button>
            </div>
            <div class="modal-body issues-modal-content">
                <div id="issues-modal-list">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('issues-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Pro Credits Modal -->
    <div id="pro-credits-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚ö° Pro Credits</span>
                <button class="modal-close" onclick="closeModal('pro-credits-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="usage-indicator">
                    <div class="usage-bar">
                        <div class="usage-fill" id="pro-usage-fill" style="width: 97.4%;"></div>
                    </div>
                    <span class="usage-text" id="pro-usage-text">487 / 500</span>
                </div>
                
                <div class="credit-breakdown">
                    <div class="credit-row">
                        <span class="credit-label">Monthly Allocation</span>
                        <span class="credit-value">500</span>
                    </div>
                    <div class="credit-row">
                        <span class="credit-label">Used This Month</span>
                        <span class="credit-value" id="pro-used">13</span>
                    </div>
                    <div class="credit-row">
                        <span class="credit-label">Resets In</span>
                        <span class="credit-value cyan">4 days</span>
                    </div>
                    <div class="credit-row total">
                        <span class="credit-label">Available</span>
                        <span class="credit-value cyan" id="pro-available">487</span>
                    </div>
                </div>

                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                    Pro credits are shared across all client work including scenarios, performance tests, and regrades.
                </p>

                <div style="background: var(--purple-dim); border-radius: 10px; padding: 14px; text-align: center;">
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Need more credits?</div>
                    <div style="font-size: 16px; font-weight: 700; color: var(--purple);">100 credits for $25</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('pro-credits-modal')">Close</button>
                <button class="btn btn-primary">Buy Credits</button>
            </div>
        </div>
    </div>

    <!-- Client Credits Modal -->
    <div id="client-credits-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚ö° Your Credits</span>
                <button class="modal-close" onclick="closeModal('client-credits-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="usage-indicator">
                    <div class="usage-bar">
                        <div class="usage-fill" id="client-usage-fill" style="width: 90%;"></div>
                    </div>
                    <span class="usage-text" id="client-usage-text">27 / 30</span>
                </div>
                
                <div class="credit-breakdown">
                    <div class="credit-row">
                        <span class="credit-label">Monthly Credits</span>
                        <span class="credit-value" id="client-monthly">30</span>
                    </div>
                    <div class="credit-row">
                        <span class="credit-label">Used This Month</span>
                        <span class="credit-value" id="client-used">3</span>
                    </div>
                    <div class="credit-row">
                        <span class="credit-label">Purchased Credits</span>
                        <span class="credit-value green" id="client-purchased">0</span>
                    </div>
                    <div class="credit-row total">
                        <span class="credit-label">Available</span>
                        <span class="credit-value cyan" id="client-available">27</span>
                    </div>
                </div>

                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                    Credits are used for scenarios, performance tests, and regrades. Monthly credits reset on the 1st.
                </p>

                <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px;">Buy Credit Packs</div>
                <div class="credit-packs-grid">
                    <div class="credit-pack" onclick="selectCreditPack(10)">
                        <div class="credit-pack-amount">10</div>
                        <div class="credit-pack-price">$1.99</div>
                    </div>
                    <div class="credit-pack" onclick="selectCreditPack(25)">
                        <div class="credit-pack-amount">25</div>
                        <div class="credit-pack-price">$3.99</div>
                    </div>
                    <div class="credit-pack" onclick="selectCreditPack(50)">
                        <div class="credit-pack-amount">50</div>
                        <div class="credit-pack-price">$6.99</div>
                    </div>
                </div>
                <p style="font-size: 11px; color: var(--text-dim); text-align: center;">Purchased credits never expire</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('client-credits-modal')">Close</button>
                <button class="btn btn-primary" id="buy-credits-btn" disabled>Select Pack</button>
            </div>
        </div>
    </div>

    <!-- Paywall Modal (Free Client) -->
    <div id="paywall-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üîí Upgrade Required</span>
                <button class="modal-close" onclick="closeModal('paywall-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="paywall-icon">üîì</div>
                <div class="paywall-title">Unlock Full Access</div>
                <div class="paywall-desc">
                    You've used your free trial for this feature. Upgrade to FitMyGolfClubs Plus for unlimited access.
                </div>
                
                <div class="paywall-features">
                    <div class="paywall-feature">
                        <span class="paywall-feature-icon">‚úì</span>
                        <span>Unlimited Scenario Testing</span>
                    </div>
                    <div class="paywall-feature">
                        <span class="paywall-feature-icon">‚úì</span>
                        <span>Performance Data Tracking</span>
                    </div>
                    <div class="paywall-feature">
                        <span class="paywall-feature-icon">‚úì</span>
                        <span>Detailed Factor Drill-Down</span>
                    </div>
                    <div class="paywall-feature">
                        <span class="paywall-feature-icon">‚úì</span>
                        <span>30 Credits/Month Included</span>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 28px; font-weight: 800; color: var(--cyan);">$7.99<span style="font-size: 14px; font-weight: 400; color: var(--text-muted);">/month</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('paywall-modal')">Maybe Later</button>
                <button class="btn btn-primary">Upgrade Now</button>
            </div>
        </div>
    </div>

    <!-- Baseline Explanation Modal -->
    <div id="baseline-modal" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <span class="modal-title" id="baseline-modal-title">‚òÖ Favorite Club Baseline</span>
                <button class="modal-close" onclick="closeModal('baseline-modal')">&times;</button>
            </div>
            <div class="modal-body" id="baseline-modal-body">
                <!-- Content populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('baseline-modal')">Got It</button>
            </div>
        </div>
    </div>

    <!-- Out of Credits Modal -->
    <div id="no-credits-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚ö° Out of Credits</span>
                <button class="modal-close" onclick="closeModal('no-credits-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="paywall-icon">üòÖ</div>
                <div class="paywall-title">You're Out of Credits</div>
                <div class="paywall-desc">
                    This action requires 1 credit. Purchase a credit pack to continue.
                </div>
                
                <div class="credit-packs-grid">
                    <div class="credit-pack" onclick="selectCreditPack(10)">
                        <div class="credit-pack-amount">10</div>
                        <div class="credit-pack-price">$1.99</div>
                    </div>
                    <div class="credit-pack" onclick="selectCreditPack(25)">
                        <div class="credit-pack-amount">25</div>
                        <div class="credit-pack-price">$3.99</div>
                    </div>
                    <div class="credit-pack" onclick="selectCreditPack(50)">
                        <div class="credit-pack-amount">50</div>
                        <div class="credit-pack-price">$6.99</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('no-credits-modal')">Cancel</button>
                <button class="btn btn-primary">Buy Credits</button>
            </div>
        </div>
    </div>

    <!-- Contact Pro Modal (for Free Clients) -->
    <div id="contact-pro-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üí¨ Contact Your Pro</span>
                <button class="modal-close" onclick="closeModal('contact-pro-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--bg-main); border-radius: 10px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--pro-green), #2e7d32); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700;">JD</div>
                        <div>
                            <div style="font-weight: 600;">John Davis</div>
                            <div style="font-size: 12px; color: var(--text-muted);">PGA Professional</div>
                        </div>
                    </div>
                </div>
                
                <label style="font-size: 13px; color: var(--text-muted); display: block; margin-bottom: 8px;">Message</label>
                <textarea id="contact-pro-message" style="width: 100%; height: 120px; background: var(--bg-main); border: 1px solid var(--border-medium); border-radius: 10px; padding: 12px; color: var(--text-primary); font-size: 14px; resize: none;" placeholder="Hi! I'd like to discuss my equipment...">Hi! I've been reviewing my bag analysis and noticed some areas for improvement. I'd love to discuss upgrading to the full analysis and hear your recommendations.</textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('contact-pro-modal')">Cancel</button>
                <button class="btn btn-pro">Send Message</button>
            </div>
        </div>
    </div>

    <!-- Client Onboarding Modal -->
    <div id="onboarding-modal" class="modal-overlay">
        <div class="modal onboarding-modal">
            <div class="modal-header">
                <h3 class="modal-title">Add & Invite Client</h3>
                <button class="modal-close" onclick="closeModal('onboarding-modal')">&times;</button>
            </div>

            <!-- Progress Dots -->
            <div class="onboarding-progress">
                <div class="onboarding-dot active" id="onboard-dot-1"></div>
                <div class="onboarding-dot" id="onboard-dot-2"></div>
            </div>

            <!-- Step 1: Client Info -->
            <div class="onboarding-step active" id="onboard-step-1">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">üë§</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">Client Information</div>
                    <div style="font-size: 13px; color: var(--text-muted);">We'll send them an invite to join your roster</div>
                </div>

                <div class="onboarding-form-group">
                    <label class="onboarding-label">Full Name *</label>
                    <input type="text" class="onboarding-input" id="onboard-name" placeholder="e.g. John Smith">
                </div>

                <div class="onboarding-form-group">
                    <label class="onboarding-label">Email Address *</label>
                    <input type="email" class="onboarding-input" id="onboard-email" placeholder="e.g. john@email.com">
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">üìß Invite & setup instructions will be sent here</div>
                </div>

                <div class="onboarding-form-group">
                    <label class="onboarding-label">GHIN Number (Optional)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="onboarding-input" id="onboard-ghin" placeholder="8-digit GHIN" maxlength="8" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="lookupGHIN()" style="white-space: nowrap;">Look Up</button>
                    </div>
                    <div id="ghin-lookup-result" style="display: none;"></div>
                </div>

                <button class="btn btn-primary" onclick="goToOnboardStep(2)" style="width: 100%; margin-top: 16px;">Continue ‚Üí</button>
            </div>

            <!-- Step 2: Choose Path -->
            <div class="onboarding-step" id="onboard-step-2">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">Client Added!</div>
                    <div style="font-size: 13px; color: var(--text-muted);">Choose how to set up their bag</div>
                </div>

                <!-- Option 1: Add Bag Now -->
                <div style="background: var(--bg-main); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 2px solid var(--cyan);">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="font-size: 24px;">üèåÔ∏è</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Add Bag Now</div>
                            <div style="font-size: 12px; color: var(--text-muted); line-height: 1.4;">
                                Enter their clubs yourself using our guided wizard. Best for in-person sessions.
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addBagNowFromOnboarding()" style="width: 100%; margin-top: 12px;">
                        Start Bag Entry ‚Üí
                    </button>
                </div>

                <!-- Option 2: Send Invite -->
                <div style="background: var(--bg-main); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="font-size: 24px;">üìß</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Send Invite Instead</div>
                            <div style="font-size: 12px; color: var(--text-muted); line-height: 1.4;">
                                Let them enter their own bag via the app. You'll be notified when complete.
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                        <div class="invite-code-display" style="margin-bottom: 8px;">
                            <div class="invite-code" id="invite-code" style="font-size: 20px;">FGA-7X2K</div>
                            <div class="invite-code-hint" style="font-size: 11px;">Client enters this code when signing up</div>
                        </div>

                        <div class="invite-link-box" style="margin-bottom: 8px;">
                            <input type="text" class="invite-link-input" id="invite-link" value="https://fitmygolfclubs.com/join/FGA-7X2K" readonly style="font-size: 11px;">
                            <button class="btn-copy" onclick="copyInviteLink()" style="padding: 6px 10px; font-size: 11px;">Copy</button>
                        </div>

                        <div class="share-options" style="gap: 8px;">
                            <button class="share-btn email" onclick="shareViaEmail()" title="Email" style="width: 36px; height: 36px; font-size: 16px;">‚úâÔ∏è</button>
                            <button class="share-btn sms" onclick="shareViaSMS()" title="SMS" style="width: 36px; height: 36px; font-size: 16px;">üí¨</button>
                            <button class="share-btn copy" onclick="copyInviteLink()" title="Copy Link" style="width: 36px; height: 36px; font-size: 16px;">üîó</button>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="finishWithInviteOnly()" style="width: 100%; margin-top: 12px;">
                        Done - I'll Wait for Them
                    </button>
                </div>

                <button class="btn btn-secondary" onclick="goToOnboardStep(1)" style="width: 100%; margin-top: 16px;">‚Üê Back to Edit Info</button>
            </div>

        </div>
    </div>

    <!-- Schedule Lesson Modal -->
    <div id="schedule-lesson-modal" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">üìÖ Schedule Lesson</h3>
                <button class="modal-close" onclick="closeModal('schedule-lesson-modal')">&times;</button>
            </div>

            <div style="text-align: center; margin-bottom: 16px;">
                <div style="font-size: 13px; color: var(--text-muted);">Schedule a lesson with Mike Johnson</div>
            </div>

            <!-- Lesson Type Selection -->
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">Select lesson type:</div>
            <div class="lesson-type-grid">
                <div class="lesson-type-btn" onclick="selectLessonType(this, 'full_swing')">
                    <div class="lesson-type-btn-icon">üèåÔ∏è</div>
                    <div class="lesson-type-btn-label">Full Swing</div>
                </div>
                <div class="lesson-type-btn" onclick="selectLessonType(this, 'short_game')">
                    <div class="lesson-type-btn-icon">‚õ≥</div>
                    <div class="lesson-type-btn-label">Short Game</div>
                </div>
                <div class="lesson-type-btn" onclick="selectLessonType(this, 'putting')">
                    <div class="lesson-type-btn-icon">üéØ</div>
                    <div class="lesson-type-btn-label">Putting</div>
                </div>
                <div class="lesson-type-btn" onclick="selectLessonType(this, 'course_management')">
                    <div class="lesson-type-btn-icon">üó∫Ô∏è</div>
                    <div class="lesson-type-btn-label">Course Mgmt</div>
                </div>
                <div class="lesson-type-btn" onclick="selectLessonType(this, 'playing_lesson')">
                    <div class="lesson-type-btn-icon">üèÜ</div>
                    <div class="lesson-type-btn-label">Playing Lesson</div>
                </div>
                <div class="lesson-type-btn" onclick="selectLessonType(this, 'fitting')">
                    <div class="lesson-type-btn-icon">üîß</div>
                    <div class="lesson-type-btn-label">Club Fitting</div>
                </div>
            </div>

            <!-- Date/Time -->
            <div style="margin-top: 20px;">
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">Date & Time:</div>
                <div style="display: flex; gap: 10px;">
                    <input type="date" class="onboarding-input" id="lesson-date" style="flex: 1;">
                    <input type="time" class="onboarding-input" id="lesson-time" style="width: 120px;">
                </div>
            </div>

            <!-- Duration -->
            <div style="margin-top: 16px;">
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">Duration:</div>
                <select class="onboarding-input" id="lesson-duration">
                    <option value="30">30 minutes</option>
                    <option value="60" selected>1 hour</option>
                    <option value="90">1.5 hours</option>
                    <option value="120">2 hours</option>
                </select>
            </div>

            <!-- Notes -->
            <div style="margin-top: 16px;">
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">Notes (optional):</div>
                <textarea class="onboarding-input" id="lesson-notes" placeholder="Focus areas, equipment to bring, etc." style="height: 80px; resize: none;"></textarea>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('schedule-lesson-modal')" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="sendLessonInvite()" style="flex: 1;">Send Invite</button>
            </div>
        </div>
    </div>

    <!-- Factor Detail Modal -->
    <div id="factor-detail-modal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="factor-modal-title">üìä Factor Analysis</h3>
                <button class="modal-close" onclick="closeModal('factor-detail-modal')">&times;</button>
            </div>

            <!-- Factor Header -->
            <div class="factor-detail-header">
                <div class="factor-detail-grade" id="factor-modal-grade">D+</div>
                <div class="factor-detail-info">
                    <h3 id="factor-modal-name">Weight Progression</h3>
                    <p id="factor-modal-weight">15% of overall grade</p>
                </div>
            </div>

            <!-- What It Means (always shown) -->
            <div class="factor-detail-section">
                <div class="factor-detail-section-title">What This Measures</div>
                <p id="factor-modal-description" style="font-size: 14px; color: var(--text-secondary); line-height: 1.5; margin: 0;">
                    Weight progression measures whether your club weights increase smoothly from driver to wedges. Proper progression helps maintain consistent swing tempo and shot control.
                </p>
            </div>

            <!-- Club Breakdown (always shown) -->
            <div class="factor-detail-section">
                <div class="factor-detail-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Your Clubs</span>
                    <div id="factor-edit-buttons" style="display: none;">
                        <button id="factor-reset-btn" class="btn-reset-small" onclick="resetFactorToDefault()">‚Ü∫ Reset</button>
                        <button id="factor-edit-btn" class="btn-edit-small" onclick="toggleFactorEditMode()">‚úèÔ∏è Edit</button>
                    </div>
                </div>
                <div id="factor-modal-clubs">
                    <div class="factor-club-row">
                        <span class="factor-club-name">Driver</span>
                        <span class="factor-club-value good">310g ‚úì</span>
                    </div>
                    <div class="factor-club-row">
                        <span class="factor-club-name">3-Wood</span>
                        <span class="factor-club-value issue">335g ‚ö†Ô∏è +25g jump</span>
                    </div>
                    <div class="factor-club-row">
                        <span class="factor-club-name">4-Hybrid</span>
                        <span class="factor-club-value good">355g ‚úì</span>
                    </div>
                    <div class="factor-club-row">
                        <span class="factor-club-name">5-Iron</span>
                        <span class="factor-club-value good">420g ‚úì</span>
                    </div>
                </div>
            </div>

            <!-- AI Analysis (Paid/Pro only) -->
            <div class="factor-ai-analysis" id="factor-ai-paid">
                <div class="factor-ai-title">
                    <span>ü§ñ</span> AI Analysis <span class="patent-tag">Patent Pending</span>
                </div>
                <div class="factor-ai-content" id="factor-modal-ai">
                    <strong>The Issue:</strong> Your 3-wood shaft (90g) is significantly heavier than your driver shaft (65g), creating a 25g jump instead of the ideal 10-15g progression. This weight inconsistency can cause tempo issues and make it harder to hit your 3-wood consistently off the deck.
                    <br><br>
                    <strong>Recommendation:</strong> Consider a lighter shaft for your 3-wood in the 70-75g range, like the Fujikura Ventus Blue 7S. This would smooth your weight progression and improve consistency.
                </div>
            </div>

            <!-- Pro Insight (Pro only) -->
            <div class="factor-pro-insight pro-only" id="factor-pro-insight">
                <div class="factor-pro-insight-title">
                    <span>üí∞</span> Sales Opportunity
                </div>
                <div class="factor-pro-insight-content">
                    <strong>Mike is aware of this issue</strong> ‚Äî he's mentioned inconsistency with his 3-wood off the fairway. This is a high-confidence reshaft opportunity (~$175-250). The TaylorMade Fitting Day on Jan 11 would be perfect timing to address this. Consider sending him a message about it.
                </div>
            </div>

            <!-- Upgrade Prompt (Free only) -->
            <div class="factor-upgrade-prompt" id="factor-upgrade-prompt" style="display: none;">
                <div class="factor-upgrade-icon">üîí</div>
                <div class="factor-upgrade-title">Unlock AI Analysis</div>
                <div class="factor-upgrade-desc">
                    Get personalized recommendations for fixing this issue and improving your bag grade.
                </div>
                <button class="btn btn-primary" onclick="closeModal('factor-detail-modal'); openModal('paywall-modal');">Upgrade to Pro</button>
            </div>

            <button class="btn btn-secondary" onclick="closeModal('factor-detail-modal')" style="width: 100%; margin-top: 8px;">Close</button>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="modal-overlay">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span class="pro-only-inline">üìÖ Add Club Event</span>
                    <span class="client-only-inline">üìÖ Add Personal Event</span>
                </h3>
                <button class="modal-close" onclick="closeModal('add-event-modal')">&times;</button>
            </div>

            <div class="onboarding-form-group">
                <label class="onboarding-label">Event Type *</label>
                <select class="onboarding-input" id="event-type">
                    <option value="">Select type...</option>
                    <option value="demo">Demo Day</option>
                    <option value="clinic">Clinic / Group Lesson</option>
                    <option value="fitting">Fitting Session</option>
                    <option value="tournament">Tournament</option>
                    <option value="member">Member Event</option>
                    <option value="program">Program / League</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="onboarding-form-group">
                <label class="onboarding-label">Event Name *</label>
                <input type="text" class="onboarding-input" id="event-name" placeholder="e.g. TaylorMade Demo Day, Spring Scramble">
            </div>

            <div style="display: flex; gap: 12px;">
                <div class="onboarding-form-group" style="flex: 1;">
                    <label class="onboarding-label">Date *</label>
                    <input type="date" class="onboarding-input" id="event-date">
                </div>
                <div class="onboarding-form-group" style="width: 120px;">
                    <label class="onboarding-label">Time</label>
                    <input type="time" class="onboarding-input" id="event-time">
                </div>
            </div>

            <div class="onboarding-form-group">
                <label class="onboarding-label">Location</label>
                <input type="text" class="onboarding-input" id="event-location" placeholder="e.g. Driving Range, Clubhouse, 1st Tee">
            </div>

            <div class="onboarding-form-group">
                <label class="onboarding-label">Price</label>
                <input type="text" class="onboarding-input" id="event-price" placeholder="e.g. $45, Free, $75/player">
            </div>

            <div class="onboarding-form-group">
                <label class="onboarding-label">Description</label>
                <textarea class="onboarding-input" id="event-description" rows="3" placeholder="Event details, what to bring, registration info..." style="resize: none;"></textarea>
            </div>

            <div class="onboarding-form-group pro-only">
                <label class="onboarding-label">Notify Clients</label>
                <select class="onboarding-input" id="event-notify">
                    <option value="all">All active clients</option>
                    <option value="flags">Clients with equipment flags</option>
                    <option value="trial">Trial clients only</option>
                    <option value="none">Don't notify</option>
                </select>
            </div>

            <div class="pro-only" style="background: var(--purple-dim); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 11px; color: var(--purple); font-weight: 600; margin-bottom: 4px;">üì£ Client Visibility</div>
                <div style="font-size: 12px; color: var(--text-muted);">This event will appear in your clients' "Events" tab.</div>
            </div>

            <div class="client-only" style="background: var(--cyan-dim); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 11px; color: var(--cyan); font-weight: 600; margin-bottom: 4px;">üìÖ Personal Event</div>
                <div style="font-size: 12px; color: var(--text-muted);">This event will be added to your personal calendar only.</div>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="closeModal('add-event-modal')" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="saveEvent()" style="flex: 1;">Create Event</button>
            </div>
        </div>
    </div>

    <!-- Log Lesson Modal (Pro Only) -->
    <div id="log-lesson-modal" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">üìö Log a Lesson</h3>
                <button class="modal-close" onclick="closeModal('log-lesson-modal')">&times;</button>
            </div>

            <div style="background: var(--green-dim); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: var(--green);">
                    <strong>üìÖ Client Visibility:</strong> This lesson will appear on your client's Events tab and Progress history.
                </div>
            </div>

            <div class="onboarding-form-group">
                <label class="onboarding-label">Client *</label>
                <select class="onboarding-input" id="lesson-client">
                    <option value="">Select client...</option>
                    <option value="mike">Mike Johnson</option>
                    <option value="sarah">Sarah Williams</option>
                    <option value="tom">Tom Anderson</option>
                    <option value="david">David Chen</option>
                    <option value="emily">Emily Rodriguez</option>
                    <option value="james">James Wilson</option>
                    <option value="lisa">Lisa Thompson</option>
                    <option value="robert">Robert Garcia</option>
                </select>
            </div>

            <div class="onboarding-form-group">
                <label class="onboarding-label">Lesson Type *</label>
                <select class="onboarding-input" id="lesson-type-log">
                    <option value="">Select type...</option>
                    <option value="full_swing">üèåÔ∏è Full Swing</option>
                    <option value="short_game">‚õ≥ Short Game</option>
                    <option value="putting">üéØ Putting</option>
                    <option value="course_mgmt">üó∫Ô∏è Course Management</option>
                    <option value="playing">üèÜ Playing Lesson</option>
                    <option value="fitting">üîß Club Fitting</option>
                </select>
            </div>

            <div style="display: flex; gap: 12px;">
                <div class="onboarding-form-group" style="flex: 1;">
                    <label class="onboarding-label">Date *</label>
                    <input type="date" class="onboarding-input" id="lesson-date-log">
                </div>
                <div class="onboarding-form-group" style="flex: 1;">
                    <label class="onboarding-label">Time</label>
                    <input type="time" class="onboarding-input" id="lesson-time-log">
                </div>
            </div>

            <div class="onboarding-form-group">
                <label class="onboarding-label">Duration</label>
                <select class="onboarding-input" id="lesson-duration-log">
                    <option value="30">30 minutes</option>
                    <option value="60" selected>1 hour</option>
                    <option value="90">1.5 hours</option>
                    <option value="120">2 hours</option>
                </select>
            </div>

            <div class="onboarding-form-group">
                <label class="onboarding-label">Notes (Optional)</label>
                <textarea class="onboarding-input" id="lesson-notes-log" rows="3" placeholder="What was covered, key takeaways, next steps..." style="resize: none;"></textarea>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="closeModal('log-lesson-modal')" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="saveLoggedLesson()" style="flex: 1;">Log Lesson</button>
            </div>
        </div>
    </div>

    <!-- Saved Scenarios Modal -->
    <div id="saved-scenarios-modal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">üìÅ Saved Scenarios</h3>
                <button class="modal-close" onclick="closeModal('saved-scenarios-modal')">&times;</button>
            </div>

            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                Compare saved scenarios or load one to continue editing
            </div>

            <div id="saved-scenarios-list">
                <!-- Saved Scenario 1 -->
                <div class="saved-scenario-card" onclick="loadScenario(1)">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">3-Wood Shaft Upgrade</div>
                            <div style="font-size: 12px; color: var(--text-muted);">TaylorMade Stealth 2 Plus + Fujikura Ventus Blue 75g</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 700; color: var(--green);">B+ ‚Üí A-</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Dec 22</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; flex: 1;" onclick="event.stopPropagation(); loadScenario(1)">Load</button>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; flex: 1;" onclick="event.stopPropagation(); applyScenarioFromSaved(1)">Apply</button>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; color: var(--red);" onclick="event.stopPropagation(); deleteScenario(1)">üóëÔ∏è</button>
                    </div>
                </div>

                <!-- Saved Scenario 2 -->
                <div class="saved-scenario-card" onclick="loadScenario(2)">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">4-Hybrid Flex Fix</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Callaway Apex + Project X HZRDUS Stiff</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 700; color: var(--green);">B+ ‚Üí A-</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Dec 20</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; flex: 1;" onclick="event.stopPropagation(); loadScenario(2)">Load</button>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; flex: 1;" onclick="event.stopPropagation(); applyScenarioFromSaved(2)">Apply</button>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; color: var(--red);" onclick="event.stopPropagation(); deleteScenario(2)">üóëÔ∏è</button>
                    </div>
                </div>

                <!-- Saved Scenario 3 -->
                <div class="saved-scenario-card" onclick="loadScenario(3)">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Full Wedge Set Update</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Titleist Vokey SM10 (52¬∞, 56¬∞, 60¬∞)</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 700; color: var(--green);">B+ ‚Üí A</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Dec 18</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; flex: 1;" onclick="event.stopPropagation(); loadScenario(3)">Load</button>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; flex: 1;" onclick="event.stopPropagation(); applyScenarioFromSaved(3)">Apply</button>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; color: var(--red);" onclick="event.stopPropagation(); deleteScenario(3)">üóëÔ∏è</button>
                    </div>
                </div>
            </div>

            <div id="no-saved-scenarios" style="display: none; text-align: center; padding: 32px; color: var(--text-muted);">
                <div style="font-size: 32px; margin-bottom: 12px;">üìÅ</div>
                <div>No saved scenarios yet</div>
                <div style="font-size: 12px; margin-top: 4px;">Run a scenario and click "Save" to store it here</div>
            </div>

            <button class="btn btn-secondary" onclick="closeModal('saved-scenarios-modal')" style="width: 100%; margin-top: 16px;">Close</button>
        </div>
    </div>

    <!-- Saved Tests Modal REMOVED - replaced by banner cards -->

    <!-- Save Test Modal (Custom styled) -->
    <div id="save-test-modal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <h3 class="modal-title">üíæ Save Test</h3>
                <button class="modal-close" onclick="closeSaveTestModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Test Name</label>
                <input type="text" id="save-test-name" class="form-input" 
                       style="width: 100%; padding: 12px; background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                       placeholder="e.g., Driver - Callaway vs TaylorMade">
            </div>
            
            <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">Test Summary</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: var(--cyan);">Your Club:</span>
                    <span id="save-modal-club-a" style="font-weight: 500;">--</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--green);">Test Club:</span>
                    <span id="save-modal-club-b" style="font-weight: 500;">--</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="closeSaveTestModal()" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="confirmSaveTest()" style="flex: 1;">üíæ Save Test</button>
            </div>
        </div>
    </div>

    <!-- Scenario Teaser Modal (FREE preview) -->
    <div id="scenario-teaser-modal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <h3 class="modal-title">üìã Add to Scenario</h3>
                <button class="modal-close" onclick="closeScenarioTeaser()">&times;</button>
            </div>
            
            <!-- Teaser Content -->
            <div id="teaser-content">
                <!-- Loading State -->
                <div id="teaser-loading" style="text-align: center; padding: 24px;">
                    <div style="font-size: 32px; margin-bottom: 12px;">‚è≥</div>
                    <div style="color: var(--text-muted);">Calculating grade impact...</div>
                </div>
                
                <!-- Results State (hidden initially) -->
                <div id="teaser-results" style="display: none;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px;">Projected Bag Grade</div>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 16px;">
                            <div>
                                <div style="font-size: 48px; font-weight: 700; color: var(--text-muted);" id="teaser-current-grade">B+</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Current</div>
                            </div>
                            <div style="font-size: 32px; color: var(--text-muted);">‚Üí</div>
                            <div>
                                <div style="font-size: 48px; font-weight: 700;" id="teaser-projected-grade">A-</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Projected</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="teaser-swap-summary" style="background: var(--bg-card); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">Proposed Swap</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--red);" id="teaser-out-club">Callaway Elyte</span>
                            <span style="color: var(--text-muted);">‚Üí</span>
                            <span style="color: var(--green);" id="teaser-in-club">TaylorMade Qi4D</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--cyan-dim); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Full analysis includes</div>
                        <div style="font-size: 13px; color: var(--cyan);">‚úì Detailed factor breakdown ‚Ä¢ ‚úì AI recommendations ‚Ä¢ ‚úì Issue detection</div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="closeScenarioTeaser()" style="flex: 1;">Maybe Later</button>
                <button class="btn btn-primary" onclick="proceedToScenario()" style="flex: 1;" id="proceed-scenario-btn" disabled>
                    üìã Build Scenario
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 12px; font-size: 11px; color: var(--text-muted);">
                <span style="color: var(--green);">‚úì FREE Preview</span> ‚Ä¢ Full scenario costs <span style="color: var(--cyan);">‚ö° 1 credit</span>
            </div>
        </div>
    </div>

    <!-- Add/Edit Club Modal -->
    <div class="modal-overlay" id="club-modal" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="club-modal-title">üèåÔ∏è Add New Club</h2>
                <button class="modal-close" onclick="closeClubModal()">√ó</button>
            </div>
            
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <!-- Hidden fields for edit mode -->
                <input type="hidden" id="club-edit-id">
                <input type="hidden" id="club-edit-mode" value="add">
                
                <!-- Category (hidden in edit mode) -->
                <div id="club-category-row" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Category</label>
                    <select class="settings-select" id="club-category" onchange="onCategoryChange()">
                        <option value="">Select category...</option>
                        <option value="woods">Woods</option>
                        <option value="hybrids">Hybrids</option>
                        <option value="irons">Irons</option>
                        <option value="wedges">Wedges</option>
                        <option value="putter">Putter</option>
                    </select>
                </div>

                <!-- Club Type (specific club within category) -->
                <div id="club-type-row" style="margin-bottom: 16px; display: none;">
                    <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Club</label>
                    <select class="settings-select" id="club-type">
                        <option value="">Select club...</option>
                    </select>
                </div>

                <!-- Brand (autocomplete) -->
                <div id="club-brand-row" style="margin-bottom: 16px; display: none;">
                    <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Club Brand</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="settings-input" id="club-brand-input" placeholder="Type brand name..." autocomplete="off" oninput="showBrandSuggestions()" onfocus="showBrandSuggestions()">
                        <input type="hidden" id="club-brand">
                        <div class="autocomplete-dropdown" id="club-brand-dropdown"></div>
                    </div>
                </div>

                <!-- Model (autocomplete) -->
                <div id="club-model-row" style="margin-bottom: 16px; display: none;">
                    <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Club Model</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="settings-input" id="club-model-input" placeholder="Type model name..." autocomplete="off" oninput="showModelSuggestions()" onfocus="showModelSuggestions()">
                        <input type="hidden" id="club-model">
                        <div class="autocomplete-dropdown" id="club-model-dropdown"></div>
                    </div>
                </div>

                <!-- Shaft Brand (autocomplete) -->
                <div id="club-shaft-brand-row" style="margin-bottom: 16px; display: none;">
                    <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Shaft Brand</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="settings-input" id="shaft-brand-input" placeholder="Type shaft brand..." autocomplete="off" oninput="showShaftBrandSuggestions()" onfocus="showShaftBrandSuggestions()">
                        <input type="hidden" id="shaft-brand">
                        <div class="autocomplete-dropdown" id="shaft-brand-dropdown"></div>
                    </div>
                </div>

                <!-- Shaft Model (autocomplete) -->
                <div id="club-shaft-row" style="margin-bottom: 16px; display: none;">
                    <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Shaft Model</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="settings-input" id="shaft-model-input" placeholder="Type shaft model..." autocomplete="off" oninput="showShaftModelSuggestions()" onfocus="showShaftModelSuggestions()">
                        <input type="hidden" id="club-shaft">
                        <div class="autocomplete-dropdown" id="shaft-model-dropdown"></div>
                    </div>
                </div>
                
                <!-- Specs Preview -->
                <div id="club-specs-preview" style="display: none; margin-top: 16px; padding: 12px; background: var(--bg-main); border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">SPECS FROM DATABASE</div>
                    <div id="club-specs-content" style="font-size: 13px; color: var(--text-secondary);"></div>
                </div>
            </div>

            <div class="modal-footer" style="flex-direction: column; gap: 8px;">
                <button class="btn btn-primary" id="club-save-btn" style="width: 100%;" onclick="saveClubToFirestore()">Add Club</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="closeClubModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete Club Confirmation Modal -->
    <div class="modal-overlay" id="delete-club-modal" style="display: none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2>üóëÔ∏è Delete Club</h2>
                <button class="modal-close" onclick="closeModal('delete-club-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="delete-club-id">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                    Are you sure you want to delete this club?
                </p>
                <div id="delete-club-info" style="padding: 12px; background: var(--bg-main); border-radius: 8px; margin-bottom: 16px;">
                    <!-- Club info will be inserted here -->
                </div>
                <p style="font-size: 12px; color: var(--text-muted);">
                    This action cannot be undone. The club will be permanently removed from this client's bag.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('delete-club-modal')">Cancel</button>
                <button class="btn" style="background: var(--red); color: white;" onclick="confirmDeleteClub()">Delete Club</button>
            </div>
        </div>
    </div>

    <!-- Scenario Swap Modal -->
    <div class="modal-overlay" id="swap-modal" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üîÑ Swap Club</h2>
                <button class="modal-close" onclick="closeSwapModal()">√ó</button>
            </div>
            
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <!-- Current Club Info -->
                <div style="padding: 12px; background: var(--bg-main); border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">CURRENT CLUB</div>
                    <div style="font-size: 14px; font-weight: 600;" id="swap-current-name">Driver</div>
                    <div style="font-size: 13px; color: var(--text-secondary);" id="swap-current-specs">Callaway Elyte (2025) ‚Ä¢ Fujikura Ventus 57g</div>
                </div>

                <input type="hidden" id="swap-club-id">
                <input type="hidden" id="swap-category">

                <!-- New Club Selection -->
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">SWAP TO</div>
                
                <!-- Brand -->
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Brand</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="settings-input" id="swap-brand-input" 
                               placeholder="Type brand name..." autocomplete="off" 
                               oninput="showSwapBrandSuggestions()" 
                               onfocus="showSwapBrandSuggestions()">
                        <input type="hidden" id="swap-brand">
                        <div class="autocomplete-dropdown" id="swap-brand-dropdown"></div>
                    </div>
                </div>
                
                <!-- Model -->
                <div id="swap-model-row" style="margin-bottom: 12px; display: none;">
                    <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Model</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="settings-input" id="swap-model-input" 
                               placeholder="Type model name..." autocomplete="off" 
                               oninput="showSwapModelSuggestions()" 
                               onfocus="showSwapModelSuggestions()">
                        <input type="hidden" id="swap-model">
                        <div class="autocomplete-dropdown" id="swap-model-dropdown"></div>
                    </div>
                </div>

                <!-- Shaft Section -->
                <div id="swap-shaft-section" style="display: none;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; margin-top: 16px;">SHAFT</div>
                    
                    <!-- Stock Shaft Toggle -->
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="swap-use-stock" checked onchange="toggleSwapStockShaft()">
                            <span style="font-size: 13px;">Use stock shaft</span>
                        </label>
                        <div id="swap-stock-info" style="margin-top: 8px; padding: 10px; background: var(--green-dim); border-radius: 8px; border: 1px solid rgba(0,200,100,0.3);">
                            <span style="color: var(--green); font-size: 13px;" id="swap-stock-shaft-name">Stock: Fujikura Ventus Blue 75g</span>
                        </div>
                    </div>
                    
                    <!-- Custom Shaft -->
                    <div id="swap-custom-shaft" style="display: none;">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Shaft Brand</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="settings-input" id="swap-shaft-brand-input" 
                                       placeholder="Type shaft brand..." autocomplete="off" 
                                       oninput="showSwapShaftBrandSuggestions()" 
                                       onfocus="showSwapShaftBrandSuggestions()">
                                <input type="hidden" id="swap-shaft-brand">
                                <div class="autocomplete-dropdown" id="swap-shaft-brand-dropdown"></div>
                            </div>
                        </div>
                        
                        <div id="swap-shaft-model-row" style="display: none;">
                            <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Shaft Model</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="settings-input" id="swap-shaft-model-input" 
                                       placeholder="Type shaft model..." autocomplete="off" 
                                       oninput="showSwapShaftModelSuggestions()" 
                                       onfocus="showSwapShaftModelSuggestions()">
                                <input type="hidden" id="swap-shaft-model">
                                <div class="autocomplete-dropdown" id="swap-shaft-model-dropdown"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer" style="flex-direction: column; gap: 8px;">
                <button class="btn btn-primary" id="swap-confirm-btn" style="width: 100%;" onclick="confirmSwap()" disabled>Confirm Swap</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="closeSwapModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Regrade Confirmation Modal -->
    <div class="modal-overlay" id="regrade-modal" style="display: none;">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-body" style="padding: 32px;">
                <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                <h2 style="margin-bottom: 8px;">Ready to Regrade?</h2>
                <p style="color: var(--text-secondary); margin-bottom: 8px;">Your bag has changed. Update the analysis?</p>
                <p style="color: var(--cyan); font-weight: 600; margin-bottom: 24px;">Cost: 1 Credit</p>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 12px;" onclick="confirmRegrade()">
                    ‚úì Yes, Regrade Now
                </button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="closeRegradeModal()">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div class="modal-overlay" id="confirm-modal" style="display: none;">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-body" style="padding: 24px;">
                <h3 id="confirm-modal-title" style="margin-bottom: 16px; color: var(--text-primary);">Confirm</h3>
                <div id="confirm-modal-message" style="color: var(--text-secondary); margin-bottom: 24px; white-space: pre-line; font-size: 13px; max-height: 300px; overflow-y: auto;"></div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="resolveConfirmModal(false)">Cancel</button>
                    <button class="btn btn-primary" style="flex: 1;" id="confirm-modal-ok" onclick="resolveConfirmModal(true)">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Grading In Progress Modal -->
    <div class="modal-overlay" id="grading-modal" style="display: none;">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-body" style="padding: 32px;">
                <div id="grading-icon" style="font-size: 48px; margin-bottom: 16px;">üìê</div>
                <h2 id="grading-title" style="margin-bottom: 8px;">Analyzing Bag...</h2>
                <p id="grading-subtitle" style="color: var(--text-secondary); margin-bottom: 16px;">Checking loft gapping...</p>
                <div class="grading-progress-bar" style="width: 100%; height: 4px; background: var(--bg-input); border-radius: 2px; overflow: hidden;">
                    <div id="grading-progress" style="width: 0%; height: 100%; background: var(--cyan); transition: width 0.5s ease;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patent Pending Modal -->
    <div class="modal-overlay" id="patent-modal">
        <div class="modal patent-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîí Patent-Protected Technology</h2>
                <button class="modal-close" onclick="closeModal('patent-modal')">√ó</button>
            </div>
            
            <div class="patent-tagline">Equipment Knowledge Finally Monetized</div>
            
            <div class="patent-stats">
                <div class="patent-stat">
                    <div class="patent-stat-value">2</div>
                    <div class="patent-stat-label">Provisional Applications</div>
                </div>
                <div class="patent-stat">
                    <div class="patent-stat-value">33</div>
                    <div class="patent-stat-label">Formal Claims</div>
                </div>
            </div>
            
            <table class="patent-table">
                <thead>
                    <tr>
                        <th>What You See</th>
                        <th>What's Protected</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>üì∏ Photo Clubs ‚Üí Get Instant Specs</td>
                        <td>Multi-Modal AI Identification</td>
                    </tr>
                    <tr>
                        <td>üìä Grade Bags Without Launch Monitors</td>
                        <td>Equipment-Only Analysis</td>
                    </tr>
                    <tr>
                        <td>‚≠ê "Match My Best Club" Recommendations</td>
                        <td>Baseline Interpolation</td>
                    </tr>
                    <tr>
                        <td>üîÆ "What If I Buy This Club?" Simulator</td>
                        <td>Scenario Simulation</td>
                    </tr>
                    <tr>
                        <td>ü§ñ AI Explains Why & What to Fix</td>
                        <td>AI Recommendation Engine</td>
                    </tr>
                    <tr>
                        <td>üìà Track Handicap vs. Equipment Changes</td>
                        <td>Three-Way Attribution</td>
                    </tr>
                    <tr>
                        <td>üéØ Algorithm Improves Over Time</td>
                        <td>Self-Learning System</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="patent-footer">
                <a href="/cdn-cgi/l/email-protection#671402060927010e130a1e00080b01040b1205144904080a"><span class="__cf_email__" data-cfemail="f18294909fb19798859c88969e9d97929d849382df929e9c">[email&#160;protected]</span></a>
                <div class="patent-confidential">Confidential ‚Äî For Licensing Discussion Only</div>
            </div>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div class="modal-overlay" id="login-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">üîê Sign In</h3>
                <button class="modal-close" onclick="closeModal('login-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Tab Switcher -->
                <div style="display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--border-light);">
                    <button id="login-tab" onclick="showAuthTab('login')" 
                        style="flex: 1; padding: 12px; background: transparent; border: none; color: var(--cyan); border-bottom: 2px solid var(--cyan); cursor: pointer; font-weight: 600;">
                        Login
                    </button>
                    <button id="signup-tab" onclick="showAuthTab('signup')" 
                        style="flex: 1; padding: 12px; background: transparent; border: none; color: var(--text-muted); border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600;">
                        Sign Up
                    </button>
                </div>
                
                <!-- Login Form -->
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Email</label>
                        <input type="email" id="login-email" placeholder="you@example.com"
                            style="width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Password</label>
                        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            style="width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div id="login-error" style="display: none; color: var(--red); font-size: 13px; margin-bottom: 12px; padding: 8px; background: var(--red-dim); border-radius: 6px;"></div>
                    <button type="submit" 
                        style="width: 100%; padding: 14px; background: var(--cyan); border: none; border-radius: 8px; color: #000; font-weight: 600; font-size: 15px; cursor: pointer;">
                        Sign In
                    </button>
                </form>
                
                <!-- Signup Form (hidden by default) -->
                <form id="signup-form" onsubmit="handleSignup(event)" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Full Name</label>
                        <input type="text" id="signup-name" placeholder="John Smith"
                            style="width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Email</label>
                        <input type="email" id="signup-email" placeholder="you@example.com"
                            style="width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Password</label>
                        <input type="password" id="signup-password" placeholder="Min 6 characters"
                            style="width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div id="signup-error" style="display: none; color: var(--red); font-size: 13px; margin-bottom: 12px; padding: 8px; background: var(--red-dim); border-radius: 6px;"></div>
                    <button type="submit" 
                        style="width: 100%; padding: 14px; background: var(--pro-green); border: none; border-radius: 8px; color: #000; font-weight: 600; font-size: 15px; cursor: pointer;">
                        Create Account
                    </button>
                </form>
                
                <!-- Logout button (shown when logged in) -->
                <div id="logout-section" style="display: none; text-align: center; padding-top: 16px; border-top: 1px solid var(--border-light); margin-top: 16px;">
                    <p style="color: var(--text-secondary); margin-bottom: 12px;">Logged in as <span id="logged-in-email" style="color: var(--cyan);"></span></p>
                    <button onclick="logout()" 
                        style="padding: 12px 24px; background: transparent; border: 1px solid var(--red); border-radius: 8px; color: var(--red); font-weight: 600; cursor: pointer;">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ============================================
        // WHITE LABEL CUSTOMIZATION
        // ============================================
        function updateBusinessName() {
            const name = document.getElementById('business-name').value || 'Your Business';
            document.getElementById('header-business-name').textContent = name;
            document.getElementById('phone-business-name').textContent = name;
            // Update settings preview if it exists
            const previewName = document.getElementById('preview-business-name');
            if (previewName) {
                previewName.textContent = name;
            }
        }

        function adjustColor(hex, amount) {
            // Simple color adjustment for gradient
            const num = parseInt(hex.slice(1), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
        }

        // ============================================
        // VIEW TOGGLE
        // ============================================
        function setView(view) {
            const body = document.body;
            const proBtn = document.querySelector('.view-toggle-btn:not(.client-btn)');
            const clientBtn = document.querySelector('.view-toggle-btn.client-btn');
            
            if (view === 'pro') {
                body.classList.remove('client-view');
                body.classList.add('pro-view');
                proBtn.classList.add('active');
                clientBtn.classList.remove('active');
                showPage('client-list');
            } else {
                body.classList.remove('pro-view');
                body.classList.add('client-view');
                proBtn.classList.remove('active');
                clientBtn.classList.add('active');
                showPage('client-detail');
            }
        }

        // ============================================
        // PAGE NAVIGATION
        // ============================================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
        }

        function backToClientList() {
            showPage('client-list');
            // Reset menu to Clients active
            showProTab('clients');
        }

        // ============================================
        // CLIENT LIST FILTERING
        // ============================================
        let currentFilter = 'all';

        function filterClients(filter) {
            currentFilter = filter;
            const filterIndicator = document.getElementById('filter-indicator');
            const filterText = document.getElementById('filter-text');
            
            // Update filter indicator
            if (filter === 'all') {
                filterIndicator.style.display = 'none';
            } else {
                filterIndicator.style.display = 'flex';
                const filterLabels = {
                    'onboarded': 'Bags Onboarded',
                    'need-onboarding': 'Need Onboarding',
                    'attention': 'Needs Attention'
                };
                filterText.textContent = 'Showing: ' + filterLabels[filter];
            }
            
            // Filter table rows
            document.querySelectorAll('.client-row').forEach(row => {
                const status = row.dataset.status;
                const attention = row.dataset.attention === 'true';
                let show = false;
                
                if (filter === 'all') {
                    show = true;
                } else if (filter === 'onboarded') {
                    show = status === 'onboarded';
                } else if (filter === 'need-onboarding') {
                    show = status === 'need-onboarding';
                } else if (filter === 'attention') {
                    show = attention;
                }
                
                row.style.display = show ? '' : 'none';
            });
            
            // Filter mobile cards
            document.querySelectorAll('.client-card').forEach(card => {
                const status = card.dataset.status;
                const attention = card.dataset.attention === 'true';
                let show = false;
                
                if (filter === 'all') {
                    show = true;
                } else if (filter === 'onboarded') {
                    show = status === 'onboarded';
                } else if (filter === 'need-onboarding') {
                    show = status === 'need-onboarding';
                } else if (filter === 'attention') {
                    show = attention;
                }
                
                card.style.display = show ? '' : 'none';
            });
        }

        function openBagEditor(clientId) {
            // Navigate to client detail and switch to Bag tab for editing
            showPage('client-detail');
            showClientTab('bag');
            
            // Show edit mode notification
            alert('üìù Bag Editor Mode\n\nYou can now edit ' + clientId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) + '\'s bag.\n\nIn the real app, this would enable inline editing of all club specifications.');
        }

        // ============================================
        // PRO NAV TABS
        // ============================================
        function showProTab(tabId) {
            // Remove active from all tabs
            document.querySelectorAll('.pro-tab').forEach(t => t.classList.remove('active'));
            
            // Set active on correct tab and show page
            if (tabId === 'clients') {
                document.getElementById('tab-clients')?.classList.add('active');
                showPage('client-list');
            } else if (tabId === 'opportunities') {
                document.getElementById('tab-opportunities')?.classList.add('active');
                showPage('opportunities');
            } else if (tabId === 'settings') {
                document.getElementById('tab-settings')?.classList.add('active');
                showPage('settings');
            }
        }

        // ============================================
        // SETTINGS PAGE
        // ============================================
        function selectBrandColor(color, element) {
            // Update swatches
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
            element.classList.add('active');
            
            // Update CSS variable
            document.documentElement.style.setProperty('--pro-green', color);
            
            // Update preview
            document.getElementById('preview-business-name').style.color = color;
            
            // Update phone preview if exists
            const phoneBusinessName = document.getElementById('phone-business-name');
            if (phoneBusinessName) {
                phoneBusinessName.style.color = color;
            }
            
            // Update header logo
            document.querySelectorAll('.logo-text').forEach(el => {
                el.style.color = color;
            });
            
            // Update gradient elements
            document.querySelectorAll('.btn-pro').forEach(btn => {
                btn.style.background = `linear-gradient(135deg, ${color}, ${adjustColor(color, -30)})`;
            });
            document.querySelectorAll('.user-avatar').forEach(avatar => {
                avatar.style.background = `linear-gradient(135deg, ${color}, ${adjustColor(color, -30)})`;
            });
        }

        function toggleLowCreditsNew() {
            const toggle = document.getElementById('low-credits-toggle');
            toggle.classList.toggle('active');
            
            const isLow = toggle.classList.contains('active');
            
            if (isLow) {
                creditState.pro.used = 488;
                creditState.pro.available = 12;
                creditState.client.used = 28;
                creditState.client.available = 2;
            } else {
                creditState.pro.used = 13;
                creditState.pro.available = 487;
                creditState.client.used = 3;
                creditState.client.available = 27;
            }
            updateCreditsDisplay();
        }

        function toggleGGDemo() {
            const toggle = document.getElementById('gg-toggle');
            toggle.classList.toggle('active');
            
            const isConnected = toggle.classList.contains('active');
            toggleGolfGenius(isConnected);
        }

        // ============================================
        // GRADING ENGINE SETTINGS
        // ============================================
        let currentGradingEngine = 'javascript'; // 'javascript' | 'hybrid' | 'claude'
        
        function updateGradingEngine(engine) {
            currentGradingEngine = engine;
            
            // Update display
            const displayNames = {
                'javascript': 'JavaScript Only',
                'hybrid': 'JavaScript + Claude Review',
                'claude': 'Claude Only'
            };
            document.getElementById('current-engine-display').textContent = displayNames[engine];
            
            // Update visual selection
            ['js', 'hybrid', 'claude'].forEach(e => {
                const label = document.getElementById('engine-' + e + '-label');
                if (label) {
                    if ((e === 'js' && engine === 'javascript') || e === engine) {
                        label.style.borderColor = 'var(--cyan)';
                        label.style.background = 'rgba(0, 212, 212, 0.1)';
                    } else {
                        label.style.borderColor = 'transparent';
                        label.style.background = 'var(--bg-main)';
                    }
                }
            });
            
            // Save to localStorage for persistence
            localStorage.setItem('gradingEngine', engine);
            
            console.log('üß† Grading engine set to:', engine);
        }
        
        // Load saved grading engine on page load
        function loadGradingEnginePreference() {
            const saved = localStorage.getItem('gradingEngine');
            if (saved && ['javascript', 'hybrid', 'claude'].includes(saved)) {
                document.getElementById('engine-' + (saved === 'javascript' ? 'js' : saved)).checked = true;
                updateGradingEngine(saved);
            } else {
                updateGradingEngine('javascript');
            }
        }

        // ============================================
        // FACTOR WEIGHTS
        // ============================================
        const defaultWeights = {
            loft: 20,
            age: 20,
            weight: 15,
            flex: 10,
            kickpoint: 10,
            length: 10,
            lie: 10,
            torque: 5
        };

        function updateWeightDisplay(factor) {
            const slider = document.getElementById('weight-' + factor);
            const display = document.getElementById('weight-' + factor + '-val');
            display.textContent = slider.value + '%';
            
            updateWeightTotal();
        }

        function updateWeightTotal() {
            const factors = ['loft', 'age', 'weight', 'flex', 'kickpoint', 'length', 'lie', 'torque'];
            let total = 0;
            
            factors.forEach(f => {
                const slider = document.getElementById('weight-' + f);
                if (slider) {
                    total += parseInt(slider.value);
                }
            });
            
            const totalDisplay = document.getElementById('weight-total');
            totalDisplay.textContent = total + '%';
            
            if (total === 100) {
                totalDisplay.style.color = 'var(--green)';
            } else if (total > 100) {
                totalDisplay.style.color = 'var(--red)';
            } else {
                totalDisplay.style.color = 'var(--yellow)';
            }
        }

        function resetWeights() {
            Object.keys(defaultWeights).forEach(factor => {
                const slider = document.getElementById('weight-' + factor);
                const display = document.getElementById('weight-' + factor + '-val');
                if (slider && display) {
                    slider.value = defaultWeights[factor];
                    display.textContent = defaultWeights[factor] + '%';
                }
            });
            updateWeightTotal();
        }

        function saveSettings(section) {
            const messages = {
                'branding': '‚úì Branding Saved!\n\nYour white label settings have been updated. Clients will see your new branding.',
                'weights': '‚úì Factor Weights Saved!\n\nBag grades will be recalculated using the new weights.',
                'subscription': '‚úì Subscription Settings Saved!\n\nTier changes applied to your account.'
            };
            
            // Validate weights total if saving weights
            if (section === 'weights') {
                const total = document.getElementById('weight-total').textContent;
                if (total !== '100%') {
                    alert('‚ö†Ô∏è Cannot Save\n\nFactor weights must total 100%. Current total: ' + total);
                    return;
                }
            }
            
            alert(messages[section] || '‚úì Settings saved!');
        }

        // ============================================
        // AI OPPORTUNITIES
        // ============================================
        function filterOpportunities(filter) {
            // Update filter buttons
            document.querySelectorAll('.opp-filter').forEach(f => f.classList.remove('active'));
            event.target.classList.add('active');
            
            // In production, would filter the opportunity cards
            // For demo, just show a message if filtering
            if (filter !== 'all') {
                const filterNames = {
                    'upgrade': 'Upgrade',
                    'fitting': 'Fitting', 
                    'replacement': 'Replacement',
                    'aging': 'Aging Equipment'
                };
                console.log('Filtering by: ' + filterNames[filter]);
            }
        }

        function viewClientOpportunity(clientId) {
            // Navigate to client detail and highlight the opportunity
            showPage('client-detail');
            
            // Update menu to Clients active
            showProTab('clients');
        }

        function runClientScenario(clientId) {
            // Navigate to client and open scenarios
            showPage('client-detail');
            showClientTab('scenarios');
            
            // Update menu to Clients active
            showProTab('clients');
        }

        function contactClient(clientId) {
            const clientNames = {
                'mike': 'Mike Johnson',
                'tom': 'Tom Bradley',
                'sarah': 'Sarah Lee',
                'dave': 'Dave Wilson',
                'jen': 'Jennifer Martinez'
            };
            
            alert('üìß Contact options for ' + (clientNames[clientId] || 'Client') + ':\n\n‚Ä¢ Send in-app message\n‚Ä¢ Schedule fitting session\n‚Ä¢ Share scenario results\n‚Ä¢ Send equipment recommendations\n\nComing in Phase 8!');
        }

        // ============================================
        // CLIENT TABS
        // ============================================
        function showClientTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            
            // Find and highlight the correct tab
            const tabs = document.querySelectorAll('.tabs .tab');
            const tabIndex = ['bag', 'progress', 'scenarios', 'testing', 'events', 'messages'].indexOf(tabId);
            if (tabIndex >= 0 && tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById('tab-' + tabId).style.display = 'block';
            
            // Clear message badge when viewing messages
            if (tabId === 'messages') {
                const badge = document.getElementById('message-badge');
                if (badge) badge.style.display = 'none';
            }
            
            // Initialize scenario tab when entering
            if (tabId === 'scenarios' && typeof renderScenarioClubList === 'function') {
                renderScenarioClubList();
            }
        }

        // ============================================
        // MESSAGING
        // ============================================
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add message to list
            const messagesList = document.getElementById('messages-list');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            const messageHtml = `
                <div class="message-item sent">
                    <div class="message-bubble">${message}</div>
                    <div class="message-meta">You ‚Ä¢ Just now</div>
                </div>
            `;
            
            messagesList.insertAdjacentHTML('beforeend', messageHtml);
            messagesList.scrollTop = messagesList.scrollHeight;
            
            // Clear input
            input.value = '';
            
            // Simulate typing response after delay
            setTimeout(() => {
                simulateTypingResponse();
            }, 1500);
        }

        function handleMessageKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function simulateTypingResponse() {
            const messagesList = document.getElementById('messages-list');
            
            // Add typing indicator
            const typingHtml = `
                <div class="message-item received" id="typing-indicator">
                    <div class="message-bubble" style="color: var(--text-muted);">
                        <span style="animation: pulse 1s infinite;">‚óè</span>
                        <span style="animation: pulse 1s infinite 0.2s;">‚óè</span>
                        <span style="animation: pulse 1s infinite 0.4s;">‚óè</span>
                    </div>
                </div>
            `;
            messagesList.insertAdjacentHTML('beforeend', typingHtml);
            messagesList.scrollTop = messagesList.scrollHeight;
            
            // Replace with actual response
            setTimeout(() => {
                const typing = document.getElementById('typing-indicator');
                if (typing) {
                    typing.outerHTML = `
                        <div class="message-item received">
                            <div class="message-bubble">Sounds good! I'll check my calendar and get back to you shortly. Looking forward to getting that 3-wood dialed in! üèåÔ∏è</div>
                            <div class="message-meta">Mike Johnson ‚Ä¢ Just now</div>
                        </div>
                    `;
                }
                messagesList.scrollTop = messagesList.scrollHeight;
            }, 2000);
        }

        function sendQuickMessage(type) {
            let message = '';
            switch(type) {
                case 'scenario':
                    message = "I just ran a scenario analysis on your bag. Your 3-Wood shaft upgrade would improve your overall grade from B- to B+. Want me to walk you through the details?";
                    break;
                case 'recommendation':
                    message = "Based on your recent rounds and bag analysis, I have a few equipment recommendations that could help lower your scores. When would be a good time to discuss?";
                    break;
                case 'schedule':
                    openModal('schedule-lesson-modal');
                    return;
            }
            
            document.getElementById('message-input').value = message;
            document.getElementById('message-input').focus();
        }

        // ============================================
        // LESSON SCHEDULING
        // ============================================
        let selectedLessonType = null;

        function selectLessonType(element, type) {
            // Remove selected from all
            document.querySelectorAll('.lesson-type-btn').forEach(btn => btn.classList.remove('selected'));
            // Add selected to clicked
            element.classList.add('selected');
            selectedLessonType = type;
        }

        function sendLessonInvite() {
            if (!selectedLessonType) {
                alert('Please select a lesson type');
                return;
            }
            
            const date = document.getElementById('lesson-date').value;
            const time = document.getElementById('lesson-time').value;
            
            if (!date || !time) {
                alert('Please select a date and time');
                return;
            }
            
            const duration = document.getElementById('lesson-duration').value;
            const notes = document.getElementById('lesson-notes').value;
            
            const lessonTypes = {
                'full_swing': 'Full Swing Lesson',
                'short_game': 'Short Game Lesson',
                'putting': 'Putting Lesson',
                'course_management': 'Course Management',
                'playing_lesson': 'Playing Lesson',
                'fitting': 'Club Fitting Session'
            };
            
            // Close modal
            closeModal('schedule-lesson-modal');
            
            // Add message to chat
            const formattedDate = new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            const message = `I'd like to schedule a ${lessonTypes[selectedLessonType]} with you on ${formattedDate} at ${time}. Duration: ${duration} minutes.${notes ? ' Notes: ' + notes : ''} Does this work for you?`;
            
            document.getElementById('message-input').value = message;
            sendMessage();
            
            // Reset form
            selectedLessonType = null;
            document.querySelectorAll('.lesson-type-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('lesson-date').value = '';
            document.getElementById('lesson-time').value = '';
            document.getElementById('lesson-notes').value = '';
        }

        // ============================================
        // COLLAPSIBLE SECTIONS
        // ============================================
        function toggleCollapsible(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('open');
        }

        // ============================================
        // EVENTS
        // ============================================
        function showEventTab(tab) {
            const upcomingBtn = document.getElementById('events-upcoming-btn');
            const pastBtn = document.getElementById('events-past-btn');
            const resultsBtn = document.getElementById('events-results-btn');
            const upcomingContent = document.getElementById('events-upcoming');
            const pastContent = document.getElementById('events-past');
            const resultsContent = document.getElementById('events-results');
            
            // Remove active from all
            upcomingBtn.classList.remove('active');
            pastBtn.classList.remove('active');
            resultsBtn.classList.remove('active');
            
            // Hide all content
            upcomingContent.style.display = 'none';
            pastContent.style.display = 'none';
            resultsContent.style.display = 'none';
            
            // Show selected
            if (tab === 'upcoming') {
                upcomingBtn.classList.add('active');
                upcomingContent.style.display = 'block';
            } else if (tab === 'past') {
                pastBtn.classList.add('active');
                pastContent.style.display = 'block';
            } else if (tab === 'results') {
                resultsBtn.classList.add('active');
                resultsContent.style.display = 'block';
            }
        }

        // Golf Genius Integration
        let ggConnected = true;

        function toggleGolfGenius(connected) {
            ggConnected = connected;
            const status = document.getElementById('gg-status');
            const connectedContent = document.getElementById('gg-connected-content');
            const disconnectedContent = document.getElementById('gg-disconnected-content');
            
            if (connected) {
                status.textContent = '‚úì Connected';
                status.classList.add('connected');
                status.classList.remove('not-connected');
                connectedContent.style.display = 'block';
                disconnectedContent.style.display = 'none';
            } else {
                status.textContent = 'Not Connected';
                status.classList.remove('connected');
                status.classList.add('not-connected');
                connectedContent.style.display = 'none';
                disconnectedContent.style.display = 'block';
            }
        }

        function connectGolfGenius() {
            alert('üîó Golf Genius Connection\n\nThis would open OAuth flow to connect your Golf Genius account.\n\nFor demo: Simulating connection...');
            setTimeout(() => {
                toggleGolfGenius(true);
                alert('‚úì Connected to Golf Genius!\n\nSyncing events from Falmouth Country Club...');
            }, 500);
        }

        function syncGolfGenius() {
            const btn = event.target;
            btn.textContent = '‚è≥ Syncing...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.textContent = 'üîÑ Sync';
                btn.disabled = false;
                alert('‚úì Golf Genius Synced!\n\n‚Ä¢ 8 events updated\n‚Ä¢ 2 new registrations found\n‚Ä¢ League standings refreshed');
            }, 1500);
        }

        function viewGGEvent() {
            alert('üîó Opening Golf Genius...\n\nThis would open the event details in Golf Genius portal.');
        }

        function viewLeaderboard() {
            alert('üèÜ Opening Leaderboard...\n\nThis would open the live leaderboard in Golf Genius.');
        }

        function viewGGResults() {
            alert('üìä Opening Results...\n\nThis would open the full results and scorecard in Golf Genius.');
        }

        function registerGGEvent() {
            alert('‚úì Registration Started!\n\nThis would open the Golf Genius registration form for this event.');
        }

        function saveEvent() {
            const eventType = document.getElementById('event-type').value;
            const eventName = document.getElementById('event-name').value;
            const eventDate = document.getElementById('event-date').value;
            
            if (!eventType || !eventName || !eventDate) {
                alert('Please fill in required fields (Type, Name, Date)');
                return;
            }
            
            closeModal('add-event-modal');
            
            const isClientView = document.body.classList.contains('client-view');
            if (isClientView) {
                alert('‚úì Event Added!\n\nThis personal event has been added to your calendar.');
            } else {
                alert('‚úì Event Created!\n\nThis event will now appear in your clients\' Events tab.');
            }
            
            // Reset form
            document.getElementById('event-type').value = '';
            document.getElementById('event-name').value = '';
            document.getElementById('event-date').value = '';
            document.getElementById('event-time').value = '';
            document.getElementById('event-location').value = '';
            document.getElementById('event-price').value = '';
            document.getElementById('event-description').value = '';
        }

        function saveLoggedLesson() {
            const client = document.getElementById('lesson-client').value;
            const lessonType = document.getElementById('lesson-type-log').value;
            const lessonDate = document.getElementById('lesson-date-log').value;
            
            if (!client || !lessonType || !lessonDate) {
                alert('Please fill in required fields (Client, Lesson Type, Date)');
                return;
            }
            
            const clientNames = {
                'mike': 'Mike Johnson',
                'sarah': 'Sarah Williams',
                'tom': 'Tom Anderson',
                'david': 'David Chen',
                'emily': 'Emily Rodriguez',
                'james': 'James Wilson',
                'lisa': 'Lisa Thompson',
                'robert': 'Robert Garcia'
            };
            
            const lessonTypes = {
                'full_swing': 'Full Swing',
                'short_game': 'Short Game',
                'putting': 'Putting',
                'course_mgmt': 'Course Management',
                'playing': 'Playing Lesson',
                'fitting': 'Club Fitting'
            };
            
            closeModal('log-lesson-modal');
            alert(`‚úì Lesson Logged!\n\n${lessonTypes[lessonType]} lesson with ${clientNames[client]} has been recorded.\n\nThis will appear on their Progress tab and Events list.`);
            
            // Reset form
            document.getElementById('lesson-client').value = '';
            document.getElementById('lesson-type-log').value = '';
            document.getElementById('lesson-date-log').value = '';
            document.getElementById('lesson-time-log').value = '';
            document.getElementById('lesson-duration-log').value = '60';
            document.getElementById('lesson-notes-log').value = '';
        }

        // ============================================
        // CLIENT ONBOARDING
        // ============================================
        let onboardingState = {
            step: 1,
            clientName: '',
            clientEmail: '',
            clientGhin: '',
            clientHandicap: null,
            inviteCode: '',
            clientId: null  // Store created client ID
        };

        async function goToOnboardStep(step) {
            // Validate current step before proceeding
            if (step > onboardingState.step) {
                if (onboardingState.step === 1) {
                    const name = document.getElementById('onboard-name').value.trim();
                    const email = document.getElementById('onboard-email').value.trim();
                    
                    if (!name) {
                        alert('Please enter the client\'s name');
                        return;
                    }
                    if (!email || !email.includes('@')) {
                        alert('Please enter a valid email address');
                        return;
                    }
                    
                    onboardingState.clientName = name;
                    onboardingState.clientEmail = email;
                    onboardingState.clientGhin = document.getElementById('onboard-ghin').value.trim();
                    
                    // Generate invite code
                    generateInviteCode();
                    
                    // Create client record in Firestore
                    try {
                        const continueBtn = document.querySelector('#onboard-step-1 .btn-primary');
                        if (continueBtn) {
                            continueBtn.disabled = true;
                            continueBtn.textContent = 'Creating...';
                        }
                        
                        const client = await createClientRecord({
                            name: onboardingState.clientName,
                            email: onboardingState.clientEmail,
                            ghin: onboardingState.clientGhin,
                            handicap: onboardingState.clientHandicap,
                            inviteCode: onboardingState.inviteCode
                        });
                        
                        onboardingState.clientId = client.id;
                        console.log('‚úÖ Client created:', client.id);
                        
                        if (continueBtn) {
                            continueBtn.disabled = false;
                            continueBtn.textContent = 'Continue ‚Üí';
                        }
                    } catch (error) {
                        console.error('‚ùå Failed to create client:', error);
                        alert('Failed to create client: ' + error.message);
                        
                        const continueBtn = document.querySelector('#onboard-step-1 .btn-primary');
                        if (continueBtn) {
                            continueBtn.disabled = false;
                            continueBtn.textContent = 'Continue ‚Üí';
                        }
                        return;
                    }
                }
            }
            
            // Update steps visibility
            document.querySelectorAll('.onboarding-step').forEach(s => s.classList.remove('active'));
            document.getElementById('onboard-step-' + step).classList.add('active');
            
            // Update progress dots
            document.querySelectorAll('.onboarding-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'complete');
                if (i + 1 < step) {
                    dot.classList.add('complete');
                } else if (i + 1 === step) {
                    dot.classList.add('active');
                }
            });
            
            onboardingState.step = step;
        }

        function generateInviteCode() {
            // Generate a random invite code
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'FGA-';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            onboardingState.inviteCode = code;
            document.getElementById('invite-code').textContent = code;
            document.getElementById('invite-link').value = `https://fitmygolfclubs.com/join/${code}`;
        }

        async function lookupGHIN() {
            const ghinInput = document.getElementById('onboard-ghin').value.trim();
            const resultDiv = document.getElementById('ghin-lookup-result');
            
            if (!ghinInput || ghinInput.length < 7) {
                showToast('Please enter a valid GHIN number (7-8 digits)', 'error');
                return;
            }
            
            // Show loading
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color: var(--text-muted);">Looking up GHIN...</div>';
            
            try {
                // Call Cloud Function
                const lookupGhinNumber = firebase.functions().httpsCallable('lookupGhinNumber');
                const result = await lookupGhinNumber({ ghinNumber: ghinInput });
                
                if (result.data) {
                    const golfer = result.data;
                    resultDiv.innerHTML = `
                        <div class="ghin-lookup-result">
                            <div class="lookup-name">‚úì Found: ${golfer.name}</div>
                            <div class="lookup-details">Handicap Index: ${golfer.handicap || 'N/A'} ‚Ä¢ ${golfer.club || ''} ${golfer.state || ''}</div>
                        </div>
                    `;
                    
                    // Auto-fill name if empty
                    const nameInput = document.getElementById('onboard-name');
                    if (nameInput && !nameInput.value.trim()) {
                        nameInput.value = golfer.name;
                    }
                    
                    // Store handicap for later use
                    if (typeof onboardingState !== 'undefined') {
                        onboardingState.clientHandicap = golfer.handicap;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="ghin-lookup-result not-found">
                            <div style="color: var(--yellow);">‚ö†Ô∏è GHIN not found</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">Please verify the number or continue without lookup</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('GHIN lookup error:', error);
                resultDiv.innerHTML = `
                    <div class="ghin-lookup-result not-found">
                        <div style="color: var(--yellow);">‚ö†Ô∏è Could not verify GHIN</div>
                        <div style="color: var(--text-secondary); font-size: 12px;">${error.message || 'Service temporarily unavailable'}</div>
                    </div>
                `;
            }
        }

        async function lookupProfileGHIN() {
            const ghinInput = document.getElementById('profile-ghin').value.trim();
            const resultDiv = document.getElementById('profile-ghin-result');
            
            if (!ghinInput || ghinInput.length < 7) {
                showToast('Please enter a valid GHIN number (7-8 digits)', 'error');
                return;
            }
            
            // Show loading
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'var(--bg-card)';
            resultDiv.innerHTML = '<div style="color: var(--text-muted);">üîç Looking up GHIN...</div>';
            
            try {
                // Call Cloud Function
                const lookupGhinNumber = firebase.functions().httpsCallable('lookupGhinNumber');
                const result = await lookupGhinNumber({ ghinNumber: ghinInput });
                
                if (result.data) {
                    const golfer = result.data;
                    resultDiv.style.background = 'var(--green-dim)';
                    resultDiv.innerHTML = `
                        <div style="color: var(--green);">‚úì Found: ${golfer.name}</div>
                        <div style="color: var(--text-secondary);">Handicap: ${golfer.handicap || 'N/A'} ‚Ä¢ ${golfer.club || ''}</div>
                    `;
                    
                    // Auto-fill handicap if found
                    if (golfer.handicap) {
                        document.getElementById('profile-handicap').value = golfer.handicap;
                    }
                    
                    // Auto-fill name fields if empty
                    const firstNameInput = document.getElementById('profile-first-name');
                    const lastNameInput = document.getElementById('profile-last-name');
                    if (golfer.name && firstNameInput && !firstNameInput.value.trim()) {
                        const nameParts = golfer.name.split(' ');
                        firstNameInput.value = nameParts[0] || '';
                        lastNameInput.value = nameParts.slice(1).join(' ') || '';
                    }
                } else {
                    resultDiv.style.background = 'var(--yellow-dim)';
                    resultDiv.innerHTML = `
                        <div style="color: var(--yellow);">‚ö†Ô∏è GHIN not found</div>
                        <div style="color: var(--text-secondary);">Verify the number or enter handicap manually</div>
                    `;
                }
            } catch (error) {
                console.error('GHIN lookup error:', error);
                resultDiv.style.background = 'var(--red-dim)';
                resultDiv.innerHTML = `
                    <div style="color: var(--red);">‚ö†Ô∏è Lookup failed</div>
                    <div style="color: var(--text-secondary);">${error.message || 'Service temporarily unavailable'}</div>
                `;
            }
        }
        
        function switchProfileTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.profile-tab-content').forEach(content => content.classList.remove('active'));
            const targetContent = document.getElementById('profile-tab-' + tabId);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }
        
        async function saveProfile() {
            // Gather form data
            const profileData = {
                firstName: document.getElementById('profile-first-name')?.value?.trim() || '',
                lastName: document.getElementById('profile-last-name')?.value?.trim() || '',
                email: document.getElementById('profile-email')?.value?.trim() || '',
                ghinNumber: document.getElementById('profile-ghin')?.value?.trim() || '',
                handicap: parseFloat(document.getElementById('profile-handicap')?.value) || null,
                age: parseInt(document.getElementById('profile-age')?.value) || null,
                gender: document.getElementById('profile-gender')?.value || '',
                handedness: document.getElementById('profile-handedness')?.value || 'right',
                // Swing tab
                swingSpeed: parseFloat(document.getElementById('profile-swing-speed')?.value) || null,
                tempo: document.getElementById('profile-tempo')?.value || '',
                // Add more fields as needed
            };
            
            console.log('Saving profile:', profileData);
            
            // TODO: Save to Firestore
            // For now, just show success
            showToast('Profile saved successfully!', 'success');
            closeModal('profile-modal');
        }
        
        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('profile-picture-img');
                const initials = document.getElementById('profile-initials');
                
                img.src = e.target.result;
                img.style.display = 'block';
                initials.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function copyInviteLink() {
            const linkInput = document.getElementById('invite-link');
            linkInput.select();
            document.execCommand('copy');
            
            // Show feedback
            const copyBtn = event.target;
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            copyBtn.style.background = 'var(--green)';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = '';
            }, 2000);
        }

        function shareViaEmail() {
            const subject = encodeURIComponent('Join me on FitMyGolfClubs');
            const body = encodeURIComponent(`Hi ${onboardingState.clientName || 'there'},\n\nI'd like to invite you to join FitMyGolfClubs so I can help analyze and optimize your golf equipment.\n\nUse this link to sign up: https://fitmygolfclubs.com/join/${onboardingState.inviteCode}\n\nOr enter code: ${onboardingState.inviteCode}\n\nLooking forward to helping you improve your game!\n\nBest,\nYour Golf Pro`);
            
            window.open(`mailto:${onboardingState.clientEmail}?subject=${subject}&body=${body}`);
        }

        function shareViaSMS() {
            const body = encodeURIComponent(`Hi! Join me on FitMyGolfClubs to get your equipment analyzed. Sign up here: https://fitmygolfclubs.com/join/${onboardingState.inviteCode}`);
            window.open(`sms:?body=${body}`);
        }

        /**
         * Add bag now - closes modal and opens BagOnboarding for the new client
         */
        function addBagNowFromOnboarding() {
            if (!onboardingState.clientId) {
                alert('Client not created yet');
                return;
            }
            
            closeModal('onboarding-modal');
            
            // Small delay to let modal close animation complete
            setTimeout(() => {
                if (typeof startBagOnboardingForNewClient === 'function') {
                    startBagOnboardingForNewClient(onboardingState.clientId);
                } else if (typeof addBagForClient === 'function') {
                    addBagForClient(onboardingState.clientId);
                } else {
                    console.error('Bag onboarding functions not available');
                    showToast('Bag onboarding not available', 'error');
                }
                
                resetOnboarding();
            }, 300);
        }

        /**
         * Finish with invite only - client will enter their own bag
         */
        function finishWithInviteOnly() {
            closeModal('onboarding-modal');
            
            if (typeof showToast === 'function') {
                showToast(`Client added! Invite sent to ${onboardingState.clientEmail}`, 'success');
            } else {
                alert(`‚úÖ Client added!\n\nInvite code: ${onboardingState.inviteCode}\nThey can enter their own bag via the app.`);
            }
            
            resetOnboarding();
        }

        function finishOnboarding() {
            closeModal('onboarding-modal');
            resetOnboarding();
            
            // Show success message
            if (typeof showToast === 'function') {
                showToast('Client added successfully!', 'success');
            } else {
                alert('‚úÖ Client added!');
            }
        }

        function addAnotherClient() {
            resetOnboarding();
            goToOnboardStep(1);
        }

        function resetOnboarding() {
            onboardingState = {
                step: 1,
                clientName: '',
                clientEmail: '',
                clientGhin: '',
                clientHandicap: null,
                inviteCode: '',
                clientId: null
            };
            
            // Clear form
            document.getElementById('onboard-name').value = '';
            document.getElementById('onboard-email').value = '';
            document.getElementById('onboard-ghin').value = '';
            document.getElementById('ghin-lookup-result').style.display = 'none';
            
            // Reset to step 1
            document.querySelectorAll('.onboarding-step').forEach(s => s.classList.remove('active'));
            document.getElementById('onboard-step-1').classList.add('active');
            document.querySelectorAll('.onboarding-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'complete');
                if (i === 0) dot.classList.add('active');
            });
        }

        // ============================================
        // GHIN / HANDICAP
        // ============================================
        let ghinState = {
            connected: true,
            ghinNumber: '1234567',
            handicapIndex: 10.4,
            lastSync: new Date()
        };

        function syncGHIN() {
            const ghinInput = document.getElementById('ghin-number').value;
            const syncBtn = document.getElementById('ghin-sync-btn');
            const syncBtnText = document.getElementById('sync-btn-text');
            
            if (!ghinInput || ghinInput.length < 7) {
                alert('Please enter a valid GHIN number (7-8 digits)');
                return;
            }
            
            // Show loading state
            syncBtn.disabled = true;
            syncBtnText.textContent = '‚è≥ Syncing...';
            
            // Simulate API call
            setTimeout(() => {
                ghinState.connected = true;
                ghinState.ghinNumber = ghinInput;
                ghinState.lastSync = new Date();
                
                // Update UI
                document.getElementById('ghin-status').textContent = '‚úì Connected';
                document.getElementById('ghin-status').className = 'ghin-status connected';
                document.getElementById('ghin-last-sync').textContent = 'Last synced: Just now';
                
                // Show handicap data
                document.getElementById('handicap-display').style.display = 'block';
                
                syncBtn.disabled = false;
                syncBtnText.textContent = 'üîÑ Sync';
                
                alert('‚úÖ GHIN synced successfully!\n\nHandicap Index: 10.4\nRounds Posted: 24');
            }, 1500);
        }

        function setTrendPeriod(period) {
            document.querySelectorAll('.trend-period-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            // In production, would update chart data
        }

        function viewAllRounds() {
            alert('üìã Full rounds history would show here.\n\nIn production, this would display:\n‚Ä¢ All posted rounds\n‚Ä¢ Score breakdown\n‚Ä¢ Differential calculations\n‚Ä¢ Course ratings');
        }

        // ============================================
        // DEMO CONTROLS
        // ============================================
        
        // Credit System State
        let creditState = {
            pro: {
                monthly: 500,
                used: 13,
                available: 487
            },
            client: {
                monthly: 30,
                used: 3,
                purchased: 0,
                available: 27,
                tier: 'paid', // 'free' or 'paid'
                freeTrials: {
                    scenarios: 1,
                    performance: 1
                }
            }
        };

        function updateProTier() {
            const tier = document.getElementById('pro-tier').value;
            // All tiers get 500 credits (per spec)
            creditState.pro.monthly = 500;
            updateCreditsDisplay();
        }

        function updateClientTier() {
            const tier = document.getElementById('client-tier').value;
            creditState.client.tier = tier;
            
            if (tier === 'free') {
                creditState.client.monthly = 0;
                creditState.client.available = 0;
            } else {
                creditState.client.monthly = 30;
                creditState.client.available = creditState.client.monthly - creditState.client.used + creditState.client.purchased;
            }
            
            updateCreditsDisplay();
            updateClientUI();
        }

        function updateCreditsDisplay() {
            // Pro header display
            const creditsDisplay = document.querySelector('.credits-display');
            const creditsValue = document.querySelector('.credits-value');
            
            creditsValue.textContent = `${creditState.pro.available}/${creditState.pro.monthly}`;
            
            if (creditState.pro.available < 50) {
                creditsDisplay.classList.add('low');
            } else {
                creditsDisplay.classList.remove('low');
            }
            
            // Pro modal
            const proUsageFill = document.getElementById('pro-usage-fill');
            const proUsageText = document.getElementById('pro-usage-text');
            const proUsed = document.getElementById('pro-used');
            const proAvailable = document.getElementById('pro-available');
            
            if (proUsageFill) {
                const proPercent = (creditState.pro.available / creditState.pro.monthly) * 100;
                proUsageFill.style.width = proPercent + '%';
                proUsageFill.className = 'usage-fill' + (proPercent < 20 ? ' critical' : proPercent < 40 ? ' warning' : '');
            }
            if (proUsageText) proUsageText.textContent = `${creditState.pro.available} / ${creditState.pro.monthly}`;
            if (proUsed) proUsed.textContent = creditState.pro.used;
            if (proAvailable) proAvailable.textContent = creditState.pro.available;
            
            // Client display (phone)
            const phoneCredits = document.querySelector('.phone-credits');
            if (phoneCredits) {
                if (creditState.client.tier === 'free') {
                    phoneCredits.textContent = 'üîí Free';
                    phoneCredits.style.background = 'var(--yellow-dim)';
                    phoneCredits.style.color = 'var(--yellow)';
                } else {
                    phoneCredits.textContent = `‚ö° ${creditState.client.available}`;
                    phoneCredits.style.background = 'var(--cyan-dim)';
                    phoneCredits.style.color = 'var(--cyan)';
                }
            }
            
            // Client modal
            const clientUsageFill = document.getElementById('client-usage-fill');
            const clientUsageText = document.getElementById('client-usage-text');
            
            if (clientUsageFill && creditState.client.tier === 'paid') {
                const clientPercent = (creditState.client.available / creditState.client.monthly) * 100;
                clientUsageFill.style.width = clientPercent + '%';
                clientUsageFill.className = 'usage-fill' + (clientPercent < 20 ? ' critical' : clientPercent < 40 ? ' warning' : '');
            }
            if (clientUsageText) clientUsageText.textContent = `${creditState.client.available} / ${creditState.client.monthly}`;
        }

        function updateClientUI() {
            // Show/hide elements based on client tier
            const isFree = creditState.client.tier === 'free';
            
            // Update contact pro button text for free clients
            const contactBtn = document.getElementById('client-contact-btn');
            if (contactBtn) {
                if (isFree) {
                    contactBtn.innerHTML = 'üîì Upgrade for Full Access';
                    contactBtn.onclick = () => openModal('paywall-modal');
                } else {
                    contactBtn.innerHTML = 'üí¨ Contact Your Pro';
                    contactBtn.onclick = () => openModal('contact-pro-modal');
                }
            }
        }

        // ============================================
        // MODALS
        // ============================================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        /**
         * Show baseline explanation modal
         */
        function showBaselineModal(type) {
            const titleEl = document.getElementById('baseline-modal-title');
            const bodyEl = document.getElementById('baseline-modal-body');
            
            if (type === 'favorite') {
                const clubType = document.getElementById('baseline-club-type')?.textContent || '7-Iron';
                titleEl.innerHTML = '‚òÖ Favorite Club Baseline';
                titleEl.style.color = '#ffd700';
                bodyEl.innerHTML = `
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 48px; margin-bottom: 8px;">‚òÖ</div>
                        <div style="font-size: 18px; font-weight: 600; color: #ffd700;">${clubType} Selected as Baseline</div>
                        <div style="margin-top: 6px;"><span style="background: rgba(255,215,0,0.2); color: #ffd700; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">PATENT PENDING</span></div>
                    </div>
                    <div style="background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">What This Means</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                            Your ${clubType} has been identified as your best-fit club. The <strong>Weight Progression</strong> factor now grades your entire bag against this club's shaft weight as the ideal baseline.
                        </div>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                        <strong>Why it matters:</strong> Instead of comparing your clubs to generic industry standards, we compare them to what actually works for YOUR swing. This makes the grading more personalized and actionable.
                    </div>
                    <div style="margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; font-size: 12px; color: var(--text-muted);">
                        <span style="color: #ffd700;">üí°</span> You can change your favorite club in the Swing tab of your Profile.
                    </div>
                `;
            } else if (type === 'bodyfit') {
                const heightDisplay = window.currentAnalysisData?.body_fit_baseline?.heightDisplay || '--';
                const wtf = window.currentAnalysisData?.body_fit_baseline?.wristToFloor || '--';
                titleEl.innerHTML = 'üìè Body Fit Baseline';
                titleEl.style.color = '#00CED1';
                bodyEl.innerHTML = `
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 48px; margin-bottom: 8px;">üìè</div>
                        <div style="font-size: 18px; font-weight: 600; color: #00CED1;">Personalized Length Grading</div>
                        <div style="margin-top: 6px;"><span style="background: rgba(0,206,209,0.2); color: #00CED1; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">PATENT PENDING</span></div>
                    </div>
                    <div style="background: rgba(0,206,209,0.1); border: 1px solid rgba(0,206,209,0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Your Measurements</div>
                        <div style="display: flex; justify-content: center; gap: 24px; font-size: 14px;">
                            <div><span style="color: var(--text-muted);">Height:</span> <strong>${heightDisplay}</strong></div>
                            <div><span style="color: var(--text-muted);">WTF:</span> <strong>${wtf}"</strong></div>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                        <strong>What This Means:</strong> Using the <strong>Wishon method</strong> of club fitting, the <strong>Length Progression</strong> factor grades your clubs against ideal lengths calculated specifically for YOUR body measurements‚Äînot generic "standard" lengths.
                    </div>
                    <div style="margin-top: 12px; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                        <strong>Why it matters:</strong> A 5'6" golfer and a 6'2" golfer shouldn't be graded against the same length standards. Body Fit ensures your grade reflects whether YOUR clubs fit YOUR body.
                    </div>
                    <div style="margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; font-size: 12px; color: var(--text-muted);">
                        <span style="color: #00CED1;">üí°</span> Update your measurements in the Swing tab of your Profile.
                    </div>
                `;
            }
            
            openModal('baseline-modal');
        }

        // ============================================
        // GENERIC CONFIRMATION MODAL
        // ============================================
        let confirmModalResolve = null;
        
        /**
         * Show a styled confirmation modal (replaces browser confirm())
         * @param {string} title - Modal title
         * @param {string} message - Modal message (supports newlines)
         * @param {string} okText - Text for OK button (default: "OK")
         * @returns {Promise<boolean>} - Resolves true if confirmed, false if cancelled
         */
        function showConfirmModal(title, message, okText = 'OK') {
            return new Promise((resolve) => {
                confirmModalResolve = resolve;
                
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-message').textContent = message;
                document.getElementById('confirm-modal-ok').textContent = okText;
                
                document.getElementById('confirm-modal').style.display = 'flex';
            });
        }
        
        /**
         * Resolve the confirmation modal
         * @param {boolean} result - true if confirmed, false if cancelled
         */
        function resolveConfirmModal(result) {
            document.getElementById('confirm-modal').style.display = 'none';
            if (confirmModalResolve) {
                confirmModalResolve(result);
                confirmModalResolve = null;
            }
        }

        // Show login modal
        function showLoginModal() {
            // If already logged in, show logout option
            if (typeof currentUser !== 'undefined' && currentUser) {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('signup-form').style.display = 'none';
                document.getElementById('logout-section').style.display = 'block';
                document.getElementById('logged-in-email').textContent = currentUser.email;
            } else {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
                document.getElementById('logout-section').style.display = 'none';
                showAuthTab('login');
            }
            openModal('login-modal');
        }

        // Auth tab switching
        function showAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            
            if (tab === 'login') {
                loginTab.style.color = 'var(--cyan)';
                loginTab.style.borderBottomColor = 'var(--cyan)';
                signupTab.style.color = 'var(--text-muted)';
                signupTab.style.borderBottomColor = 'transparent';
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                signupTab.style.color = 'var(--pro-green)';
                signupTab.style.borderBottomColor = 'var(--pro-green)';
                loginTab.style.color = 'var(--text-muted)';
                loginTab.style.borderBottomColor = 'transparent';
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            }
        }

        // Close modal on outside click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            }
        });

        function openCreditsModal() {
            // Show appropriate modal based on current view
            if (document.body.classList.contains('pro-view')) {
                openModal('pro-credits-modal');
            } else {
                if (creditState.client.tier === 'free') {
                    openModal('paywall-modal');
                } else {
                    openModal('client-credits-modal');
                }
            }
        }

        let selectedCreditPack = null;
        
        function selectCreditPack(amount) {
            selectedCreditPack = amount;
            document.querySelectorAll('.credit-pack').forEach(p => p.classList.remove('selected'));
            event.target.closest('.credit-pack').classList.add('selected');
            
            const buyBtn = document.getElementById('buy-credits-btn');
            if (buyBtn) {
                buyBtn.disabled = false;
                buyBtn.textContent = `Buy ${amount} Credits`;
            }
        }

        // Action handlers that check credits
        function runScenario(clubName) {
            if (creditState.client.tier === 'free') {
                if (creditState.client.freeTrials.scenarios > 0) {
                    creditState.client.freeTrials.scenarios--;
                    alert(`Running free scenario for ${clubName}. You have ${creditState.client.freeTrials.scenarios} free trials remaining.`);
                } else {
                    openModal('paywall-modal');
                }
            } else if (creditState.client.available < 1) {
                openModal('no-credits-modal');
            } else {
                creditState.client.used++;
                creditState.client.available--;
                updateCreditsDisplay();
                alert(`Scenario started for ${clubName}! (1 credit used)`);
            }
        }

        function runPerformanceTest(clubName) {
            if (creditState.client.tier === 'free') {
                if (creditState.client.freeTrials.performance > 0) {
                    creditState.client.freeTrials.performance--;
                    alert(`Running free performance test for ${clubName}. You have ${creditState.client.freeTrials.performance} free trials remaining.`);
                } else {
                    openModal('paywall-modal');
                }
            } else if (creditState.client.available < 1) {
                openModal('no-credits-modal');
            } else {
                creditState.client.used++;
                creditState.client.available--;
                updateCreditsDisplay();
                alert(`Performance test started for ${clubName}! (1 credit used)`);
            }
        }

        // ============================================
        // CLUB MENU FUNCTIONS
        // ============================================
        let activeClubMenu = null;

        function toggleClubMenu(btn, clubId) {
            event.stopPropagation();
            const menu = document.getElementById('club-menu-' + clubId);
            
            // Close any other open menu
            if (activeClubMenu && activeClubMenu !== menu) {
                activeClubMenu.classList.remove('show');
            }
            
            // Toggle this menu
            menu.classList.toggle('show');
            activeClubMenu = menu.classList.contains('show') ? menu : null;
        }

        // Close menu when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (activeClubMenu && !e.target.closest('.club-menu-wrapper')) {
                activeClubMenu.classList.remove('show');
                activeClubMenu = null;
            }
        });

        // Club management functions (editClub, deleteClub, openAddClubModal) are now in firebase-auth.js

        // Factor data for modal
        const factorData = {
            'weight': {
                name: 'Weight Progression',
                grade: 'D+',
                gradeClass: 'd',
                weight: '15% of overall grade',
                description: 'Weight progression measures whether your club weights increase smoothly from driver to wedges. Proper progression helps maintain consistent swing tempo and shot control throughout your bag.',
                clubs: [
                    { name: 'Driver', value: '310g ‚úì', status: 'good' },
                    { name: '3-Wood', value: '335g ‚ö†Ô∏è +25g jump', status: 'issue' },
                    { name: '4-Hybrid', value: '355g ‚úì', status: 'good' },
                    { name: '5-Iron', value: '420g ‚úì', status: 'good' }
                ],
                aiAnalysis: '<strong>The Issue:</strong> Your 3-wood shaft (90g) is significantly heavier than your driver shaft (65g), creating a 25g jump instead of the ideal 10-15g progression. This weight inconsistency can cause tempo issues and make it harder to hit your 3-wood consistently off the deck.<br><br><strong>Recommendation:</strong> Consider a lighter shaft for your 3-wood in the 70-75g range, like the Fujikura Ventus Blue 7S. This would smooth your weight progression and improve consistency.',
                proInsight: '<strong>Mike is aware of this issue</strong> ‚Äî he\'s mentioned inconsistency with his 3-wood off the fairway. This is a high-confidence reshaft opportunity (~$175-250). The TaylorMade Fitting Day on Feb 15 would be perfect timing to address this. Consider sending him a message about it.'
            },
            'flex': {
                name: 'Shaft Flex Consistency',
                grade: 'C',
                gradeClass: 'c',
                weight: '10% of overall grade',
                description: 'Shaft flex consistency measures whether all your clubs have matching flex ratings appropriate for your swing speed. Mismatched flex can cause unpredictable ball flight.',
                clubs: [
                    { name: 'Driver', value: 'Stiff ‚úì', status: 'good' },
                    { name: '3-Wood', value: 'Stiff ‚úì', status: 'good' },
                    { name: '4-Hybrid', value: 'Regular ‚ö†Ô∏è', status: 'issue' },
                    { name: 'Irons', value: 'Stiff ‚úì', status: 'good' }
                ],
                aiAnalysis: '<strong>The Issue:</strong> Your 4-Hybrid has a Regular flex shaft while the rest of your bag is Stiff. This can cause the hybrid to feel "whippy" and produce higher, less controlled shots compared to your other clubs.<br><br><strong>Recommendation:</strong> Reshaft the 4-Hybrid to a Stiff flex shaft, or consider replacing with a newer hybrid that comes stock with your preferred flex.',
                proInsight: '<strong>Quick win opportunity</strong> ‚Äî This is an easy reshaft or trade-in conversation. Mike\'s handicap suggests Stiff is correct for his swing speed. The Cobra hybrid is also 2 years old, making a full club upgrade a reasonable option (~$250-350).'
            },
            'loft': {
                name: 'Loft Gapping',
                grade: 'A-',
                gradeClass: 'a',
                weight: '20% of overall grade',
                description: 'Loft gapping measures whether there are consistent degree intervals between clubs to create predictable distance gaps. Proper gapping eliminates distance "holes" in your bag.',
                clubs: [
                    { name: 'Driver ‚Üí 3W', value: '4.5¬∞ gap ‚úì', status: 'good' },
                    { name: '3W ‚Üí 4H', value: '6¬∞ gap ‚úì', status: 'good' },
                    { name: '4H ‚Üí 5H', value: '4¬∞ gap ‚úì', status: 'good' },
                    { name: 'PW ‚Üí GW', value: '4¬∞ gap ‚úì', status: 'good' }
                ],
                aiAnalysis: '<strong>Great news:</strong> Your loft gapping is excellent! You have consistent 4-6¬∞ gaps throughout your bag, which translates to predictable 10-15 yard distance gaps between clubs.<br><br><strong>One minor note:</strong> Your wedge setup (52¬∞, 56¬∞, 60¬∞) follows the standard 4¬∞ progression. If you find a distance gap between PW and 52¬∞, consider a 50¬∞ gap wedge.',
                proInsight: '<strong>No immediate sales opportunity</strong> ‚Äî Loft gapping is a strength. Use this as a positive talking point when discussing other equipment changes. Could mention wedge fitting if Mike wants to dial in scoring club distances.'
            },
            'age': {
                name: 'Club Age',
                grade: 'B+',
                gradeClass: 'b',
                weight: '20% of overall grade',
                description: 'Club age evaluates how current your equipment is. While older clubs can still perform, technology improvements typically provide meaningful benefits every 3-5 years.',
                clubs: [
                    { name: 'Driver', value: '2023 (1 yr) ‚úì', status: 'good' },
                    { name: '3-Wood', value: '2023 (1 yr) ‚úì', status: 'good' },
                    { name: '4-Hybrid', value: '2022 (2 yr)', status: 'good' },
                    { name: 'Wedges', value: '2020 (4 yr) ‚ö†Ô∏è', status: 'issue' }
                ],
                aiAnalysis: '<strong>Overall Assessment:</strong> Your woods are current and performing well. Your wedges (2020 Vokey SM8) are 4 years old ‚Äî wedge grooves typically lose effectiveness after 75-100 rounds due to wear.<br><br><strong>Recommendation:</strong> Consider updating your wedges within the next 6-12 months. New Vokey SM10s or Cleveland RTX ZipCores would restore spin performance around the greens.',
                proInsight: '<strong>Wedge upgrade is the play</strong> ‚Äî Mike plays frequently (his GHIN shows 30+ rounds this year). At that volume, his wedge grooves are likely worn. This is a $400-500 opportunity for a 3-wedge set. His short game lesson history suggests he cares about scoring.'
            },
            'kickpoint': {
                name: 'Kickpoint Consistency',
                grade: 'B',
                gradeClass: 'b',
                weight: '10% of overall grade',
                description: 'Kickpoint (or bend point) affects launch angle and ball flight. Consistent kickpoints across your bag help produce predictable trajectories.',
                clubs: [
                    { name: 'Driver', value: 'Mid ‚úì', status: 'good' },
                    { name: '3-Wood', value: 'Mid ‚úì', status: 'good' },
                    { name: '4-Hybrid', value: 'Low-Mid', status: 'good' },
                    { name: '5-Hybrid', value: 'Mid ‚úì', status: 'good' }
                ],
                aiAnalysis: '<strong>Good consistency:</strong> Your shafts are predominantly mid-kickpoint, which produces a moderate ball flight. This suits your 10-handicap game well.<br><br><strong>Note:</strong> The 4-Hybrid has a slightly lower kickpoint which may launch a bit higher than your other clubs. This isn\'t necessarily bad for a rescue club but worth noting.',
                proInsight: '<strong>Low priority</strong> ‚Äî Kickpoint is reasonably consistent. If addressing the 4-Hybrid for flex issues, could mention kickpoint matching as an additional benefit of a new shaft.'
            },
            'length': {
                name: 'Length Progression',
                grade: 'A',
                gradeClass: 'a',
                weight: '10% of overall grade',
                description: 'Length progression checks if your clubs decrease in length appropriately from driver to wedges, following standard intervals for proper posture and ball position.',
                clubs: [
                    { name: 'Driver', value: '45.5" ‚úì', status: 'good' },
                    { name: '3-Wood', value: '43" ‚úì', status: 'good' },
                    { name: '5-Iron', value: '38" ‚úì', status: 'good' },
                    { name: 'PW', value: '35.5" ‚úì', status: 'good' }
                ],
                aiAnalysis: '<strong>Excellent:</strong> Your length progression follows standard specifications perfectly. This means your setup and ball position can remain consistent from club to club.<br><br><strong>No action needed</strong> ‚Äî Length is optimal throughout your bag.',
                proInsight: '<strong>No opportunity here</strong> ‚Äî Length is standard across the bag. No custom fitting needed unless Mike requests specific length changes.'
            },
            'lie': {
                name: 'Lie Angle',
                grade: 'A-',
                gradeClass: 'a',
                weight: '10% of overall grade',
                description: 'Lie angle affects whether your clubface is square at impact. Incorrect lie can cause the ball to go left (too upright) or right (too flat) even with a good swing.',
                clubs: [
                    { name: 'Driver', value: 'Standard ‚úì', status: 'good' },
                    { name: 'Irons', value: '1¬∞ Upright ‚úì', status: 'good' },
                    { name: 'Wedges', value: 'Standard ‚úì', status: 'good' }
                ],
                aiAnalysis: '<strong>Well-fitted:</strong> Your irons are 1¬∞ upright from standard, which is appropriate for your height and arm length. This was likely set during a previous fitting.<br><br><strong>Consistent setup:</strong> Your lie angles are matched throughout the bag, promoting consistent ball flight direction.',
                proInsight: '<strong>Previous fitting done well</strong> ‚Äî Mike\'s irons have been adjusted. If discussing new irons, remember to specify 1¬∞ upright to maintain consistency.'
            },
            'torque': {
                name: 'Shaft Torque',
                grade: 'B-',
                gradeClass: 'b',
                weight: '5% of overall grade',
                description: 'Torque measures how much the shaft twists during the swing. Lower torque provides more control but requires faster swing speeds; higher torque offers more forgiveness.',
                clubs: [
                    { name: 'Driver', value: '3.2¬∞ ‚úì', status: 'good' },
                    { name: '3-Wood', value: '3.8¬∞ ‚úì', status: 'good' },
                    { name: '4-Hybrid', value: '4.5¬∞', status: 'good' },
                    { name: '5-Hybrid', value: '3.5¬∞ ‚úì', status: 'good' }
                ],
                aiAnalysis: '<strong>Acceptable range:</strong> Your torque values are in a reasonable range for a 10-handicap. The 4-Hybrid has slightly higher torque (4.5¬∞) than ideal, which may contribute to some dispersion.<br><br><strong>Minor consideration:</strong> When addressing the 4-Hybrid flex issue, selecting a shaft with lower torque (3.5-4.0¬∞) would improve consistency.',
                proInsight: '<strong>Bundle with flex fix</strong> ‚Äî If reshafting the 4-Hybrid, recommend a shaft that addresses both flex and torque. This isn\'t a standalone opportunity but adds value to the hybrid conversation.'
            }
        };

        /**
         * Open Issues Modal - shows all bag issues with club associations
         */
        function openIssuesModal() {
            const analysis = window.currentAnalysisData;
            const issues = analysis?.issues_found || [];
            const clubs = analysis?.clubs || [];
            
            if (issues.length === 0) {
                alert('No issues found for this bag!');
                return;
            }
            
            // Parse issues and associate with clubs
            const parsedIssues = issues.map(issue => {
                const parsed = parseIssueForClub(issue, clubs);
                return {
                    text: issue,
                    club: parsed.club,
                    clubId: parsed.clubId,
                    category: parsed.category,
                    shortDesc: parsed.shortDesc
                };
            });
            
            // Group by category
            const categories = {
                age: { name: '‚è∞ Age Issues', issues: [] },
                loft: { name: 'üìê Loft Gapping', issues: [] },
                weight: { name: '‚öñÔ∏è Weight Progression', issues: [] },
                flex: { name: 'üîÑ Flex Consistency', issues: [] },
                kickpoint: { name: 'üìç Kickpoint', issues: [] },
                length: { name: 'üìè Length', issues: [] },
                lie: { name: 'üìê Lie Angle', issues: [] },
                torque: { name: 'üåÄ Torque', issues: [] },
                defaults: { name: 'üìù Missing Data', issues: [] },
                other: { name: 'üìã Other', issues: [] }
            };
            
            parsedIssues.forEach(issue => {
                const cat = categories[issue.category] || categories.other;
                cat.issues.push(issue);
            });
            
            // Build HTML
            let html = '';
            Object.values(categories).forEach(cat => {
                if (cat.issues.length > 0) {
                    html += `<div class="issue-category">${cat.name} (${cat.issues.length})</div>`;
                    html += '<ul class="issues-list">';
                    cat.issues.forEach(issue => {
                        const clubTag = issue.club ? `<span class="issue-club-tag">${issue.club}</span>` : '';
                        html += `
                            <li class="issue-item">
                                <span class="issue-icon">‚Ä¢</span>
                                <span class="issue-text">${issue.text}</span>
                                ${clubTag}
                            </li>`;
                    });
                    html += '</ul>';
                }
            });
            
            document.getElementById('issues-modal-list').innerHTML = html;
            document.getElementById('issues-modal').querySelector('.modal-title').innerHTML = 
                `‚ö†Ô∏è ${issues.length} Issue${issues.length !== 1 ? 's' : ''} Found`;
            openModal('issues-modal');
        }
        
        /**
         * Parse an issue string to identify related club and category
         */
        function parseIssueForClub(issue, clubs) {
            const lower = issue.toLowerCase();
            let club = null;
            let clubId = null;
            let category = 'other';
            let shortDesc = '';
            
            // Detect category
            if (lower.includes('standard lofts used') || lower.includes('standard lengths used') || lower.includes('standard lie angles used')) {
                category = 'defaults';
                if (lower.includes('lofts')) shortDesc = 'Loft estimated';
                else if (lower.includes('lengths')) shortDesc = 'Length estimated';
                else if (lower.includes('lie')) shortDesc = 'Lie estimated';
                else shortDesc = 'Using estimates';
            } else if (lower.includes('year old') || lower.includes('years old') || lower.includes('outdated')) {
                category = 'age';
                // Extract age for short description
                const ageMatch = issue.match(/(\d+)\s*years?\s*old/i);
                shortDesc = ageMatch ? `${ageMatch[1]} yrs old` : 'Aging';
            } else if (lower.includes('gap between') || lower.includes('overlap') || lower.includes('same loft') || lower.includes('duplicate') || lower.includes('too similar')) {
                category = 'loft';
                if (lower.includes('overlap') || lower.includes('too similar')) shortDesc = 'Loft overlap';
                else if (lower.includes('gap')) shortDesc = 'Large gap';
                else shortDesc = 'Loft issue';
            } else if (lower.includes('weight') || lower.includes('gram') || lower.includes('heavier') || lower.includes('lighter') || lower.includes('vs expected') && lower.includes('g based on')) {
                category = 'weight';
                // Try to extract weight deviation for favorite club baseline issues
                // Pattern: "4H (75g) is -7g vs expected 109g based on ‚òÖ 7-Iron"
                const weightMatch = issue.match(/\((\d+)g\).*?(-?\d+)g.*?expected\s+(\d+)g/i);
                if (weightMatch) {
                    shortDesc = `${weightMatch[1]}g vs ${weightMatch[3]}g expected`;
                } else {
                    shortDesc = 'Weight issue';
                }
            } else if (lower.includes('flex') || lower.includes('stiff') || lower.includes('regular')) {
                category = 'flex';
                if (lower.includes('mismatch')) shortDesc = 'Flex mismatch';
                else if (lower.includes('mixed')) shortDesc = 'Mixed flex';
                else shortDesc = 'Flex issue';
            } else if (lower.includes('kickpoint') || lower.includes('kick point')) {
                category = 'kickpoint';
                shortDesc = 'Kickpoint issue';
            } else if (lower.includes('length') || lower.includes('shorter than ideal') || lower.includes('longer than ideal') || (lower.includes('"') && lower.includes('for your body'))) {
                category = 'length';
                // Try to extract length deviation for body fit issues
                // Pattern: "4H (39.5") is 0.75" shorter than ideal 40.25" for your body"
                const bodyFitMatch = issue.match(/([\d.]+)"\s*(shorter|longer)\s*than\s*ideal/i);
                if (bodyFitMatch) {
                    shortDesc = `${bodyFitMatch[1]}" ${bodyFitMatch[2]} than ideal`;
                } else {
                    shortDesc = 'Length issue';
                }
            } else if (lower.includes('lie')) {
                category = 'lie';
                shortDesc = 'Lie angle';
            } else if (lower.includes('torque')) {
                category = 'torque';
                shortDesc = 'Torque issue';
            }
            
            // Try to match club name from issue text - including model names
            const clubPatterns = [
                { pattern: /driver/i, name: 'Driver', type: 'Driver' },
                { pattern: /3-wood|3 wood|3wood/i, name: '3-Wood', type: '3W' },
                { pattern: /5-wood|5 wood|5wood/i, name: '5-Wood', type: '5W' },
                { pattern: /7-wood|7 wood|7wood/i, name: '7-Wood', type: '7W' },
                { pattern: /2-hybrid|2 hybrid|2h\b/i, name: '2-Hybrid', type: '2H' },
                { pattern: /3-hybrid|3 hybrid|3h\b/i, name: '3-Hybrid', type: '3H' },
                { pattern: /4-hybrid|4 hybrid|4h\b/i, name: '4-Hybrid', type: '4H' },
                { pattern: /5-hybrid|5 hybrid|5h\b/i, name: '5-Hybrid', type: '5H' },
                { pattern: /4-iron|4 iron|4i\b/i, name: '4-Iron', type: '4i' },
                { pattern: /5-iron|5 iron|5i\b/i, name: '5-Iron', type: '5i' },
                { pattern: /6-iron|6 iron|6i\b/i, name: '6-Iron', type: '6i' },
                { pattern: /7-iron|7 iron|7i\b/i, name: '7-Iron', type: '7i' },
                { pattern: /8-iron|8 iron|8i\b/i, name: '8-Iron', type: '8i' },
                { pattern: /9-iron|9 iron|9i\b/i, name: '9-Iron', type: '9i' },
                { pattern: /pw\b|pitching wedge/i, name: 'PW', type: 'PW' },
                { pattern: /gw\b|gap wedge/i, name: 'GW', type: 'GW' },
                { pattern: /sw\b|sand wedge/i, name: 'SW', type: 'SW' },
                { pattern: /lw\b|lob wedge/i, name: 'LW', type: 'LW' },
                { pattern: /46¬∞/i, name: '46¬∞', type: '46¬∞' },
                { pattern: /48¬∞/i, name: '48¬∞', type: '48¬∞' },
                { pattern: /50¬∞/i, name: '50¬∞', type: '50¬∞' },
                { pattern: /52¬∞/i, name: '52¬∞', type: '52¬∞' },
                { pattern: /54¬∞/i, name: '54¬∞', type: '54¬∞' },
                { pattern: /56¬∞/i, name: '56¬∞', type: '56¬∞' },
                { pattern: /58¬∞/i, name: '58¬∞', type: '58¬∞' },
                { pattern: /60¬∞/i, name: '60¬∞', type: '60¬∞' }
            ];
            
            // First try to find specific club mentions
            for (const cp of clubPatterns) {
                const match = issue.match(cp.pattern);
                if (match) {
                    club = cp.name;
                    break;
                }
            }
            
            // Also try to match against actual club model names in bag
            if (clubs.length > 0) {
                for (const c of clubs) {
                    const model = (c.model || '').toLowerCase();
                    const brand = (c.brand || '').toLowerCase();
                    // Check if issue mentions the model name (e.g., "Mizuno JPX 900")
                    if (model && lower.includes(model)) {
                        // Found model match - get the club type
                        const clubType = c.clubType || c.club_type || c.type;
                        if (clubType) {
                            club = formatClubNameForKey(clubType);
                            clubId = c.id;
                        }
                        break;
                    }
                    // Check brand + partial model
                    if (brand && model) {
                        const modelParts = model.split(/\s+/);
                        for (const part of modelParts) {
                            if (part.length > 2 && lower.includes(part)) {
                                const clubType = c.clubType || c.club_type || c.type;
                                if (clubType) {
                                    club = formatClubNameForKey(clubType);
                                    clubId = c.id;
                                }
                                break;
                            }
                        }
                    }
                }
            }
            
            return { club, clubId, category, shortDesc };
        }
        
        // Helper to format club type for key matching
        function formatClubNameForKey(clubType) {
            if (!clubType) return null;
            if (clubType === 'Driver') return 'Driver';
            if (clubType.match(/^\d+W$/i)) return clubType.charAt(0) + '-Wood';
            if (clubType.match(/^\d+H$/i)) return clubType.charAt(0) + '-Hybrid';
            if (clubType.match(/^\d+i$/i)) return clubType.charAt(0) + '-Iron';
            if (clubType === 'PW') return 'PW';
            if (clubType === 'GW') return 'GW';
            if (clubType === 'SW') return 'SW';
            if (clubType === 'LW') return 'LW';
            if (clubType.match(/^\d+¬∞$/)) return clubType;
            return clubType;
        }
        
        // Store parsed issues for club cards
        window.clubIssuesMap = {};
        
        function buildClubIssuesMap() {
            const analysis = window.currentAnalysisData;
            const issues = analysis?.issues_found || [];
            const clubs = analysis?.clubs || [];
            
            window.clubIssuesMap = {};
            
            issues.forEach(issue => {
                const parsed = parseIssueForClub(issue, clubs);
                if (parsed.club) {
                    // Add issue under multiple key variations for better matching
                    const keys = getClubKeyVariations(parsed.club);
                    keys.forEach(key => {
                        if (!window.clubIssuesMap[key]) {
                            window.clubIssuesMap[key] = [];
                        }
                        // Avoid duplicates
                        const exists = window.clubIssuesMap[key].some(i => i.text === issue);
                        if (!exists) {
                            window.clubIssuesMap[key].push({
                                text: issue,
                                category: parsed.category,
                                shortDesc: parsed.shortDesc
                            });
                        }
                    });
                }
            });
            
            // Add weight_suggestions to issues map (favorite club baseline)
            const weightSuggestions = analysis?.weight_suggestions || [];
            const baselineClub = analysis?.favorite_club_baseline?.clubType || 'baseline';
            weightSuggestions.forEach(ws => {
                if (ws.clubType) {
                    const keys = getClubKeyVariations(ws.clubType);
                    const deviation = ws.currentWeight - ws.idealWeight;
                    const shortDesc = `${ws.currentWeight}g vs ${ws.idealWeight}g expected`;
                    const fullText = `${ws.clubType} (${ws.currentWeight}g) is ${deviation > 0 ? '+' : ''}${deviation}g vs expected ${ws.idealWeight}g based on ‚òÖ ${baselineClub}`;
                    keys.forEach(key => {
                        if (!window.clubIssuesMap[key]) {
                            window.clubIssuesMap[key] = [];
                        }
                        const exists = window.clubIssuesMap[key].some(i => i.text === fullText);
                        if (!exists) {
                            window.clubIssuesMap[key].push({
                                text: fullText,
                                category: 'weight',
                                shortDesc: shortDesc
                            });
                        }
                    });
                }
            });
            
            // Add length_suggestions to issues map (body fit baseline)
            const lengthSuggestions = analysis?.length_suggestions || [];
            lengthSuggestions.forEach(ls => {
                if (ls.clubType) {
                    const keys = getClubKeyVariations(ls.clubType);
                    const direction = ls.adjustment > 0 ? 'longer' : 'shorter';
                    const shortDesc = `Length: ${Math.abs(ls.adjustment).toFixed(2)}" ${direction} than ideal`;
                    const fullText = `${ls.clubType} (${ls.currentLength}") is ${Math.abs(ls.adjustment).toFixed(2)}" ${direction} than ideal ${ls.idealLength}" for your body`;
                    keys.forEach(key => {
                        if (!window.clubIssuesMap[key]) {
                            window.clubIssuesMap[key] = [];
                        }
                        const exists = window.clubIssuesMap[key].some(i => i.text === fullText);
                        if (!exists) {
                            window.clubIssuesMap[key].push({
                                text: fullText,
                                category: 'length',
                                shortDesc: shortDesc
                            });
                        }
                    });
                }
            });
            
            console.log('üìã Built club issues map:', window.clubIssuesMap);
        }
        
        /**
         * Generate multiple key variations for a club name to improve matching
         */
        function getClubKeyVariations(clubName) {
            if (!clubName) return [];
            const keys = [];
            const lower = clubName.toLowerCase();
            
            // Always add the lowercase version
            keys.push(lower);
            keys.push(lower.replace(/\s+/g, '-'));
            keys.push(lower.replace(/\s+/g, ''));
            
            // Add specific variations based on club type
            if (lower === 'driver') {
                keys.push('driver');
            } else if (lower.match(/^\d-wood$/) || lower.match(/^\dw$/)) {
                const num = lower.charAt(0);
                keys.push(`${num}-wood`, `${num}w`, `${num}-w`, `${num}wood`);
            } else if (lower.match(/^\d-hybrid$/) || lower.match(/^\dh$/)) {
                const num = lower.charAt(0);
                keys.push(`${num}-hybrid`, `${num}h`, `${num}-h`, `${num}hybrid`);
            } else if (lower.match(/^\d-iron$/) || lower.match(/^\di$/)) {
                const num = lower.charAt(0);
                keys.push(`${num}-iron`, `${num}i`, `${num}-i`, `${num}iron`);
            } else if (lower === 'pw' || lower === 'pitching-wedge') {
                keys.push('pw', 'pitching-wedge', 'pitchingwedge');
            } else if (lower === 'gw' || lower === 'gap-wedge') {
                keys.push('gw', 'gap-wedge', 'gapwedge');
            } else if (lower === 'sw' || lower === 'sand-wedge') {
                keys.push('sw', 'sand-wedge', 'sandwedge');
            } else if (lower === 'lw' || lower === 'lob-wedge') {
                keys.push('lw', 'lob-wedge', 'lobwedge');
            } else if (lower.match(/^\d+¬∞$/)) {
                keys.push(lower, lower.replace('¬∞', ''));
            }
            
            return [...new Set(keys)]; // Remove duplicates
        }

        function showFactorDetail(factorId) {
            const factor = factorData[factorId];
            if (!factor) {
                alert('Factor details coming soon');
                return;
            }
            
            // Reset swing speed edit mode when switching to a different factor
            if (window.currentFactorId !== factorId) {
                window.swingSpeedEditMode = false;
            }
            
            const isClientView = document.body.classList.contains('client-view');
            const isFreeTier = creditState.client.tier === 'free';
            
            // Get real grade from analysis data if available
            const componentKeyMap = {
                'loft': 'loft_gapping', 'age': 'age', 'weight': 'weight_progression',
                'flex': 'flex_consistency', 'kickpoint': 'kickpoint_consistency',
                'length': 'length_progression', 'lie': 'lie_angle_progression', 'torque': 'torque_consistency'
            };
            let displayGrade = factor.grade;
            let displayGradeClass = factor.gradeClass;
            const analysis = window.currentAnalysisData;
            if (analysis && analysis.component_scores) {
                const compKey = componentKeyMap[factorId];
                const comp = analysis.component_scores[compKey];
                if (comp && comp.grade) {
                    displayGrade = comp.grade;
                    displayGradeClass = comp.grade.charAt(0).toLowerCase();
                }
            }
            
            // Update modal content
            document.getElementById('factor-modal-title').textContent = 'üìä ' + factor.name;
            document.getElementById('factor-modal-name').textContent = factor.name;
            document.getElementById('factor-modal-grade').textContent = displayGrade;
            document.getElementById('factor-modal-grade').className = 'factor-detail-grade ' + displayGradeClass;
            document.getElementById('factor-modal-weight').textContent = factor.weight;
            document.getElementById('factor-modal-description').textContent = factor.description;
            
            // Build clubs list - use real data if available
            let clubsHtml = '';
            if (analysis && analysis.clubs && analysis.clubs.length > 0) {
                // Helper to extract value from strengths array
                function getStrengthValue(club, keyword) {
                    if (!club.grading || !club.grading.strengths) return null;
                    const match = club.grading.strengths.find(s => s.toLowerCase().includes(keyword.toLowerCase()));
                    if (!match) return null;
                    // Extract value after colon or in parentheses
                    const colonMatch = match.match(/:\s*(.+)/);
                    if (colonMatch) return colonMatch[1].trim();
                    const parenMatch = match.match(/\(([^)]+)\)/);
                    if (parenMatch) return parenMatch[1].trim();
                    return match;
                }
                
                // Filter out putters
                const clubs = analysis.clubs.filter(c => c.clubType && c.clubType.toLowerCase() !== 'putter');
                
                // Smart sorting helper - sorts by club type in natural bag order
                function getClubSortOrder(club) {
                    const type = (club.clubType || '').toLowerCase();
                    
                    // For irons, ALWAYS use club number (more reliable than loft data)
                    if (type.includes('iron') || /^\d+-iron$/i.test(type)) {
                        const num = parseInt(type.match(/\d+/)?.[0] || '5');
                        return 20 + (num * 4); // 3i=32, 4i=36, 5i=40, 6i=44, 7i=48, 8i=52, 9i=56
                    }
                    
                    // For woods/hybrids, use loft if available, else club type
                    if (type === 'driver') return club.loft || 10;
                    if (type === '3-wood' || type === '3w') return club.loft || 15;
                    if (type === '5-wood' || type === '5w') return club.loft || 18;
                    if (type === '7-wood' || type === '7w') return club.loft || 21;
                    if (type.includes('wood')) return club.loft || 20;
                    
                    if (type.includes('hybrid') || /^\d+h$/i.test(type)) {
                        const num = parseInt(type.match(/\d+/)?.[0] || '4');
                        return club.loft || (18 + num); // 2H=20, 3H=21, 4H=22, etc.
                    }
                    
                    if (type === 'pw' || type === 'pitching') return 64;
                    
                    // Degree wedges (50¬∞, 52¬∞, etc.) - sort after PW
                    const degMatch = type.match(/^(\d+)/);
                    if (degMatch) {
                        const deg = parseInt(degMatch[1], 10);
                        if (deg >= 46 && deg <= 64) return 65 + (deg - 46); // 46¬∞=65, 50¬∞=69, 54¬∞=73, 60¬∞=79
                    }
                    if (type === 'gw' || type === 'gap' || type === 'aw') return 68;
                    if (type === 'sw' || type === 'sand') return 72;
                    if (type === 'lw' || type === 'lob') return 76;
                    return 999;
                }
                
                if (factorId === 'loft') {
                    // For loft, show gaps between consecutive clubs
                    // Use direct club.loft value (enriched with defaults by backend)
                    const clubsWithLoft = clubs.map(c => {
                        const loftStr = getStrengthValue(c, 'loft');
                        const loft = c.loft || (loftStr ? parseFloat(loftStr) : null);
                        return { ...c, loftVal: loft, loftIsDefault: c.loftIsDefault || false };
                    }).filter(c => c.loftVal !== null).sort((a, b) => a.loftVal - b.loftVal);
                    
                    // Add "YOUR CLUBS" header with inline edit buttons (pro view only)
                    if (!isClientView) {
                        clubsHtml += `
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 12px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-primary); font-weight: 500;">YOUR CLUBS</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Edit individual lofts to improve gapping analysis</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-reset-small" onclick="resetLoftToOriginal()" style="padding: 6px 10px; font-size: 11px;">‚Ü∫ Reset</button>
                                    <button class="btn-edit-small" onclick="toggleLoftEditMode()" style="padding: 6px 10px; font-size: 11px;">‚úèÔ∏è Edit</button>
                                </div>
                            </div>
                        `;
                    } else {
                        clubsHtml += `<div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; margin-top: 8px;">YOUR CLUBS</div>`;
                    }
                    
                    let hasEstimatedValues = false;
                    for (let i = 0; i < clubsWithLoft.length - 1; i++) {
                        const curr = clubsWithLoft[i];
                        const next = clubsWithLoft[i + 1];
                        const gap = Math.round(Math.abs(next.loftVal - curr.loftVal));
                        
                        // Status: overlap (0-2¬∞) = red, wide (>6¬∞) = orange/issue, good (3-5¬∞) = green
                        let status = '';
                        let icon = '';
                        if (gap <= 2) {
                            status = 'overlap';
                            icon = '‚õî';
                        } else if (gap > 6) {
                            status = 'issue';
                            icon = '‚ö†';
                        } else if (gap >= 3 && gap <= 5) {
                            status = 'good';
                            icon = '‚úì';
                        }
                        
                        const currEst = curr.loftIsDefault ? ' estimated' : '';
                        const nextEst = next.loftIsDefault ? ' estimated' : '';
                        if (curr.loftIsDefault || next.loftIsDefault) hasEstimatedValues = true;
                        
                        const currName = curr.loftIsDefault ? `${curr.clubType}` : curr.clubType;
                        const nextName = next.loftIsDefault ? `${next.clubType}` : next.clubType;
                        
                        // Special text for overlap
                        const gapText = gap <= 2 ? `${gap}¬∞ gap ${icon} DUPLICATE` : `${gap}¬∞ gap ${icon}`;
                        
                        clubsHtml += `<div class="factor-club-row">
                            <span class="factor-club-name">${currName} ‚Üí ${nextName}</span>
                            <span class="factor-club-value ${status}">${gapText}</span>
                        </div>`;
                    }
                    
                    // Add footnote if any estimated values
                    if (hasEstimatedValues) {
                        clubsHtml += `<div class="factor-estimated-footnote">Some loft values are estimated based on standard club specifications. Enter actual lofts for more accurate analysis.</div>`;
                    }
                } else if (factorId === 'age') {
                    const currentYear = new Date().getFullYear();
                    // Sort by loft order (driver to wedge)
                    const sortedClubs = [...clubs].sort((a, b) => getClubSortOrder(a) - getClubSortOrder(b));
                    sortedClubs.forEach(club => {
                        // Try multiple sources for year
                        let year = null;
                        
                        // Direct year fields
                        if (club.year) year = parseInt(club.year);
                        else if (club.release_year) year = parseInt(club.release_year);
                        else if (club.model_year) year = parseInt(club.model_year);
                        
                        // Try to extract from technology string in strengths
                        if (!year) {
                            const techStr = getStrengthValue(club, 'technology');
                            const yearMatch = techStr ? techStr.match(/\d{4}/) : null;
                            if (yearMatch) year = parseInt(yearMatch[0]);
                        }
                        
                        // Try to extract from model name
                        if (!year && club.model) {
                            const modelYearMatch = club.model.match(/\b(20\d{2})\b/);
                            if (modelYearMatch) year = parseInt(modelYearMatch[1]);
                        }
                        
                        // Try to extract from club name/description
                        if (!year && club.clubName) {
                            const nameYearMatch = club.clubName.match(/\b(20\d{2})\b/);
                            if (nameYearMatch) year = parseInt(nameYearMatch[1]);
                        }
                        
                        // Check grading data for age
                        if (!year && club.grading && club.grading.strengths) {
                            for (const s of club.grading.strengths) {
                                const ageMatch = s.match(/(\d+)\s*years?\s*old/i);
                                if (ageMatch) {
                                    year = currentYear - parseInt(ageMatch[1]);
                                    break;
                                }
                                // Also try to find year in any strength text
                                const yearInStrength = s.match(/\b(20\d{2})\b/);
                                if (yearInStrength) {
                                    year = parseInt(yearInStrength[1]);
                                    break;
                                }
                            }
                        }
                        
                        // Check issues for age info
                        if (!year && club.grading && club.grading.issues) {
                            for (const issue of club.grading.issues) {
                                const ageMatch = issue.match(/(\d+)\s*years?\s*old/i);
                                if (ageMatch) {
                                    year = currentYear - parseInt(ageMatch[1]);
                                    break;
                                }
                            }
                        }
                        
                        const age = year ? currentYear - year : null;
                        const status = age && age > 7 ? 'issue' : (age && age <= 3 ? 'good' : '');
                        const ageText = age !== null ? `${age} yr${age !== 1 ? 's' : ''} old` : 'Unknown';
                        clubsHtml += `<div class="factor-club-row">
                            <span class="factor-club-name">${club.clubType}</span>
                            <span class="factor-club-value ${status}">${ageText} ${status === 'good' ? '‚úì' : (status === 'issue' ? '‚ö†' : '')}</span>
                        </div>`;
                    });
                } else if (factorId === 'weight') {
                    // Get swing speed from user context or client data
                    const swingSpeed = window.currentClient?.swingSpeed || window.currentAnalysisData?.user_context?.swing_speed || null;
                    const swingSpeedSource = window.currentClient?.swingSpeedSource || 'unknown';
                    const gender = window.currentClient?.gender || 'male';
                    
                    // Get recommended weight ranges based on swing speed
                    function getRecommendedWeights(speed, gender) {
                        if (!speed) return null;
                        
                        if (gender === 'female') {
                            if (speed >= 85) return { driver: '55-65g', irons: '85-105g' };
                            if (speed >= 70) return { driver: '45-55g', irons: '70-90g' };
                            if (speed >= 60) return { driver: '40-50g', irons: '60-80g' };
                            return { driver: '35-45g', irons: '55-75g' };
                        } else {
                            if (speed >= 105) return { driver: '65-75g', irons: '110-130g' };
                            if (speed >= 95) return { driver: '55-65g', irons: '95-120g' };
                            if (speed >= 84) return { driver: '50-60g', irons: '85-105g' };
                            if (speed >= 72) return { driver: '45-55g', irons: '75-95g' };
                            return { driver: '40-50g', irons: '65-85g' };
                        }
                    }
                    
                    const recommendedWeights = getRecommendedWeights(swingSpeed, gender);
                    
                    // Source display text
                    const sourceLabels = {
                        'trackman': 'TrackMan',
                        'flightscope': 'FlightScope',
                        'mevo': 'Mevo/Rapsodo',
                        'fitting': 'Fitting Session',
                        'manual': 'Manual Entry',
                        'estimated': 'Estimated',
                        'onboarding': 'Onboarding',
                        'unknown': 'Not specified'
                    };
                    
                    // Build swing speed panel
                    if (!window.swingSpeedEditMode) {
                        clubsHtml += `
                            <div class="swing-speed-panel">
                                <div class="swing-speed-header">
                                    <span class="swing-speed-label">Driver Swing Speed</span>
                                    <button class="swing-speed-edit-btn" onclick="toggleSwingSpeedEdit('weight')">‚úèÔ∏è Edit</button>
                                </div>
                                ${swingSpeed 
                                    ? `<div class="swing-speed-value">${swingSpeed} <span class="unit">mph</span></div>
                                       <div class="swing-speed-source">Source: ${sourceLabels[swingSpeedSource] || swingSpeedSource}</div>`
                                    : `<div class="swing-speed-value not-set">Not set - tap Edit to enter</div>`
                                }
                                ${swingSpeed && recommendedWeights ? `
                                <div class="swing-speed-recommendation">
                                    <div class="swing-speed-rec-title">RECOMMENDED WEIGHTS FOR ${swingSpeed} MPH</div>
                                    <div class="swing-speed-rec-row">
                                        <span class="swing-speed-rec-zone">Driver shaft:</span>
                                        <span class="swing-speed-rec-value">${recommendedWeights.driver}</span>
                                    </div>
                                    <div class="swing-speed-rec-row">
                                        <span class="swing-speed-rec-zone">Iron shafts:</span>
                                        <span class="swing-speed-rec-value">${recommendedWeights.irons}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        // Edit mode panel
                        const currentSpeed = swingSpeed || 90;
                        const handicap = window.currentClient?.handicap || 15;
                        const estimatedSpeed = gender === 'female' 
                            ? Math.max(65, 90 - (handicap * 0.8))
                            : Math.max(75, 105 - (handicap * 1));
                        
                        clubsHtml += `
                            <div class="swing-speed-edit-panel">
                                <div class="swing-speed-edit-title">Update Swing Speed</div>
                                
                                <div class="swing-speed-slider-container">
                                    <div class="swing-speed-slider-value" id="swing-speed-display">${currentSpeed} mph</div>
                                    <input type="range" class="swing-speed-slider" id="swing-speed-slider" 
                                           min="50" max="130" value="${currentSpeed}" 
                                           oninput="document.getElementById('swing-speed-display').textContent = this.value + ' mph'">
                                    <div class="swing-speed-slider-labels">
                                        <span>50 mph</span>
                                        <span>130 mph</span>
                                    </div>
                                </div>
                                
                                <div class="swing-speed-source-select">
                                    <div class="swing-speed-source-label">How did you measure this?</div>
                                    <div class="swing-speed-source-options">
                                        <label class="swing-speed-source-option">
                                            <input type="radio" name="swing-speed-source" value="trackman" ${swingSpeedSource === 'trackman' ? 'checked' : ''}>
                                            Launch monitor (TrackMan, FlightScope, etc.)
                                        </label>
                                        <label class="swing-speed-source-option">
                                            <input type="radio" name="swing-speed-source" value="fitting" ${swingSpeedSource === 'fitting' ? 'checked' : ''}>
                                            Professional fitting session
                                        </label>
                                        <label class="swing-speed-source-option">
                                            <input type="radio" name="swing-speed-source" value="mevo" ${swingSpeedSource === 'mevo' ? 'checked' : ''}>
                                            Personal monitor (Mevo, Rapsodo, etc.)
                                        </label>
                                        <label class="swing-speed-source-option">
                                            <input type="radio" name="swing-speed-source" value="estimated" ${swingSpeedSource === 'estimated' || !swingSpeedSource ? 'checked' : ''}>
                                            Estimated / I'm not sure
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="swing-speed-tip">
                                    üí° Slower swingers benefit from lighter shafts; faster swingers can handle heavier weights for control.
                                </div>
                                
                                <div class="swing-speed-edit-actions" style="flex-wrap: wrap; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="toggleSwingSpeedEdit('weight')" style="flex: 1; min-width: 80px;">Cancel</button>
                                    <button class="btn btn-secondary" onclick="saveSwingSpeed('weight', false)" style="flex: 1; min-width: 100px;">üíæ Save Only</button>
                                    <button class="btn btn-primary" onclick="saveSwingSpeed('weight', true)" style="flex: 1; min-width: 130px;">üíæ Save & Regrade</button>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Zone-based display - group by category and highlight within-zone outliers
                    
                    // Determine weight zone for each club
                    function getWeightZone(club) {
                        const type = (club.clubType || '').toLowerCase();
                        if (type === 'driver') return 'woods';
                        if (type.includes('wood') || /^\d+w$/i.test(type)) return 'woods';
                        if (type.includes('hybrid') || /^\d+h$/i.test(type)) return 'hybrids';
                        // PW stays with irons
                        if (type === 'pw' || type === 'pitching') return 'irons';
                        // Degree wedges (46¬∞+)
                        const degMatch = type.match(/^(\d+)/);
                        if (degMatch) {
                            const num = parseInt(degMatch[1], 10);
                            if (num >= 46 && num <= 64) return 'wedges';
                        }
                        // Named wedges
                        if (['gw','sw','lw','aw','gap','sand','lob'].some(w => type === w || type.includes(w))) return 'wedges';
                        // Irons
                        if (type.includes('iron') || /^\d+-iron$/i.test(type)) return 'irons';
                        return 'irons';
                    }
                    
                    // Zone order for sorting
                    const weightZoneOrder = { woods: 0, hybrids: 1, irons: 2, wedges: 3 };
                    
                    // Sort by zone first, then by club order within zone
                    const sortedClubs = [...clubs].sort((a, b) => {
                        const zoneA = getWeightZone(a);
                        const zoneB = getWeightZone(b);
                        if (zoneA !== zoneB) return weightZoneOrder[zoneA] - weightZoneOrder[zoneB];
                        return getClubSortOrder(a) - getClubSortOrder(b);
                    });
                    
                    // Group clubs by zone with weight data
                    const weightZones = { woods: [], hybrids: [], irons: [], wedges: [] };
                    sortedClubs.forEach(club => {
                        const weight = club.shaft_weight || getStrengthValue(club, 'shaft weight') || getStrengthValue(club, 'weight');
                        if (weight) {
                            const zone = getWeightZone(club);
                            const weightNum = parseFloat(weight);
                            if (!isNaN(weightNum)) {
                                weightZones[zone].push({ 
                                    club, 
                                    weight: weightNum,
                                    isDefault: club.weightIsDefault || false
                                });
                            }
                        }
                    });
                    
                    // Tiered thresholds per zone (deviation from average in grams)
                    const WEIGHT_THRESHOLDS = {
                        woods:   { A: 5, B: 10, C: 15 },
                        hybrids: { A: 5, B: 8, C: 12 },
                        irons:   { A: 3, B: 6, C: 10 },   // Tightest - matched set critical
                        wedges:  { A: 8, B: 12, C: 18 }
                    };
                    
                    // Calculate average weight per zone WITH OUTLIER EXCLUSION
                    const zoneAvg = {};
                    Object.entries(weightZones).forEach(([zone, items]) => {
                        if (items.length === 1) {
                            // Single club zone - use its weight for cross-zone comparison
                            zoneAvg[zone] = items[0].weight;
                        } else if (items.length >= 2) {
                            const thresholds = WEIGHT_THRESHOLDS[zone] || { A: 5, B: 10, C: 15 };
                            const outlierThreshold = thresholds.C * 2; // 2x C = extreme outlier
                            
                            // Step 1: Initial average
                            const weights = items.map(i => i.weight);
                            const initialAvg = weights.reduce((a, b) => a + b, 0) / weights.length;
                            
                            // Step 2: Filter out extreme outliers
                            const normalItems = items.filter(i => Math.abs(i.weight - initialAvg) <= outlierThreshold);
                            
                            // Step 3: Calculate clean average from normal clubs
                            if (normalItems.length >= 2) {
                                const cleanTotal = normalItems.reduce((sum, i) => sum + i.weight, 0);
                                zoneAvg[zone] = Math.round(cleanTotal / normalItems.length);
                            } else {
                                zoneAvg[zone] = Math.round(initialAvg);
                            }
                        }
                    });
                    
                    console.log('WEIGHT ZONE AVG (outliers excluded):', zoneAvg);
                    
                    // Check if hybrids should be flagged (not heavier than woods)
                    const hybridTooLight = zoneAvg.woods && zoneAvg.hybrids && zoneAvg.hybrids <= zoneAvg.woods;
                    
                    // Check if favorite club baseline is active
                    const baseline = window.currentAnalysisData?.favorite_club_baseline;
                    if (baseline && baseline.clubType) {
                        clubsHtml += `
                            <div class="baseline-indicator">
                                <span class="baseline-star">‚òÖ</span>
                                <span>Baseline: <strong>${baseline.clubType}</strong> (${baseline.weight}g) ‚Äî All weights compared to your favorite club</span>
                            </div>
                        `;
                    }
                    
                    let hasEstimatedValues = false;
                    let currentZone = '';
                    
                    // Add "YOUR CLUBS" header with inline edit buttons (pro view only)
                    if (!isClientView) {
                        clubsHtml += `
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 12px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-primary); font-weight: 500;">Club Shaft Weights</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Edit individual weights or reset to original values</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-reset-small" onclick="resetWeightToOriginal()" style="padding: 6px 10px; font-size: 11px;">‚Ü∫ Reset</button>
                                    <button class="btn-edit-small" onclick="toggleWeightEditMode()" style="padding: 6px 10px; font-size: 11px;">‚úèÔ∏è Edit</button>
                                </div>
                            </div>
                        `;
                    } else {
                        clubsHtml += `<div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; margin-top: 8px;">YOUR CLUBS</div>`;
                    }
                    
                    sortedClubs.forEach(club => {
                        const weight = club.shaft_weight || getStrengthValue(club, 'shaft weight') || getStrengthValue(club, 'weight');
                        if (weight) {
                            const zone = getWeightZone(club);
                            const weightNum = parseFloat(weight);
                            const isEst = club.weightIsDefault || false;
                            if (isEst) hasEstimatedValues = true;
                            
                            // Add zone header when zone changes
                            if (zone !== currentZone) {
                                const zoneLabels = { woods: 'üå≤ WOODS', hybrids: 'üîÄ HYBRIDS', irons: '‚õ≥ IRONS', wedges: 'üéØ WEDGES' };
                                clubsHtml += `<div class="factor-zone-header" style="margin-top: ${currentZone ? '12px' : '0'}; padding: 4px 0; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1);">${zoneLabels[zone] || zone}</div>`;
                                currentZone = zone;
                            }
                            
                            // SIMPLIFIED: Use structured weight_suggestions from backend
                            let valueHtml = '';
                            const weightSuggestions = window.currentAnalysisData?.weight_suggestions || [];
                            const suggestion = weightSuggestions.find(s => s.clubType === club.clubType);
                            
                            // Check if this is the favorite club
                            const isFavoriteClub = baseline && baseline.clubType === club.clubType;
                            
                            // Check if this is a hybrid that's too light
                            const isHybridTooLight = zone === 'hybrids' && hybridTooLight;
                            
                            if (isFavoriteClub) {
                                // Favorite club - show star, no suggestion badge
                                valueHtml = `<span class="factor-club-value">${weightNum}g <span style="color: #ffd700;">‚òÖ</span> <span style="font-size: 10px; color: var(--text-muted);">favorite</span></span>`;
                            } else if (isHybridTooLight) {
                                // Hybrid too light - show warning
                                valueHtml = `<span class="factor-club-value weight-mismatch">${weightNum}g ‚ö† ideal: ${Math.round(zoneAvg.woods + 10)}g</span>`;
                            } else if (suggestion) {
                                // Has a suggestion - show simplified badge
                                // Use yellow for baseline-based, orange for zone-average based
                                const cssClass = suggestion.isBaselineBased ? 'weight-baseline' : 'weight-mismatch';
                                const badgeText = suggestion.isBaselineBased 
                                    ? `‚ö† ideal: ${suggestion.idealWeight}g (based on favorite club)`
                                    : `‚ö† ideal: ${suggestion.idealWeight}g`;
                                valueHtml = `<span class="factor-club-value ${cssClass}">${weightNum}g ${badgeText}</span>`;
                            } else if (isEst) {
                                valueHtml = `<span class="factor-club-value estimated">${weightNum}g</span>`;
                            } else {
                                valueHtml = `<span class="factor-club-value">${weightNum}g</span>`;
                            }
                            
                            clubsHtml += `<div class="factor-club-row">
                                <span class="factor-club-name">${club.clubType}</span>
                                ${valueHtml}
                            </div>`;
                        }
                    });
                    
                    // Add guidance about cross-zone transitions
                    clubsHtml += `<div class="factor-estimated-footnote" style="margin-top: 12px;">* Different weights between categories (woods vs irons) is normal due to graphite/steel shaft differences.</div>`;
                    
                    // Cross-zone warning: Hybrids should be heavier than woods
                    if (hybridTooLight) {
                        clubsHtml += `<div class="factor-estimated-footnote" style="color: #ff5252; margin-top: 8px;">* Hybrids (${zoneAvg.hybrids}g) should typically be 5-15g heavier than woods (${zoneAvg.woods}g) for optimal tempo transition.</div>`;
                    }
                    
                    if (hasEstimatedValues) {
                        clubsHtml += `<div class="factor-estimated-footnote">Some weights are estimated. Enter actual shaft weights for accurate analysis.</div>`;
                    }
                } else if (factorId === 'flex') {
                    // Get swing speed from user context or client data
                    const swingSpeed = window.currentClient?.swingSpeed || window.currentAnalysisData?.user_context?.swing_speed || null;
                    const swingSpeedSource = window.currentClient?.swingSpeedSource || 'unknown';
                    const gender = window.currentClient?.gender || 'male';
                    
                    // Get recommended flex based on swing speed
                    function getRecommendedFlex(speed, gender) {
                        if (!speed) return { woods: 'Unknown', irons: 'Unknown' };
                        const thresholds = gender === 'female'
                            ? { xstiff: 95, stiff: 85, regular: 70, senior: 60 }
                            : { xstiff: 105, stiff: 95, regular: 84, senior: 72 };
                        
                        let woodsFlex, ironsFlex;
                        if (speed >= thresholds.xstiff) {
                            woodsFlex = 'X-Stiff'; ironsFlex = 'Stiff';
                        } else if (speed >= thresholds.stiff) {
                            woodsFlex = 'Stiff'; ironsFlex = 'Regular';
                        } else if (speed >= thresholds.regular) {
                            woodsFlex = 'Regular'; ironsFlex = 'Regular';
                        } else if (speed >= thresholds.senior) {
                            woodsFlex = 'Senior'; ironsFlex = 'Senior';
                        } else {
                            woodsFlex = 'Ladies'; ironsFlex = 'Ladies';
                        }
                        return { woods: woodsFlex, irons: ironsFlex };
                    }
                    
                    const recommended = getRecommendedFlex(swingSpeed, gender);
                    
                    // Zone detection function for flex recommendations
                    function getFlexZone(club) {
                        const type = (club.clubType || '').toLowerCase();
                        if (type === 'driver') return 'woods';
                        if (type.includes('wood') || /^\d+w$/i.test(type)) return 'woods';
                        if (type.includes('hybrid') || /^\d+h$/i.test(type)) return 'hybrids';
                        if (type === 'pw' || type === 'pitching') return 'irons';
                        const degMatch = type.match(/^(\d+)/);
                        if (degMatch) {
                            const num = parseInt(degMatch[1], 10);
                            if (num >= 46 && num <= 64) return 'wedges';
                        }
                        if (['gw','sw','lw','aw','gap','sand','lob'].some(w => type === w || type.includes(w))) return 'wedges';
                        if (type.includes('iron') || /^\d+-iron$/i.test(type)) return 'irons';
                        return 'irons';
                    }
                    
                    // Normalize flex value for display (S ‚Üí Stiff, R ‚Üí Regular, etc.)
                    function normalizeFlexForDropdown(flex) {
                        if (!flex) return '';
                        const f = flex.toLowerCase().trim();
                        if (f === 'l' || f === 'ladies' || f === 'lady') return 'Ladies';
                        if (f === 'a' || f === 'sr' || f === 'senior' || f === 'am') return 'Senior';
                        if (f === 'r' || f === 'regular' || f === 'reg' || f === 'm' || f === 'med' || f === 'medium') return 'Regular';
                        if (f === 's' || f === 'stiff' || f === 'firm') return 'Stiff';
                        if (f === 'x' || f === 'xs' || f === 'x-stiff' || f === 'xstiff' || f === 'extra stiff' || f === 'tour') return 'X-Stiff';
                        // Check for flex embedded in shaft code (e.g., "6S" = Stiff, "5R" = Regular)
                        if (/\d+s$/i.test(f) || /s\d*$/i.test(f)) return 'Stiff';
                        if (/\d+r$/i.test(f) || /r\d*$/i.test(f)) return 'Regular';
                        if (/\d+x$/i.test(f) || /x\d*$/i.test(f)) return 'X-Stiff';
                        if (/\d+a$/i.test(f) || /a\d*$/i.test(f)) return 'Senior';
                        if (/\d+l$/i.test(f) || /l\d*$/i.test(f)) return 'Ladies';
                        return flex; // Return original if no match
                    }
                    
                    // Source display text
                    const sourceLabels = {
                        'trackman': 'TrackMan',
                        'flightscope': 'FlightScope',
                        'mevo': 'Mevo/Rapsodo',
                        'fitting': 'Fitting Session',
                        'manual': 'Manual Entry',
                        'estimated': 'Estimated',
                        'onboarding': 'Onboarding',
                        'unknown': 'Not specified'
                    };
                    
                    // Build swing speed panel
                    if (!window.swingSpeedEditMode) {
                        clubsHtml += `
                            <div class="swing-speed-panel">
                                <div class="swing-speed-header">
                                    <span class="swing-speed-label">Driver Swing Speed</span>
                                    <button class="swing-speed-edit-btn" onclick="toggleSwingSpeedEdit('flex')">‚úèÔ∏è Edit</button>
                                </div>
                                ${swingSpeed 
                                    ? `<div class="swing-speed-value">${swingSpeed} <span class="unit">mph</span></div>
                                       <div class="swing-speed-source">Source: ${sourceLabels[swingSpeedSource] || swingSpeedSource}</div>`
                                    : `<div class="swing-speed-value not-set">Not set - tap Edit to enter</div>`
                                }
                                ${swingSpeed ? `
                                <div class="swing-speed-recommendation">
                                    <div class="swing-speed-rec-title">RETAIL RECOMMENDED FLEX FOR ${swingSpeed} MPH</div>
                                    <div class="swing-speed-rec-row">
                                        <span class="swing-speed-rec-zone">Woods/Driver:</span>
                                        <span class="swing-speed-rec-value">${recommended.woods}</span>
                                    </div>
                                    <div class="swing-speed-rec-row">
                                        <span class="swing-speed-rec-zone">Irons:</span>
                                        <span class="swing-speed-rec-value">${recommended.irons}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        // Edit mode panel
                        const currentSpeed = swingSpeed || 90;
                        const handicap = window.currentClient?.handicap || 15;
                        const estimatedSpeed = gender === 'female' 
                            ? Math.max(65, 90 - (handicap * 0.8))
                            : Math.max(75, 105 - (handicap * 1));
                        
                        clubsHtml += `
                            <div class="swing-speed-edit-panel">
                                <div class="swing-speed-edit-title">Update Swing Speed</div>
                                
                                <div class="swing-speed-slider-container">
                                    <div class="swing-speed-slider-value" id="swing-speed-display">${currentSpeed} mph</div>
                                    <input type="range" class="swing-speed-slider" id="swing-speed-slider" 
                                           min="50" max="130" value="${currentSpeed}" 
                                           oninput="document.getElementById('swing-speed-display').textContent = this.value + ' mph'">
                                    <div class="swing-speed-slider-labels">
                                        <span>50 mph</span>
                                        <span>130 mph</span>
                                    </div>
                                </div>
                                
                                <div class="swing-speed-source-select">
                                    <div class="swing-speed-source-label">How did you measure this?</div>
                                    <div class="swing-speed-source-options">
                                        <label class="swing-speed-source-option">
                                            <input type="radio" name="swing-speed-source" value="trackman" ${swingSpeedSource === 'trackman' ? 'checked' : ''}>
                                            Launch monitor (TrackMan, FlightScope, etc.)
                                        </label>
                                        <label class="swing-speed-source-option">
                                            <input type="radio" name="swing-speed-source" value="fitting" ${swingSpeedSource === 'fitting' ? 'checked' : ''}>
                                            Professional fitting session
                                        </label>
                                        <label class="swing-speed-source-option">
                                            <input type="radio" name="swing-speed-source" value="mevo" ${swingSpeedSource === 'mevo' ? 'checked' : ''}>
                                            Personal monitor (Mevo, Rapsodo, etc.)
                                        </label>
                                        <label class="swing-speed-source-option">
                                            <input type="radio" name="swing-speed-source" value="estimated" ${swingSpeedSource === 'estimated' || !swingSpeedSource ? 'checked' : ''}>
                                            Estimated / I'm not sure
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="swing-speed-tip">
                                    üí° Based on ${handicap}-handicap ${gender}, estimated speed is ~${Math.round(estimatedSpeed)} mph
                                </div>
                                
                                <div class="swing-speed-edit-actions" style="flex-wrap: wrap; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="toggleSwingSpeedEdit('flex')" style="flex: 1; min-width: 80px;">Cancel</button>
                                    <button class="btn btn-secondary" onclick="saveSwingSpeed('flex', false)" style="flex: 1; min-width: 100px;">üíæ Save Only</button>
                                    <button class="btn btn-primary" onclick="saveSwingSpeed('flex', true)" style="flex: 1; min-width: 130px;">üíæ Save & Regrade</button>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Sort by loft order (driver to wedge)
                    const sortedClubs = [...clubs].sort((a, b) => getClubSortOrder(a) - getClubSortOrder(b));
                    
                    // Count flex types for summary (using normalized values)
                    const flexCounts = {};
                    sortedClubs.forEach(club => {
                        const rawFlex = club.shaft_flex || getStrengthValue(club, 'flex');
                        if (rawFlex) {
                            const normalizedFlex = normalizeFlexForDropdown(rawFlex);
                            flexCounts[normalizedFlex] = (flexCounts[normalizedFlex] || 0) + 1;
                        }
                    });
                    
                    // Determine dominant flex (normalized)
                    const dominantFlex = Object.entries(flexCounts).sort((a, b) => b[1] - a[1])[0];
                    
                    // Check if we're in edit mode
                    if (window.flexEditMode) {
                        // Render edit UI instead of normal display
                        renderFlexEditMode();
                        return; // Exit early - renderFlexEditMode handles the rest
                    }
                    
                    // Add "YOUR CLUBS" header with inline edit buttons (pro view only)
                    if (!isClientView) {
                        clubsHtml += `
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 12px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-primary); font-weight: 500;">Your Current Flex Setup</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Inconsistent flex labels shown with ‚ö†</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-reset-small" onclick="resetFlexToOriginal()" style="padding: 6px 10px; font-size: 11px;">‚Ü∫ Reset</button>
                                    <button class="btn-edit-small" onclick="toggleFlexEditMode()" style="padding: 6px 10px; font-size: 11px;">‚úèÔ∏è Edit</button>
                                </div>
                            </div>
                        `;
                    } else {
                        clubsHtml += `
                            <div style="margin-top: 12px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div style="font-size: 12px; color: var(--text-primary); font-weight: 500;">Your Current Flex Setup</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Inconsistent flex labels shown with ‚ö†</div>
                            </div>
                        `;
                    }
                    
                    sortedClubs.forEach(club => {
                        const actualFlex = club.shaft_flex;
                        const inferredFlex = getStrengthValue(club, 'flex');
                        const rawFlex = actualFlex || inferredFlex;
                        
                        // Normalize flex for display (convert S ‚Üí Stiff, R ‚Üí Regular, etc.)
                        const normalizedFlex = rawFlex ? normalizeFlexForDropdown(rawFlex) : 'Regular';
                        const hasActualData = !!actualFlex;
                        
                        // Display: show normalized flex, with note if defaulted
                        let displayFlex = normalizedFlex;
                        if (!hasActualData && !inferredFlex) {
                            displayFlex = 'Regular'; // Default when no data
                        }
                        
                        // Highlight inconsistent flex labels (compare to DOMINANT flex, not swing speed)
                        // NOTE: Flex labels have no industry standard - we only check for consistency within the bag
                        let status = '';
                        if (hasActualData && dominantFlex && normalizedFlex !== dominantFlex[0]) {
                            status = 'issue'; // Flex label differs from most common in bag
                        } else if (!hasActualData) {
                            status = 'estimated'; // No actual flex data - using default
                        }
                        
                        clubsHtml += `<div class="factor-club-row">
                            <span class="factor-club-name">${club.clubType}</span>
                            <span class="factor-club-value ${status}">${displayFlex}${status === 'issue' ? ' ‚ö†' : ''}</span>
                        </div>`;
                    });
                } else if (factorId === 'kickpoint') {
                    // Zone-based display - group by category and highlight within-zone mismatches
                    
                    // Determine zone for each club - PW stays with IRONS (loft ~45¬∞)
                    function getZone(club) {
                        const type = (club.clubType || '').toLowerCase();
                        const loft = club.loft || 0;
                        if (type === 'driver' || type.includes('wood')) return 'woods';
                        if (type.includes('hybrid') || /^\d+h$/i.test(type)) return 'hybrids';
                        // PW (45¬∞) stays with irons
                        if (type === 'pw' || type === 'pitching') return 'irons';
                        // Degree wedges - check if starts with 2 digits (46-64) regardless of suffix
                        const degMatch = type.match(/^(\d+)/);
                        if (degMatch) {
                            const num = parseInt(degMatch[1], 10);
                            if (num >= 46 && num <= 64) return 'wedges';  // 46¬∞ through 64¬∞ are wedges
                        }
                        // Named wedges
                        if (['gw','sw','lw','aw','gap','sand','lob'].some(w => type === w || type.includes(w))) return 'wedges';
                        // Irons
                        if (type.includes('iron') || /^\d+-iron$/i.test(type)) return 'irons';
                        // Fallback to loft check
                        if (loft >= 48) return 'wedges';
                        return 'irons';
                    }
                    
                    // Zone order for sorting
                    const zoneOrder = { woods: 0, hybrids: 1, irons: 2, wedges: 3 };
                    
                    // Sort by zone first, then by loft within zone
                    const sortedClubs = [...clubs].sort((a, b) => {
                        const zoneA = getZone(a);
                        const zoneB = getZone(b);
                        if (zoneA !== zoneB) return zoneOrder[zoneA] - zoneOrder[zoneB];
                        return getClubSortOrder(a) - getClubSortOrder(b);
                    });
                    
                    // Group clubs by zone with kickpoint data
                    const zones = { woods: [], hybrids: [], irons: [], wedges: [] };
                    sortedClubs.forEach(club => {
                        // Use same lookup as display - check multiple possible fields
                        const kp = club.shaft_kickpoint || getStrengthValue(club, 'kickpoint') || club.kickpoint;
                        if (kp) {
                            const zone = getZone(club);
                            console.log('ZONE ASSIGNMENT:', club.clubType, '‚Üí', zone, '(kickpoint:', kp, ')');
                            zones[zone].push({ 
                                club, 
                                kickpoint: kp.toLowerCase().trim(),
                                original: kp 
                            });
                        }
                    });
                    
                    // Find dominant kickpoint per zone (need 2+ clubs)
                    const zoneDominant = {};
                    const zoneInfo = {};
                    Object.entries(zones).forEach(([zone, items]) => {
                        zoneInfo[zone] = { count: items.length, kickpoints: new Set(items.map(i => i.kickpoint)) };
                        if (items.length >= 2) {
                            const counts = {};
                            items.forEach(i => counts[i.kickpoint] = (counts[i.kickpoint] || 0) + 1);
                            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                            zoneDominant[zone] = sorted[0][0];
                        }
                    });
                    console.log('ZONE DOMINANT:', zoneDominant);
                    console.log('ZONE INFO:', JSON.stringify(zoneInfo));
                    
                    // Find what adjacent zone has (for single-club comparisons)
                    const adjacentZoneKickpoint = {
                        woods: zoneDominant.hybrids || null,
                        hybrids: zoneDominant.irons || zoneDominant.woods || null
                    };
                    
                    let currentZone = '';
                    sortedClubs.forEach(club => {
                        const kickpoint = club.shaft_kickpoint || getStrengthValue(club, 'kickpoint');
                        if (kickpoint) {
                            const zone = getZone(club);
                            const dominant = zoneDominant[zone];
                            const kpLower = kickpoint.toLowerCase().trim();
                            
                            // Add zone header when zone changes
                            if (zone !== currentZone) {
                                const zoneLabels = { woods: 'üå≤ WOODS', hybrids: 'üîÄ HYBRIDS', irons: '‚õ≥ IRONS', wedges: 'üéØ WEDGES' };
                                clubsHtml += `<div class="factor-zone-header" style="margin-top: ${currentZone ? '12px' : '0'}; padding: 4px 0; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1);">${zoneLabels[zone] || zone}</div>`;
                                currentZone = zone;
                            }
                            
                            // Check if this club's kickpoint differs from zone dominant
                            const zoneDom = zoneDominant[zone];
                            const mismatch = zoneDom && kpLower !== zoneDom;
                            
                            // Build the value cell - yellow highlight if mismatch
                            let valueHtml = '';
                            if (mismatch) {
                                const zoneLabel = zone === 'irons' ? 'other irons' : 
                                                  zone === 'woods' ? 'other woods' :
                                                  zone === 'hybrids' ? 'other hybrids' : 'other wedges';
                                valueHtml = `<span class="factor-club-value kickpoint-mismatch">${kickpoint} ‚ö† should match ${zoneLabel} (${zoneDom})</span>`;
                                console.log('KICKPOINT MISMATCH:', club.clubType, kickpoint, 'vs dominant', zoneDom);
                            } else if (!zoneDom && zoneInfo[zone] && zoneInfo[zone].count === 1) {
                                // Single club in zone - check if differs from adjacent zone
                                const adjacent = adjacentZoneKickpoint[zone];
                                if (adjacent && kpLower !== adjacent) {
                                    valueHtml = `<span class="factor-club-value" style="color: #888;">${kickpoint} ‚Ñπ</span>`;
                                } else {
                                    valueHtml = `<span class="factor-club-value">${kickpoint}</span>`;
                                }
                            } else {
                                valueHtml = `<span class="factor-club-value">${kickpoint}</span>`;
                            }
                            
                            clubsHtml += `<div class="factor-club-row">
                                <span class="factor-club-name">${club.clubType}</span>
                                ${valueHtml}
                            </div>`;
                        }
                    });
                    
                    // Add guidance based on findings
                    let guidance = '<div class="factor-estimated-footnote" style="margin-top: 12px;">';
                    
                    // Check for within-zone issues
                    const issueZones = [];
                    Object.entries(zones).forEach(([zone, items]) => {
                        if (items.length >= 2 && zoneInfo[zone].kickpoints.size > 1) {
                            issueZones.push(zone);
                        }
                    });
                    
                    if (issueZones.length > 0) {
                        guidance += `<strong style="color: var(--yellow);">‚ö† Action Needed:</strong> Your ${issueZones.join(' and ')} have mixed kickpoints. For consistent ball flight, clubs within the same category should match.<br><br>`;
                    }
                    
                    // Check for single-zone differences (like Driver alone)
                    if (zones.woods.length === 1 && zoneDominant.hybrids && zones.woods[0].kickpoint !== zoneDominant.hybrids) {
                        guidance += `<strong style="color: var(--text-muted);">‚Ñπ Note:</strong> Driver has different kickpoint than hybrids. This may be intentional for launch optimization, but consider matching if you want consistent feel throughout long clubs.<br><br>`;
                    }
                    
                    guidance += `<span style="color: var(--text-muted);">Different kickpoints between categories (woods vs irons vs wedges) is normal and expected with standard OEM equipment.</span>`;
                    guidance += '</div>';
                    clubsHtml += guidance;
                } else if (factorId === 'length') {
                    // Body Fit Baseline indicator
                    const bodyFitBaseline = window.currentAnalysisData?.body_fit_baseline;
                    if (bodyFitBaseline && bodyFitBaseline.heightDisplay) {
                        const adj = bodyFitBaseline.adjustment;
                        const adjText = adj > 0 ? `+${adj}"` : (adj < 0 ? `${adj}"` : 'standard');
                        const direction = adj > 0 ? 'longer' : (adj < 0 ? 'shorter' : 'same as');
                        clubsHtml += `
                            <div class="bodyfit-indicator">
                                <span class="bodyfit-icon">üìè</span>
                                <span>Body Fit: <strong>${bodyFitBaseline.heightDisplay}</strong>, WTF: <strong>${bodyFitBaseline.wristToFloor}"</strong> ‚Äî All lengths compared to your body (${adjText} ${direction} than standard)</span>
                            </div>
                        `;
                    }
                    
                    let hasEstimatedValues = false;
                    // Sort by loft order (driver to wedge)
                    const sortedClubs = [...clubs].sort((a, b) => getClubSortOrder(a) - getClubSortOrder(b));
                    
                    // Get length suggestions from backend
                    const lengthSuggestions = window.currentAnalysisData?.length_suggestions || [];
                    
                    sortedClubs.forEach(club => {
                        const length = club.length || getStrengthValue(club, 'length');
                        if (length) {
                            const isEst = club.lengthIsDefault || false;
                            if (isEst) hasEstimatedValues = true;
                            const lengthVal = typeof length === 'number' ? length : parseFloat(length);
                            
                            // Check for length suggestion from backend
                            const suggestion = lengthSuggestions.find(s => s.clubType === club.clubType);
                            
                            let valueHtml = '';
                            if (suggestion && suggestion.isBodyFitBased) {
                                // Has body fit suggestion - show teal badge
                                const direction = suggestion.adjustment > 0 ? 'longer' : 'shorter';
                                const amount = Math.abs(suggestion.adjustment).toFixed(2);
                                valueHtml = `<span class="factor-club-value length-baseline">${lengthVal}" ‚ö† ideal: ${suggestion.idealLength}" (${amount}" ${direction})</span>`;
                            } else if (isEst) {
                                valueHtml = `<span class="factor-club-value estimated">${lengthVal}"</span>`;
                            } else {
                                valueHtml = `<span class="factor-club-value">${lengthVal}"</span>`;
                            }
                            
                            clubsHtml += `<div class="factor-club-row">
                                <span class="factor-club-name">${club.clubType}</span>
                                ${valueHtml}
                            </div>`;
                        }
                    });
                    if (hasEstimatedValues) {
                        clubsHtml += `<div class="factor-estimated-footnote">Estimated lengths based on standard specifications. Enter actual club lengths for accurate analysis.</div>`;
                    }
                    if (bodyFitBaseline && bodyFitBaseline.heightDisplay) {
                        clubsHtml += `<div class="factor-estimated-footnote" style="color: #00CED1; margin-top: 8px;">üìè Lengths compared against your body measurements using Wishon fitting methodology.</div>`;
                    }
                } else if (factorId === 'lie') {
                    let hasEstimatedValues = false;
                    // Sort by loft order (driver to wedge)
                    const sortedClubs = [...clubs].sort((a, b) => getClubSortOrder(a) - getClubSortOrder(b));
                    sortedClubs.forEach(club => {
                        const lie = club.lie || getStrengthValue(club, 'lie');
                        if (lie) {
                            const isEst = club.lieIsDefault || false;
                            if (isEst) hasEstimatedValues = true;
                            const estClass = isEst ? 'estimated' : '';
                            const lieVal = typeof lie === 'number' ? `${lie}¬∞` : lie;
                            clubsHtml += `<div class="factor-club-row">
                                <span class="factor-club-name">${club.clubType}</span>
                                <span class="factor-club-value ${estClass}">${lieVal}</span>
                            </div>`;
                        }
                    });
                    if (hasEstimatedValues) {
                        clubsHtml += `<div class="factor-estimated-footnote">Estimated lie angles based on standard specifications. Enter actual lie angles for accurate analysis.</div>`;
                    }
                } else if (factorId === 'torque') {
                    // Sort by loft order (driver to wedge)
                    const sortedClubs = [...clubs].sort((a, b) => getClubSortOrder(a) - getClubSortOrder(b));
                    sortedClubs.forEach(club => {
                        const torque = club.shaft_torque || getStrengthValue(club, 'torque');
                        if (torque) {
                            const torqueVal = typeof torque === 'number' ? `${torque}¬∞` : torque;
                            clubsHtml += `<div class="factor-club-row">
                                <span class="factor-club-name">${club.clubType}</span>
                                <span class="factor-club-value">${torqueVal}</span>
                            </div>`;
                        }
                    });
                }
                
                // Fallback if no data for this factor
                if (!clubsHtml) {
                    clubsHtml = '<div class="factor-club-row"><span class="factor-club-name">No data available for this factor</span></div>';
                }
            } else {
                // Fallback to demo data
                factor.clubs.forEach(club => {
                    const statusClass = club.status === 'issue' ? 'issue' : (club.status === 'good' ? 'good' : '');
                    clubsHtml += `<div class="factor-club-row">
                        <span class="factor-club-name">${club.name}</span>
                        <span class="factor-club-value ${statusClass}">${club.value}</span>
                    </div>`;
                });
            }
            document.getElementById('factor-modal-clubs').innerHTML = clubsHtml;
            
            // AI Analysis content - use real issues if available
            let aiAnalysisHtml = factor.aiAnalysis; // Default to demo
            if (analysis && analysis.issues_found && analysis.issues_found.length > 0) {
                const factorKeywords = {
                    'loft': ['loft', 'gap between', 'gapping', 'duplicate', 'overlap', 'same loft', 'both 50', 'both 52', 'both 54', 'both 56', 'both 58', 'both 60'],
                    'age': ['year old', 'years old', 'older', 'aging', 'updating', 'outdated'],
                    'weight': ['weight', 'gram', 'g shaft', 'heavier', 'lighter', 'g)', 'g avg'],
                    'flex': ['flex', 'stiff', 'regular', 'senior', 'x-stiff', 'a-flex', 'mixed'],
                    'kickpoint': ['kickpoint', 'kick point', 'kick-point', 'bend point'],
                    'length': ['length', 'inch', '"', 'longer', 'shorter', '\\" gap'],
                    'lie': ['lie angle', 'lie difference'],
                    'torque': ['torque']
                };
                // Negative keywords - exclude issues containing these for specific factors
                const factorExclusions = {
                    'loft': ['lie', 'weight', 'flex', 'length', 'torque', 'kickpoint', 'putter'],
                    'weight': ['kickpoint', 'flex', 'loft', 'lie', 'torque', 'length', 'ball flight'],
                    'flex': ['kickpoint', 'weight', 'loft', 'lie', 'torque', 'length'],
                    'kickpoint': ['weight', 'flex', 'loft', 'lie', 'torque', 'length'],
                    'length': ['lie', 'putter', 'kickpoint', 'flex', 'weight', 'torque'],
                    'lie': ['putter', 'kickpoint', 'flex', 'weight', 'torque', 'length'],
                    'torque': ['kickpoint', 'flex', 'weight', 'loft', 'lie', 'length']
                };
                const keywords = factorKeywords[factorId] || [];
                const exclusions = factorExclusions[factorId] || [];
                
                const relevantIssues = analysis.issues_found.filter(issue => {
                    const lower = issue.toLowerCase();
                    // Must match at least one keyword
                    const hasKeyword = keywords.some(kw => lower.includes(kw));
                    // Must NOT match any exclusion
                    const hasExclusion = exclusions.some(ex => lower.includes(ex));
                    return hasKeyword && !hasExclusion;
                });
                
                const score = analysis.component_scores?.[componentKeyMap[factorId]]?.score;
                const clubs = analysis.clubs || [];
                
                if (relevantIssues.length > 0) {
                    aiAnalysisHtml = '<strong>Issues Found:</strong><ul style="margin: 8px 0; padding-left: 20px;">';
                    relevantIssues.forEach(issue => {
                        aiAnalysisHtml += '<li>' + issue + '</li>';
                    });
                    aiAnalysisHtml += '</ul>';
                    
                    // Add smart commentary based on factor type
                    let commentary = '';
                    
                    if (factorId === 'loft') {
                        // Check for duplicates or large gaps
                        const hasDuplicates = relevantIssues.some(i => i.toLowerCase().includes('duplicate') || i.toLowerCase().includes('overlap') || i.toLowerCase().includes('both'));
                        const hasLargeGaps = relevantIssues.some(i => i.toLowerCase().includes('gap') && (i.includes('6¬∞') || i.includes('7¬∞') || i.includes('8¬∞')));
                        if (hasDuplicates) {
                            commentary = 'Duplicate lofts create redundancy in your bag. Consider replacing one club with a different loft to fill distance gaps.';
                        } else if (hasLargeGaps) {
                            commentary = 'Large loft gaps make it difficult to control distances consistently. Consider adding a club to bridge the gap.';
                        }
                    } else if (factorId === 'age') {
                        const oldClubs = clubs.filter(c => {
                            const year = c.year || c.release_year;
                            return year && (new Date().getFullYear() - year) > 7;
                        });
                        if (oldClubs.length > 0) {
                            commentary = `${oldClubs.length} club(s) are over 7 years old. Modern equipment offers improved forgiveness, distance, and consistency that could benefit your game.`;
                        }
                    } else if (factorId === 'weight') {
                        // Zone-aware weight commentary
                        const hasWithinZoneIssue = relevantIssues.some(i => 
                            i.toLowerCase().includes('outlier') || 
                            i.toLowerCase().includes('doesn\'t match') ||
                            i.toLowerCase().includes('within')
                        );
                        const hasCrossZoneIssue = relevantIssues.some(i => 
                            i.toLowerCase().includes('large weight difference') || 
                            i.toLowerCase().includes('jump')
                        );
                        
                        if (hasWithinZoneIssue) {
                            commentary = 'One or more clubs have weights that don\'t match others in the same category. Consistent weights within your irons (or woods/wedges) promote better tempo and feel.';
                        } else if (hasCrossZoneIssue) {
                            commentary = 'Note: Weight differences between woods and irons are normal due to graphite vs steel shafts. Only within-category inconsistencies affect your score.';
                        } else {
                            commentary = 'Weight consistency within each club category helps maintain consistent swing tempo and feel throughout your bag.';
                        }
                    } else if (factorId === 'flex') {
                        const flexTypes = new Set();
                        // Inline normalization function since normalizeFlexValue is defined later
                        const normalizeFlex = (flex) => {
                            if (!flex) return '';
                            const f = flex.toLowerCase().trim();
                            // Filter out invalid flex values (e.g., "wedge" stored by mistake)
                            if (f === 'wedge' || f === 'putter' || f === 'n/a' || f === 'unknown') return '';
                            if (f === 'l' || f === 'ladies' || f === 'lady') return 'ladies';
                            if (f === 'a' || f === 'sr' || f === 'senior' || f === 'am') return 'senior';
                            if (f === 'r' || f === 'regular' || f === 'reg' || f === 'm' || f === 'med' || f === 'medium') return 'regular';
                            if (f === 's' || f === 'stiff' || f === 'firm') return 'stiff';
                            if (f === 'x' || f === 'xs' || f === 'x-stiff' || f === 'xstiff' || f === 'extra stiff' || f === 'tour') return 'x-stiff';
                            if (/\d+s$/i.test(f) || /s\d*$/i.test(f)) return 'stiff';
                            if (/\d+r$/i.test(f) || /r\d*$/i.test(f)) return 'regular';
                            if (/\d+x$/i.test(f) || /x\d*$/i.test(f)) return 'x-stiff';
                            if (/\d+a$/i.test(f) || /a\d*$/i.test(f)) return 'senior';
                            if (/\d+l$/i.test(f) || /l\d*$/i.test(f)) return 'ladies';
                            return f;
                        };
                        clubs.forEach(c => {
                            const flex = c.shaft_flex;
                            if (flex) {
                                const normalized = normalizeFlex(flex);
                                if (normalized) flexTypes.add(normalized);
                            }
                        });
                        // Educational context about flex + issue description
                        const flexEducation = '<strong>Important:</strong> Shaft flex labels (Regular, Stiff, X-Stiff) have no industry standard. Research shows only 10-20% of shafts match their printed flex when measured. A "Stiff" from one brand may equal "Regular" from another. <em>Flex is largely a marketing term, not a technical specification.</em>';
                        if (flexTypes.size > 2) {
                            commentary = `${flexEducation}<br><br>Your bag has ${flexTypes.size} different flex labels. While label consistency can help with feel, the actual performance difference may be minimal due to the lack of standardization.`;
                        } else if (flexTypes.size === 2) {
                            commentary = `${flexEducation}<br><br>You have 2 different flex labels in your bag. This is common and usually not a significant performance issue - focus on other factors first.`;
                        } else {
                            commentary = `${flexEducation}<br><br>Your flex labels are consistent, which is good for psychological confidence even if the actual stiffness varies between brands.`;
                        }
                    } else if (factorId === 'kickpoint') {
                        // Zone-based analysis: kickpoint should be consistent WITHIN categories
                        // Different between woods/irons/wedges is NORMAL
                        const zones = { woods: [], hybrids: [], irons: [], wedges: [] };
                        clubs.forEach(c => {
                            const kp = c.shaft_kickpoint?.toLowerCase();
                            if (!kp) return;
                            const type = (c.clubType || '').toLowerCase();
                            const loft = c.loft || 0;
                            if (type === 'driver' || type.includes('wood')) zones.woods.push(kp);
                            else if (type.includes('hybrid') || /^\d+h$/i.test(type)) zones.hybrids.push(kp);
                            else if (loft >= 50 || ['gw','sw','lw','50¬∞','52¬∞','54¬∞','56¬∞','58¬∞','60¬∞'].some(w => type.includes(w))) zones.wedges.push(kp);
                            else zones.irons.push(kp);
                        });
                        
                        // Check for inconsistency within zones
                        const zoneIssues = [];
                        Object.entries(zones).forEach(([zone, kps]) => {
                            if (kps.length >= 2) {
                                const unique = new Set(kps);
                                if (unique.size > 1) zoneIssues.push(zone);
                            }
                        });
                        
                        if (zoneIssues.length > 0) {
                            commentary = `Kickpoint inconsistency detected in your ${zoneIssues.join(' and ')}. For best feel and trajectory control, clubs within the same category should have matching kickpoints. Note: Different kickpoints between woods and irons is normal and expected.`;
                        } else {
                            // Multiple kickpoints across bag but consistent within zones
                            const allKps = new Set([...zones.woods, ...zones.hybrids, ...zones.irons, ...zones.wedges]);
                            if (allKps.size > 1 && score >= 90) {
                                commentary = 'Your kickpoints are consistent within each club category. Different kickpoints between woods, irons, and wedges is standard practice and not a concern.';
                            }
                        }
                    } else if (factorId === 'length') {
                        // Check if clubs have non-standard lengths
                        const stdLengths = {
                            'driver': 45.0, '3-wood': 42.5, '5-wood': 41.5, '2h': 40.5,
                            '3h': 40.0, '4h': 39.5, '5h': 39.0, '6-iron': 37.0, '7-iron': 36.5,
                            '8-iron': 36.0, '9-iron': 35.5, 'pw': 35.5, '50¬∞': 35.25, '58¬∞': 35.0
                        };
                        let wayOffCount = 0;
                        clubs.forEach(club => {
                            const std = stdLengths[(club.clubType || '').toLowerCase()];
                            if (std && club.length && Math.abs(club.length - std) > 1.5) {
                                wayOffCount++;
                            }
                        });
                        if (wayOffCount > 0) {
                            commentary = `${wayOffCount} club(s) have lengths significantly different from standard. Verify these measurements or use "Reset to Standard" if data was entered incorrectly.`;
                        } else if (score && score < 85) {
                            commentary = 'Inconsistent length progression affects posture and ball position consistency. Standard progression is 0.5" between consecutive clubs.';
                        }
                    } else if (factorId === 'lie') {
                        commentary = 'Lie angle affects shot direction at impact. Incorrect lie angles cause shots to go left (too upright) or right (too flat) even with a good swing.';
                    } else if (factorId === 'torque') {
                        commentary = 'Torque measures shaft twist during the swing. Inconsistent torque values affect clubface feel and timing at impact.';
                    }
                    
                    if (commentary) {
                        aiAnalysisHtml += `<p style="margin-top: 10px; color: var(--yellow);"><strong>Note:</strong> ${commentary}</p>`;
                    }
                    
                } else {
                    // No issues found - check if score still indicates problems
                    if (score && score < 70) {
                        aiAnalysisHtml = `<strong>Attention Needed:</strong> Score of ${score} indicates issues in this area. Review the club data above for potential problems.`;
                        
                        // Factor-specific guidance when no specific issues but low score
                        let guidance = '';
                        if (factorId === 'loft') guidance = 'Check for duplicate lofts or large gaps between clubs.';
                        else if (factorId === 'age') guidance = 'Consider updating clubs that are more than 7 years old.';
                        else if (factorId === 'weight') guidance = 'Look for large weight jumps between consecutive clubs.';
                        else if (factorId === 'flex') guidance = 'Verify all shafts have consistent flex ratings.';
                        else if (factorId === 'kickpoint') guidance = 'Check for mixed kickpoints within your woods, irons, or wedges. Different kickpoints between categories is normal.';
                        else if (factorId === 'length') guidance = 'Verify length progression follows standard 0.5" increments.';
                        else if (factorId === 'lie') guidance = 'Check lie angle progression from short irons to long clubs.';
                        else if (factorId === 'torque') guidance = 'Look for torque consistency across your shaft set.';
                        
                        if (guidance) {
                            aiAnalysisHtml += `<p style="margin-top: 8px;">${guidance}</p>`;
                        }
                    } else if (score && score >= 95) {
                        aiAnalysisHtml = `<strong>Excellent!</strong> Score of ${score}. This area of your bag shows outstanding consistency and optimization.`;
                    } else if (score && score >= 85) {
                        aiAnalysisHtml = `<strong>Great news:</strong> This factor is performing well with a score of ${score}. No significant issues detected.`;
                    } else if (score) {
                        aiAnalysisHtml = `<strong>Good:</strong> Score of ${score}. Minor improvements possible but no major concerns.`;
                    }
                }
            }
            document.getElementById('factor-modal-ai').innerHTML = aiAnalysisHtml;
            
            // Pro Insight content - use real AI salesOpportunities if available
            let proInsightHtml = factor.proInsight; // Default to demo
            if (analysis && analysis.ai_bag_analysis && analysis.ai_bag_analysis.salesOpportunities) {
                const salesOps = analysis.ai_bag_analysis.salesOpportunities;
                const factorSalesMap = {
                    'age': salesOps.age,
                    'loft': salesOps.loft,
                    'flex': salesOps.flex,
                    'kickpoint': salesOps.kickpoint,
                    'weight': salesOps.weight,
                    'torque': salesOps.kickpoint, // Torque can use kickpoint's opportunity
                    'length': analysis.body_fit_baseline ? 'Consider custom fitting shaft lengths to match body measurements.' : 'No immediate opportunity ‚Äî Length is typically standard.',
                    'lie': 'No immediate opportunity ‚Äî Lie angles require fitting session to diagnose.'
                };
                const factorSales = factorSalesMap[factorId];
                if (factorSales && factorSales !== 'No immediate opportunity') {
                    proInsightHtml = `<strong>Sales Opportunity:</strong> ${factorSales}`;
                    if (salesOps.topPriority && (factorId === 'age' || factorId === 'loft' || factorId === 'flex')) {
                        proInsightHtml += `<br><br><strong>Top Priority:</strong> ${salesOps.topPriority}`;
                    }
                } else if (factorSales) {
                    proInsightHtml = `<strong>Low priority</strong> ‚Äî ${factorSales}`;
                }
            }
            document.querySelector('#factor-pro-insight .factor-pro-insight-content').innerHTML = proInsightHtml;
            
            // Show/hide based on tier and view
            const aiSection = document.getElementById('factor-ai-paid');
            const proInsight = document.getElementById('factor-pro-insight');
            const upgradePrompt = document.getElementById('factor-upgrade-prompt');
            
            if (isClientView && isFreeTier) {
                // Free client: hide AI, show upgrade prompt
                aiSection.style.display = 'none';
                proInsight.style.display = 'none';
                upgradePrompt.style.display = 'block';
            } else if (isClientView) {
                // Paid client: show AI, hide pro insight and upgrade
                aiSection.style.display = 'block';
                proInsight.style.display = 'none';
                upgradePrompt.style.display = 'none';
            } else {
                // Pro view: show AI and pro insight, hide upgrade
                aiSection.style.display = 'block';
                proInsight.style.display = 'block';
                upgradePrompt.style.display = 'none';
            }
            
            // Show Edit/Reset buttons only for length or lie factors (and not in client view)
            // Weight and Flex use inline buttons below the swing speed panel
            const editBtnsContainer = document.getElementById('factor-edit-buttons');
            const editBtn = document.getElementById('factor-edit-btn');
            if (editBtnsContainer) {
                if ((factorId === 'length' || factorId === 'lie') && !isClientView) {
                    editBtnsContainer.style.display = 'flex';
                    if (editBtn) {
                        editBtn.classList.remove('active');
                        editBtn.textContent = '‚úèÔ∏è Edit';
                    }
                } else {
                    editBtnsContainer.style.display = 'none';
                }
            }
            
            // Store current factor ID for edit mode
            window.currentFactorId = factorId;
            window.lengthEditMode = false;
            window.weightEditMode = false;
            window.lieEditMode = false;
            window.flexEditMode = false;
            window.loftEditMode = false;
            // Note: Don't reset swingSpeedEditMode here - it's managed by toggleSwingSpeedEdit
            
            openModal('factor-detail-modal');
            
            // Update grade explainer when we have analysis data
            if (analysis && analysis.grade_explainer) {
                updateGradeExplainer(analysis.grade_explainer);
            }
        }
        
        // ============================================
        // FACTOR EDIT MODE: Wrapper Functions
        // ============================================
        
        /**
         * Toggle edit mode based on current factor
         */
        function toggleFactorEditMode() {
            if (window.currentFactorId === 'length') {
                toggleLengthEditMode();
            } else if (window.currentFactorId === 'weight') {
                toggleWeightEditMode();
            } else if (window.currentFactorId === 'lie') {
                toggleLieEditMode();
            } else if (window.currentFactorId === 'loft') {
                toggleLoftEditMode();
            }
        }
        
        /**
         * Reset to default/original based on current factor
         */
        function resetFactorToDefault() {
            if (window.currentFactorId === 'length') {
                resetLengthsToStandard();
            } else if (window.currentFactorId === 'weight') {
                resetWeightToOriginal();
            } else if (window.currentFactorId === 'lie') {
                resetLieToOriginal();
            } else if (window.currentFactorId === 'loft') {
                resetLoftToOriginal();
            }
        }
        
        // ============================================
        // GLOBAL HELPER: Extract value from club grading strengths
        // ============================================
        function getStrengthValue(club, keyword) {
            if (!club.grading || !club.grading.strengths) return null;
            const match = club.grading.strengths.find(s => s.toLowerCase().includes(keyword.toLowerCase()));
            if (!match) return null;
            // Extract value after colon or in parentheses
            const colonMatch = match.match(/:\s*(.+)/);
            if (colonMatch) return colonMatch[1].trim();
            const parenMatch = match.match(/\(([^)]+)\)/);
            if (parenMatch) return parenMatch[1].trim();
            return match;
        }
        
        // ============================================
        // GLOBAL HELPER: Club Sort Order
        // ============================================
        function getClubSortOrder(club) {
            const type = (club.clubType || '').toLowerCase();
            
            // For irons, ALWAYS use club number (more reliable than loft data)
            if (type.includes('iron') || /^\d+-iron$/i.test(type)) {
                const num = parseInt(type.match(/\d+/)?.[0] || '5');
                return 20 + (num * 4); // 3i=32, 4i=36, 5i=40, 6i=44, 7i=48, 8i=52, 9i=56
            }
            
            // For woods/hybrids, use loft if available, else club type
            if (type === 'driver') return club.loft || 10;
            if (type === '3-wood' || type === '3w') return club.loft || 15;
            if (type === '5-wood' || type === '5w') return club.loft || 18;
            if (type === '7-wood' || type === '7w') return club.loft || 21;
            if (type.includes('wood')) return club.loft || 20;
            
            if (type.includes('hybrid') || /^\d+h$/i.test(type)) {
                const num = parseInt(type.match(/\d+/)?.[0] || '4');
                return club.loft || (18 + num); // 2H=20, 3H=21, 4H=22, etc.
            }
            
            if (type === 'pw' || type === 'pitching') return 64;
            
            // Degree wedges (50¬∞, 52¬∞, etc.) - sort after PW
            const degMatch = type.match(/^(\d+)/);
            if (degMatch) {
                const deg = parseInt(degMatch[1], 10);
                if (deg >= 46 && deg <= 64) return 65 + (deg - 46);
            }
            if (type === 'gw' || type === 'gap' || type === 'aw') return 68;
            if (type === 'sw' || type === 'sand') return 72;
            if (type === 'lw' || type === 'lob') return 76;
            return 999;
        }
        
        // ============================================
        // LENGTH EDIT MODE
        // ============================================
        
        function toggleLengthEditMode() {
            window.lengthEditMode = !window.lengthEditMode;
            const editBtn = document.getElementById('factor-edit-btn');
            
            if (window.lengthEditMode) {
                editBtn.classList.add('active');
                editBtn.textContent = '‚úì Done';
                renderLengthEditMode();
            } else {
                editBtn.classList.remove('active');
                editBtn.textContent = '‚úèÔ∏è Edit';
                // Re-render normal view
                showFactorDetail('length');
            }
        }
        
        async function resetLengthsToStandard() {
            const confirmed = await showConfirmModal(
                'Reset All Lengths?',
                'Reset all club lengths to standard values?\n\nThis will mark all lengths as default/estimated.',
                'Reset All'
            );
            if (!confirmed) return;
            
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs || !window.currentClient) {
                await showConfirmModal('Error', 'No club data available', 'OK');
                return;
            }
            
            // Standard lengths (Men's Steel)
            const standardLengths = {
                'Driver': 45.0, '3-Wood': 42.5, '4-Wood': 42.0, '5-Wood': 41.5,
                '7-Wood': 41.0, '9-Wood': 40.5,
                '2H': 40.5, '3H': 40.0, '4H': 39.5, '5H': 39.0, '6H': 38.5,
                '2-Hybrid': 40.5, '3-Hybrid': 40.0, '4-Hybrid': 39.5, '5-Hybrid': 39.0, '6-Hybrid': 38.5,
                '3-Iron': 38.5, '4-Iron': 38.0, '5-Iron': 37.5, '6-Iron': 37.0,
                '7-Iron': 36.5, '8-Iron': 36.0, '9-Iron': 35.5, 
                'PW': 35.5, 'AW': 35.25, 'GW': 35.25, 'SW': 35.0, 'LW': 35.0,
                '46¬∞': 35.5, '48¬∞': 35.5, '50¬∞': 35.25, '52¬∞': 35.25, 
                '54¬∞': 35.0, '56¬∞': 35.0, '58¬∞': 35.0, '60¬∞': 35.0
            };
            
            try {
                const resetBtn = document.getElementById('factor-reset-btn');
                if (resetBtn) {
                    resetBtn.disabled = true;
                    resetBtn.textContent = '‚è≥...';
                }
                
                const clientId = window.currentClient.id;
                const batch = db.batch();
                let resetCount = 0;
                
                for (const club of analysis.clubs) {
                    if (!club.id) continue;
                    
                    const stdLength = standardLengths[club.clubType];
                    if (!stdLength) continue;
                    
                    const clubRef = db.collection('users').doc(clientId)
                        .collection('clubs').doc(club.id);
                    
                    batch.update(clubRef, {
                        length: stdLength,
                        lengthIsDefault: true,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update in-memory
                    club.length = stdLength;
                    club.lengthIsDefault = true;
                    resetCount++;
                }
                
                await batch.commit();
                console.log(`‚úÖ Reset ${resetCount} clubs to standard lengths`);
                
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = '‚Ü∫ Reset';
                }
                
                // Refresh display
                await fetchClientClubs(clientId);
                
                // Show regrade modal
                closeModal('factor-detail-modal');
                if (typeof showRegradeModal === 'function') {
                    showRegradeModal();
                } else {
                    const regrade = confirm(`Reset ${resetCount} clubs to standard lengths!\n\nRegrade now? (Uses 1 credit)`);
                    if (regrade && typeof gradeBag === 'function') {
                        gradeBag();
                    }
                }
                
            } catch (error) {
                console.error('Error resetting lengths:', error);
                alert('Error resetting lengths: ' + error.message);
                const resetBtn = document.getElementById('factor-reset-btn');
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = '‚Ü∫ Reset';
                }
            }
        }
        
        function renderLengthEditMode() {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs) return;
            
            const clubs = analysis.clubs;
            const sortedClubs = [...clubs].sort((a, b) => getClubSortOrder(a) - getClubSortOrder(b));
            
            // Standard club lengths - Men's Steel (most common for irons)
            // Based on industry standards from spec
            const standardLengths = {
                'Driver': 45.0, '3-Wood': 42.5, '4-Wood': 42.0, '5-Wood': 41.5,
                '7-Wood': 41.0, '9-Wood': 40.5,
                '2H': 40.5, '3H': 40.0, '4H': 39.5, '5H': 39.0, '6H': 38.5,
                '2-Hybrid': 40.5, '3-Hybrid': 40.0, '4-Hybrid': 39.5, '5-Hybrid': 39.0, '6-Hybrid': 38.5,
                '3-Iron': 38.5, '4-Iron': 38.0, '5-Iron': 37.5, '6-Iron': 37.0,
                '7-Iron': 36.5, '8-Iron': 36.0, '9-Iron': 35.5, 
                'PW': 35.5, 'AW': 35.25, 'GW': 35.25, 'SW': 35.0, 'LW': 35.0,
                '46¬∞': 35.5, '48¬∞': 35.5, '50¬∞': 35.25, '52¬∞': 35.25, 
                '54¬∞': 35.0, '56¬∞': 35.0, '58¬∞': 35.0, '60¬∞': 35.0
            };
            
            // Store standard lengths globally for reset function
            window.standardLengths = standardLengths;
            
            // Length thresholds (vs standard)
            const LENGTH_THRESHOLDS = { minor: 0.5, warning: 1.0, severe: 1.5 };
            
            // Build bulk adjustment options
            let bulkOptionsHtml = '<option value="0">No change</option>';
            
            // Add body fit apply option if body fit is active
            const bodyFitBaseline = analysis.body_fit_baseline;
            if (bodyFitBaseline && bodyFitBaseline.heightDisplay) {
                bulkOptionsHtml += '<option value="apply-bodyfit">üìè Apply Body Fit</option>';
            }
            
            const adjustments = [];
            for (let adj = 0.25; adj <= 2; adj += 0.25) {
                adjustments.push(adj);
                adjustments.push(-adj);
            }
            adjustments.sort((a, b) => Math.abs(a) - Math.abs(b));
            for (const adj of adjustments) {
                const sign = adj > 0 ? '+' : '';
                bulkOptionsHtml += `<option value="${adj}">${sign}${adj}"</option>`;
            }
            
            // Helper to get length from club data
            function getClubLength(club) {
                // Try direct length field
                if (club.length && typeof club.length === 'number') {
                    return club.length;
                }
                // Try grading strengths
                if (club.grading && club.grading.strengths) {
                    const lengthStr = club.grading.strengths.find(s => 
                        s.toLowerCase().includes('length') || s.toLowerCase().includes('inch'));
                    if (lengthStr) {
                        const match = lengthStr.match(/(\d+\.?\d*)\s*["'‚Ä≥]|(\d+\.?\d*)\s*inch/i);
                        if (match) return parseFloat(match[1] || match[2]);
                    }
                }
                // Fall back to standard length
                return standardLengths[club.clubType] || null;
            }
            
            // Build edit rows
            let editHtml = `
                <div class="length-select-all">
                    <input type="checkbox" id="length-select-all-checkbox" class="length-edit-checkbox" checked onchange="toggleAllLengthCheckboxes(this.checked)">
                    <label for="length-select-all-checkbox">Select All</label>
                    <select id="length-bulk-adjust" class="length-edit-select" style="margin-left: auto;" onchange="applyBulkLengthAdjust(this.value)">
                        ${bulkOptionsHtml}
                    </select>
                    <span style="font-size: 11px; color: var(--text-muted);">Bulk adjust</span>
                </div>
            `;
            
            // Add body fit summary banner if active
            if (bodyFitBaseline && bodyFitBaseline.adjustment !== undefined) {
                const adj = bodyFitBaseline.adjustment;
                const direction = adj > 0 ? 'longer' : 'shorter';
                const absAdj = Math.abs(adj).toFixed(1);
                editHtml += `
                    <div style="background: rgba(0, 206, 209, 0.15); border: 1px solid rgba(0, 206, 209, 0.4); border-radius: 8px; padding: 10px 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">üìè</span>
                        <div>
                            <div style="font-size: 13px; color: #00CED1; font-weight: 500;">Body Fit: ${bodyFitBaseline.heightDisplay}, WTF: ${bodyFitBaseline.wristToFloor}"</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Your ideal lengths are <strong style="color: #00CED1;">${absAdj}" ${direction}</strong> than standard</div>
                        </div>
                    </div>
                `;
            }
            
            sortedClubs.forEach((club, index) => {
                const currentLength = getClubLength(club);
                if (!currentLength) return; // Skip clubs without length
                
                const lengthVal = currentLength.toFixed(2);
                const isEstimated = !club.length || club.lengthIsDefault;
                const stdLength = standardLengths[club.clubType];
                
                // Calculate body fit ideal length if active
                let bodyFitIdeal = null;
                if (bodyFitBaseline && bodyFitBaseline.adjustment !== undefined && stdLength) {
                    bodyFitIdeal = stdLength + bodyFitBaseline.adjustment;
                }
                
                // === CALCULATE ISSUE SEVERITY ===
                let severity = 'ok';
                let warningText = '';
                let rowClass = '';
                
                if (isEstimated) {
                    // Estimated/default - just mark as needs input (body fit summary above handles the rest)
                    severity = 'severe';
                    rowClass = 'issue-severe';
                    warningText = `<span class="edit-warning-text severe">‚ö† needs input</span>`;
                } else if (bodyFitIdeal) {
                    // Body fit active - compare against body fit ideal
                    const deviation = Math.abs(currentLength - bodyFitIdeal);
                    const diff = currentLength - bodyFitIdeal;
                    
                    if (deviation > LENGTH_THRESHOLDS.severe) severity = 'severe';
                    else if (deviation > LENGTH_THRESHOLDS.warning) severity = 'warning';
                    else if (deviation > LENGTH_THRESHOLDS.minor) severity = 'minor';
                    
                    if (severity !== 'ok') {
                        const diffText = diff > 0 ? `+${diff.toFixed(2)}"` : `${diff.toFixed(2)}"`;
                        warningText = `<span class="edit-warning-text" style="color: #00CED1;">‚ö† ${diffText} vs ideal</span>`;
                        rowClass = `issue-${severity}`;
                    }
                } else if (stdLength) {
                    // No body fit - compare against standard
                    const deviation = Math.abs(currentLength - stdLength);
                    const diff = currentLength - stdLength;
                    
                    if (deviation > LENGTH_THRESHOLDS.severe) severity = 'severe';
                    else if (deviation > LENGTH_THRESHOLDS.warning) severity = 'warning';
                    else if (deviation > LENGTH_THRESHOLDS.minor) severity = 'minor';
                    
                    if (severity !== 'ok') {
                        const diffText = diff > 0 ? `+${diff.toFixed(2)}"` : `${diff.toFixed(2)}"`;
                        warningText = `<span class="edit-warning-text ${severity}">‚ö† ${diffText} vs std</span>`;
                        rowClass = `issue-${severity}`;
                    }
                }
                
                const estClass = isEstimated ? 'estimated' : '';
                
                // Per-club reset: enabled if current differs from standard
                const canReset = stdLength && Math.abs(currentLength - stdLength) >= 0.01;
                const resetDisabled = !canReset ? 'disabled' : '';
                const resetTitle = stdLength 
                    ? `Reset to standard (${stdLength}")` 
                    : 'No standard length available';
                
                // Data attribute for bulk body fit apply
                const bodyFitAttr = bodyFitIdeal ? `data-bodyfit-ideal="${bodyFitIdeal.toFixed(2)}"` : '';
                
                editHtml += `
                    <div class="length-edit-row ${rowClass}" data-club-id="${club.id}" data-club-type="${club.clubType}" data-original-length="${currentLength}" data-standard-length="${stdLength || ''}" data-is-estimated="${isEstimated}" ${bodyFitAttr}>
                        <input type="checkbox" class="length-edit-checkbox length-club-checkbox" checked data-index="${index}">
                        <span class="length-edit-club">${club.clubType}</span>
                        <span class="length-edit-current ${estClass}">${lengthVal}"${warningText}</span>
                        <input type="number" 
                               class="length-edit-input" 
                               value="${lengthVal}" 
                               min="30" max="50" step="0.25"
                               data-index="${index}"
                               data-original="${currentLength}">
                        <span class="length-edit-unit">"</span>
                        <button class="length-edit-reset-btn" 
                                onclick="resetSingleLength('${club.id}')" 
                                ${resetDisabled}
                                title="${resetTitle}">‚Ü∫</button>
                    </div>
                `;
            });
            
            // Add action buttons
            editHtml += `
                <div class="length-edit-actions">
                    <button class="btn btn-secondary" onclick="toggleLengthEditMode()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveLengthEdits()">üíæ Save Changes</button>
                </div>
            `;
            
            // Add footnote
            editHtml += `
                <div class="factor-estimated-footnote" style="margin-top: 12px; font-size: 11px;">
                    <span style="color: var(--red);">‚ö† needs input</span> = using standard defaults ‚Ä¢ ‚Ü∫ resets to standard length
                </div>
            `;
            
            document.getElementById('factor-modal-clubs').innerHTML = editHtml;
        }
        
        /**
         * Reset a single club's length to standard
         */
        async function resetSingleLength(clubId) {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs || !window.currentClient) return;
            
            const club = analysis.clubs.find(c => c.id === clubId);
            if (!club) return;
            
            const stdLength = window.standardLengths?.[club.clubType];
            if (!stdLength) {
                alert('No standard length available for this club.');
                return;
            }
            
            // Update the input field directly (don't save to DB yet)
            const row = document.querySelector(`.length-edit-row[data-club-id="${clubId}"]`);
            if (row) {
                const input = row.querySelector('.length-edit-input');
                if (input) {
                    input.value = stdLength.toFixed(2);
                    // Disable the reset button since it's now at standard
                    const resetBtn = row.querySelector('.length-edit-reset-btn');
                    if (resetBtn) resetBtn.disabled = true;
                }
            }
        }
        
        function toggleAllLengthCheckboxes(checked) {
            document.querySelectorAll('.length-club-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }
        
        function applyBulkLengthAdjust(value) {
            // Handle body fit apply
            if (value === 'apply-bodyfit') {
                document.querySelectorAll('.length-edit-input').forEach(input => {
                    const row = input.closest('.length-edit-row');
                    const checkbox = row.querySelector('.length-club-checkbox');
                    if (checkbox && checkbox.checked) {
                        const bodyFitIdeal = row.dataset.bodyfitIdeal;
                        if (bodyFitIdeal) {
                            input.value = parseFloat(bodyFitIdeal).toFixed(2);
                        }
                    }
                });
                // Reset bulk adjust dropdown
                document.getElementById('length-bulk-adjust').value = '0';
                return;
            }
            
            const adjustment = parseFloat(value) || 0;
            if (adjustment === 0) return;
            
            document.querySelectorAll('.length-edit-input').forEach(input => {
                const row = input.closest('.length-edit-row');
                const checkbox = row.querySelector('.length-club-checkbox');
                if (checkbox && checkbox.checked) {
                    const currentVal = parseFloat(input.value) || 0;
                    const newVal = Math.round((currentVal + adjustment) * 100) / 100;
                    // Clamp to valid range
                    input.value = Math.max(30, Math.min(50, newVal)).toFixed(2);
                }
            });
            
            // Reset bulk adjust dropdown
            document.getElementById('length-bulk-adjust').value = '0';
        }
        
        /**
         * Reset all lengths to standard values
         */
        function resetAllLengthsToStandard() {
            document.querySelectorAll('.length-edit-row').forEach(row => {
                const checkbox = row.querySelector('.length-club-checkbox');
                if (checkbox && checkbox.checked) {
                    const stdLength = row.dataset.standardLength;
                    const input = row.querySelector('.length-edit-input');
                    if (stdLength && input) {
                        input.value = parseFloat(stdLength).toFixed(2);
                    }
                }
            });
        }
        
        /**
         * Validate height feet input (4-7)
         */
        function validateHeightInput(input) {
            let val = parseInt(input.value);
            if (isNaN(val)) return;
            if (val < 4) input.value = 4;
            if (val > 7) input.value = 7;
        }
        
        /**
         * Validate height inches input (0-11)
         */
        function validateInchesInput(input) {
            let val = parseInt(input.value);
            if (isNaN(val)) return;
            if (val < 0) input.value = 0;
            if (val > 11) input.value = 11;
        }
        
        /**
         * Validate wrist-to-floor input (25-45)
         */
        function validateWTFInput(input) {
            let val = parseFloat(input.value);
            if (isNaN(val)) return;
            if (val < 25) input.value = 25;
            if (val > 45) input.value = 45;
        }
        
        async function saveLengthEdits() {
            const rows = document.querySelectorAll('.length-edit-row');
            const updates = [];
            
            rows.forEach(row => {
                const checkbox = row.querySelector('.length-club-checkbox');
                if (!checkbox || !checkbox.checked) return;
                
                const clubId = row.dataset.clubId;
                const clubType = row.dataset.clubType;
                const originalLength = parseFloat(row.dataset.originalLength);
                const input = row.querySelector('.length-edit-input');
                const newLength = parseFloat(input.value);
                
                // Only include if length changed
                if (!isNaN(newLength) && Math.abs(newLength - originalLength) >= 0.01 && newLength >= 30 && newLength <= 50) {
                    updates.push({
                        clubId: clubId,
                        clubType: clubType,
                        originalLength: originalLength,
                        newLength: Math.round(newLength * 100) / 100 // Round to 2 decimals
                    });
                }
            });
            
            if (updates.length === 0) {
                await showConfirmModal('No Changes', 'No changes to save. Modify length values to save.', 'OK');
                return;
            }
            
            // Show confirmation
            const changesList = updates.map(u => `${u.clubType}: ${u.originalLength}" ‚Üí ${u.newLength}"`).join('\n');
            const confirmed = await showConfirmModal(
                `Update ${updates.length} Club${updates.length > 1 ? 's' : ''}?`,
                changesList,
                'Save Changes'
            );
            
            if (!confirmed) return;
            
            // Save to Firestore
            try {
                const saveBtn = document.querySelector('.length-edit-actions .btn-primary');
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Saving...';
                
                // Call the save function (defined in firebase-auth.js)
                if (typeof saveLengthUpdates === 'function') {
                    await saveLengthUpdates(updates);
                    
                    // Show success
                    saveBtn.textContent = '‚úì Saved!';
                    
                    // Close modal and show regrade modal after short delay
                    setTimeout(() => {
                        closeModal('factor-detail-modal');
                        window.lengthEditMode = false;
                        
                        // Show the styled regrade modal
                        if (typeof showRegradeModal === 'function') {
                            showRegradeModal();
                        } else {
                            // Fallback to confirm
                            const regrade = confirm('Lengths updated!\n\nRegrade now? (Uses 1 credit)');
                            if (regrade && typeof gradeBag === 'function') {
                                gradeBag();
                            }
                        }
                    }, 500);
                } else {
                    throw new Error('Save function not available. Make sure firebase-auth.js is loaded.');
                }
            } catch (error) {
                console.error('Error saving lengths:', error);
                alert('Error saving lengths: ' + error.message);
                const saveBtn = document.querySelector('.length-edit-actions .btn-primary');
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Changes';
            }
        }
        
        // ============================================
        // WEIGHT EDIT MODE
        // ============================================
        
        /**
         * Toggle weight edit mode on/off
         */
        function toggleWeightEditMode() {
            window.weightEditMode = !window.weightEditMode;
            const editBtn = document.getElementById('factor-edit-btn');
            
            if (window.weightEditMode) {
                editBtn.classList.add('active');
                editBtn.textContent = '‚úï Cancel';
                renderWeightEditMode();
            } else {
                editBtn.classList.remove('active');
                editBtn.textContent = '‚úèÔ∏è Edit';
                // Re-render normal view
                showFactorDetail('weight');
            }
        }
        
        /**
         * Get weight zone for a club (matches display logic)
         */
        function getWeightZoneForEdit(club) {
            const type = (club.clubType || '').toLowerCase();
            if (type === 'driver') return 'woods';
            if (type.includes('wood') || /^\d+w$/i.test(type)) return 'woods';
            if (type.includes('hybrid') || /^\d+h$/i.test(type)) return 'hybrids';
            if (type === 'pw' || type === 'pitching') return 'irons';
            const degMatch = type.match(/^(\d+)/);
            if (degMatch) {
                const num = parseInt(degMatch[1], 10);
                if (num >= 46 && num <= 64) return 'wedges';
            }
            if (['gw','sw','lw','aw','gap','sand','lob'].some(w => type === w || type.includes(w))) return 'wedges';
            if (type.includes('iron') || /^\d+-iron$/i.test(type)) return 'irons';
            return 'irons';
        }
        
        /**
         * Render weight edit UI with zone grouping and number inputs
         */
        function renderWeightEditMode() {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs) return;
            
            const clubs = analysis.clubs;
            const weightZoneOrder = { woods: 0, hybrids: 1, irons: 2, wedges: 3 };
            
            // Sort by zone first, then by club order within zone
            const sortedClubs = [...clubs].sort((a, b) => {
                const zoneA = getWeightZoneForEdit(a);
                const zoneB = getWeightZoneForEdit(b);
                if (zoneA !== zoneB) return weightZoneOrder[zoneA] - weightZoneOrder[zoneB];
                return getClubSortOrder(a) - getClubSortOrder(b);
            });
            
            // Filter to clubs with weight data
            const clubsWithWeight = sortedClubs.filter(club => {
                const weight = club.shaft_weight || getStrengthValue(club, 'shaft weight') || getStrengthValue(club, 'weight');
                return weight && !isNaN(parseFloat(weight));
            });
            
            // === CALCULATE ZONE AVERAGES WITH OUTLIER EXCLUSION ===
            const WEIGHT_THRESHOLDS = {
                woods:   { A: 5, B: 10, C: 15 },
                hybrids: { A: 5, B: 8, C: 12 },
                irons:   { A: 3, B: 6, C: 10 },
                wedges:  { A: 8, B: 12, C: 18 }
            };
            
            // Group clubs by zone
            const weightZones = { woods: [], hybrids: [], irons: [], wedges: [] };
            clubsWithWeight.forEach(club => {
                const zone = getWeightZoneForEdit(club);
                const weight = club.shaft_weight || getStrengthValue(club, 'shaft weight') || getStrengthValue(club, 'weight');
                const weightNum = parseFloat(weight);
                if (!isNaN(weightNum)) {
                    weightZones[zone].push({ club, weight: weightNum });
                }
            });
            
            // Calculate average weight per zone with outlier exclusion
            const zoneAvg = {};
            Object.entries(weightZones).forEach(([zone, items]) => {
                if (items.length === 1) {
                    zoneAvg[zone] = items[0].weight;
                } else if (items.length >= 2) {
                    const thresholds = WEIGHT_THRESHOLDS[zone] || { A: 5, B: 10, C: 15 };
                    const outlierThreshold = thresholds.C * 2;
                    const weights = items.map(i => i.weight);
                    const initialAvg = weights.reduce((a, b) => a + b, 0) / weights.length;
                    const normalItems = items.filter(i => Math.abs(i.weight - initialAvg) <= outlierThreshold);
                    if (normalItems.length >= 2) {
                        const cleanTotal = normalItems.reduce((sum, i) => sum + i.weight, 0);
                        zoneAvg[zone] = Math.round(cleanTotal / normalItems.length);
                    } else {
                        zoneAvg[zone] = Math.round(initialAvg);
                    }
                }
            });
            
            // Check if hybrids are too light
            const hybridTooLight = zoneAvg.woods && zoneAvg.hybrids && zoneAvg.hybrids <= zoneAvg.woods;
            
            const zoneLabels = { woods: 'üå≤ WOODS', hybrids: 'üîÄ HYBRIDS', irons: '‚õ≥ IRONS', wedges: 'üéØ WEDGES' };
            
            // Build bulk adjustment options for weight (¬±1g to ¬±10g)
            let bulkOptionsHtml = '<option value="0">No change</option>';
            const adjustments = [];
            for (let adj = 1; adj <= 10; adj += 1) {
                adjustments.push(adj);
                adjustments.push(-adj);
            }
            adjustments.sort((a, b) => Math.abs(a) - Math.abs(b));
            for (const adj of adjustments) {
                const sign = adj > 0 ? '+' : '';
                bulkOptionsHtml += `<option value="${adj}">${sign}${adj}g</option>`;
            }
            
            // Select All header
            let editHtml = `
                <div class="weight-select-all">
                    <input type="checkbox" id="weight-select-all-checkbox" class="weight-edit-checkbox" checked onchange="toggleAllWeightCheckboxes(this.checked)">
                    <label for="weight-select-all-checkbox">Select All</label>
                    <select id="weight-bulk-adjust" class="weight-edit-select" style="margin-left: auto;" onchange="applyBulkWeightAdjust(this.value)">
                        ${bulkOptionsHtml}
                    </select>
                    <span style="font-size: 11px; color: var(--text-muted);">Bulk adjust</span>
                </div>
            `;
            
            let currentZone = '';
            let hasEditableClubs = false;
            
            clubsWithWeight.forEach((club, index) => {
                const weight = club.shaft_weight || getStrengthValue(club, 'shaft weight') || getStrengthValue(club, 'weight');
                const weightNum = parseFloat(weight);
                const zone = getWeightZoneForEdit(club);
                const isEst = club.weightIsDefault || false;
                const hasOriginal = club.originalShaftWeight !== undefined && club.originalShaftWeight !== null;
                
                // Add zone header when zone changes
                if (zone !== currentZone) {
                    editHtml += `<div class="weight-zone-header">${zoneLabels[zone] || zone}</div>`;
                    currentZone = zone;
                }
                
                hasEditableClubs = true;
                const estClass = isEst ? 'estimated' : '';
                
                // === CALCULATE ISSUE SEVERITY ===
                const avg = zoneAvg[zone];
                const thresholds = WEIGHT_THRESHOLDS[zone] || { A: 5, B: 10, C: 15 };
                const deviation = avg ? Math.abs(weightNum - avg) : 0;
                const isHybridTooLight = zone === 'hybrids' && hybridTooLight;
                
                let severity = 'ok';
                let warningText = '';
                
                if (isHybridTooLight) {
                    severity = 'severe';
                    warningText = `<span class="edit-warning-text severe">‚ö† should be heavier than woods</span>`;
                } else if (!isEst && avg && weightZones[zone].length > 1) {
                    if (deviation > thresholds.C) severity = 'severe';
                    else if (deviation > thresholds.B) severity = 'warning';
                    else if (deviation > thresholds.A) severity = 'minor';
                    
                    if (severity !== 'ok') {
                        const diff = weightNum - avg;
                        const diffText = diff > 0 ? `+${Math.round(diff)}g` : `${Math.round(diff)}g`;
                        warningText = `<span class="edit-warning-text ${severity}">‚ö† ${diffText} vs avg</span>`;
                    }
                }
                
                const rowClass = severity !== 'ok' ? `issue-${severity}` : '';
                
                // Per-club reset button
                const resetDisabled = !hasOriginal ? 'disabled' : '';
                const resetTitle = hasOriginal 
                    ? `Reset to original (${club.originalShaftWeight}g)` 
                    : 'No original weight stored';
                
                editHtml += `
                    <div class="weight-edit-row ${rowClass}" data-club-id="${club.id}" data-club-type="${club.clubType}" data-original-weight="${weightNum}" data-zone="${zone}">
                        <input type="checkbox" class="weight-edit-checkbox weight-club-checkbox" checked data-index="${index}">
                        <span class="weight-edit-club">${club.clubType}</span>
                        <span class="weight-edit-current ${estClass}">${weightNum}g${warningText}</span>
                        <input type="number" 
                               class="weight-edit-input" 
                               value="${weightNum}" 
                               min="40" max="150" step="1"
                               data-index="${index}"
                               data-original="${weightNum}">
                        <span class="weight-edit-unit">g</span>
                        <button class="weight-edit-reset-btn" 
                                onclick="resetSingleWeight('${club.id}')" 
                                ${resetDisabled}
                                title="${resetTitle}">‚Ü∫</button>
                    </div>
                `;
            });
            
            if (!hasEditableClubs) {
                editHtml = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No clubs with weight data to edit.</div>';
            }
            
            // Add action buttons
            editHtml += `
                <div class="weight-edit-actions">
                    <button class="btn btn-secondary" onclick="toggleWeightEditMode()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveWeightEdits()">üíæ Save Changes</button>
                </div>
            `;
            
            // Add footnote about per-club reset
            editHtml += `
                <div class="factor-estimated-footnote" style="margin-top: 12px; font-size: 11px;">
                    ‚Ü∫ resets individual club to its original spec weight (only available for previously edited clubs)
                </div>
            `;
            
            document.getElementById('factor-modal-clubs').innerHTML = editHtml;
        }
        
        /**
         * Toggle all weight checkboxes
         */
        function toggleAllWeightCheckboxes(checked) {
            document.querySelectorAll('.weight-club-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }
        
        /**
         * Apply bulk weight adjustment to selected clubs
         */
        function applyBulkWeightAdjust(value) {
            const adjustment = parseFloat(value) || 0;
            if (adjustment === 0) return;
            
            document.querySelectorAll('.weight-edit-input').forEach(input => {
                const row = input.closest('.weight-edit-row');
                const checkbox = row.querySelector('.weight-club-checkbox');
                if (checkbox && checkbox.checked) {
                    const currentVal = parseFloat(input.value) || 0;
                    const newVal = Math.round(currentVal + adjustment);
                    // Clamp to valid range
                    input.value = Math.max(40, Math.min(150, newVal));
                }
            });
            
            // Reset bulk adjust dropdown
            document.getElementById('weight-bulk-adjust').value = '0';
        }
        
        /**
         * Save weight edits to Firestore
         */
        async function saveWeightEdits() {
            const rows = document.querySelectorAll('.weight-edit-row');
            const updates = [];
            
            rows.forEach(row => {
                const checkbox = row.querySelector('.weight-club-checkbox');
                if (!checkbox || !checkbox.checked) return;
                
                const clubId = row.dataset.clubId;
                const clubType = row.dataset.clubType;
                const originalWeight = parseFloat(row.dataset.originalWeight);
                const input = row.querySelector('.weight-edit-input');
                const newWeight = parseFloat(input.value);
                
                // Only include if weight changed
                if (!isNaN(newWeight) && newWeight !== originalWeight && newWeight >= 40 && newWeight <= 150) {
                    updates.push({
                        clubId: clubId,
                        clubType: clubType,
                        originalWeight: originalWeight,
                        newWeight: Math.round(newWeight) // Round to whole grams
                    });
                }
            });
            
            if (updates.length === 0) {
                await showConfirmModal('No Changes', 'No changes to save. Modify weight values to save.', 'OK');
                return;
            }
            
            // Show confirmation
            const changesList = updates.map(u => `${u.clubType}: ${u.originalWeight}g ‚Üí ${u.newWeight}g`).join('\n');
            const confirmed = await showConfirmModal(
                `Update ${updates.length} Club${updates.length > 1 ? 's' : ''}?`,
                changesList,
                'Save Changes'
            );
            
            if (!confirmed) return;
            
            // Save to Firestore
            try {
                const saveBtn = document.querySelector('.weight-edit-actions .btn-primary');
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Saving...';
                
                // Call the save function (defined in firebase-auth.js)
                if (typeof saveWeightUpdates === 'function') {
                    await saveWeightUpdates(updates);
                    
                    // Show success
                    saveBtn.textContent = '‚úì Saved!';
                    
                    // Close modal and show regrade modal after short delay
                    setTimeout(() => {
                        closeModal('factor-detail-modal');
                        window.weightEditMode = false;
                        
                        // Show the styled regrade modal
                        if (typeof showRegradeModal === 'function') {
                            showRegradeModal();
                        } else {
                            // Fallback to confirm
                            const regrade = confirm('Weights updated!\n\nRegrade now? (Uses 1 credit)');
                            if (regrade && typeof gradeBag === 'function') {
                                gradeBag();
                            }
                        }
                    }, 500);
                } else {
                    throw new Error('Save function not available. Make sure firebase-auth.js is loaded.');
                }
            } catch (error) {
                console.error('Error saving weights:', error);
                alert('Error saving weights: ' + error.message);
                const saveBtn = document.querySelector('.weight-edit-actions .btn-primary');
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Changes';
            }
        }
        
        /**
         * Reset a single club's weight to original spec
         */
        async function resetSingleWeight(clubId) {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs || !window.currentClient) return;
            
            const club = analysis.clubs.find(c => c.id === clubId);
            if (!club || club.originalShaftWeight === undefined) {
                await showConfirmModal('Cannot Reset', 'No original weight stored for this club.', 'OK');
                return;
            }
            
            const confirmed = await showConfirmModal(
                'Reset Weight?',
                `Reset ${club.clubType} to original ${club.originalShaftWeight}g?`,
                'Reset'
            );
            if (!confirmed) return;
            
            try {
                const clientId = window.currentClient.id;
                const clubRef = db.collection('users').doc(clientId)
                    .collection('clubs').doc(clubId);
                
                await clubRef.update({
                    shaft_weight: club.originalShaftWeight,
                    weightIsUserEdited: false,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update in-memory
                club.shaft_weight = club.originalShaftWeight;
                club.weightIsUserEdited = false;
                
                console.log(`‚úÖ Reset ${club.clubType} to ${club.originalShaftWeight}g`);
                
                // Refresh edit mode display
                renderWeightEditMode();
                
            } catch (error) {
                console.error('Error resetting weight:', error);
                alert('Error resetting weight: ' + error.message);
            }
        }
        
        /**
         * Reset ALL edited weights to original specs
         */
        async function resetWeightToOriginal() {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs || !window.currentClient) {
                alert('No club data available');
                return;
            }
            
            // Find clubs that have original weights stored
            const resettableClubs = analysis.clubs.filter(c => 
                c.originalShaftWeight !== undefined && 
                c.originalShaftWeight !== null &&
                c.weightIsUserEdited === true
            );
            
            if (resettableClubs.length === 0) {
                await showConfirmModal('Cannot Reset', 'No clubs with editable weights to reset.\n\nOnly clubs that have been previously edited can be reset.', 'OK');
                return;
            }
            
            const changesList = resettableClubs.map(c => `${c.clubType}: ${c.shaft_weight}g ‚Üí ${c.originalShaftWeight}g`).join('\n');
            const confirmed = await showConfirmModal(
                `Reset ${resettableClubs.length} Club${resettableClubs.length > 1 ? 's' : ''}?`,
                changesList,
                'Reset All'
            );
            
            if (!confirmed) return;
            
            try {
                const resetBtn = document.getElementById('factor-reset-btn');
                if (resetBtn) {
                    resetBtn.disabled = true;
                    resetBtn.textContent = '‚è≥...';
                }
                
                const clientId = window.currentClient.id;
                const batch = db.batch();
                let resetCount = 0;
                
                for (const club of resettableClubs) {
                    if (!club.id) continue;
                    
                    const clubRef = db.collection('users').doc(clientId)
                        .collection('clubs').doc(club.id);
                    
                    batch.update(clubRef, {
                        shaft_weight: club.originalShaftWeight,
                        weightIsUserEdited: false,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update in-memory
                    club.shaft_weight = club.originalShaftWeight;
                    club.weightIsUserEdited = false;
                    resetCount++;
                }
                
                await batch.commit();
                console.log(`‚úÖ Reset ${resetCount} clubs to original weights`);
                
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = '‚Ü∫ Reset';
                }
                
                // Refresh display
                await fetchClientClubs(clientId);
                
                // Show regrade modal
                closeModal('factor-detail-modal');
                window.weightEditMode = false;
                
                if (typeof showRegradeModal === 'function') {
                    showRegradeModal();
                } else {
                    const regrade = confirm(`Reset ${resetCount} clubs to original weights!\n\nRegrade now? (Uses 1 credit)`);
                    if (regrade && typeof gradeBag === 'function') {
                        gradeBag();
                    }
                }
                
            } catch (error) {
                console.error('Error resetting weights:', error);
                alert('Error resetting weights: ' + error.message);
                const resetBtn = document.getElementById('factor-reset-btn');
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = '‚Ü∫ Reset';
                }
            }
        }
        
        // ============================================
        // LIE ANGLE EDIT MODE
        // ============================================
        
        /**
         * Get lie angle zone for a club
         */
        function getLieZone(club) {
            const type = (club.clubType || '').toLowerCase();
            
            // Woods
            if (type.includes('driver') || type.includes('wood') || /^\d+w$/i.test(type)) {
                return 'woods';
            }
            // Hybrids
            if (type.includes('hybrid') || /^\d+h$/i.test(type)) {
                return 'hybrids';
            }
            // Wedges (check before irons since some wedges have numbers)
            if (type.includes('wedge') || type === 'pw' || type === 'aw' || type === 'gw' || type === 'sw' || type === 'lw' ||
                /^(46|48|50|52|54|56|58|60|62|64)¬∞?$/.test(type)) {
                return 'wedges';
            }
            // Irons
            if (type.includes('iron') || /^\d+-iron$/i.test(type) || /^\d+i$/i.test(type)) {
                return 'irons';
            }
            return 'irons'; // Default
        }
        
        /**
         * Toggle lie angle edit mode
         */
        function toggleLieEditMode() {
            const editBtn = document.getElementById('factor-edit-btn');
            
            if (!window.lieEditMode) {
                // Enter edit mode
                window.lieEditMode = true;
                editBtn.classList.add('active');
                editBtn.textContent = '‚úèÔ∏è Editing...';
                renderLieEditMode();
            } else {
                // Exit edit mode - refresh the display
                window.lieEditMode = false;
                editBtn.classList.remove('active');
                editBtn.textContent = '‚úèÔ∏è Edit';
                // Re-render normal view
                showFactorDetail('lie');
            }
        }
        
        /**
         * Render lie angle edit mode UI
         */
        function renderLieEditMode() {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs) return;
            
            const clubs = analysis.clubs;
            const lieZoneOrder = { woods: 0, hybrids: 1, irons: 2, wedges: 3 };
            
            // Sort by zone first, then by club order within zone
            const sortedClubs = [...clubs].sort((a, b) => {
                const zoneA = getLieZone(a);
                const zoneB = getLieZone(b);
                if (zoneA !== zoneB) return lieZoneOrder[zoneA] - lieZoneOrder[zoneB];
                return getClubSortOrder(a) - getClubSortOrder(b);
            });
            
            // Filter to clubs with lie data (exclude putters)
            const clubsWithLie = sortedClubs.filter(club => {
                const type = (club.clubType || '').toLowerCase();
                if (type.includes('putter')) return false; // Exclude putters
                const lie = club.lie || getStrengthValue(club, 'lie');
                return lie && !isNaN(parseFloat(lie));
            });
            
            // === CALCULATE ZONE PROGRESSION AVERAGES ===
            const LIE_THRESHOLDS = {
                woods:   { A: 1.0, B: 1.5, C: 2.0 },
                hybrids: { A: 0.5, B: 1.0, C: 1.5 },
                irons:   { A: 0.25, B: 0.5, C: 1.0 },
                wedges:  { A: 1.0, B: 1.5, C: 2.0 }
            };
            
            // Group clubs by zone
            const lieZones = { woods: [], hybrids: [], irons: [], wedges: [] };
            clubsWithLie.forEach(club => {
                const zone = getLieZone(club);
                const lie = club.lie || getStrengthValue(club, 'lie');
                const lieNum = parseFloat(lie);
                if (!isNaN(lieNum)) {
                    lieZones[zone].push({ club, lie: lieNum });
                }
            });
            
            // Calculate expected progression step per zone
            const zoneProgression = {};
            Object.entries(lieZones).forEach(([zone, items]) => {
                if (items.length >= 2) {
                    // Sort by club order (longest to shortest)
                    items.sort((a, b) => getClubSortOrder(a.club) - getClubSortOrder(b.club));
                    const steps = [];
                    for (let i = 1; i < items.length; i++) {
                        steps.push(items[i].lie - items[i-1].lie);
                    }
                    const avgStep = steps.reduce((a, b) => a + b, 0) / steps.length;
                    zoneProgression[zone] = { avgStep, items, steps };
                }
            });
            
            const zoneLabels = { woods: 'üå≤ WOODS', hybrids: 'üîÄ HYBRIDS', irons: '‚õ≥ IRONS', wedges: 'üéØ WEDGES' };
            
            // Build bulk adjustment options for lie (¬±0.5¬∞ to ¬±3¬∞)
            let bulkOptionsHtml = '<option value="0">No change</option>';
            const adjustments = [];
            for (let adj = 0.5; adj <= 3; adj += 0.5) {
                adjustments.push(adj);
                adjustments.push(-adj);
            }
            adjustments.sort((a, b) => Math.abs(a) - Math.abs(b));
            for (const adj of adjustments) {
                const sign = adj > 0 ? '+' : '';
                bulkOptionsHtml += `<option value="${adj}">${sign}${adj}¬∞</option>`;
            }
            
            // Select All header
            let editHtml = `
                <div class="lie-select-all">
                    <input type="checkbox" id="lie-select-all-checkbox" class="lie-edit-checkbox" checked onchange="toggleAllLieCheckboxes(this.checked)">
                    <label for="lie-select-all-checkbox">Select All</label>
                    <select id="lie-bulk-adjust" class="lie-edit-select" style="margin-left: auto;" onchange="applyBulkLieAdjust(this.value)">
                        ${bulkOptionsHtml}
                    </select>
                    <span style="font-size: 11px; color: var(--text-muted);">Bulk adjust</span>
                </div>
            `;
            
            let currentZone = '';
            let hasEditableClubs = false;
            
            clubsWithLie.forEach((club, index) => {
                const lie = club.lie || getStrengthValue(club, 'lie');
                const lieNum = parseFloat(lie);
                const zone = getLieZone(club);
                const isEst = club.lieIsDefault || false;
                const hasOriginal = club.originalLieAngle !== undefined && club.originalLieAngle !== null;
                
                // Add zone header when zone changes
                if (zone !== currentZone) {
                    editHtml += `<div class="lie-zone-header">${zoneLabels[zone] || zone}</div>`;
                    currentZone = zone;
                }
                
                hasEditableClubs = true;
                const estClass = isEst ? 'estimated' : '';
                
                // === CALCULATE ISSUE SEVERITY ===
                const prog = zoneProgression[zone];
                const thresholds = LIE_THRESHOLDS[zone] || { A: 0.5, B: 1.0, C: 1.5 };
                
                let severity = 'ok';
                let warningText = '';
                
                if (prog && prog.items.length >= 2 && !isEst) {
                    // Find this club's position in the zone
                    const clubIndex = prog.items.findIndex(item => item.club.id === club.id);
                    if (clubIndex > 0) {
                        const actualStep = prog.items[clubIndex].lie - prog.items[clubIndex - 1].lie;
                        const deviation = Math.abs(actualStep - prog.avgStep);
                        
                        // Check for reverse progression (shorter club has flatter lie)
                        if (actualStep < 0) {
                            severity = 'severe';
                            warningText = `<span class="edit-warning-text severe">‚ö† reverse progression</span>`;
                        } else if (deviation > thresholds.C) {
                            severity = 'severe';
                            const diffText = actualStep > prog.avgStep ? `+${deviation.toFixed(1)}¬∞` : `-${deviation.toFixed(1)}¬∞`;
                            warningText = `<span class="edit-warning-text severe">‚ö† ${diffText} vs avg step</span>`;
                        } else if (deviation > thresholds.B) {
                            severity = 'warning';
                            const diffText = actualStep > prog.avgStep ? `+${deviation.toFixed(1)}¬∞` : `-${deviation.toFixed(1)}¬∞`;
                            warningText = `<span class="edit-warning-text warning">‚ö† ${diffText} vs avg step</span>`;
                        } else if (deviation > thresholds.A) {
                            severity = 'minor';
                            const diffText = actualStep > prog.avgStep ? `+${deviation.toFixed(1)}¬∞` : `-${deviation.toFixed(1)}¬∞`;
                            warningText = `<span class="edit-warning-text minor">‚ö† ${diffText} vs avg step</span>`;
                        }
                    }
                }
                
                const rowClass = severity !== 'ok' ? `issue-${severity}` : '';
                
                // Per-club reset button
                const resetDisabled = !hasOriginal ? 'disabled' : '';
                const resetTitle = hasOriginal 
                    ? `Reset to original (${club.originalLieAngle}¬∞)` 
                    : 'No original lie angle stored';
                
                editHtml += `
                    <div class="lie-edit-row ${rowClass}" data-club-id="${club.id}" data-club-type="${club.clubType}" data-original-lie="${lieNum}" data-zone="${zone}">
                        <input type="checkbox" class="lie-edit-checkbox lie-club-checkbox" checked data-index="${index}">
                        <span class="lie-edit-club">${club.clubType}</span>
                        <span class="lie-edit-current ${estClass}">${lieNum}¬∞${warningText}</span>
                        <input type="number" 
                               class="lie-edit-input" 
                               value="${lieNum}" 
                               min="52" max="70" step="0.5"
                               data-index="${index}"
                               data-original="${lieNum}">
                        <span class="lie-edit-unit">¬∞</span>
                        <button class="lie-edit-reset-btn" 
                                onclick="resetSingleLie('${club.id}')" 
                                ${resetDisabled}
                                title="${resetTitle}">‚Ü∫</button>
                    </div>
                `;
            });
            
            if (!hasEditableClubs) {
                editHtml = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No clubs with lie angle data to edit.</div>';
            }
            
            // Add action buttons
            editHtml += `
                <div class="lie-edit-actions">
                    <button class="btn btn-secondary" onclick="toggleLieEditMode()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveLieEdits()">üíæ Save Changes</button>
                </div>
            `;
            
            // Add footnote about per-club reset
            editHtml += `
                <div class="factor-estimated-footnote" style="margin-top: 12px; font-size: 11px;">
                    ‚Ü∫ resets individual club to its original lie angle (only available for previously edited clubs)
                </div>
            `;
            
            document.getElementById('factor-modal-clubs').innerHTML = editHtml;
        }
        
        /**
         * Toggle all lie checkboxes
         */
        function toggleAllLieCheckboxes(checked) {
            document.querySelectorAll('.lie-club-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }
        
        /**
         * Apply bulk lie adjustment to selected clubs
         */
        function applyBulkLieAdjust(value) {
            const adjustment = parseFloat(value) || 0;
            if (adjustment === 0) return;
            
            document.querySelectorAll('.lie-club-checkbox:checked').forEach(checkbox => {
                const row = checkbox.closest('.lie-edit-row');
                const input = row.querySelector('.lie-edit-input');
                const currentVal = parseFloat(input.value) || 60;
                const newVal = Math.max(52, Math.min(70, currentVal + adjustment));
                input.value = newVal.toFixed(1);
            });
            
            // Reset dropdown to "No change"
            document.getElementById('lie-bulk-adjust').value = '0';
        }
        
        /**
         * Reset a single club's lie to original
         */
        async function resetSingleLie(clubId) {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs || !window.currentClient) return;
            
            const club = analysis.clubs.find(c => c.id === clubId);
            if (!club || club.originalLieAngle === undefined) {
                await showConfirmModal('Cannot Reset', 'No original lie angle stored for this club.', 'OK');
                return;
            }
            
            const confirmed = await showConfirmModal(
                'Reset Lie Angle?',
                `Reset ${club.clubType} to original ${club.originalLieAngle}¬∞?`,
                'Reset'
            );
            if (!confirmed) return;
            
            try {
                const clientId = window.currentClient.id;
                const clubRef = db.collection('users').doc(clientId)
                    .collection('clubs').doc(clubId);
                
                await clubRef.update({
                    lie: club.originalLieAngle,
                    lieIsUserEdited: false,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update in-memory
                club.lie = club.originalLieAngle;
                club.lieIsUserEdited = false;
                
                console.log(`‚úÖ Reset ${club.clubType} to ${club.originalLieAngle}¬∞`);
                
                // Re-render edit mode to show updated value
                renderLieEditMode();
                
            } catch (error) {
                console.error('Error resetting lie angle:', error);
                alert('Error resetting lie angle: ' + error.message);
            }
        }
        
        /**
         * Save lie angle edits
         */
        async function saveLieEdits() {
            const rows = document.querySelectorAll('.lie-edit-row');
            const updates = [];
            
            rows.forEach(row => {
                const checkbox = row.querySelector('.lie-club-checkbox');
                if (!checkbox || !checkbox.checked) return;
                
                const clubId = row.dataset.clubId;
                const clubType = row.dataset.clubType;
                const originalLie = parseFloat(row.dataset.originalLie);
                const input = row.querySelector('.lie-edit-input');
                const newLie = parseFloat(input.value);
                
                // Only include if lie changed
                if (!isNaN(newLie) && Math.abs(newLie - originalLie) >= 0.1 && newLie >= 52 && newLie <= 70) {
                    updates.push({
                        clubId: clubId,
                        clubType: clubType,
                        originalLie: originalLie,
                        newLie: Math.round(newLie * 10) / 10 // Round to 1 decimal
                    });
                }
            });
            
            if (updates.length === 0) {
                await showConfirmModal('No Changes', 'No changes to save. Modify lie angle values to save.', 'OK');
                return;
            }
            
            // Show confirmation
            const changesList = updates.map(u => `${u.clubType}: ${u.originalLie}¬∞ ‚Üí ${u.newLie}¬∞`).join('\n');
            const confirmed = await showConfirmModal(
                `Update ${updates.length} Club${updates.length > 1 ? 's' : ''}?`,
                changesList,
                'Save Changes'
            );
            
            if (!confirmed) return;
            
            // Save to Firestore
            try {
                const saveBtn = document.querySelector('.lie-edit-actions .btn-primary');
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Saving...';
                
                // Call the save function (defined in firebase-auth.js)
                if (typeof saveLieUpdates === 'function') {
                    await saveLieUpdates(updates);
                    
                    // Show success
                    saveBtn.textContent = '‚úì Saved!';
                    
                    // Close modal and show regrade modal after short delay
                    setTimeout(() => {
                        closeModal('factor-detail-modal');
                        window.lieEditMode = false;
                        
                        // Show the styled regrade modal
                        if (typeof showRegradeModal === 'function') {
                            showRegradeModal();
                        } else {
                            // Fallback to confirm
                            const regrade = confirm('Lie angles updated!\n\nRegrade now? (Uses 1 credit)');
                            if (regrade && typeof gradeBag === 'function') {
                                gradeBag();
                            }
                        }
                    }, 500);
                } else {
                    throw new Error('Save function not available. Make sure firebase-auth.js is loaded.');
                }
            } catch (error) {
                console.error('Error saving lie edits:', error);
                alert('Error saving: ' + error.message);
                const saveBtn = document.querySelector('.lie-edit-actions .btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Save Changes';
                }
            }
        }
        
        /**
         * Reset all lie angles to original (batch reset)
         */
        async function resetLieToOriginal() {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs || !window.currentClient) {
                alert('No club data available');
                return;
            }
            
            // Find clubs that have original lie angles stored
            const resettableClubs = analysis.clubs.filter(c => 
                c.originalLieAngle !== undefined && 
                c.originalLieAngle !== null &&
                c.lieIsUserEdited === true
            );
            
            if (resettableClubs.length === 0) {
                await showConfirmModal('Cannot Reset', 'No clubs with editable lie angles to reset.\n\nOnly clubs that have been previously edited can be reset.', 'OK');
                return;
            }
            
            const changesList = resettableClubs.map(c => `${c.clubType}: ${c.lie}¬∞ ‚Üí ${c.originalLieAngle}¬∞`).join('\n');
            const confirmed = await showConfirmModal(
                `Reset ${resettableClubs.length} Club${resettableClubs.length > 1 ? 's' : ''}?`,
                changesList,
                'Reset All'
            );
            
            if (!confirmed) return;
            
            try {
                const resetBtn = document.getElementById('factor-reset-btn');
                if (resetBtn) {
                    resetBtn.disabled = true;
                    resetBtn.textContent = '‚è≥...';
                }
                
                const clientId = window.currentClient.id;
                const batch = db.batch();
                let resetCount = 0;
                
                for (const club of resettableClubs) {
                    if (!club.id) continue;
                    
                    const clubRef = db.collection('users').doc(clientId)
                        .collection('clubs').doc(club.id);
                    
                    batch.update(clubRef, {
                        lie: club.originalLieAngle,
                        lieIsUserEdited: false,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update in-memory
                    club.lie = club.originalLieAngle;
                    club.lieIsUserEdited = false;
                    resetCount++;
                }
                
                await batch.commit();
                console.log(`‚úÖ Reset ${resetCount} clubs to original lie angles`);
                
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = '‚Ü∫ Reset';
                }
                
                // Refresh display
                await fetchClientClubs(clientId);
                
                // Show regrade modal
                closeModal('factor-detail-modal');
                window.lieEditMode = false;
                
                if (typeof showRegradeModal === 'function') {
                    showRegradeModal();
                } else {
                    const regrade = confirm(`Reset ${resetCount} clubs to original lie angles!\n\nRegrade now? (Uses 1 credit)`);
                    if (regrade && typeof gradeBag === 'function') {
                        gradeBag();
                    }
                }
                
            } catch (error) {
                console.error('Error resetting lie angles:', error);
                alert('Error resetting lie angles: ' + error.message);
                const resetBtn = document.getElementById('factor-reset-btn');
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = '‚Ü∫ Reset';
                }
            }
        }
        
        // ============================================
        // LOFT EDIT MODE
        // ============================================
        
        /**
         * Toggle loft edit mode
         */
        function toggleLoftEditMode() {
            window.loftEditMode = !window.loftEditMode;
            
            if (window.loftEditMode) {
                renderLoftEditMode();
            } else {
                showFactorDetail('loft');
            }
        }
        
        /**
         * Render loft edit mode UI with live gap calculation
         */
        function renderLoftEditMode() {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs) return;
            
            const clubs = analysis.clubs;
            const clubsWithLoft = clubs.map(c => {
                const loftStr = getStrengthValue(c, 'loft');
                const loft = c.loft || (loftStr ? parseFloat(loftStr) : null);
                return { ...c, loftVal: loft, loftIsDefault: c.loftIsDefault || false };
            }).filter(c => c.loftVal !== null).sort((a, b) => a.loftVal - b.loftVal);
            
            if (clubsWithLoft.length === 0) {
                document.getElementById('factor-modal-clubs').innerHTML = '<p style="color: var(--text-muted);">No clubs with loft data to edit.</p>';
                return;
            }
            
            let editHtml = `
                <div class="loft-select-all">
                    <input type="checkbox" id="loft-select-all-checkbox" class="loft-edit-checkbox" onchange="toggleAllLoftCheckboxes(this.checked)" checked>
                    <label for="loft-select-all-checkbox">Select All</label>
                    <select class="loft-edit-select" onchange="applyBulkLoftAdjust(this.value); this.value='';">
                        <option value="">Bulk Adjust...</option>
                        <option value="-3">‚àí3¬∞</option>
                        <option value="-2">‚àí2¬∞</option>
                        <option value="-1.5">‚àí1.5¬∞</option>
                        <option value="-1">‚àí1¬∞</option>
                        <option value="-0.5">‚àí0.5¬∞</option>
                        <option value="0.5">+0.5¬∞</option>
                        <option value="1">+1¬∞</option>
                        <option value="1.5">+1.5¬∞</option>
                        <option value="2">+2¬∞</option>
                        <option value="3">+3¬∞</option>
                    </select>
                </div>
                <div id="loft-edit-clubs">
            `;
            
            clubsWithLoft.forEach((club, index) => {
                const isEstimated = club.loftIsDefault;
                const wasEdited = club.loftIsUserEdited === true;
                
                editHtml += `
                    <div class="loft-edit-row" data-club-id="${club.id}" data-club-type="${club.clubType}" data-original-loft="${club.loftVal}" data-index="${index}">
                        <input type="checkbox" class="loft-club-checkbox loft-edit-checkbox" checked>
                        <span class="loft-edit-club">${club.clubType}</span>
                        <span class="loft-edit-current ${isEstimated ? 'estimated' : ''}">${club.loftVal}¬∞</span>
                        <span style="color: var(--text-muted);">‚Üí</span>
                        <input type="number" class="loft-edit-input" value="${club.loftVal}" min="8" max="64" step="0.5" onchange="recalculateLoftGaps()" oninput="recalculateLoftGaps()">
                        <span class="loft-edit-unit">¬∞</span>
                        <button class="loft-edit-reset-btn" onclick="resetSingleLoft('${club.id}', ${club.loftVal})" ${!wasEdited ? 'disabled' : ''}>‚Ü∫</button>
                    </div>
                `;
                
                if (index < clubsWithLoft.length - 1) {
                    const nextClub = clubsWithLoft[index + 1];
                    const gap = Math.round(Math.abs(nextClub.loftVal - club.loftVal));
                    let gapClass = gap <= 2 ? 'overlap' : gap > 6 ? 'issue' : 'good';
                    let gapIcon = gap <= 2 ? '‚õî' : gap > 6 ? '‚ö†' : '‚úì';
                    
                    editHtml += `
                        <div class="loft-gap-row" data-gap-index="${index}">
                            <span class="loft-gap-indicator">‚Üï</span>
                            <span class="loft-gap-value ${gapClass}">${gap}¬∞ gap ${gapIcon}</span>
                        </div>
                    `;
                }
            });
            
            editHtml += `
                </div>
                <div class="loft-edit-actions">
                    <button class="btn btn-secondary" onclick="toggleLoftEditMode()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveLoftEdits()">üíæ Save Changes</button>
                </div>
            `;
            
            document.getElementById('factor-modal-clubs').innerHTML = editHtml;
        }
        
        function toggleAllLoftCheckboxes(checked) {
            document.querySelectorAll('.loft-club-checkbox').forEach(cb => cb.checked = checked);
        }
        
        function applyBulkLoftAdjust(value) {
            if (!value) return;
            const adjustment = parseFloat(value);
            
            document.querySelectorAll('.loft-edit-row').forEach(row => {
                const checkbox = row.querySelector('.loft-club-checkbox');
                if (!checkbox || !checkbox.checked) return;
                
                const input = row.querySelector('.loft-edit-input');
                let newVal = Math.max(8, Math.min(64, parseFloat(input.value) + adjustment));
                input.value = Math.round(newVal * 2) / 2;
            });
            
            recalculateLoftGaps();
        }
        
        function resetSingleLoft(clubId, originalLoft) {
            const row = document.querySelector(`.loft-edit-row[data-club-id="${clubId}"]`);
            if (row) {
                row.querySelector('.loft-edit-input').value = originalLoft;
                recalculateLoftGaps();
            }
        }
        
        function recalculateLoftGaps() {
            const rows = document.querySelectorAll('.loft-edit-row');
            const lofts = [];
            rows.forEach((row, index) => {
                lofts.push({ index, loft: parseFloat(row.querySelector('.loft-edit-input').value) || 0 });
            });
            
            for (let i = 0; i < lofts.length - 1; i++) {
                const gapRow = document.querySelector(`.loft-gap-row[data-gap-index="${i}"]`);
                if (!gapRow) continue;
                
                const gap = Math.round(Math.abs(lofts[i + 1].loft - lofts[i].loft));
                let gapClass = gap <= 2 ? 'overlap' : gap > 6 ? 'issue' : 'good';
                let gapIcon = gap <= 2 ? '‚õî' : gap > 6 ? '‚ö†' : '‚úì';
                
                const gapValueSpan = gapRow.querySelector('.loft-gap-value');
                if (gapValueSpan) {
                    gapValueSpan.className = `loft-gap-value ${gapClass}`;
                    gapValueSpan.textContent = `${gap}¬∞ gap ${gapIcon}`;
                }
            }
        }
        
        async function saveLoftEdits() {
            const rows = document.querySelectorAll('.loft-edit-row');
            const updates = [];
            
            rows.forEach(row => {
                const checkbox = row.querySelector('.loft-club-checkbox');
                if (!checkbox || !checkbox.checked) return;
                
                const clubId = row.dataset.clubId;
                const clubType = row.dataset.clubType;
                const originalLoft = parseFloat(row.dataset.originalLoft);
                const newLoft = parseFloat(row.querySelector('.loft-edit-input').value);
                
                if (!isNaN(newLoft) && Math.abs(newLoft - originalLoft) >= 0.1 && newLoft >= 8 && newLoft <= 64) {
                    updates.push({ clubId, clubType, originalLoft, newLoft: Math.round(newLoft * 2) / 2 });
                }
            });
            
            if (updates.length === 0) {
                await showConfirmModal('No Changes', 'No changes to save. Modify loft values to save.', 'OK');
                return;
            }
            
            const changesList = updates.map(u => `${u.clubType}: ${u.originalLoft}¬∞ ‚Üí ${u.newLoft}¬∞`).join('\n');
            const confirmed = await showConfirmModal(`Update ${updates.length} Club${updates.length > 1 ? 's' : ''}?`, changesList, 'Save Changes');
            if (!confirmed) return;
            
            try {
                const saveBtn = document.querySelector('.loft-edit-actions .btn-primary');
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Saving...';
                
                if (typeof saveLoftUpdates === 'function') {
                    await saveLoftUpdates(updates);
                    saveBtn.textContent = '‚úì Saved!';
                    
                    setTimeout(() => {
                        closeModal('factor-detail-modal');
                        window.loftEditMode = false;
                        if (typeof showRegradeModal === 'function') {
                            showRegradeModal();
                        }
                    }, 500);
                } else {
                    throw new Error('Save function not available.');
                }
            } catch (error) {
                console.error('Error saving loft edits:', error);
                alert('Error saving: ' + error.message);
                const saveBtn = document.querySelector('.loft-edit-actions .btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Save Changes';
                }
            }
        }
        
        async function resetLoftToOriginal() {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs || !window.currentClient) {
                alert('No club data available');
                return;
            }
            
            const resettableClubs = analysis.clubs.filter(c => 
                c.originalLoft !== undefined && c.originalLoft !== null && c.loftIsUserEdited === true
            );
            
            if (resettableClubs.length === 0) {
                await showConfirmModal('Cannot Reset', 'No clubs with edited lofts to reset.', 'OK');
                return;
            }
            
            const changesList = resettableClubs.map(c => `${c.clubType}: ${c.loft}¬∞ ‚Üí ${c.originalLoft}¬∞`).join('\n');
            const confirmed = await showConfirmModal(`Reset ${resettableClubs.length} Club${resettableClubs.length > 1 ? 's' : ''}?`, changesList, 'Reset All');
            if (!confirmed) return;
            
            try {
                const clientId = window.currentClient.id;
                const batch = db.batch();
                
                for (const club of resettableClubs) {
                    if (!club.id) continue;
                    const clubRef = db.collection('users').doc(clientId).collection('clubs').doc(club.id);
                    batch.update(clubRef, {
                        loft: club.originalLoft,
                        loftIsUserEdited: false,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    club.loft = club.originalLoft;
                    club.loftIsUserEdited = false;
                }
                
                await batch.commit();
                await fetchClientClubs(clientId);
                closeModal('factor-detail-modal');
                window.loftEditMode = false;
                
                if (typeof showRegradeModal === 'function') {
                    showRegradeModal();
                }
            } catch (error) {
                console.error('Error resetting lofts:', error);
                alert('Error resetting lofts: ' + error.message);
            }
        }
        
        // ============================================
        // FLEX EDIT MODE
        // ============================================
        
        /**
         * Toggle flex edit mode
         */
        function toggleFlexEditMode() {
            window.flexEditMode = !window.flexEditMode;
            
            if (window.flexEditMode) {
                renderFlexEditMode();
            } else {
                // Re-render normal view
                showFactorDetail('flex');
            }
        }
        
        /**
         * Render flex edit mode UI
         */
        function renderFlexEditMode() {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs) return;
            
            const clubs = analysis.clubs;
            const flexZoneOrder = { woods: 0, hybrids: 1, irons: 2, wedges: 3 };
            
            // Get swing speed from user data
            const swingSpeed = window.currentClient?.swingSpeed || analysis.user_context?.swing_speed || null;
            const gender = window.currentClient?.gender || 'male';
            
            // Calculate recommended flex based on swing speed
            function getRecommendedFlex(speed, gender) {
                if (!speed) return null;
                if (gender === 'female') {
                    if (speed >= 75) return 'Stiff';
                    if (speed >= 65) return 'Regular';
                    if (speed >= 55) return 'Senior';
                    return 'Ladies';
                } else {
                    if (speed >= 105) return 'X-Stiff';
                    if (speed >= 95) return 'Stiff';
                    if (speed >= 84) return 'Regular';
                    if (speed >= 72) return 'Senior';
                    return 'Ladies';
                }
            }
            
            const recommendedFlex = getRecommendedFlex(swingSpeed, gender);
            
            // Zone detection function
            function getFlexZone(club) {
                const type = (club.clubType || '').toLowerCase();
                if (type === 'driver') return 'woods';
                if (type.includes('wood') || /^\d+w$/i.test(type)) return 'woods';
                if (type.includes('hybrid') || /^\d+h$/i.test(type)) return 'hybrids';
                if (type === 'pw' || type === 'pitching') return 'irons';
                const degMatch = type.match(/^(\d+)/);
                if (degMatch) {
                    const num = parseInt(degMatch[1], 10);
                    if (num >= 46 && num <= 64) return 'wedges';
                }
                if (['gw','sw','lw','aw','gap','sand','lob'].some(w => type === w || type.includes(w))) return 'wedges';
                if (type.includes('iron') || /^\d+-iron$/i.test(type)) return 'irons';
                return 'irons';
            }
            
            // Sort by zone first, then by club order within zone
            const sortedClubs = [...clubs].sort((a, b) => {
                const zoneA = getFlexZone(a);
                const zoneB = getFlexZone(b);
                if (zoneA !== zoneB) return flexZoneOrder[zoneA] - flexZoneOrder[zoneB];
                return getClubSortOrder(a) - getClubSortOrder(b);
            });
            
            // Filter to clubs (exclude putter)
            const clubsWithFlex = sortedClubs.filter(club => {
                const type = (club.clubType || '').toLowerCase();
                return !type.includes('putter');
            });
            
            // Flex options
            const flexOptions = ['Ladies', 'Senior', 'Regular', 'Stiff', 'X-Stiff'];
            
            // Normalize flex value to match dropdown options
            function normalizeFlexForDropdown(flex) {
                if (!flex) return '';
                const f = flex.toLowerCase().trim();
                if (f === 'l' || f === 'ladies' || f === 'lady') return 'Ladies';
                if (f === 'a' || f === 'sr' || f === 'senior' || f === 'am') return 'Senior';
                if (f === 'r' || f === 'regular' || f === 'reg' || f === 'm' || f === 'med' || f === 'medium') return 'Regular';
                if (f === 's' || f === 'stiff' || f === 'firm') return 'Stiff';
                if (f === 'x' || f === 'xs' || f === 'x-stiff' || f === 'xstiff' || f === 'extra stiff' || f === 'tour') return 'X-Stiff';
                // Check for flex embedded in shaft code (e.g., "6S" = Stiff, "5R" = Regular)
                if (/\d+s$/i.test(f) || /s\d*$/i.test(f)) return 'Stiff';
                if (/\d+r$/i.test(f) || /r\d*$/i.test(f)) return 'Regular';
                if (/\d+x$/i.test(f) || /x\d*$/i.test(f)) return 'X-Stiff';
                if (/\d+a$/i.test(f) || /a\d*$/i.test(f)) return 'Senior';
                if (/\d+l$/i.test(f) || /l\d*$/i.test(f)) return 'Ladies';
                return flex; // Return original if no match
            }
            
            // Count current flexes to find dominant per zone (using normalized values, only actual stored flex)
            const zoneFlexCounts = { woods: {}, hybrids: {}, irons: {}, wedges: {} };
            clubsWithFlex.forEach(club => {
                const flex = club.shaft_flex; // Only use actual stored value, not AI-inferred
                const zone = getFlexZone(club);
                if (flex) {
                    const normalized = normalizeFlexForDropdown(flex);
                    zoneFlexCounts[zone][normalized] = (zoneFlexCounts[zone][normalized] || 0) + 1;
                }
            });
            
            // Find dominant flex per zone
            const zoneDominantFlex = {};
            Object.entries(zoneFlexCounts).forEach(([zone, counts]) => {
                const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                if (sorted.length > 0) {
                    zoneDominantFlex[zone] = sorted[0][0];
                }
            });
            
            const zoneLabels = { woods: 'üå≤ WOODS', hybrids: 'üîÄ HYBRIDS', irons: '‚õ≥ IRONS', wedges: 'üéØ WEDGES' };
            
            // Build bulk set options
            let bulkOptionsHtml = '<option value="">Set all to...</option>';
            flexOptions.forEach(f => {
                bulkOptionsHtml += `<option value="${f}">${f}</option>`;
            });
            
            // Header with Reset/Edit buttons
            let editHtml = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-size: 12px; color: var(--text-primary); font-weight: 500;">Edit Shaft Flex</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Select clubs and set flex values</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-reset-small" onclick="resetFlexToOriginal()" style="padding: 6px 10px; font-size: 11px;">‚Ü∫ Reset</button>
                        <button class="btn-edit-small active" onclick="toggleFlexEditMode()" style="padding: 6px 10px; font-size: 11px;">‚úï Cancel</button>
                    </div>
                </div>
            `;
            
            // Add swing speed recommendation note if available
            if (swingSpeed && recommendedFlex) {
                editHtml += `
                    <div style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: var(--cyan);">
                            üí° Retail flex charts suggest <strong>${recommendedFlex}</strong> for ${swingSpeed} mph. Note: Flex labels vary by manufacturer - consistency within your bag matters more than matching a chart.
                        </div>
                    </div>
                `;
            } else {
                editHtml += `
                    <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: var(--orange);">
                            ‚ö† No swing speed set. Enter your swing speed above to see retail flex recommendations.
                        </div>
                    </div>
                `;
            }
            
            // Select All header
            editHtml += `
                <div class="flex-select-all">
                    <input type="checkbox" id="flex-select-all-checkbox" class="flex-edit-checkbox" checked onchange="toggleAllFlexCheckboxes(this.checked)">
                    <label for="flex-select-all-checkbox">Select All</label>
                    <select id="flex-bulk-set" class="flex-edit-select" style="margin-left: auto;" onchange="applyBulkFlexSet(this.value)">
                        ${bulkOptionsHtml}
                    </select>
                    <span style="font-size: 11px; color: var(--text-muted);">Bulk set</span>
                </div>
            `;
            
            let currentZone = '';
            let hasEditableClubs = false;
            
            clubsWithFlex.forEach((club, index) => {
                // Only use actual stored shaft_flex, not AI-inferred values from grading
                const actualFlex = club.shaft_flex;
                const inferredFlex = getStrengthValue(club, 'flex');
                const flex = actualFlex; // Only use stored value
                const displayFlex = flex || (inferredFlex ? `(${inferredFlex})` : 'Unknown'); // Show inferred in parentheses
                const zone = getFlexZone(club);
                // Needs input if no actual stored flex (ignore AI-inferred)
                const needsInput = !actualFlex || club.flexIsDefault;
                const hasOriginal = club.originalShaftFlex !== undefined && club.originalShaftFlex !== null;
                
                // Add zone header when zone changes
                if (zone !== currentZone) {
                    editHtml += `<div class="flex-zone-header">${zoneLabels[zone] || zone}</div>`;
                    currentZone = zone;
                }
                
                hasEditableClubs = true;
                const estClass = needsInput ? 'estimated' : '';
                
                // Determine row class and issue text
                let rowClass = '';
                let issueText = '';
                
                if (needsInput) {
                    // Needs input - highlight with red
                    rowClass = 'issue-severe';
                    issueText = `<span style="color: var(--red); font-size: 10px; margin-left: 4px;">‚ö† needs input</span>`;
                } else if (flex) {
                    // Check if flex differs from zone's dominant flex (consistency check)
                    const zoneDom = zoneDominantFlex[zone];
                    const normalizedCurrentFlex = normalizeFlexForDropdown(flex);
                    if (zoneDom && normalizedCurrentFlex !== zoneDom) {
                        rowClass = 'issue-warning';
                        issueText = `<span style="color: var(--orange); font-size: 10px; margin-left: 4px;">‚ö† differs from ${zoneDom}</span>`;
                    }
                }
                
                // Build flex select options - use normalized flex or empty for needs input
                const normalizedFlex = flex ? normalizeFlexForDropdown(flex) : '';
                let selectOptionsHtml = '<option value="">-- Select --</option>';
                flexOptions.forEach(f => {
                    const selected = (normalizedFlex && f === normalizedFlex) ? 'selected' : '';
                    selectOptionsHtml += `<option value="${f}" ${selected}>${f}</option>`;
                });
                
                // Per-club reset button
                const resetDisabled = !hasOriginal ? 'disabled' : '';
                const resetTitle = hasOriginal 
                    ? `Reset to original (${club.originalShaftFlex})` 
                    : 'No original flex stored';
                
                editHtml += `
                    <div class="flex-edit-row ${rowClass}" data-club-id="${club.id}" data-club-type="${club.clubType}" data-original-flex="${flex || ''}">
                        <input type="checkbox" class="flex-edit-checkbox flex-club-checkbox" checked data-index="${index}">
                        <span class="flex-edit-club">${club.clubType}</span>
                        <span class="flex-edit-current ${estClass}">${displayFlex}${issueText}</span>
                        <select class="flex-edit-select" data-index="${index}" data-original="${flex || ''}">
                            ${selectOptionsHtml}
                        </select>
                        <button class="flex-edit-reset-btn" 
                                onclick="resetSingleFlex('${club.id}')" 
                                ${resetDisabled}
                                title="${resetTitle}">‚Ü∫</button>
                    </div>
                `;
            });
            
            if (!hasEditableClubs) {
                editHtml = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No clubs to edit.</div>';
            }
            
            // Add action buttons
            editHtml += `
                <div class="flex-edit-actions">
                    <button class="btn btn-secondary" onclick="toggleFlexEditMode()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveFlexEdits()">üíæ Save Changes</button>
                </div>
            `;
            
            // Add footnote
            editHtml += `
                <div class="factor-estimated-footnote" style="margin-top: 12px; font-size: 11px;">
                    <span style="color: var(--red);">‚ö† needs input</span> = no flex data ‚Ä¢ <span style="color: var(--orange);">‚ö† rec:</span> = differs from swing speed recommendation ‚Ä¢ ‚Ü∫ resets to original
                </div>
            `;
            
            document.getElementById('factor-modal-clubs').innerHTML = editHtml;
        }
        
        /**
         * Toggle all flex checkboxes
         */
        function toggleAllFlexCheckboxes(checked) {
            document.querySelectorAll('.flex-club-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }
        
        /**
         * Apply bulk flex set to selected clubs
         */
        function applyBulkFlexSet(value) {
            if (!value) return;
            
            document.querySelectorAll('.flex-club-checkbox:checked').forEach(checkbox => {
                const row = checkbox.closest('.flex-edit-row');
                const select = row.querySelector('.flex-edit-select');
                select.value = value;
            });
            
            // Reset dropdown
            document.getElementById('flex-bulk-set').value = '';
        }
        
        /**
         * Reset a single club's flex to original
         */
        async function resetSingleFlex(clubId) {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs || !window.currentClient) return;
            
            const club = analysis.clubs.find(c => c.id === clubId);
            if (!club || club.originalShaftFlex === undefined) {
                await showConfirmModal('Cannot Reset', 'No original flex stored for this club.', 'OK');
                return;
            }
            
            const confirmed = await showConfirmModal(
                'Reset Flex?',
                `Reset ${club.clubType} to original ${club.originalShaftFlex}?`,
                'Reset'
            );
            if (!confirmed) return;
            
            try {
                const clientId = window.currentClient.id;
                const clubRef = db.collection('users').doc(clientId)
                    .collection('clubs').doc(clubId);
                
                await clubRef.update({
                    shaft_flex: club.originalShaftFlex,
                    flexIsUserEdited: false,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update in-memory
                club.shaft_flex = club.originalShaftFlex;
                club.flexIsUserEdited = false;
                
                console.log(`‚úÖ Reset ${club.clubType} to ${club.originalShaftFlex}`);
                
                // Re-render edit mode
                renderFlexEditMode();
                
            } catch (error) {
                console.error('Error resetting flex:', error);
                alert('Error resetting flex: ' + error.message);
            }
        }
        
        /**
         * Save flex edits
         */
        async function saveFlexEdits() {
            const rows = document.querySelectorAll('.flex-edit-row');
            const updates = [];
            
            // Normalize flex for comparison
            function normalizeFlexValue(flex) {
                if (!flex) return '';
                const f = flex.toLowerCase().trim();
                if (f === 'l' || f === 'ladies' || f === 'lady') return 'Ladies';
                if (f === 'a' || f === 'sr' || f === 'senior' || f === 'am') return 'Senior';
                if (f === 'r' || f === 'regular' || f === 'reg' || f === 'm' || f === 'med' || f === 'medium') return 'Regular';
                if (f === 's' || f === 'stiff' || f === 'firm') return 'Stiff';
                if (f === 'x' || f === 'xs' || f === 'x-stiff' || f === 'xstiff' || f === 'extra stiff' || f === 'tour') return 'X-Stiff';
                if (/\d+s$/i.test(f) || /s\d*$/i.test(f)) return 'Stiff';
                if (/\d+r$/i.test(f) || /r\d*$/i.test(f)) return 'Regular';
                if (/\d+x$/i.test(f) || /x\d*$/i.test(f)) return 'X-Stiff';
                if (/\d+a$/i.test(f) || /a\d*$/i.test(f)) return 'Senior';
                if (/\d+l$/i.test(f) || /l\d*$/i.test(f)) return 'Ladies';
                return flex;
            }
            
            rows.forEach(row => {
                const checkbox = row.querySelector('.flex-club-checkbox');
                if (!checkbox || !checkbox.checked) return;
                
                const clubId = row.dataset.clubId;
                const clubType = row.dataset.clubType;
                const originalFlex = row.dataset.originalFlex;
                const select = row.querySelector('.flex-edit-select');
                const newFlex = select.value;
                
                // Only include if flex changed (compare normalized values)
                const normalizedOriginal = normalizeFlexValue(originalFlex);
                if (newFlex && newFlex !== normalizedOriginal) {
                    updates.push({
                        clubId: clubId,
                        clubType: clubType,
                        originalFlex: originalFlex,
                        newFlex: newFlex
                    });
                }
            });
            
            if (updates.length === 0) {
                await showConfirmModal('No Changes', 'No changes to save. Modify flex values to save.', 'OK');
                return;
            }
            
            // Show confirmation
            const changesList = updates.map(u => `${u.clubType}: ${u.originalFlex || 'Unknown'} ‚Üí ${u.newFlex}`).join('\n');
            const confirmed = await showConfirmModal(
                `Update ${updates.length} Club${updates.length > 1 ? 's' : ''}?`,
                changesList,
                'Save Changes'
            );
            
            if (!confirmed) return;
            
            // Save to Firestore
            try {
                const saveBtn = document.querySelector('.flex-edit-actions .btn-primary');
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Saving...';
                
                // Call the save function
                if (typeof saveFlexUpdates === 'function') {
                    await saveFlexUpdates(updates);
                    
                    // Show success
                    saveBtn.textContent = '‚úì Saved!';
                    
                    // Close modal and show regrade modal after short delay
                    setTimeout(() => {
                        closeModal('factor-detail-modal');
                        window.flexEditMode = false;
                        
                        if (typeof showRegradeModal === 'function') {
                            showRegradeModal();
                        } else {
                            const regrade = confirm('Flex updated!\n\nRegrade now? (Uses 1 credit)');
                            if (regrade && typeof gradeBag === 'function') {
                                gradeBag();
                            }
                        }
                    }, 500);
                } else {
                    throw new Error('Save function not available. Make sure firebase-auth.js is loaded.');
                }
            } catch (error) {
                console.error('Error saving flex edits:', error);
                alert('Error saving: ' + error.message);
                const saveBtn = document.querySelector('.flex-edit-actions .btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Save Changes';
                }
            }
        }
        
        /**
         * Reset all flex to original (batch reset)
         */
        async function resetFlexToOriginal() {
            const analysis = window.currentAnalysisData;
            if (!analysis || !analysis.clubs || !window.currentClient) {
                alert('No club data available');
                return;
            }
            
            // Find clubs that have original flex stored
            const resettableClubs = analysis.clubs.filter(c => 
                c.originalShaftFlex !== undefined && 
                c.originalShaftFlex !== null &&
                c.flexIsUserEdited === true
            );
            
            if (resettableClubs.length === 0) {
                await showConfirmModal('Cannot Reset', 'No clubs with editable flex to reset.\n\nOnly clubs that have been previously edited can be reset.', 'OK');
                return;
            }
            
            const changesList = resettableClubs.map(c => `${c.clubType}: ${c.shaft_flex} ‚Üí ${c.originalShaftFlex}`).join('\n');
            const confirmed = await showConfirmModal(
                `Reset ${resettableClubs.length} Club${resettableClubs.length > 1 ? 's' : ''}?`,
                changesList,
                'Reset All'
            );
            
            if (!confirmed) return;
            
            try {
                const clientId = window.currentClient.id;
                const batch = db.batch();
                let resetCount = 0;
                
                for (const club of resettableClubs) {
                    if (!club.id) continue;
                    
                    const clubRef = db.collection('users').doc(clientId)
                        .collection('clubs').doc(club.id);
                    
                    batch.update(clubRef, {
                        shaft_flex: club.originalShaftFlex,
                        flexIsUserEdited: false,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update in-memory
                    club.shaft_flex = club.originalShaftFlex;
                    club.flexIsUserEdited = false;
                    resetCount++;
                }
                
                await batch.commit();
                console.log(`‚úÖ Reset ${resetCount} clubs to original flex`);
                
                // Refresh display
                await fetchClientClubs(clientId);
                
                // Show regrade modal
                closeModal('factor-detail-modal');
                window.flexEditMode = false;
                
                if (typeof showRegradeModal === 'function') {
                    showRegradeModal();
                } else {
                    const regrade = confirm(`Reset ${resetCount} clubs to original flex!\n\nRegrade now? (Uses 1 credit)`);
                    if (regrade && typeof gradeBag === 'function') {
                        gradeBag();
                    }
                }
                
            } catch (error) {
                console.error('Error resetting flex:', error);
                alert('Error resetting flex: ' + error.message);
            }
        }
        
        // ============================================
        // SWING SPEED EDIT MODE
        // ============================================
        
        /**
         * Toggle swing speed edit mode
         * @param {string} sourceCard - Which factor card triggered this ('flex' or 'weight')
         */
        function toggleSwingSpeedEdit(sourceCard) {
            window.swingSpeedEditMode = !window.swingSpeedEditMode;
            
            // Re-render the factor modal to show edit/display mode
            if (sourceCard === 'flex') {
                showFactorDetail('flex');
            } else if (sourceCard === 'weight') {
                showFactorDetail('weight');
            }
        }
        
        /**
         * Save swing speed to user profile and optionally trigger regrade
         * @param {string} sourceCard - Which factor card triggered this ('flex' or 'weight')
         * @param {boolean} triggerRegrade - Whether to show regrade modal after save
         */
        async function saveSwingSpeed(sourceCard, triggerRegrade = true) {
            const slider = document.getElementById('swing-speed-slider');
            const sourceRadio = document.querySelector('input[name="swing-speed-source"]:checked');
            
            if (!slider) {
                alert('Error: Could not find swing speed input');
                return;
            }
            
            const swingSpeed = parseInt(slider.value);
            const swingSpeedSource = sourceRadio ? sourceRadio.value : 'manual';
            
            if (swingSpeed < 50 || swingSpeed > 130) {
                alert('Please enter a valid swing speed between 50-130 mph');
                return;
            }
            
            if (!window.currentClient) {
                alert('No client selected');
                return;
            }
            
            try {
                const saveBtn = document.querySelector('.swing-speed-edit-actions .btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = '‚è≥ Saving...';
                }
                
                const clientId = window.currentClient.id;
                
                // Update client's user document
                await db.collection('users').doc(clientId).update({
                    swingSpeed: swingSpeed,
                    swingSpeedSource: swingSpeedSource,
                    swingSpeedUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(`‚úÖ Saved swing speed: ${swingSpeed} mph (source: ${swingSpeedSource})`);
                
                // Update local client data
                window.currentClient.swingSpeed = swingSpeed;
                window.currentClient.swingSpeedSource = swingSpeedSource;
                
                // Exit edit mode
                window.swingSpeedEditMode = false;
                
                if (triggerRegrade) {
                    // Close modal and show regrade prompt
                    closeModal('factor-detail-modal');
                    
                    // Show regrade modal
                    if (typeof showRegradeModal === 'function') {
                        showRegradeModal();
                    } else {
                        const regrade = confirm(`Swing speed updated to ${swingSpeed} mph!\n\nRegrade now? (Uses 1 credit)`);
                        if (regrade && typeof gradeBag === 'function') {
                            gradeBag();
                        }
                    }
                } else {
                    // Just refresh the factor display
                    showFactorDetail(sourceCard);
                }
                
            } catch (error) {
                console.error('Error saving swing speed:', error);
                alert('Error saving swing speed: ' + error.message);
                
                const saveBtn = document.querySelector('.swing-speed-edit-actions .btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Save & Regrade';
                }
            }
        }
        
        // ============================================
        // GRADE EXPLAINER - Why This Grade?
        // ============================================
        
        // Call this when loading a client's analysis data from Firestore
        // analysisData should contain grade_explainer object
        function loadAnalysisDisplay(analysisData) {
            if (!analysisData) return;
            
            // Store globally for factor modals
            window.currentAnalysisData = analysisData;
            
            // Build club issues map for club card badges
            if (typeof buildClubIssuesMap === 'function') {
                buildClubIssuesMap();
            }
            
            // Update AI score comparison
            if (analysisData.ai_bag_analysis) {
                updateAIScoreComparison(analysisData);
            }
            
            // Update grade explainer
            if (analysisData.grade_explainer) {
                updateGradeExplainer(analysisData.grade_explainer);
            }
            
            // Update grip assessment
            if (analysisData.grip_assessment) {
                updateGripAssessment(analysisData.grip_assessment);
            }
            
            // Update favorite club baseline badge
            const baselineBadge = document.getElementById('favorite-baseline-badge');
            const baselineClubType = document.getElementById('baseline-club-type');
            if (baselineBadge) {
                if (analysisData.favorite_club_baseline && analysisData.favorite_club_baseline.clubType) {
                    baselineClubType.textContent = analysisData.favorite_club_baseline.clubType;
                    baselineBadge.style.display = 'inline-flex';
                } else {
                    baselineBadge.style.display = 'none';
                }
            }
            
            // Update body fit baseline badge
            const bodyfitBadge = document.getElementById('bodyfit-baseline-badge');
            if (bodyfitBadge) {
                if (analysisData.body_fit_baseline && analysisData.body_fit_baseline.heightDisplay) {
                    bodyfitBadge.style.display = 'inline-flex';
                } else {
                    bodyfitBadge.style.display = 'none';
                }
            }
        }
        
        function updateAIScoreComparison(analysisData) {
            const comparisonEl = document.getElementById('ai-score-comparison');
            const summaryEl = document.getElementById('ai-adjustment-summary');
            const factorTagsEl = document.getElementById('ai-factor-adjustments');
            const overallGradeEl = document.getElementById('overall-grade-letter');
            
            if (!comparisonEl) return;
            
            const ai = analysisData.ai_bag_analysis;
            const rawScore = analysisData.algorithm_score || ai?.algorithm_score || 0;
            const adjustedScore = analysisData.overall_score || ai?.ai_adjusted_score || rawScore;
            const adjustmentTotal = analysisData.ai_adjustment_total || ai?.ai_adjustment_total || 0;
            const factorAdjustments = ai?.factor_adjustments || [];
            const adjustmentSummary = ai?.adjustment_summary || '';
            
            // Update overall grade letter (use AI grade if available, else calculate from score)
            const overallGrade = analysisData.overall_grade || ai?.ai_grade || 
                (adjustedScore >= 90 ? 'A' : adjustedScore >= 80 ? 'B' : adjustedScore >= 70 ? 'C' : adjustedScore >= 60 ? 'D' : 'F');
            if (overallGradeEl) {
                overallGradeEl.textContent = overallGrade;
                overallGradeEl.className = 'overall-grade-value grade-' + overallGrade.charAt(0).toLowerCase();
            }
            
            // Update score values
            document.getElementById('raw-algo-score').textContent = rawScore;
            document.getElementById('ai-adjusted-score').textContent = adjustedScore;
            
            // Update adjustment value with color
            const adjValueEl = document.getElementById('ai-adjustment-value');
            const adjSign = adjustmentTotal >= 0 ? '+' : '';
            adjValueEl.textContent = adjSign + adjustmentTotal;
            adjValueEl.className = 'adj-value ' + (adjustmentTotal > 0 ? 'positive' : adjustmentTotal < 0 ? 'negative' : 'neutral');
            
            // Show comparison section
            comparisonEl.style.display = 'flex';
            
            // Show adjustment summary if available
            if (adjustmentSummary && adjustmentSummary.length > 0) {
                summaryEl.textContent = adjustmentSummary;
                summaryEl.style.display = 'block';
            } else {
                summaryEl.style.display = 'none';
            }
            
            // Show factor adjustment tags
            if (factorAdjustments && factorAdjustments.length > 0) {
                const factorNames = {
                    age: 'Age',
                    weight: 'Weight',
                    loft: 'Loft',
                    flex: 'Flex',
                    kickpoint: 'Kickpoint',
                    torque: 'Torque',
                    length: 'Length',
                    lie: 'Lie'
                };
                
                let tagsHtml = '';
                factorAdjustments.forEach(adj => {
                    const name = factorNames[adj.factor] || adj.factor;
                    const sign = adj.adjustment >= 0 ? '+' : '';
                    const cssClass = adj.adjustment > 0 ? 'positive' : 'negative';
                    tagsHtml += `<span class="ai-factor-adj-tag ${cssClass}">${name} ${sign}${adj.adjustment}</span>`;
                });
                
                factorTagsEl.innerHTML = tagsHtml;
                factorTagsEl.style.display = 'flex';
            } else {
                factorTagsEl.style.display = 'none';
            }
        }
        
        function updateGradeExplainer(explainer) {
            if (!explainer) return;
            
            const container = document.getElementById('grade-explainer');
            const impactsEl = document.getElementById('grade-explainer-impacts');
            
            if (!container) return;
            
            if (!explainer.top_impacts || explainer.top_impacts.length === 0) {
                // No issues - show positive message
                impactsEl.innerHTML = '<div style="font-size: 11px; color: var(--green); text-align: center; padding: 6px;">‚úì No major issues</div>';
                return;
            }
            
            // Build compact impacts HTML
            let impactsHtml = '';
            explainer.top_impacts.slice(0, 3).forEach((impact) => {
                // Shorten the issue text
                let shortIssue = impact.issue;
                if (shortIssue.length > 45) {
                    shortIssue = shortIssue.substring(0, 42) + '...';
                }
                impactsHtml += `
                    <div class="grade-impact-item">
                        <div class="grade-impact-issue">${shortIssue}</div>
                        <div class="grade-impact-points">${impact.impact}</div>
                    </div>
                `;
            });
            impactsEl.innerHTML = impactsHtml;
        }
        
        // Call updateGradeExplainer when analysis data becomes available
        // This watches for changes to window.currentAnalysisData
        (function watchAnalysisData() {
            let lastData = null;
            setInterval(() => {
                const data = window.currentAnalysisData;
                if (data && data !== lastData) {
                    lastData = data;
                    // Update AI score comparison
                    if (data.ai_bag_analysis) {
                        updateAIScoreComparison(data);
                    }
                    if (data.grade_explainer) {
                        updateGradeExplainer(data.grade_explainer);
                    }
                    if (data.grip_assessment) {
                        updateGripAssessment(data.grip_assessment);
                    }
                }
            }, 500);
        })();
        
        // ============================================
        // GRIP ASSESSMENT - Regripping Opportunities
        // ============================================
        function updateGripAssessment(grip) {
            if (!grip) return;
            
            const container = document.getElementById('grip-assessment');
            if (!container) return;
            
            // Always show grip section (even with no data - shows "add data" prompt)
            container.style.display = 'block';
            
            // Update stats
            document.getElementById('grip-clubs-count').textContent = grip.total_clubs || 0;
            document.getElementById('grip-need-regrip').textContent = grip.clubs_needing_regrip || 0;
            document.getElementById('grip-data-count').textContent = grip.clubs_with_grip_data || 0;
            
            // Update status badge
            const badge = document.getElementById('grip-status-badge');
            if (grip.clubs_needing_regrip > 0) {
                if (grip.bulk_replace_recommended) {
                    badge.textContent = 'Full Regrip Needed';
                    badge.className = 'grip-status-badge attention';
                } else {
                    badge.textContent = grip.clubs_needing_regrip + ' Need Attention';
                    badge.className = 'grip-status-badge warning';
                }
            } else if (grip.clubs_with_grip_data === 0) {
                badge.textContent = 'No Data';
                badge.className = 'grip-status-badge warning';
            } else {
                badge.textContent = 'All Good';
                badge.className = 'grip-status-badge good';
            }
            
            // Show/hide cost row
            const costRow = document.getElementById('grip-cost-row');
            const noDataMsg = document.getElementById('grip-no-data');
            
            if (grip.clubs_with_grip_data === 0) {
                // No grip data
                costRow.style.display = 'none';
                noDataMsg.style.display = 'block';
            } else if (grip.clubs_needing_regrip > 0 && grip.cost_estimate) {
                // Show cost for clubs needing regrip
                costRow.style.display = 'flex';
                noDataMsg.style.display = 'none';
                const cost = grip.cost_estimate;
                if (grip.bulk_replace_recommended) {
                    document.getElementById('grip-cost-value').textContent = 
                        `$${cost.fullBagStandard} - $${cost.fullBagPremium}`;
                } else {
                    document.getElementById('grip-cost-value').textContent = 
                        `$${cost.neededClubsStandard} - $${cost.neededClubsPremium}`;
                }
            } else {
                costRow.style.display = 'none';
                noDataMsg.style.display = 'none';
            }
        }

        // ============================================
        // SCENARIO BUILDER (Retail-style)
        // ============================================
        let scenarioState = {
            currentStep: 1,
            selectedClub: null,
            selectedHead: null,
            selectedShaft: null,
            useStockShaft: null,
            isComplete: false
        };

        const clubSetups = {
            'driver': { name: 'Driver', current: 'TaylorMade Stealth 2 (2023)\n10.5¬∞ ‚Ä¢ Stock Aldila 65g ‚Ä¢ Stiff' },
            '3wood': { name: '3-Wood', current: 'TaylorMade Stealth 2 (2023)\n15¬∞ ‚Ä¢ Stock Aldila 90g ‚Ä¢ Stiff' },
            'hybrid': { name: '4-Hybrid', current: 'Cobra LTDx (2022)\n21¬∞ ‚Ä¢ Stock UST Recoil 75g ‚Ä¢ Regular' },
            '5hybrid': { name: '5-Hybrid', current: 'TaylorMade Stealth 2 (2023)\n25¬∞ ‚Ä¢ Stock Fujikura 70g ‚Ä¢ Stiff' },
            'irons': { name: 'Irons (6i-PW)', current: 'TaylorMade P790 (2023)\nSteel - KBS Tour 120g ‚Ä¢ Stiff' },
            'wedges': { name: 'Wedges', current: 'Titleist Vokey SM8 (2020)\n52¬∞, 56¬∞, 60¬∞ ‚Ä¢ True Temper ‚Ä¢ Wedge Flex' }
        };

        function toggleScenarioDropdown() {
            const dropdown = document.getElementById('club-dropdown');
            dropdown.classList.toggle('open');
        }

        function selectScenarioClub(clubId, displayName, status) {
            scenarioState.selectedClub = clubId;
            
            // Update dropdown display
            const dropdown = document.getElementById('club-dropdown');
            const dropdownValue = document.getElementById('club-dropdown-value');
            dropdownValue.textContent = displayName;
            dropdownValue.classList.remove('placeholder');
            dropdown.classList.remove('open');
            dropdown.classList.add('filled');
            
            // Show current setup
            document.getElementById('current-setup-card').style.display = 'block';
            document.getElementById('current-setup-display').innerHTML = clubSetups[clubId].current.replace(/\n/g, '<br>');
            
            // Show head swap card
            document.getElementById('head-swap-card').style.display = 'block';
            
            // Reset head/shaft selections
            resetHeadShaftSelections();
        }

        function resetHeadShaftSelections() {
            scenarioState.selectedHead = null;
            scenarioState.selectedShaft = null;
            scenarioState.useStockShaft = null;
            
            document.getElementById('head-swap-btn').classList.remove('filled');
            document.getElementById('head-swap-text').textContent = 'Tap to select new club head ‚Üí';
            document.getElementById('shaft-choice-card').style.display = 'none';
            document.getElementById('stock-shaft-info').style.display = 'none';
            document.getElementById('custom-shaft-picker').style.display = 'none';
            document.getElementById('stock-yes').classList.remove('selected-yes');
            document.getElementById('stock-no').classList.remove('selected-no');
            document.getElementById('run-scenario-btn').disabled = true;
        }

        function openHeadPicker() {
            document.getElementById('head-picker-screen').classList.add('active');
        }

        function closeHeadPicker() {
            document.getElementById('head-picker-screen').classList.remove('active');
        }

        function selectHead(headName, loft, stockShaft) {
            scenarioState.selectedHead = { name: headName, loft: loft, stockShaft: stockShaft };
            
            // Update UI
            document.getElementById('head-swap-btn').classList.add('filled');
            document.getElementById('head-swap-text').innerHTML = '‚úì ' + headName + ' ‚Ä¢ ' + loft;
            
            // Close picker and show shaft choice
            closeHeadPicker();
            document.getElementById('shaft-choice-card').style.display = 'block';
            document.getElementById('stock-shaft-name').textContent = stockShaft;
            
            // Scroll to shaft choice
            document.getElementById('shaft-choice-card').scrollIntoView({ behavior: 'smooth' });
        }

        function selectStockShaft(useStock) {
            scenarioState.useStockShaft = useStock;
            
            // Update buttons
            document.getElementById('stock-yes').classList.toggle('selected-yes', useStock);
            document.getElementById('stock-no').classList.toggle('selected-no', !useStock);
            
            // Show appropriate section
            document.getElementById('stock-shaft-info').style.display = useStock ? 'block' : 'none';
            document.getElementById('custom-shaft-picker').style.display = useStock ? 'none' : 'block';
            
            if (useStock) {
                scenarioState.selectedShaft = scenarioState.selectedHead.stockShaft;
                document.getElementById('run-scenario-btn').disabled = false;
            } else {
                scenarioState.selectedShaft = null;
                document.getElementById('run-scenario-btn').disabled = true;
            }
        }

        function openShaftPicker() {
            document.getElementById('shaft-picker-screen').classList.add('active');
        }

        function closeShaftPicker() {
            document.getElementById('shaft-picker-screen').classList.remove('active');
        }

        function selectShaft(shaftName, weight, kickpoint, torque) {
            scenarioState.selectedShaft = shaftName + ' ‚Ä¢ ' + weight + ' ‚Ä¢ ' + kickpoint;
            
            // Update UI
            document.getElementById('shaft-swap-btn').classList.add('filled');
            document.getElementById('shaft-swap-text').innerHTML = '‚úì ' + shaftName;
            
            // Close picker and enable run button
            closeShaftPicker();
            document.getElementById('run-scenario-btn').disabled = false;
        }

        function filterHeads(category) {
            document.querySelectorAll('#head-picker-screen .picker-filter').forEach(f => f.classList.remove('active'));
            event.target.classList.add('active');
            // In production, would filter the picker cards
        }

        function filterShafts(weightRange) {
            document.querySelectorAll('#shaft-picker-screen .picker-filter').forEach(f => f.classList.remove('active'));
            event.target.classList.add('active');
            // In production, would filter the picker cards
        }

        function startScenarioForClub(clubId) {
            showClientTab('scenarios');
            resetScenario();
            
            // Auto-select the club
            const statusMap = {
                'driver': 'good', '3wood': 'attention', 'hybrid': 'attention',
                '5hybrid': 'good', 'irons': 'good', 'wedges': 'attention'
            };
            const displayNames = {
                'driver': 'Driver', '3wood': '3-Wood', 'hybrid': '4-Hybrid',
                '5hybrid': '5-Hybrid', 'irons': 'Irons (6i-PW)', 'wedges': 'Wedges'
            };
            
            if (clubSetups[clubId]) {
                selectScenarioClub(clubId, displayNames[clubId], statusMap[clubId]);
            }
        }

        function goToScenarioStep(step) {
            // Update progress
            for (let i = 1; i <= 4; i++) {
                const progressEl = document.getElementById('progress-' + i);
                if (progressEl) {
                    progressEl.classList.remove('active', 'complete');
                    if (i < step) {
                        progressEl.classList.add('complete');
                    } else if (i === step) {
                        progressEl.classList.add('active');
                    }
                }
            }
            
            // Show correct step
            document.querySelectorAll('#tab-scenarios .scenario-step').forEach(s => s.classList.remove('active'));
            const stepEl = document.getElementById('scenario-step-' + step);
            if (stepEl) stepEl.classList.add('active');
            
            // Update review content when going to step 2
            if (step === 2) {
                updateReviewContent();
            }
            
            scenarioState.currentStep = step;
        }

        function updateReviewContent() {
            if (scenarioState.selectedClub && clubSetups[scenarioState.selectedClub]) {
                document.getElementById('review-club-name').textContent = clubSetups[scenarioState.selectedClub].name;
                document.getElementById('review-from').innerHTML = clubSetups[scenarioState.selectedClub].current.replace(/\n/g, '<br>');
            }
            if (scenarioState.selectedHead) {
                document.getElementById('review-to').innerHTML = 
                    scenarioState.selectedHead.name + '<br>' +
                    scenarioState.selectedHead.loft + ' ‚Ä¢ ' + scenarioState.selectedShaft;
            }
        }

        function cancelScenario() {
            resetScenario();
            showClientTab('bag');
            document.querySelectorAll('.tabs .tab').forEach((t, i) => {
                if (i === 0) t.classList.add('active');
                else t.classList.remove('active');
            });
        }

        function resetScenario() {
            scenarioState = {
                currentStep: 1,
                selectedClub: null,
                selectedHead: null,
                selectedShaft: null,
                useStockShaft: null,
                isComplete: false
            };
            
            // Reset dropdown
            const dropdownValue = document.getElementById('club-dropdown-value');
            if (dropdownValue) {
                dropdownValue.textContent = 'Select club or set...';
                dropdownValue.classList.add('placeholder');
            }
            const dropdown = document.getElementById('club-dropdown');
            if (dropdown) {
                dropdown.classList.remove('filled', 'open');
            }
            
            // Hide cards
            const cards = ['current-setup-card', 'head-swap-card', 'shaft-choice-card'];
            cards.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            
            // Reset run button
            const runBtn = document.getElementById('run-scenario-btn');
            if (runBtn) runBtn.disabled = true;
            
            goToScenarioStep(1);
        }

        function runScenarioAnalysis() {
            // Check credits
            if (creditState.client.tier === 'free') {
                if (creditState.client.freeTrials.scenarios > 0) {
                    creditState.client.freeTrials.scenarios--;
                } else {
                    openModal('paywall-modal');
                    return;
                }
            } else if (creditState.client.available < 1) {
                openModal('no-credits-modal');
                return;
            } else {
                creditState.client.used++;
                creditState.client.available--;
                updateCreditsDisplay();
            }
            
            goToScenarioStep(3);
            scenarioState.isComplete = true;
        }

        function applyScenarioToBag() {
            alert('‚úÖ Scenario applied to your bag! Your ' + (clubSetups[scenarioState.selectedClub]?.name || 'club') + ' has been updated.');
            resetScenario();
            showClientTab('bag');
            document.querySelectorAll('.tabs .tab').forEach((t, i) => {
                if (i === 0) t.classList.add('active');
                else t.classList.remove('active');
            });
        }

        function openShopForScenario() {
            if (document.body.classList.contains('client-view')) {
                openModal('contact-pro-modal');
            } else {
                alert('üõí Shop modal would open with affiliate links for:\n\n‚Ä¢ ' + (scenarioState.selectedHead?.name || 'Selected Club') + '\n‚Ä¢ ' + (scenarioState.selectedShaft || 'Selected Shaft') + '\n\nComing in Phase 5!');
            }
        }

        function tryAnotherScenario() {
            if (creditState.client.tier === 'free') {
                openModal('paywall-modal');
                return;
            }
            if (creditState.client.available < 1) {
                openModal('no-credits-modal');
                return;
            }
            resetScenario();
        }

        function saveScenario() {
            if (!scenarioState.isComplete) {
                alert('Please complete the scenario first before saving.');
                return;
            }
            
            const clubName = clubSetups[scenarioState.selectedClub]?.name || 'Club';
            const scenarioName = prompt('Name this scenario:', clubName + ' Upgrade');
            
            if (scenarioName) {
                // Update saved count
                const countEl = document.getElementById('saved-count');
                const currentCount = parseInt(countEl.textContent) || 0;
                countEl.textContent = currentCount + 1;
                
                alert('‚úÖ Scenario Saved!\n\n"' + scenarioName + '" has been saved to your scenarios list.');
            }
        }

        function loadScenario(id) {
            closeModal('saved-scenarios-modal');
            
            // Saved scenario data (in production, would come from database)
            const scenarios = {
                1: { 
                    name: '3-Wood Shaft Upgrade', 
                    club: '3wood',
                    clubName: '3-Wood',
                    currentGrade: 'B+',
                    projectedGrade: 'A-',
                    head: { name: 'TaylorMade Stealth 2 Plus', loft: '15¬∞' },
                    shaft: 'Fujikura Ventus Blue 75g',
                    factorChanges: [
                        { name: 'Weight Progression', from: 'C', to: 'A', improved: true },
                        { name: 'Kickpoint Consistency', from: 'B', to: 'A-', improved: true }
                    ],
                    aiAnalysis: 'Swapping to the Fujikura Ventus Blue 75g improves your weight progression significantly. Before: Driver 65g ‚Üí 3-Wood 90g (25g gap). After: Driver 65g ‚Üí 3-Wood 75g (10g gap). This creates a smoother tempo transition between your driver and fairway woods.'
                },
                2: { 
                    name: '4-Hybrid Flex Fix', 
                    club: 'hybrid',
                    clubName: '4-Hybrid',
                    currentGrade: 'B+',
                    projectedGrade: 'A-',
                    head: { name: 'Callaway Apex', loft: '21¬∞' },
                    shaft: 'Project X HZRDUS Stiff',
                    factorChanges: [
                        { name: 'Shaft Flex Consistency', from: 'C+', to: 'A', improved: true },
                        { name: 'Kickpoint Consistency', from: 'B-', to: 'A-', improved: true }
                    ],
                    aiAnalysis: 'Switching to the Project X HZRDUS Stiff shaft brings your hybrid in line with the rest of your bag. Your current Regular flex creates inconsistent ball flight compared to your Stiff flex irons and woods.'
                },
                3: { 
                    name: 'Full Wedge Set Update', 
                    club: 'wedges',
                    clubName: 'Wedges',
                    currentGrade: 'B+',
                    projectedGrade: 'A',
                    head: { name: 'Titleist Vokey SM10', loft: '52¬∞, 56¬∞, 60¬∞' },
                    shaft: 'True Temper Dynamic Gold S200',
                    factorChanges: [
                        { name: 'Club Age', from: 'D', to: 'A', improved: true },
                        { name: 'Loft Gapping', from: 'B', to: 'A', improved: true }
                    ],
                    aiAnalysis: 'Your current wedges are 6+ years old with worn grooves affecting spin consistency. The Vokey SM10 set provides modern groove technology and proper 4¬∞ gapping (52¬∞, 56¬∞, 60¬∞) for precise distance control around the greens.'
                }
            };
            
            const scenario = scenarios[id];
            if (scenario) {
                // Navigate to scenarios tab
                showClientTab('scenarios');
                
                // Set scenario state
                scenarioState.selectedClub = scenario.club;
                scenarioState.selectedHead = scenario.head;
                scenarioState.selectedShaft = scenario.shaft;
                scenarioState.isComplete = true;
                
                // Update results display
                document.getElementById('result-current-grade').textContent = scenario.currentGrade;
                document.getElementById('result-projected-grade').textContent = scenario.projectedGrade;
                
                // Update improvement text
                document.getElementById('result-improvement-text').textContent = 
                    'üéâ Grade improved! This change would move you from ' + scenario.currentGrade + ' to ' + scenario.projectedGrade + '.';
                
                // Update AI analysis
                document.getElementById('result-ai-analysis').textContent = scenario.aiAnalysis;
                
                // Update factor changes
                const factorContainer = document.getElementById('factor-changes-container');
                let factorHTML = '<div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Factor Changes</div>';
                scenario.factorChanges.forEach(factor => {
                    factorHTML += `
                        <div class="factor-change-row">
                            <span class="factor-change-name">${factor.name}</span>
                            <span class="factor-change-value ${factor.improved ? 'improved' : 'same'}">${factor.from} ‚Üí ${factor.to} ${factor.improved ? '‚Üë' : ''}</span>
                        </div>
                    `;
                });
                factorHTML += `
                    <div class="factor-change-row">
                        <span class="factor-change-name">Other Factors</span>
                        <span class="factor-change-value same">No change</span>
                    </div>
                `;
                factorContainer.innerHTML = factorHTML;
                
                // Jump to results step (step 3)
                goToScenarioStep(3);
            }
        }

        function applyScenarioFromSaved(id) {
            const scenarios = {
                1: '3-Wood Shaft Upgrade',
                2: '4-Hybrid Flex Fix',
                3: 'Full Wedge Set Update'
            };
            
            closeModal('saved-scenarios-modal');
            alert('‚úÖ Applied "' + scenarios[id] + '" to your bag!\n\nYour equipment has been updated.');
            showClientTab('bag');
        }

        function deleteScenario(id) {
            const scenarios = {
                1: '3-Wood Shaft Upgrade',
                2: '4-Hybrid Flex Fix',
                3: 'Full Wedge Set Update'
            };
            
            if (confirm('Delete "' + scenarios[id] + '"?\n\nThis cannot be undone.')) {
                // Update saved count
                const countEl = document.getElementById('saved-count');
                const currentCount = parseInt(countEl.textContent) || 0;
                if (currentCount > 0) {
                    countEl.textContent = currentCount - 1;
                }
                
                // Remove the card (in production, would remove from database)
                event.target.closest('.saved-scenario-card').remove();
                
                // Check if no scenarios left
                const remainingCards = document.querySelectorAll('.saved-scenario-card').length;
                if (remainingCards === 0) {
                    document.getElementById('saved-scenarios-list').style.display = 'none';
                    document.getElementById('no-saved-scenarios').style.display = 'block';
                }
            }
        }

        // ============================================
        // PERFORMANCE TESTING
        // ============================================
        let perfTestState = {
            currentStep: 1,
            selectedClub: null,
            compareClub: null,
            clubAData: {},
            clubBData: {},
            goals: [],
            isComplete: false,
            photoCount: 0,
            manualEntry: false
        };

        const testClubData = {
            'driver': { name: 'Driver', specs: 'TaylorMade Stealth 2 ‚Ä¢ 10.5¬∞' },
            '3wood': { name: '3-Wood', specs: 'TaylorMade Stealth 2 ‚Ä¢ 15¬∞' },
            '7iron': { name: '7-Iron', specs: 'TaylorMade P790 ‚Ä¢ 30.5¬∞' },
            'pw': { name: 'Pitching Wedge', specs: 'TaylorMade P790 ‚Ä¢ 45¬∞' },
            'hybrid': { name: '4-Hybrid', specs: 'Cobra LTDx ‚Ä¢ 21¬∞' },
            '5hybrid': { name: '5-Hybrid', specs: 'TaylorMade Stealth 2 ‚Ä¢ 25¬∞' }
        };

        // Photo capture functions
        function addTestPhoto() {
            perfTestState.photoCount++;
            
            // Show thumbnails container
            document.getElementById('test-photos').style.display = 'flex';
            
            // Add new thumbnail if more than 1
            if (perfTestState.photoCount > 1) {
                const thumb = document.createElement('div');
                thumb.className = 'photo-thumb';
                thumb.id = 'photo-thumb-' + perfTestState.photoCount;
                thumb.innerHTML = '<span>üì∑</span><button onclick="removeTestPhoto(' + perfTestState.photoCount + ')">√ó</button>';
                document.getElementById('test-photos').appendChild(thumb);
            }
            
            // Show add more button, hide capture zone
            document.getElementById('add-more-photos').style.display = 'block';
            document.getElementById('photo-capture-zone').style.display = 'none';
            
            // Hide manual entry link since we have photos
            document.getElementById('manual-entry-link').style.display = 'none';
            
            // Enable continue button
            document.getElementById('data-continue-btn').disabled = false;
            
            // Simulate AI extraction with processing overlay
            showProcessingOverlay('Extracting data from image...', 1500, function() {
                // Auto-fill some data after "extraction"
                document.getElementById('perf-ball-speed').value = '167';
                document.getElementById('perf-club-speed').value = '112';
                document.getElementById('perf-launch').value = '11.2';
                document.getElementById('perf-spin').value = '2650';
                document.getElementById('perf-carry').value = '282';
                document.getElementById('perf-total').value = '301';
                document.getElementById('perf-dispersion').value = '12';
            });
        }

        function removeTestPhoto(photoNum) {
            const thumb = document.getElementById('photo-thumb-' + photoNum);
            if (thumb) {
                thumb.remove();
            }
            perfTestState.photoCount--;
            
            if (perfTestState.photoCount === 0) {
                document.getElementById('test-photos').style.display = 'none';
                document.getElementById('add-more-photos').style.display = 'none';
                document.getElementById('photo-capture-zone').style.display = 'block';
                document.getElementById('manual-entry-link').style.display = 'block';
                document.getElementById('data-continue-btn').disabled = true;
            }
        }

        function showManualDataEntry() {
            perfTestState.manualEntry = true;
            
            // Hide photo capture, show manual form
            document.getElementById('photo-capture-zone').style.display = 'none';
            document.getElementById('manual-entry-link').style.display = 'none';
            document.getElementById('manual-data-section').style.display = 'block';
            
            // Enable continue button (will validate on click)
            document.getElementById('data-continue-btn').disabled = false;
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            // Add keyframes if not already added
            if (!document.getElementById('toast-keyframes')) {
                const style = document.createElement('style');
                style.id = 'toast-keyframes';
                style.textContent = `
                    @keyframes toastSlideIn {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Check if toast container exists
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = 'position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 10000;';
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'var(--red, #ff4444)' : type === 'success' ? 'var(--green, #00d26a)' : 'var(--cyan, #00bcd4)';
            toast.style.cssText = `
                background: ${bgColor};
                color: #000;
                padding: 12px 24px;
                border-radius: 8px;
                margin-top: 8px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: toastSlideIn 0.3s ease;
            `;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showProcessingOverlay(message, duration, callback) {
            // Create overlay if it doesn't exist
            let overlay = document.getElementById('processing-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'processing-overlay';
                overlay.className = 'processing-overlay';
                overlay.innerHTML = `
                    <div class="processing-icon">üîÑ</div>
                    <div class="processing-text" id="processing-message">Processing...</div>
                    <div class="processing-sub">This may take a moment</div>
                `;
                document.body.appendChild(overlay);
            }
            
            document.getElementById('processing-message').textContent = message;
            overlay.classList.add('active');
            
            setTimeout(function() {
                overlay.classList.remove('active');
                if (callback) callback();
            }, duration);
        }

        function selectTestClub(clubId, element) {
            perfTestState.selectedClub = clubId;
            document.querySelectorAll('#test-step-1 .club-select-item').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('test-step1-next').disabled = false;
            
            // Update club display for step 2 and step 3
            if (testClubData[clubId]) {
                document.getElementById('step2-your-club').textContent = testClubData[clubId].name;
                document.getElementById('step2-your-specs').textContent = testClubData[clubId].specs;
                document.getElementById('step3-your-club').textContent = testClubData[clubId].name;
                document.getElementById('step3-your-specs').textContent = testClubData[clubId].specs.split(' ‚Ä¢ ')[0];
            }
        }

        function toggleGoal(element) {
            element.classList.toggle('selected');
            const goalText = element.textContent.trim();
            if (element.classList.contains('selected')) {
                perfTestState.goals.push(goalText);
            } else {
                perfTestState.goals = perfTestState.goals.filter(g => g !== goalText);
            }
        }

        // Comparison club functions
        const compareModels = {
            'TaylorMade': ['Qi10', 'Qi10 Max', 'Qi10 LS', 'Stealth 2', 'Stealth 2 Plus', 'Stealth 2 HD'],
            'Titleist': ['GT2', 'GT3', 'GT4', 'TSR2', 'TSR3', 'TSR4'],
            'Callaway': ['Paradym Ai Smoke', 'Paradym Ai Smoke Max', 'Paradym Triple Diamond', 'Paradym X'],
            'Ping': ['G430 Max 10K', 'G430 Max', 'G430 LST', 'G430 SFT'],
            'Cobra': ['Darkspeed X', 'Darkspeed LS', 'Darkspeed Max', 'Aerojet'],
            'Mizuno': ['ST-Z 230', 'ST-X 230', 'ST-Max 230'],
            'Srixon': ['ZX5 MK II', 'ZX7 MK II', 'ZX5 LS MK II'],
            'Cleveland': ['Launcher XL', 'Launcher XL Lite']
        };

        function updateCompareModels() {
            const brand = document.getElementById('compare-brand').value;
            const modelSelect = document.getElementById('compare-model');
            
            modelSelect.innerHTML = '<option value="">Select model...</option>';
            
            if (brand && compareModels[brand]) {
                modelSelect.disabled = false;
                compareModels[brand].forEach(model => {
                    const opt = document.createElement('option');
                    opt.value = model;
                    opt.textContent = model;
                    modelSelect.appendChild(opt);
                });
            } else {
                modelSelect.disabled = true;
            }
            
            updateComparePreview();
        }

        function updateComparePreview() {
            const brand = document.getElementById('compare-brand').value;
            const model = document.getElementById('compare-model').value;
            const shaft = document.getElementById('compare-shaft').value;
            const preview = document.getElementById('compare-preview');
            const step2Next = document.getElementById('test-step2-next');
            
            if (brand && model) {
                document.getElementById('compare-preview-name').textContent = brand + ' ' + model;
                document.getElementById('compare-preview-specs').textContent = shaft || 'Stock Shaft';
                preview.style.display = 'block';
                step2Next.disabled = false;
                
                // Update step 3 compare display
                document.getElementById('step3-compare-club').textContent = brand + ' ' + model;
                document.getElementById('step3-compare-specs').textContent = shaft || 'Stock Shaft';
                
                // Store in state
                perfTestState.compareClub = {
                    brand: brand,
                    model: model,
                    shaft: shaft,
                    name: brand + ' ' + model
                };
            } else {
                preview.style.display = 'none';
                step2Next.disabled = true;
            }
        }

        function showClubAManualEntry() {
            document.getElementById('photo-capture-zone-a').style.display = 'none';
            document.getElementById('club-a-data').style.display = 'block';
        }

        function showClubBManualEntry() {
            document.getElementById('photo-capture-zone-b').style.display = 'none';
            document.getElementById('club-b-data').style.display = 'block';
        }

        // ===========================================
        // OCR PHOTO CAPTURE FOR LAUNCH MONITOR DATA
        // ===========================================
        
        function addTestPhotoA() {
            // Create hidden file input for camera/gallery
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // Use back camera on mobile
            input.onchange = (e) => handlePhotoCapture(e, 'a');
            input.click();
        }

        function addTestPhotoB() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = (e) => handlePhotoCapture(e, 'b');
            input.click();
        }
        
        async function handlePhotoCapture(event, clubSide) {
            const file = event.target.files[0];
            if (!file) return;
            
            const captureZone = document.getElementById(`photo-capture-zone-${clubSide}`);
            const originalContent = captureZone.innerHTML;
            
            // Show processing state
            captureZone.innerHTML = `
                <div style="color: var(--cyan); font-size: 24px;">‚è≥</div>
                <div style="font-size: 13px;">Processing image...</div>
            `;
            
            try {
                // Convert file to base64
                const base64 = await fileToBase64(file);
                
                // Call OCR Cloud Function
                const extractData = firebase.functions().httpsCallable('extractLaunchMonitorData');
                
                const clubType = clubSide === 'a' 
                    ? perfTestState.selectedClub?.clubType 
                    : perfTestState.compareClub?.clubType || perfTestState.selectedClub?.clubType;
                
                const result = await extractData({
                    imageBase64: base64,
                    expectedClubType: clubType,
                    userId: window.currentClient?.id
                });
                
                if (result.data.success && result.data.metrics) {
                    // Populate form fields
                    populateMetricsFromOCR(result.data.metrics, clubSide);
                    
                    // Show success
                    captureZone.innerHTML = `
                        <div style="color: var(--green); font-size: 24px;">‚úì</div>
                        <div style="font-size: 13px;">${Object.keys(result.data.metrics).length} fields detected</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                            ${result.data.detectedDevice || 'Launch Monitor'} ‚Ä¢ ${Math.round(result.data.confidence * 100)}% confidence
                        </div>
                    `;
                    
                    // Show any warnings
                    if (result.data.warnings && result.data.warnings.length > 0) {
                        console.warn('OCR warnings:', result.data.warnings);
                        showToast(`Review extracted values - ${result.data.warnings.length} warning(s)`, 'info');
                    } else {
                        showToast('Data extracted successfully!', 'success');
                    }
                    
                    // Still show manual entry for review/corrections
                    setTimeout(() => {
                        if (clubSide === 'a') showClubAManualEntry();
                        else showClubBManualEntry();
                    }, 1000);
                    
                } else {
                    throw new Error(result.data.error || 'No data extracted');
                }
                
            } catch (error) {
                console.error('OCR extraction failed:', error);
                
                // Show error state with retry option
                captureZone.innerHTML = `
                    <div style="color: var(--red); font-size: 24px;">‚ö†Ô∏è</div>
                    <div style="font-size: 13px;">Could not read image</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Tap to try again or enter manually</div>
                `;
                
                showToast('OCR failed - please enter data manually', 'error');
                
                // Fall back to manual entry
                setTimeout(() => {
                    if (clubSide === 'a') showClubAManualEntry();
                    else showClubBManualEntry();
                }, 1500);
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function populateMetricsFromOCR(metrics, clubSide) {
            const suffix = clubSide === 'a' ? '-a' : '-b';
            const stateKey = clubSide === 'a' ? 'clubAData' : 'clubBData';
            
            // Map OCR field names to form field IDs
            const fieldMap = {
                ballSpeed: 'perf-ball-speed',
                carry: 'perf-carry',
                launch: 'perf-launch',
                launchAngle: 'perf-launch',
                spin: 'perf-spin',
                spinRate: 'perf-spin',
                clubSpeed: 'perf-club-speed',
                totalDistance: 'perf-total',
                attackAngle: 'perf-attack',
                smashFactor: 'perf-smash',
                clubPath: 'perf-path',
                faceAngle: 'perf-face',
                height: 'perf-height'
            };
            
            for (const [ocrKey, formPrefix] of Object.entries(fieldMap)) {
                if (metrics[ocrKey] !== undefined && metrics[ocrKey] !== null) {
                    const field = document.getElementById(formPrefix + suffix);
                    if (field) {
                        field.value = metrics[ocrKey];
                        // Highlight auto-filled fields
                        field.style.borderColor = 'var(--green)';
                        setTimeout(() => {
                            field.style.borderColor = '';
                        }, 3000);
                    }
                    
                    // Also update state for validation
                    perfTestState[stateKey][ocrKey] = metrics[ocrKey];
                }
            }
            
            console.log(`‚úÖ Populated ${Object.keys(metrics).length} fields for Club ${clubSide.toUpperCase()} from OCR`);
            
            // Re-validate to enable Continue button
            validateStep3Data();
        }

        function goToTestStep(step) {
            // Update progress (now 5 steps)
            for (let i = 1; i <= 5; i++) {
                const progressEl = document.getElementById('test-progress-' + i);
                if (progressEl) {
                    progressEl.classList.remove('active', 'complete');
                    if (i < step) {
                        progressEl.classList.add('complete');
                    } else if (i === step) {
                        progressEl.classList.add('active');
                    }
                }
            }
            
            // Show correct step
            document.querySelectorAll('#tab-testing .scenario-step').forEach(s => s.classList.remove('active'));
            document.getElementById('test-step-' + step).classList.add('active');
            
            // Populate Step 3 displays when entering
            if (step === 3) {
                updateStep3Displays();
            }
            
            perfTestState.currentStep = step;
        }
        
        function updateStep3Displays() {
            // Club A (Your Club)
            if (perfTestState.selectedClub) {
                const clubA = perfTestState.selectedClub;
                document.getElementById('step3-your-club').textContent = clubA.clubType || 'Club A';
                document.getElementById('step3-your-specs').textContent = `${clubA.brand || ''} ${clubA.model || ''}`.trim();
            }
            
            // Club B (Test Club)
            if (perfTestState.compareClub) {
                const clubB = perfTestState.compareClub;
                document.getElementById('step3-compare-club').textContent = clubB.name || `${clubB.brand || ''} ${clubB.model || ''}`.trim();
                document.getElementById('step3-compare-specs').textContent = clubB.shaft || 'Stock Shaft';
            }
        }
        
        function updatePerfDataA() {
            perfTestState.clubAData = {
                // Required
                ballSpeed: parseFloat(document.getElementById('perf-ball-speed-a')?.value) || null,
                carry: parseFloat(document.getElementById('perf-carry-a')?.value) || null,
                // Optional - manual entry
                launch: parseFloat(document.getElementById('perf-launch-a')?.value) || null,
                spin: parseFloat(document.getElementById('perf-spin-a')?.value) || null,
                clubSpeed: parseFloat(document.getElementById('perf-club-speed-a')?.value) || null,
                totalDistance: parseFloat(document.getElementById('perf-total-a')?.value) || null,
                attackAngle: parseFloat(document.getElementById('perf-attack-a')?.value) || null,
                smashFactor: parseFloat(document.getElementById('perf-smash-a')?.value) || null,
                clubPath: parseFloat(document.getElementById('perf-path-a')?.value) || null,
                faceAngle: parseFloat(document.getElementById('perf-face-a')?.value) || null,
                height: parseFloat(document.getElementById('perf-height-a')?.value) || null,
                // Future OCR fields (full TrackMan schema)
                launchDirection: null,
                spinAxis: null,
                landingAngle: null,
                curve: null,
                side: null,
                hangTime: null,
                faceToPath: null,
                dynamicLoft: null,
                spinLoft: null,
                lowPoint: null,
                impactLocation: null
            };
            validateStep3Data();
        }
        
        function updatePerfDataB() {
            perfTestState.clubBData = {
                // Required
                ballSpeed: parseFloat(document.getElementById('perf-ball-speed-b')?.value) || null,
                carry: parseFloat(document.getElementById('perf-carry-b')?.value) || null,
                // Optional - manual entry
                launch: parseFloat(document.getElementById('perf-launch-b')?.value) || null,
                spin: parseFloat(document.getElementById('perf-spin-b')?.value) || null,
                clubSpeed: parseFloat(document.getElementById('perf-club-speed-b')?.value) || null,
                totalDistance: parseFloat(document.getElementById('perf-total-b')?.value) || null,
                attackAngle: parseFloat(document.getElementById('perf-attack-b')?.value) || null,
                smashFactor: parseFloat(document.getElementById('perf-smash-b')?.value) || null,
                clubPath: parseFloat(document.getElementById('perf-path-b')?.value) || null,
                faceAngle: parseFloat(document.getElementById('perf-face-b')?.value) || null,
                height: parseFloat(document.getElementById('perf-height-b')?.value) || null,
                // Future OCR fields (full TrackMan schema)
                launchDirection: null,
                spinAxis: null,
                landingAngle: null,
                curve: null,
                side: null,
                hangTime: null,
                faceToPath: null,
                dynamicLoft: null,
                spinLoft: null,
                lowPoint: null,
                impactLocation: null
            };
            validateStep3Data();
        }
        
        function validateStep3Data() {
            // Need at least ball speed and carry for both clubs
            const aValid = perfTestState.clubAData?.ballSpeed && perfTestState.clubAData?.carry;
            const bValid = perfTestState.clubBData?.ballSpeed && perfTestState.clubBData?.carry;
            
            const continueBtn = document.getElementById('data-continue-btn');
            if (continueBtn) {
                continueBtn.disabled = !(aValid && bValid);
                continueBtn.style.opacity = (aValid && bValid) ? '1' : '0.5';
            }
        }

        function toggleManualEntry(btn) {
            const fields = document.getElementById('manual-entry-fields');
            if (fields.style.display === 'none') {
                fields.style.display = 'block';
                btn.innerHTML = '‚ñ≤ Hide manual entry';
            } else {
                fields.style.display = 'none';
                btn.innerHTML = '‚ñº Enter manually instead';
            }
        }

        function cancelPerfTest() {
            resetPerfTest();
            showClientTab('bag');
        }

        function resetPerfTest() {
            perfTestState = {
                currentStep: 1,
                selectedClub: null,
                compareClub: null,
                clubAData: {},
                clubBData: {},
                goals: [],
                isComplete: false,
                photoCount: 0,
                manualEntry: false
            };
            
            // Reset UI
            document.querySelectorAll('#test-step-1 .club-select-item').forEach(item => item.classList.remove('selected'));
            document.querySelectorAll('.goal-chip').forEach(chip => chip.classList.remove('selected'));
            document.getElementById('test-step1-next').disabled = true;
            
            // Reset comparison club form
            const compareBrand = document.getElementById('compare-brand');
            const compareModel = document.getElementById('compare-model');
            if (compareBrand) compareBrand.value = '';
            if (compareModel) {
                compareModel.value = '';
                compareModel.disabled = true;
            }
            const compareShaft = document.getElementById('compare-shaft');
            if (compareShaft) compareShaft.value = 'Stock';
            
            // Reset manual entry fields
            const brandManual = document.getElementById('compare-brand-manual');
            const modelManual = document.getElementById('compare-model-manual');
            const shaftManual = document.getElementById('compare-shaft-manual');
            if (brandManual) brandManual.value = '';
            if (modelManual) modelManual.value = '';
            if (shaftManual) shaftManual.value = '';
            
            const preview = document.getElementById('compare-preview');
            if (preview) preview.style.display = 'none';
            document.getElementById('test-step2-next').disabled = true;
            
            // Reset data entry areas
            document.getElementById('photo-capture-zone-a').style.display = 'block';
            document.getElementById('photo-capture-zone-a').innerHTML = '<div class="photo-capture-icon" style="font-size: 24px;">üì∏</div><div class="photo-capture-text" style="font-size: 13px;">Capture YOUR club\'s data</div>';
            document.getElementById('club-a-data').style.display = 'none';
            document.getElementById('photo-capture-zone-b').style.display = 'block';
            document.getElementById('photo-capture-zone-b').innerHTML = '<div class="photo-capture-icon" style="font-size: 24px;">üì∏</div><div class="photo-capture-text" style="font-size: 13px;">Capture TEST club\'s data</div>';
            document.getElementById('club-b-data').style.display = 'none';
            
            // Reset all data input fields
            const dataFields = [
                'perf-ball-speed-a', 'perf-carry-a', 'perf-launch-a', 'perf-spin-a',
                'perf-club-speed-a', 'perf-total-a', 'perf-attack-a', 'perf-smash-a',
                'perf-path-a', 'perf-face-a', 'perf-height-a',
                'perf-ball-speed-b', 'perf-carry-b', 'perf-launch-b', 'perf-spin-b',
                'perf-club-speed-b', 'perf-total-b', 'perf-attack-b', 'perf-smash-b',
                'perf-path-b', 'perf-face-b', 'perf-height-b'
            ];
            dataFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Reset continue button
            const continueBtn = document.getElementById('data-continue-btn');
            if (continueBtn) {
                continueBtn.disabled = true;
                continueBtn.style.opacity = '0.5';
            }
            
            goToTestStep(1);
        }

        function runPerfTest() {
            // Check credits
            if (creditState.client.tier === 'free') {
                if (creditState.client.freeTrials.performance > 0) {
                    creditState.client.freeTrials.performance--;
                } else {
                    openModal('paywall-modal');
                    return;
                }
            } else if (creditState.client.available < 1) {
                openModal('no-credits-modal');
                return;
            } else {
                // Deduct credit
                creditState.client.used++;
                creditState.client.available--;
                updateCreditsDisplay();
            }
            
            // Populate results from captured data
            populateTestResults();
            
            // Show results (now step 5)
            goToTestStep(5);
            perfTestState.isComplete = true;
        }
        
        function populateTestResults() {
            const dataA = perfTestState.clubAData || {};
            const dataB = perfTestState.clubBData || {};
            const clubA = perfTestState.selectedClub || {};
            const clubB = perfTestState.compareClub || {};
            
            // Update subtitle with club type and date
            const clubType = clubA.clubType || 'Club';
            const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('results-subtitle').textContent = `${clubType} Test ‚Ä¢ ${today}`;
            
            // Update comparison header club names
            const clubAName = [clubA.brand, clubA.model].filter(Boolean).join(' ') || 'Your Club';
            const clubBName = clubB.name || [clubB.brand, clubB.model].filter(Boolean).join(' ') || 'Test Club';
            const headerClubA = document.getElementById('header-club-a-name');
            const headerClubB = document.getElementById('header-club-b-name');
            if (headerClubA) headerClubA.textContent = clubAName;
            if (headerClubB) headerClubB.textContent = clubBName;
            
            // Calculate winner based on carry distance (primary metric)
            const carryDiff = (dataB.carry || 0) - (dataA.carry || 0);
            const bWins = carryDiff > 0;
            
            // Update winner display
            const winnerSummary = document.getElementById('winner-summary');
            const winnerIcon = document.getElementById('winner-icon');
            const winnerTitle = document.getElementById('winner-title');
            const winnerSubtitle = document.getElementById('winner-subtitle');
            
            if (Math.abs(carryDiff) < 2) {
                // Tie
                winnerSummary.style.background = 'var(--bg-card)';
                winnerSummary.style.border = '1px solid var(--border-light)';
                winnerIcon.textContent = 'ü§ù';
                winnerTitle.textContent = 'Too Close to Call';
                winnerTitle.style.color = 'var(--text-muted)';
                winnerSubtitle.textContent = 'Both clubs perform similarly';
            } else if (bWins) {
                winnerSummary.style.background = 'var(--green-dim)';
                winnerSummary.style.border = '1px solid var(--green)';
                winnerIcon.textContent = 'üèÜ';
                winnerTitle.textContent = 'Test Club (B) Wins!';
                winnerTitle.style.color = 'var(--green)';
                winnerSubtitle.textContent = `${clubB.name || 'Test Club'} outperforms your current ${clubType.toLowerCase()}`;
            } else {
                winnerSummary.style.background = 'var(--cyan-dim)';
                winnerSummary.style.border = '1px solid var(--cyan)';
                winnerIcon.textContent = '‚úì';
                winnerTitle.textContent = 'Your Club (A) Wins!';
                winnerTitle.style.color = 'var(--cyan)';
                winnerSubtitle.textContent = `Keep your current ${clubA.brand || ''} ${clubA.model || ''}`.trim();
            }
            
            // Populate comparison rows
            populateMetricRow('ballSpeed', dataA.ballSpeed, dataB.ballSpeed, 'mph', true); // higher is better
            populateMetricRow('carry', dataA.carry, dataB.carry, 'yds', true);
            populateMetricRow('launch', dataA.launch, dataB.launch, '¬∞', true);
            
            // For spin: lower is better for woods/hybrids (distance), higher for wedges (control)
            const category = (clubA.category || '').toLowerCase();
            const isDistanceClub = category === 'woods' || category === 'hybrids' || category === 'driver';
            populateMetricRow('spin', dataA.spin, dataB.spin, 'rpm', !isDistanceClub);
            
            populateMetricRow('clubSpeed', dataA.clubSpeed, dataB.clubSpeed, 'mph', true);
            populateMetricRow('total', dataA.totalDistance, dataB.totalDistance, 'yds', true);
            populateMetricRow('smash', dataA.smashFactor, dataB.smashFactor, '', true);
            populateMetricRow('attack', dataA.attackAngle, dataB.attackAngle, '¬∞', null); // context dependent
            populateMetricRow('path', dataA.clubPath, dataB.clubPath, '¬∞', null); // closer to 0 is neutral
            populateMetricRow('face', dataA.faceAngle, dataB.faceAngle, '¬∞', null); // closer to 0 is neutral
            populateMetricRow('height', dataA.height, dataB.height, 'ft', null); // context dependent
            
            // Calculate net gains
            const netCarry = (dataB.carry || 0) - (dataA.carry || 0);
            const netBallSpeed = (dataB.ballSpeed || 0) - (dataA.ballSpeed || 0);
            const netSpin = (dataB.spin || 0) - (dataA.spin || 0);
            
            // Update net gains section
            const netGainsSection = document.getElementById('net-gains-section');
            const netGainsLabel = document.getElementById('net-gains-label');
            
            if (bWins) {
                netGainsSection.style.background = 'var(--green-dim)';
                netGainsLabel.style.color = 'var(--green)';
                netGainsLabel.textContent = 'Net Gains with Test Club (B)';
            } else {
                netGainsSection.style.background = 'var(--cyan-dim)';
                netGainsLabel.style.color = 'var(--cyan)';
                netGainsLabel.textContent = 'Your Club (A) Advantage';
            }
            
            const winnerColor = bWins ? 'var(--green)' : 'var(--cyan)';
            
            document.getElementById('net-carry').textContent = formatNetGain(bWins ? netCarry : -netCarry);
            document.getElementById('net-carry').style.color = winnerColor;
            
            document.getElementById('net-ballspeed').textContent = formatNetGain(bWins ? netBallSpeed : -netBallSpeed);
            document.getElementById('net-ballspeed').style.color = winnerColor;
            
            // Hide spin if not provided
            if (dataA.spin && dataB.spin) {
                document.getElementById('net-spin-container').style.display = 'block';
                document.getElementById('net-spin').textContent = formatNetGain(bWins ? netSpin : -netSpin);
                document.getElementById('net-spin').style.color = winnerColor;
            } else {
                document.getElementById('net-spin-container').style.display = 'none';
            }
            
            // Generate AI analysis
            generateAIAnalysis(dataA, dataB, clubA, clubB, bWins);
        }
        
        function populateMetricRow(metric, valueA, valueB, unit, higherIsBetter) {
            const row = document.getElementById('row-' + metric);
            const cellA = document.getElementById('result-' + metric + '-a');
            const cellB = document.getElementById('result-' + metric + '-b');
            
            if (!row || !cellA || !cellB) return;
            
            // Show row only if both values exist
            if (valueA && valueB) {
                row.style.display = 'flex';
                
                const diff = valueB - valueA;
                const bIsBetter = higherIsBetter === null ? false : (higherIsBetter ? diff > 0 : diff < 0);
                const aIsBetter = higherIsBetter === null ? false : (higherIsBetter ? diff < 0 : diff > 0);
                
                // Format values
                const decimals = (metric === 'smash') ? 2 : (metric === 'launch' || metric === 'attack') ? 1 : 0;
                cellA.textContent = valueA.toFixed(decimals) + (unit ? ' ' + unit : '');
                cellB.textContent = valueB.toFixed(decimals) + (unit ? ' ' + unit : '');
                
                // Add arrow and color for winner
                if (Math.abs(diff) > 0.1) {
                    if (bIsBetter) {
                        cellB.style.color = 'var(--green)';
                        cellB.textContent += diff > 0 ? ' ‚Üë' : ' ‚Üì';
                        cellA.style.color = '';
                    } else if (aIsBetter) {
                        cellA.style.color = 'var(--cyan)';
                        cellA.textContent += diff < 0 ? ' ‚Üë' : ' ‚Üì';
                        cellB.style.color = '';
                    } else {
                        cellA.style.color = '';
                        cellB.style.color = '';
                    }
                }
            } else {
                row.style.display = 'none';
            }
        }
        
        function formatNetGain(value) {
            if (value === 0) return '0';
            const rounded = Math.round(value);
            return rounded > 0 ? '+' + rounded : rounded.toString();
        }
        
        async function generateAIAnalysis(dataA, dataB, clubA, clubB, bWins) {
            const analysisEl = document.getElementById('ai-analysis-text');
            
            // Show loading state
            analysisEl.innerHTML = '<span style="color: var(--text-muted);">ü§ñ Generating personalized AI analysis...</span>';
            
            const clubAName = `${clubA.brand || ''} ${clubA.model || ''}`.trim() || 'Your Club';
            const clubBName = clubB.name || `${clubB.brand || ''} ${clubB.model || ''}`.trim() || 'Test Club';
            const clubType = clubA.clubType || 'club';
            
            try {
                // Use AIRecommendations service (profile-aware)
                if (typeof AIRecommendations !== 'undefined' && window.currentClient?.id) {
                    const result = await AIRecommendations.analyzeTest(
                        window.currentClient.id,
                        {
                            name: clubAName,
                            brand: clubA.brand,
                            model: clubA.model,
                            clubType: clubA.clubType,
                            category: clubA.category,
                            metrics: dataA
                        },
                        {
                            name: clubBName,
                            brand: clubB.brand,
                            model: clubB.model,
                            shaft: clubB.shaft,
                            metrics: dataB
                        },
                        perfTestState.goals || []
                    );
                    
                    if (result?.recommendation) {
                        analysisEl.textContent = result.recommendation;
                        console.log('‚úÖ AI analysis generated via AIRecommendations service');
                        return;
                    }
                }
                
                // If AIRecommendations not available, throw to trigger fallback
                throw new Error('AIRecommendations service not available');
                
            } catch (error) {
                console.warn('AI API failed, using local fallback:', error);
                // Fallback to local generation
                generateLocalAnalysis(dataA, dataB, clubA, clubB, bWins, analysisEl);
            }
        }
        
        // Fallback local analysis (no API)
        function generateLocalAnalysis(dataA, dataB, clubA, clubB, bWins, analysisEl) {
            const clubAName = `${clubA.brand || ''} ${clubA.model || ''}`.trim() || 'Your Club';
            const clubBName = clubB.name || 'Test Club';
            const clubType = clubA.clubType || 'club';
            
            const carryDiff = Math.round((dataB.carry || 0) - (dataA.carry || 0));
            const ballSpeedDiff = Math.round((dataB.ballSpeed || 0) - (dataA.ballSpeed || 0));
            
            let analysis = '';
            
            if (Math.abs(carryDiff) < 2) {
                analysis = `The ${clubBName} and your ${clubAName} perform nearly identically in this test. `;
                analysis += `With only ${Math.abs(carryDiff)} yard${Math.abs(carryDiff) !== 1 ? 's' : ''} difference in carry, the choice comes down to feel and confidence. `;
                analysis += `Consider testing both clubs in different conditions before making a decision.`;
            } else if (bWins) {
                analysis = `The ${clubBName} shows improvement over your current ${clubAName}. `;
                analysis += `You're gaining ${carryDiff} yards of carry`;
                if (ballSpeedDiff > 0) {
                    analysis += ` with ${ballSpeedDiff} mph more ball speed`;
                }
                analysis += `. `;
                
                if (dataA.spin && dataB.spin) {
                    const spinDiff = Math.round(dataB.spin - dataA.spin);
                    if (spinDiff < -200) {
                        analysis += `The lower spin rate (${Math.abs(spinDiff)} rpm less) is helping maximize distance. `;
                    } else if (spinDiff > 200) {
                        analysis += `Note: spin is higher (+${spinDiff} rpm), which may affect performance in windy conditions. `;
                    }
                }
                
                analysis += `This is a strong candidate to replace your current ${clubType.toLowerCase()}.`;
            } else {
                analysis = `Your ${clubAName} outperforms the ${clubBName} in this test. `;
                analysis += `You're seeing ${Math.abs(carryDiff)} more yards of carry with your current club`;
                if (ballSpeedDiff < 0) {
                    analysis += ` and ${Math.abs(ballSpeedDiff)} mph better ball speed`;
                }
                analysis += `. `;
                analysis += `Keep your current ${clubType.toLowerCase()} - it's well matched to your swing.`;
            }
            
            analysisEl.textContent = analysis;
        }

        // Saved Tests Data
        const savedTestsData = {
            1: {
                name: 'Driver Comparison',
                yourClub: 'TaylorMade Stealth 2',
                testClub: 'TaylorMade Qi10',
                winner: 'test', // 'yours' or 'test'
                metrics: {
                    ballSpeedA: '167 mph', ballSpeedB: '170 mph',
                    launchA: '11.2¬∞', launchB: '12.8¬∞',
                    spinA: '2650 rpm', spinB: '2350 rpm',
                    carryA: '275 yds', carryB: '285 yds',
                    totalA: '295 yds', totalB: '308 yds'
                },
                netGains: { carry: '+10', ballSpeed: '+3', spin: '-300' },
                aiAnalysis: 'The TaylorMade Qi10 shows a significant improvement over your current Stealth 2. The higher launch angle (12.8¬∞ vs 11.2¬∞) combined with lower spin (2350 vs 2650 rpm) creates a more optimal ball flight for maximum distance. You\'re gaining 10 yards of carry and 13 yards total. This is a strong candidate to replace your current driver.',
                date: 'Dec 27'
            },
            2: {
                name: '3-Wood Comparison',
                yourClub: 'TaylorMade Stealth 2',
                testClub: 'Callaway Paradym',
                winner: 'yours',
                metrics: {
                    ballSpeedA: '158 mph', ballSpeedB: '156 mph',
                    launchA: '13.5¬∞', launchB: '14.2¬∞',
                    spinA: '3200 rpm', spinB: '3400 rpm',
                    carryA: '242 yds', carryB: '240 yds',
                    totalA: '258 yds', totalB: '254 yds'
                },
                netGains: { carry: '+2', ballSpeed: '+2', spin: '-200' },
                aiAnalysis: 'Your current TaylorMade Stealth 2 3-Wood outperforms the Callaway Paradym in this test. You\'re seeing 2 yards more carry with better ball speed. The lower spin on your current club is helping maintain distance. Keep your current 3-Wood - it\'s well matched to your swing.',
                date: 'Dec 20'
            }
        };

        let savedTestsCount = 2;

        // Open Save Test Modal
        function saveTest() {
            // Validate we have test data
            if (!perfTestState.isComplete) {
                showToast('No test results to save', 'error');
                return;
            }
            
            // Build descriptive test name
            const clubType = perfTestState.selectedClub?.clubType || 'Club';
            const myClubName = [perfTestState.selectedClub?.brand, perfTestState.selectedClub?.model].filter(Boolean).join(' ') || 'My Club';
            const testClubName = perfTestState.compareClub?.name || 
                [perfTestState.compareClub?.brand, perfTestState.compareClub?.model].filter(Boolean).join(' ') || 'Test Club';
            
            const defaultName = `${clubType} - ${myClubName} vs ${testClubName}`;
            
            // Populate modal
            document.getElementById('save-test-name').value = defaultName;
            document.getElementById('save-modal-club-a').textContent = myClubName;
            document.getElementById('save-modal-club-b').textContent = testClubName;
            
            // Show modal
            document.getElementById('save-test-modal').style.display = 'flex';
            document.getElementById('save-test-name').focus();
            document.getElementById('save-test-name').select();
        }
        
        function closeSaveTestModal() {
            document.getElementById('save-test-modal').style.display = 'none';
        }
        
        async function confirmSaveTest() {
            const testName = document.getElementById('save-test-name').value.trim();
            if (!testName) {
                showToast('Please enter a test name', 'error');
                return;
            }
            
            // Close modal immediately
            closeSaveTestModal();
            
            // Show loading
            showToast('Saving test...', 'info');
            
            try {
                // Get current user/client ID
                const userId = window.currentClient?.id;
                if (!userId) {
                    throw new Error('No client selected');
                }
                
                // Calculate winner
                const carryDiff = (perfTestState.clubBData?.carry || 0) - (perfTestState.clubAData?.carry || 0);
                let winner = 'tie';
                if (carryDiff > 2) winner = 'b';
                else if (carryDiff < -2) winner = 'a';
                
                // Build test document
                const testData = {
                    name: testName,
                    created_at: firebase.firestore.FieldValue.serverTimestamp(),
                    
                    // Club A (user's club from bag)
                    club_a: {
                        id: perfTestState.selectedClub?.id || null,
                        clubType: perfTestState.selectedClub?.clubType || null,
                        brand: perfTestState.selectedClub?.brand || null,
                        model: perfTestState.selectedClub?.model || null,
                        category: perfTestState.selectedClub?.category || null
                    },
                    
                    // Club B (comparison/test club)
                    club_b: {
                        name: perfTestState.compareClub?.name || null,
                        brand: perfTestState.compareClub?.brand || null,
                        model: perfTestState.compareClub?.model || null,
                        shaft: perfTestState.compareClub?.shaft || null,
                        source: perfTestState.compareClub?.source || 'database'
                    },
                    
                    // Performance data - Club A
                    club_a_data: {
                        ballSpeed: perfTestState.clubAData?.ballSpeed || null,
                        carry: perfTestState.clubAData?.carry || null,
                        launch: perfTestState.clubAData?.launch || null,
                        spin: perfTestState.clubAData?.spin || null,
                        clubSpeed: perfTestState.clubAData?.clubSpeed || null,
                        totalDistance: perfTestState.clubAData?.totalDistance || null,
                        attackAngle: perfTestState.clubAData?.attackAngle || null,
                        smashFactor: perfTestState.clubAData?.smashFactor || null,
                        clubPath: perfTestState.clubAData?.clubPath || null,
                        faceAngle: perfTestState.clubAData?.faceAngle || null,
                        height: perfTestState.clubAData?.height || null
                    },
                    
                    // Performance data - Club B
                    club_b_data: {
                        ballSpeed: perfTestState.clubBData?.ballSpeed || null,
                        carry: perfTestState.clubBData?.carry || null,
                        launch: perfTestState.clubBData?.launch || null,
                        spin: perfTestState.clubBData?.spin || null,
                        clubSpeed: perfTestState.clubBData?.clubSpeed || null,
                        totalDistance: perfTestState.clubBData?.totalDistance || null,
                        attackAngle: perfTestState.clubBData?.attackAngle || null,
                        smashFactor: perfTestState.clubBData?.smashFactor || null,
                        clubPath: perfTestState.clubBData?.clubPath || null,
                        faceAngle: perfTestState.clubBData?.faceAngle || null,
                        height: perfTestState.clubBData?.height || null
                    },
                    
                    // Results
                    winner: winner,
                    goals: perfTestState.goals || [],
                    
                    // Net gains
                    net_gains: {
                        carry: carryDiff,
                        ballSpeed: (perfTestState.clubBData?.ballSpeed || 0) - (perfTestState.clubAData?.ballSpeed || 0),
                        spin: (perfTestState.clubBData?.spin || 0) - (perfTestState.clubAData?.spin || 0)
                    },
                    
                    // AI Analysis text
                    ai_summary: document.getElementById('ai-analysis-text')?.textContent || null,
                    
                    // Metadata
                    applied_to_scenario: false,
                    applied_to_bag: false
                };
                
                // Save to Firestore
                const db = firebase.firestore();
                const testsRef = db.collection('users').doc(userId).collection('tests');
                
                // Check current count - enforce 30 max
                const existingTests = await testsRef.orderBy('created_at', 'desc').get();
                
                if (existingTests.size >= 30) {
                    // Delete oldest test to make room
                    const oldestTest = existingTests.docs[existingTests.docs.length - 1];
                    await oldestTest.ref.delete();
                    console.log('Deleted oldest test to make room:', oldestTest.id);
                }
                
                // Add new test
                const docRef = await testsRef.add(testData);
                console.log('‚úÖ Test saved with ID:', docRef.id);
                
                // Update UI
                showToast('‚úÖ Test saved!', 'success');
                
                // Refresh banner cards if TestingTab module is available
                if (typeof TestingTab !== 'undefined' && TestingTab.refreshTests) {
                    await TestingTab.refreshTests();
                }
                
                // Update saved tests count in UI
                const countEl = document.getElementById('saved-tests-count');
                if (countEl) {
                    const newCount = Math.min(existingTests.size + 1, 10);
                    countEl.textContent = newCount;
                }
                
            } catch (error) {
                console.error('Error saving test:', error);
                showToast('Failed to save test: ' + error.message, 'error');
            }
        }

        function loadTest(id) {
            const test = savedTestsData[id];
            if (!test) return;
            
            closeModal('saved-tests-modal');
            showClientTab('testing');
            
            // Update results page with saved test data
            goToTestStep(5);
            
            // Update winner summary based on who won
            const summaryEl = document.querySelector('#test-step-5 .test-result-summary');
            if (test.winner === 'test') {
                summaryEl.style.background = 'var(--green-dim)';
                summaryEl.style.border = '1px solid var(--green)';
                summaryEl.querySelector('.test-result-icon').textContent = 'üèÜ';
                summaryEl.querySelector('.test-result-title').textContent = 'Test Club (B) Wins!';
                summaryEl.querySelector('.test-result-title').style.color = 'var(--green)';
                summaryEl.querySelector('.test-result-subtitle').textContent = test.testClub + ' outperforms your current ' + test.yourClub.split(' ').pop();
            } else {
                summaryEl.style.background = 'var(--cyan-dim)';
                summaryEl.style.border = '1px solid var(--cyan)';
                summaryEl.querySelector('.test-result-icon').textContent = '‚úì';
                summaryEl.querySelector('.test-result-title').textContent = 'Your Club (A) Wins!';
                summaryEl.querySelector('.test-result-title').style.color = 'var(--cyan)';
                summaryEl.querySelector('.test-result-subtitle').textContent = 'Your ' + test.yourClub + ' outperforms the ' + test.testClub;
            }
            
            // Update AI analysis
            document.querySelector('#test-step-5 .test-ai-text').textContent = test.aiAnalysis;
        }

        function applyTestFromSaved(id) {
            const test = savedTestsData[id];
            if (!test) return;
            
            const winner = test.winner === 'test' ? test.testClub : test.yourClub;
            alert('‚úÖ Applied ' + winner + ' to your bag!');
            closeModal('saved-tests-modal');
            showClientTab('bag');
        }

        function deleteTest(id) {
            if (!confirm('Delete this saved test?')) return;
            
            const card = document.getElementById('saved-test-' + id);
            if (card) card.remove();
            
            savedTestsCount--;
            document.getElementById('saved-tests-count').textContent = savedTestsCount;
            
            if (savedTestsCount <= 0) {
                document.getElementById('saved-tests-list').style.display = 'none';
                document.getElementById('no-saved-tests').style.display = 'block';
            }
        }

        function savePerfTest() {
            alert('‚úÖ Comparison saved! Your test data has been added to your history.');
            resetPerfTest();
            showClientTab('bag');
        }

        function applyTestClubToBag() {
            const compareName = perfTestState.compareClub?.name || 'Test Club';
            alert('‚úÖ Bag Updated!\n\nYour driver has been replaced with ' + compareName + '.\n\nYour bag grade will be recalculated.');
            resetPerfTest();
            showClientTab('bag');
        }

        function shopForTestClub() {
            const compareName = perfTestState.compareClub?.name || 'Test Club';
            alert('üõí Shop modal would open with affiliate links for:\n\n‚Ä¢ ' + compareName + '\n\nComing soon!');
        }

        // ============================================
        // SCENARIO TEASER (Add to Scenario from Test)
        // ============================================
        
        let pendingScenarioSwap = null; // Holds the swap to pre-populate
        
        function showScenarioTeaser() {
            // Validate we have test data
            if (!perfTestState.isComplete || !perfTestState.selectedClub || !perfTestState.compareClub) {
                showToast('No test data available', 'error');
                return;
            }
            
            // Show modal with loading state
            document.getElementById('scenario-teaser-modal').style.display = 'flex';
            document.getElementById('teaser-loading').style.display = 'block';
            document.getElementById('teaser-results').style.display = 'none';
            document.getElementById('proceed-scenario-btn').disabled = true;
            
            // Build swap data
            const winnerIsB = perfTestState.winner === 'b' || 
                ((perfTestState.clubBData?.carry || 0) - (perfTestState.clubAData?.carry || 0)) > 2;
            
            pendingScenarioSwap = {
                clubOut: {
                    id: perfTestState.selectedClub.id,
                    clubType: perfTestState.selectedClub.clubType,
                    brand: perfTestState.selectedClub.brand,
                    model: perfTestState.selectedClub.model,
                    name: [perfTestState.selectedClub.brand, perfTestState.selectedClub.model].filter(Boolean).join(' ')
                },
                clubIn: {
                    name: perfTestState.compareClub.name || [perfTestState.compareClub.brand, perfTestState.compareClub.model].filter(Boolean).join(' '),
                    brand: perfTestState.compareClub.brand,
                    model: perfTestState.compareClub.model,
                    shaft: perfTestState.compareClub.shaft
                },
                testData: {
                    carry: perfTestState.clubBData?.carry,
                    ballSpeed: perfTestState.clubBData?.ballSpeed,
                    netGain: (perfTestState.clubBData?.carry || 0) - (perfTestState.clubAData?.carry || 0)
                }
            };
            
            // Simulate teaser calculation (in real impl, would call gradeUserBag with preview flag)
            calculateTeaserGrade();
        }
        
        async function calculateTeaserGrade() {
            try {
                // Get current bag grade from UI or client data
                const currentGrade = window.currentClient?.bag_grade || 
                    document.getElementById('client-bag-grade')?.textContent || 'B';
                
                // Simulate projected grade based on test results
                // In real implementation, call gradeUserBag Cloud Function with scenario preview mode
                const gradeOrder = ['F', 'D-', 'D', 'D+', 'C-', 'C', 'C+', 'B-', 'B', 'B+', 'A-', 'A', 'A+'];
                const currentIndex = gradeOrder.indexOf(currentGrade);
                
                // If test club won by significant margin, project improvement
                const netGain = pendingScenarioSwap?.testData?.netGain || 0;
                let projectedIndex = currentIndex;
                
                if (netGain >= 10) {
                    projectedIndex = Math.min(currentIndex + 2, gradeOrder.length - 1);
                } else if (netGain >= 5) {
                    projectedIndex = Math.min(currentIndex + 1, gradeOrder.length - 1);
                } else if (netGain <= -5) {
                    projectedIndex = Math.max(currentIndex - 1, 0);
                }
                
                const projectedGrade = gradeOrder[projectedIndex];
                const improved = projectedIndex > currentIndex;
                
                // Update UI
                document.getElementById('teaser-current-grade').textContent = currentGrade;
                document.getElementById('teaser-projected-grade').textContent = projectedGrade;
                document.getElementById('teaser-projected-grade').style.color = 
                    improved ? 'var(--green)' : (projectedIndex < currentIndex ? 'var(--red)' : 'var(--text-primary)');
                
                document.getElementById('teaser-out-club').textContent = pendingScenarioSwap.clubOut.name;
                document.getElementById('teaser-in-club').textContent = pendingScenarioSwap.clubIn.name;
                
                // Show results, hide loading
                setTimeout(() => {
                    document.getElementById('teaser-loading').style.display = 'none';
                    document.getElementById('teaser-results').style.display = 'block';
                    document.getElementById('proceed-scenario-btn').disabled = false;
                }, 800); // Brief delay for effect
                
            } catch (error) {
                console.error('Teaser calculation error:', error);
                showToast('Could not calculate preview', 'error');
                closeScenarioTeaser();
            }
        }
        
        function closeScenarioTeaser() {
            document.getElementById('scenario-teaser-modal').style.display = 'none';
            pendingScenarioSwap = null;
        }
        
        function proceedToScenario() {
            if (!pendingScenarioSwap) {
                showToast('No swap data available', 'error');
                return;
            }
            
            // Store the pending swap for scenarios tab to pick up
            window.pendingTestSwap = pendingScenarioSwap;
            
            // Close modal
            closeScenarioTeaser();
            
            // Navigate to Scenarios tab
            showClientTab('scenarios');
            
            // Show toast with instructions
            showToast('Swap added! Click "Run Scenario" to analyze (1 credit)', 'info');
            
            // Pre-populate the scenario (slight delay for tab switch)
            setTimeout(() => {
                prePopulateScenarioFromTest();
            }, 300);
        }
        
        function prePopulateScenarioFromTest() {
            const swap = window.pendingTestSwap;
            if (!swap) return;
            
            // Show the swap summary area
            const swapSummary = document.getElementById('scenario-swap-summary');
            if (swapSummary) {
                swapSummary.style.display = 'block';
                document.getElementById('swap-count').textContent = '1';
            }
            
            // Add the swap to the club list area
            const clubList = document.getElementById('scenario-club-list');
            if (clubList) {
                // Clear any existing test swaps first
                const existingTestSwaps = clubList.querySelectorAll('[data-from-test="true"]');
                existingTestSwaps.forEach(el => el.remove());
                
                // Add the swap card
                const swapHtml = `
                    <div class="pending-swap-item" data-from-test="true" data-club-out-id="${swap.clubOut.id}" 
                         style="background: var(--green-dim); border: 1px solid var(--green); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 11px; padding: 2px 8px; background: var(--green); color: #000; border-radius: 4px; font-weight: 600;">FROM TEST</span>
                                    <span style="font-size: 13px; color: var(--text-muted);">${swap.clubOut.clubType}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <div style="text-decoration: line-through; color: var(--red);">${swap.clubOut.name}</div>
                                    <div style="color: var(--text-muted);">‚Üí</div>
                                    <div style="color: var(--green); font-weight: 600;">${swap.clubIn.name}</div>
                                </div>
                                ${swap.testData.netGain > 0 ? `
                                    <div style="font-size: 12px; color: var(--green); margin-top: 8px;">
                                        üìä +${swap.testData.netGain} yds carry in performance test
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="removeTestSwap(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">‚úï</button>
                        </div>
                    </div>
                `;
                clubList.insertAdjacentHTML('afterbegin', swapHtml);
            }
            
            // Store in scenario state for the runScenarioAnalysis function
            scenarioState.pendingSwaps = scenarioState.pendingSwaps || [];
            scenarioState.pendingSwaps.push({
                type: 'swap',
                fromTest: true,
                clubOutId: swap.clubOut.id,
                clubOut: swap.clubOut,
                clubIn: swap.clubIn,
                testData: swap.testData
            });
            
            // Enable the Run button
            const runBtn = document.getElementById('run-scenario-btn');
            if (runBtn) {
                runBtn.disabled = false;
            }
            
            // Clear pending
            window.pendingTestSwap = null;
            
            console.log('‚úÖ Pre-populated scenario with test swap:', swap);
        }
        
        function removeTestSwap(btn) {
            const swapEl = btn.closest('.pending-swap-item');
            const clubOutId = swapEl?.dataset?.clubOutId;
            
            if (swapEl) swapEl.remove();
            
            // Remove from scenarioState
            if (scenarioState.pendingSwaps) {
                scenarioState.pendingSwaps = scenarioState.pendingSwaps.filter(s => s.clubOutId !== clubOutId);
            }
            
            // Update swap count
            const remainingSwaps = document.querySelectorAll('.pending-swap-item').length;
            document.getElementById('swap-count').textContent = remainingSwaps;
            
            if (remainingSwaps === 0) {
                document.getElementById('scenario-swap-summary').style.display = 'none';
                document.getElementById('run-scenario-btn').disabled = true;
            }
        }

        function startScenarioFromTest() {
            resetPerfTest();
            showClientTab('scenarios');
        }

        function runAnotherTest() {
            // Check credits first
            if (creditState.client.tier === 'free') {
                openModal('paywall-modal');
                return;
            }
            
            if (creditState.client.available < 1) {
                openModal('no-credits-modal');
                return;
            }
            
            resetPerfTest();
        }

        function startTestForClub(clubId) {
            // Navigate to testing tab
            showClientTab('testing');
            
            // Pre-select the club in step 1
            resetPerfTest();
            
            const clubItems = document.querySelectorAll('#test-step-1 .club-select-item');
            const clubMap = {
                'driver': 0,
                '3wood': 1,
                '7iron': 2,
                'pw': 3
            };
            
            if (clubMap[clubId] !== undefined && clubItems[clubMap[clubId]]) {
                clubItems[clubMap[clubId]].classList.add('selected');
                perfTestState.selectedClub = clubId;
                document.getElementById('test-step1-next').disabled = false;
                
                if (testClubData[clubId]) {
                    document.getElementById('test-selected-club').textContent = testClubData[clubId].name;
                }
            }
        }
    </script>
    
    <!-- User Profile Modal -->
    <div id="profile-modal" class="modal-overlay">
        <div class="modal profile-modal">
            <div class="modal-header">
                <h3 class="modal-title">üë§ Golfer Profile</h3>
                <button class="modal-close" onclick="closeModal('profile-modal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Profile Header with Picture -->
                <div class="profile-header">
                    <div class="profile-picture-container" id="profile-picture-container">
                        <div class="profile-picture-initials" id="profile-initials">MJ</div>
                        <img id="profile-picture-img" src="" alt="" style="display: none;">
                        <div class="profile-picture-upload" onclick="document.getElementById('profile-picture-input').click()">
                            üì∑ Change
                        </div>
                        <input type="file" id="profile-picture-input" accept="image/*" style="display: none;" onchange="handleProfilePictureUpload(event)">
                    </div>
                    <div class="profile-name-section">
                        <h3 id="profile-display-name">Client Name</h3>
                        <div class="email" id="profile-email-display"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dabfb7bbb3b69abfa2bbb7aab6bff4b9b5b7">[email&#160;protected]</a></div>
                    </div>
                </div>
                
                <!-- Profile Tabs -->
                <div class="profile-tabs">
                    <button class="profile-tab active" onclick="switchProfileTab('basic')">Basic</button>
                    <button class="profile-tab" onclick="switchProfileTab('swing')">Swing</button>
                    <button class="profile-tab" onclick="switchProfileTab('preferences')">Preferences</button>
                    <button class="profile-tab" onclick="switchProfileTab('notes')" id="pro-notes-tab">Pro Notes</button>
                </div>
                
                <!-- Tab 1: Basic Info -->
                <div id="profile-tab-basic" class="profile-tab-content active">
                    <div class="profile-form-row">
                        <div class="profile-form-group">
                            <label class="profile-form-label">First Name</label>
                            <input type="text" class="profile-form-input" id="profile-first-name" placeholder="First name">
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Last Name</label>
                            <input type="text" class="profile-form-input" id="profile-last-name" placeholder="Last name">
                        </div>
                    </div>
                    
                    <div class="profile-form-row">
                        <div class="profile-form-group full-width">
                            <label class="profile-form-label">Email</label>
                            <input type="email" class="profile-form-input" id="profile-email" placeholder="email@example.com">
                        </div>
                    </div>
                    
                    <div class="profile-form-row">
                        <div class="profile-form-group">
                            <label class="profile-form-label">GHIN Number</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" class="profile-form-input" id="profile-ghin" placeholder="e.g. 1234567" style="flex: 1;">
                                <button class="btn btn-secondary" onclick="lookupProfileGHIN()" style="white-space: nowrap; padding: 8px 12px;">üîç Look Up</button>
                            </div>
                            <div id="profile-ghin-result" style="display: none; margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 12px;"></div>
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Handicap</label>
                            <input type="number" class="profile-form-input" id="profile-handicap" min="-5" max="54" step="0.1" placeholder="e.g. 10.4">
                        </div>
                    </div>
                    
                    <div class="profile-form-row">
                        <div class="profile-form-group">
                            <label class="profile-form-label">Age</label>
                            <input type="number" class="profile-form-input" id="profile-age" min="10" max="100" placeholder="Age">
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Gender</label>
                            <select class="profile-form-select" id="profile-gender">
                                <option value="">Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Prefer not to say</option>
                            </select>
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Handedness</label>
                            <select class="profile-form-select" id="profile-handedness">
                                <option value="right">Right</option>
                                <option value="left">Left</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 2: Swing Profile -->
                <div id="profile-tab-swing" class="profile-tab-content">
                    <div class="profile-form-row">
                        <div class="profile-form-group">
                            <label class="profile-form-label">Driver Swing Speed</label>
                            <div class="profile-form-input-with-unit">
                                <input type="number" class="profile-form-input" id="profile-swing-speed" min="40" max="140" placeholder="--">
                                <span class="profile-form-unit">mph</span>
                            </div>
                            <div class="profile-form-helper">Syncs with Weight & Flex factor cards</div>
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Tempo</label>
                            <select class="profile-form-select" id="profile-tempo">
                                <option value="">Select...</option>
                                <option value="fast">Fast / Aggressive</option>
                                <option value="moderate">Moderate</option>
                                <option value="smooth">Smooth / Slow</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="profile-form-row">
                        <div class="profile-form-group full-width">
                            <label class="profile-form-label">Typical Miss</label>
                            <select class="profile-form-select" id="profile-typical-miss">
                                <option value="">Select...</option>
                                <option value="slice">Slice / Fade</option>
                                <option value="straight">Straight</option>
                                <option value="hook">Hook / Draw</option>
                                <option value="varies">Varies / Inconsistent</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Favorite Club Baseline Section -->
                    <div style="margin-top: 20px; padding: 16px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 16px; color: #ffd700;">‚òÖ</span>
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Favorite Club Baseline</span>
                            <span style="background: #ffd700; color: #1a1a2e; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600;">PATENT PENDING</span>
                        </div>
                        
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 14px; line-height: 1.4;">
                            Your favorite club's shaft matches your tempo. Grade weight progression against it instead of generic standards.
                        </p>
                        
                        <div class="profile-form-row" style="margin-bottom: 10px;">
                            <div class="profile-form-group full-width">
                                <label class="profile-form-label" style="font-size: 12px;">Favorite Club</label>
                                <select class="profile-form-select" id="profile-favorite-club">
                                    <option value="">Select your favorite club...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="profile-use-favorite-baseline" style="width: 16px; height: 16px; cursor: pointer;">
                            <label for="profile-use-favorite-baseline" style="cursor: pointer; flex: 1;">
                                <span style="font-size: 13px; color: var(--text-primary);">Enable Favorite Club Grading</span>
                                <div style="font-size: 11px; color: var(--text-secondary);">‚ÑπÔ∏è Future gradings will use this setting</div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Body Fit Baseline Section -->
                    <div style="margin-top: 12px; padding: 16px; background: rgba(0,206,209,0.08); border: 1px solid rgba(0,206,209,0.3); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 16px; color: #00CED1;">üìè</span>
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Body Fit Baseline</span>
                            <span style="background: #00CED1; color: #1a1a2e; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600;">PATENT PENDING</span>
                        </div>
                        
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 14px; line-height: 1.4;">
                            Grade length progression against your body measurements instead of generic standards.
                        </p>
                        
                        <div class="profile-form-row" style="margin-bottom: 14px;">
                            <div class="profile-form-group">
                                <label class="profile-form-label" style="font-size: 12px;">Height</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" class="profile-form-input" id="profile-height-feet" min="4" max="7" placeholder="5" inputmode="numeric" style="width: 60px; text-align: center; font-size: 16px;" onblur="validateHeightInput(this)">
                                    <span style="color: var(--text-secondary); font-size: 13px;">ft</span>
                                    <input type="number" class="profile-form-input" id="profile-height-inches" min="0" max="11" placeholder="10" inputmode="numeric" style="width: 60px; text-align: center; font-size: 16px;" onblur="validateInchesInput(this)">
                                    <span style="color: var(--text-secondary); font-size: 13px;">in</span>
                                </div>
                                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">4'6" to 7'0" typical</div>
                            </div>
                            <div class="profile-form-group">
                                <label class="profile-form-label" style="font-size: 12px;">Wrist-to-Floor <a href="https://youtu.be/YwA5_kwj-Wg?t=399" target="_blank" style="font-size: 10px; color: #00CED1;">üìè How to measure</a></label>
                                <div class="profile-form-input-with-unit">
                                    <input type="number" class="profile-form-input" id="profile-wrist-to-floor" min="25" max="45" step="0.5" placeholder="33" inputmode="decimal" style="font-size: 16px;" onblur="validateWTFInput(this)">
                                    <span class="profile-form-unit">inches</span>
                                </div>
                                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">25" to 45" typical (avg: 33")</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="profile-use-body-baseline" style="width: 16px; height: 16px; cursor: pointer;">
                            <label for="profile-use-body-baseline" style="cursor: pointer; flex: 1;">
                                <span style="font-size: 13px; color: var(--text-primary);">Enable Body Fit Grading</span>
                                <div style="font-size: 11px; color: var(--text-secondary);">‚ÑπÔ∏è Future gradings will use this setting</div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 3: Preferences -->
                <div id="profile-tab-preferences" class="profile-tab-content">
                    <div class="profile-form-row">
                        <div class="profile-form-group">
                            <label class="profile-form-label">Ball Flight Preference</label>
                            <select class="profile-form-select" id="profile-ball-flight">
                                <option value="none">No Preference</option>
                                <option value="high">High</option>
                                <option value="mid">Mid</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Primary Goal</label>
                            <select class="profile-form-select" id="profile-primary-goal">
                                <option value="">Select...</option>
                                <option value="distance">More Distance</option>
                                <option value="accuracy">Better Accuracy</option>
                                <option value="consistency">More Consistency</option>
                                <option value="scores">Lower Scores</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="profile-form-row">
                        <div class="profile-form-group full-width">
                            <label class="profile-form-label">Communication Style</label>
                            <select class="profile-form-select" id="profile-communication-level">
                                <option value="basic">Keep it Simple</option>
                                <option value="moderate" selected>Some Technical Terms OK</option>
                                <option value="advanced">Full Technical Detail</option>
                            </select>
                            <div class="profile-form-helper">How technical should your AI recommendations be?</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 4: Pro Notes (Pro Only) -->
                <div id="profile-tab-notes" class="profile-tab-content">
                    <div class="pro-notes-section">
                        <div class="pro-notes-header">
                            üîí Pro-Only Notes
                        </div>
                        
                        <div class="profile-form-row">
                            <div class="profile-form-group full-width">
                                <label class="profile-form-label">Fitting Notes</label>
                                <textarea class="profile-form-textarea" id="profile-fitting-notes" placeholder="Equipment observations, fitting history, recommendations..."></textarea>
                            </div>
                        </div>
                        
                        <div class="profile-form-row">
                            <div class="profile-form-group">
                                <label class="profile-form-label">Last Fitting Date</label>
                                <input type="date" class="profile-form-input" id="profile-last-fitting-date">
                            </div>
                        </div>
                        
                        <div class="profile-form-row">
                            <div class="profile-form-group full-width">
                                <label class="profile-form-label">Pro Observations</label>
                                <textarea class="profile-form-textarea" id="profile-pro-observations" placeholder="Swing tendencies, learning style, goals discussed..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('profile-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfile()">üíæ Save Profile</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    
    <!-- Firebase Auth -->
    <script src="firebase-auth.js?v=5"></script>
    
    <!-- Club Selection Components -->
    <script src="club-selector.js?v=1"></script>
    <script src="bag-onboarding.js?v=1"></script>
    <script src="testing-tab.js?v=1"></script>
    <script src="pro-integration.js?v=1"></script>
    
    <!-- AI Recommendations Service -->
    <script src="ai-recommendations.js?v=1"></script>
</body>
</html>
